<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Celeb Wall — OAuth</title>
<style>
  :root{
    --bg:#0c0e11;--panel:#14171c;--glass:rgba(255,255,255,.06);
    --text:#e8edf7;--muted:#aab3c5;--pill:#1b2027;--ok:#23c9b8;--bad:#ff5a76;
    --grad1:#b99cff;--grad2:#7dd6ff;--gradHot:#ff8ec3;--gradTeal:#8ff0d0;
    --radius:20px;--radiusSm:14px;--shadow:0 8px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 600px at 70% -10%, #1a2030 0%, #0c0e11 45%) fixed;color:var(--text);font:600 18px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .wrap{max-width:860px;margin:28px auto 80px;padding:0 16px}
  .row{display:flex;flex-wrap:wrap;gap:16px;justify-content:center}
  .pill{background:var(--pill);border-radius:24px;padding:18px 22px;box-shadow:var(--shadow);display:flex;align-items:center;gap:14px}
  .big{font-size:34px;font-weight:800}
  .muted{color:var(--muted)}
  .btn{background:var(--panel);border:none;border-radius:22px;padding:18px 22px;color:var(--text);font-weight:800;box-shadow:var(--shadow);letter-spacing:.3px}
  .btn:active{transform:translateY(1px)}
  .btn.grad{background:linear-gradient(135deg,var(--grad1),var(--grad2))}
  .btn.glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(6px)}
  .btn.bad{background:linear-gradient(135deg,#ff7aa2,#ff4d6d)}
  .btn.ok{background:linear-gradient(135deg,#27e8c8,#18b5a4)}
  .grid{margin-top:18px;display:grid;grid-template-columns:1fr;gap:18px}
  @media(min-width:700px){.grid{grid-template-columns:1fr 1fr}}
  .card{position:relative;background:var(--panel);border-radius:26px;overflow:hidden;box-shadow:var(--shadow)}
  .nameTag{position:absolute;top:14px;left:14px;background:var(--glass);backdrop-filter:blur(8px);padding:10px 14px;border-radius:14px;font-weight:900}
  .srcTag{position:absolute;bottom:14px;left:14px;background:var(--glass);padding:8px 12px;border-radius:12px;font-size:14px;color:var(--muted)}
  .media{display:block;width:100%;aspect-ratio:3/4;object-fit:cover;background:#0a0c0f}
  .bar{height:14px;border-radius:10px;background:#1b2027;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--grad1),var(--grad2),var(--gradHot));transition:width .25s ease}
  .status{display:flex;justify-content:space-between;align-items:center;margin:8px 4px 0;color:var(--muted);font-size:16px}
  .dash{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:14px;margin:8px 0 18px}
  @media(max-width:760px){.dash{grid-template-columns:repeat(2,1fr)}}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:20px}
  .sheet{max-width:720px;width:100%;background:#12151b;border-radius:22px;padding:20px;box-shadow:var(--shadow)}
  pre{white-space:pre-wrap;word-break:break-word;font:600 15px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#d7e1ff;background:#0b0d11;padding:14px;border-radius:14px;max-height:60vh;overflow:auto}
  .hide{display:none!important}
</style>
</head>
<body>
<div class="wrap">

  <!-- top counters -->
  <div class="dash">
    <div class="pill"><div>BUILD</div><div class="big" id="build">v2.9-oauth</div></div>
    <div class="pill"><div>SHOWN</div><div class="big" id="shown">0</div></div>
    <div class="pill"><div>POOL</div><div class="big" id="pool">0</div></div>
    <div class="pill"><div>TOTAL</div><div class="big" id="total">0</div></div>
  </div>

  <!-- progress -->
  <div class="bar"><i id="bar"></i></div>
  <div class="status"><span id="phase">Ready</span><span id="percent">0%</span></div>

  <!-- controls -->
  <div class="row" style="margin:18px 0 8px">
    <button class="btn" id="btnHome">Home</button>
    <button class="btn glass" id="btnLikes">⭐ Likes <span id="likeCount" class="muted">0</span></button>
    <button class="btn grad" id="btnBatch">New batch</button>
    <button class="btn glass" id="btnShuffle">Shuffle feed</button>
    <button class="btn" id="btnMore">Load more</button>
    <button class="btn" id="btnAuth">Connect Reddit</button>
    <button class="btn" id="btnTrouble">Troubleshoot</button>
  </div>

  <!-- cards -->
  <section id="cards" class="grid"></section>
</div>

<!-- modal -->
<div id="modal" class="modal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div class="pill">Troubleshoot</div>
      <button class="btn grad" id="btnClose">Close</button>
    </div>
    <pre id="log"></pre>
  </div>
</div>

<script>
/* ====== CONFIG — edit these ====== */
const REDDIT_CLIENT_ID = "-ZjCpRiT6UPJVawJqRU_9g"; // <-- paste your client id
// The redirect URI must exactly match what you set in your Reddit app.
// By default we use the current page URL:
const REDIRECT_URI = location.origin + location.pathname;

// Subreddits to search
const SUBS = [
  "Celebs","BeautifulCelebrities","celebrityhotties",
  "celebrities","celeblegs","LadiesOfWrestling"
];

// Initial list of names (you can add more)
const NAMES = [
  "Alexandra Daddario","Ana de Armas","Dua Lipa","Hailee Steinfeld",
  "Hailey Bieber","Madison Beer","Megan Fox","Sydney Sweeney",
  "Selena Gomez","Sabrina Carpenter","Emilia Clarke","Gal Gadot",
  "Taylor Swift","Margot Robbie","Vanessa Hudgens","Olivia Rodrigo"
];

/* ====== UI helpers ====== */
const $ = s => document.querySelector(s);
const cards = $("#cards");
const log = $("#log");
const shownEl = $("#shown"), poolEl = $("#pool"), totalEl = $("#total");
const likeCountEl = $("#likeCount");
const phaseEl = $("#phase"), percentEl = $("#percent"), barEl = $("#bar");
const modal = $("#modal");

function setProgress(p, phase=""){ barEl.style.width = (p*100|0)+"%"; percentEl.textContent = (p*100|0)+"%"; if(phase) phaseEl.textContent = phase; }
function say(m){ const t = new Date().toLocaleTimeString(); log.textContent = `[${t}] ${m}\n` + log.textContent; }
function pillNum(el, n){ el.textContent = n; }

/* ====== OAuth token (implicit flow) ====== */
const TOKEN_KEY = "cw_token";
function tokenFromHash(){
  const h = new URLSearchParams(location.hash.replace(/^#/,""));
  if (h.get("access_token")){
    const token = h.get("access_token");
    const expires = Date.now() + (parseInt(h.get("expires_in")||"3600",10)*1000);
    localStorage.setItem(TOKEN_KEY, JSON.stringify({token,expires}));
    // clean hash
    history.replaceState({}, document.title, location.pathname + location.search);
    return token;
  }
  return null;
}
function getStoredToken(){
  const raw = localStorage.getItem(TOKEN_KEY);
  if(!raw) return null;
  try{
    const o = JSON.parse(raw);
    if(o.expires && o.expires> Date.now()+5000) return o.token;
  }catch{}
  return null;
}
function authUrl(){
  const params = new URLSearchParams({
    client_id: REDDIT_CLIENT_ID,
    response_type: "token",
    state: (Math.random().toString(36).slice(2)),
    redirect_uri: REDIRECT_URI,
    duration: "temporary",
    scope: "read"
  });
  return `https://www.reddit.com/api/v1/authorize.compact?${params}`;
}
let ACCESS_TOKEN = tokenFromHash() || getStoredToken();

/* ====== Data + feed ====== */
let pool = [];      // queued items not shown yet
let shown = 0;      // shown count
let likes = JSON.parse(localStorage.getItem("cw_likes")||"[]");

function saveLikes(){ localStorage.setItem("cw_likes", JSON.stringify(likes)); likeCountEl.textContent = likes.length; }
saveLikes();

function buildCard(item){
  const card = document.createElement("article");
  card.className = "card";
  card.innerHTML = `
    <img class="media" src="${item.url}" alt="${item.title}">
    <div class="nameTag">${item.person||"Unknown"}</div>
    <div class="srcTag">r/${item.sub} • ${item.score}↑</div>
    <div style="display:flex;gap:12px;position:absolute;bottom:14px;right:14px">
      <button class="btn bad" data-act="dislike">Dismiss</button>
      <button class="btn ok" data-act="like">Like</button>
    </div>
  `;
  card.addEventListener("click", (e)=>{
    const act = e.target?.dataset?.act;
    if(!act) return;
    if(act==="like"){ likes.push(item); saveLikes(); card.remove(); }
    else { card.remove(); }
  });
  return card;
}

function renderNext(n=6){
  let added=0;
  while(pool.length && added<n){
    const it = pool.shift();
    cards.appendChild(buildCard(it));
    added++; shown++;
  }
  pillNum(poolEl, pool.length); pillNum(shownEl, shown); pillNum(totalEl, shown + pool.length);
}

async function api(path){
  if(!ACCESS_TOKEN) throw new Error("No token");
  const res = await fetch(`https://oauth.reddit.com${path}`, {
    headers:{
      "Authorization": `Bearer ${ACCESS_TOKEN}`,
      "User-Agent": "celebwall/1.0 by personal"
    }
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`HTTP ${res.status}: ${t.slice(0,160)}`);
  }
  return res.json();
}

function extractItems(json, person, sub){
  const out=[];
  const list = json?.data?.children || [];
  for(const ch of list){
    const d=ch.data;
    if(!d) continue;
    // media filters: images & gifs
    const isImg = /\.(jpg|jpeg|png|gif)$/i.test(d.url_overridden_by_dest||"") || (d.post_hint==="image");
    if(!isImg) continue;
    out.push({
      id:d.id, url:(d.url_overridden_by_dest||d.url), title:d.title, score:d.ups||0,
      sub: d.subreddit, person
    });
  }
  return out;
}

async function fetchForPerson(person){
  // try each sub with a search query limited to that sub
  const batch=[];
  for(const sub of SUBS){
    try{
      const q = encodeURIComponent(person);
      const json = await api(`/r/${sub}/search.json?q=${q}&restrict_sr=1&sort=top&limit=10&raw_json=1`);
      const items = extractItems(json, person, sub);
      say(`+ ${person} • r/${sub}: ${items.length}`);
      batch.push(...items);
      setProgress(Math.min(0.95, (shown + pool.length) / 60), `Searching ${person}`);
      if(batch.length>12) break;
    }catch(err){
      say(`× r/${sub} (${person}): ${err.message}`);
    }
  }
  return batch;
}

async function buildBatch(maxPeople=8){
  if(!ACCESS_TOKEN){ say("No token. Tap Connect Reddit."); return; }
  setProgress(0.05,"Starting…");
  const names = [...NAMES].sort(()=>Math.random()-.5).slice(0,maxPeople);
  const collected=[];
  for(const name of names){
    const got = await fetchForPerson(name);
    collected.push(...got);
    await new Promise(r=>setTimeout(r,200)); // polite
  }
  // de-dup by url
  const seen=new Set();
  pool = collected.filter(it=>{ if(seen.has(it.url)) return false; seen.add(it.url); return true; });
  pillNum(poolEl, pool.length); pillNum(totalEl, shown + pool.length);
  say(`Batch ready: +${pool.length}`);
  setProgress(1,"Ready");
  renderNext(8);
}

/* ====== wire up UI ====== */
$("#btnBatch").onclick = ()=> buildBatch();
$("#btnMore").onclick = ()=> renderNext(8);
$("#btnShuffle").onclick = ()=> { pool.sort(()=>Math.random()-.5); say("Shuffled feed"); };
$("#btnHome").onclick = ()=> { cards.innerHTML=""; pool.length=0; shown=0; pillNum(shownEl,0); pillNum(poolEl,0); pillNum(totalEl,0); say("Cleared feed"); };
$("#btnTrouble").onclick = ()=> modal.style.display="flex";
$("#btnClose").onclick = ()=> modal.style.display="none";
$("#btnLikes").onclick = ()=>{
  cards.innerHTML="";
  if(!likes.length){ say("No likes yet"); return; }
  for(const it of likes.slice().reverse()) cards.appendChild(buildCard(it));
  pillNum(shownEl,0); pillNum(poolEl,likes.length); pillNum(totalEl,likes.length);
  say("Showing likes");
};
$("#btnAuth").onclick = ()=>{
  const url = authUrl();
  location.href = url;
};

/* ====== startup ====== */
window.addEventListener("load", ()=>{
  if(ACCESS_TOKEN){ $("#btnAuth").textContent="Connected ✓"; say("OAuth token ready"); }
  else { say("Tap Connect Reddit to authorize"); }
  setProgress(1,"Ready");
});
</script>
</body>
</html>