<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Celeb Wall</title>
<style>
  :root{
    --bg:#0d0f12;
    --card:#15181d;
    --glass: rgba(255,255,255,.06);
    --glass-2: rgba(255,255,255,.1);
    --text:#e9eef5;
    --muted:#a9b1bd;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --round: 22px;
    --round-lg: 26px;
    --grad-1: linear-gradient(90deg, #b592ff, #84d4ff, #ff9ac2);
    --like: linear-gradient(180deg,#32d3c8,#16b3a7);
    --nope: linear-gradient(180deg,#ff6b6b,#e35151);
    --pill: rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:radial-gradient(1200px 600px at 50% -200px, rgba(159,123,255,.15), transparent 60%) , var(--bg); color:var(--text); font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";}
  .wrap{max-width:820px; margin:0 auto; padding:16px 16px 84px}

  /* tiles */
  .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:14px; align-items:stretch}
  .tile{background:var(--glass); border-radius:18px; padding:18px 16px; box-shadow:var(--shadow); text-align:center}
  .t-k{font-size:14px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted)}
  .t-v{font-size:42px; font-weight:900; line-height:1.05}

  /* bar */
  .bar-wrap{margin:14px 2px 6px}
  .bar{height:12px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .bar > i{display:block; height:100%; width:0%; background:var(--grad-1)}
  .status-line{display:flex; justify-content:space-between; color:var(--muted); font-weight:800; margin-top:6px}

  /* controls */
  .controls{display:grid; grid-template-columns:1fr 1fr; gap:16px; margin:18px 0 10px}
  .btn{border:none; padding:18px 18px; border-radius:26px; background:var(--glass); color:var(--text); font-weight:900; font-size:22px; letter-spacing:.2px; box-shadow:var(--shadow); backdrop-filter: blur(10px)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background: var(--grad-1); color:#0c1015}
  .btn.ghost{background:var(--glass)}
  .btn.wide{grid-column:1/-1}

  .badge{display:inline-grid; place-items:center; width:44px; height:44px; border-radius:50%; background:var(--glass-2); margin-left:10px; font-size:16px}

  /* cards */
  #cards{display:grid; gap:20px; margin-top:18px}
  .card{background: var(--glass); border-radius:24px; overflow:hidden; box-shadow:var(--shadow)}
  .media{background:#0b0e12; min-height:280px; display:grid; place-items:center}
  .media img,.media video{width:100%; height:auto; display:block; max-height:80vh; object-fit:contain; background:#0b0e12}
  .meta{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 18px}
  .name{font-size:22px; font-weight:900}
  .actions{display:flex; gap:10px}
  .act{border:none; padding:14px 18px; border-radius:15px; color:#0a0f12; font-weight:900; font-size:18px; letter-spacing:.2px}
  .act.like{background:var(--like)}
  .act.nope{background:var(--nope)}

  /* modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; padding:16px}
  .modal.on{display:grid}
  .sheet{max-width:760px; width:100%; background:rgba(9,12,16,.96); border-radius:24px; padding:16px; box-shadow:var(--shadow)}
  .hd{display:flex; align-items:center; justify-content:space-between; padding:8px 10px 10px}
  .hd .title{font-size:28px; font-weight:900}
  .hd .close{border:none; padding:10px 16px; border-radius:18px; background:var(--grad-1); font-weight:800}
  pre{margin:0; padding:14px; border-radius:18px; background:#0d1117; color:#d7deea; font-size:16px; line-height:1.46; overflow:auto; max-height:60vh}

  /* footer link */
  .foot{display:grid; place-items:center; margin:26px 0 8px}
  .chip{background:var(--glass); padding:10px 16px; border-radius:999px; color:var(--muted); font-weight:800; text-decoration:none}
  @media (max-width:720px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .controls{grid-template-columns:1fr; gap:14px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="tile"><div class="t-k">BUILD</div><div class="t-v" id="tBuild">v2.8.2</div></div>
      <div class="tile"><div class="t-k">SHOWN</div><div class="t-v" id="tShown">0</div></div>
      <div class="tile"><div class="t-k">POOL</div><div class="t-v" id="tPool">0</div></div>
      <div class="tile"><div class="t-k">TOTAL</div><div class="t-v" id="tTotal">0</div></div>
    </div>

    <div class="bar-wrap">
      <div class="bar"><i id="bar"></i></div>
      <div class="status-line"><span id="phase">Ready</span><span id="pct">100%</span></div>
    </div>

    <div class="controls">
      <button class="btn ghost" id="btnHome">Home</button>
      <button class="btn ghost" id="btnLikes">⭐ Likes <span class="badge" id="likeCount">0</span></button>
      <button class="btn primary" id="btnNew">New batch</button>
      <button class="btn ghost" id="btnShuffle">Shuffle feed</button>
      <button class="btn ghost" id="btnMore">Load more</button>
      <button class="btn ghost" id="btnConnect">Connect Reddit</button>
      <button class="btn ghost wide" id="btnTrouble">Troubleshoot</button>
    </div>

    <section id="cards"></section>

    <div class="foot">
      <a class="chip" href="https://a11y.github.io" target="_blank" rel="noopener">a11y.github.io</a>
    </div>
  </div>

  <!-- Troubleshoot modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="hd">
        <div class="title">Troubleshoot</div>
        <button class="close" id="closeModal">Close</button>
      </div>
      <pre id="log"></pre>
    </div>
  </div>

<script>
/* =========================
   CONFIG — UPDATE THIS
   ========================= */
const CLIENT_ID    = "-ZjCpRiT6UPJVawJqRU_9g"; // ← TODO: paste your Client ID
const REDIRECT_URI = "https://charlessmainville-a11y.github.io/"; // EXACT (with trailing slash)
const SCOPES       = "read";          // we only need read
const BUILD        = "v2.8.2-stable";

/* ============= UI refs ============= */
const el = {
  tBuild: document.getElementById('tBuild'),
  tShown: document.getElementById('tShown'),
  tPool:  document.getElementById('tPool'),
  tTotal: document.getElementById('tTotal'),
  bar:    document.getElementById('bar'),
  phase:  document.getElementById('phase'),
  pct:    document.getElementById('pct'),
  cards:  document.getElementById('cards'),
  likeCount: document.getElementById('likeCount'),
  btnNew: document.getElementById('btnNew'),
  btnShuffle: document.getElementById('btnShuffle'),
  btnMore: document.getElementById('btnMore'),
  btnLikes: document.getElementById('btnLikes'),
  btnConnect: document.getElementById('btnConnect'),
  btnTrouble: document.getElementById('btnTrouble'),
  modal: document.getElementById('modal'),
  closeModal: document.getElementById('closeModal'),
  log: document.getElementById('log')
};
el.tBuild.textContent = BUILD;

/* ============= logger ============= */
function log(msg){
  const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  el.log.textContent = (line + el.log.textContent).slice(0, 4000);
}
function setPhase(p, frac){
  el.phase.textContent = p;
  const pct = Math.max(0, Math.min(1, frac ?? 1));
  el.bar.style.width = (pct*100).toFixed(0) + '%';
  el.pct.textContent = (pct*100).toFixed(0)+ '%';
}

/* ============= OAuth ============= */
const AUTH_URL  = "https://www.reddit.com/api/v1/authorize";
const API_BASE  = "https://oauth.reddit.com";

function randState(n=24){
  const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let s=""; for(let i=0;i<n;i++) s+=a[Math.floor(Math.random()*a.length)];
  return s;
}

function startOAuth(){
  try{ sessionStorage.removeItem("rw_expected_state"); }catch{}
  localStorage.removeItem("rw_access_token");
  const state = randState();
  try{ sessionStorage.setItem("rw_expected_state", state); }catch{}
  const u = AUTH_URL
    + `?client_id=${encodeURIComponent(CLIENT_ID)}`
    + `&response_type=token`
    + `&state=${encodeURIComponent(state)}`
    + `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`
    + `&duration=permanent`
    + `&scope=${encodeURIComponent(SCOPES)}`;
  location.href = u;
}

function finishOAuthFromHash(){
  if (!location.hash.startsWith("#")) return false;
  const qs = new URLSearchParams(location.hash.slice(1));
  const token = qs.get("access_token");
  const state = qs.get("state");
  const error = qs.get("error");
  if (error){ log(`OAuth error: ${error}`); cleanHash(); return true; }
  if (!token){ cleanHash(); return false; }

  let expected=null; try{ expected=sessionStorage.getItem("rw_expected_state"); }catch{}
  if (expected && expected !== state) log("State mismatch (continuing for personal app).");
  localStorage.setItem("rw_access_token", token);
  cleanHash();
  log("Connected to Reddit ✔︎");
  return true;
}
function cleanHash(){ history.replaceState({}, document.title, REDIRECT_URI); }

async function apiGet(path){
  const token = localStorage.getItem("rw_access_token");
  if (!token) throw new Error("No token — tap Connect Reddit");
  const res = await fetch(`${API_BASE}${path}`, { headers:{ "Authorization": `Bearer ${token}` }});
  if (!res.ok){
    const txt = await res.text().catch(()=>String(res.status));
    throw new Error(`HTTP ${res.status}: ${txt.slice(0,200)}`);
  }
  return res.json();
}

/* ============= Data / feed ============= */
const SUBS = [
  "Celebs", "BeautifulCelebrities", "celebrityhotties",
  "TheCelebArchive", "celebritylegs", "LadiesOfWrestling"
];
let pool = [];    // unseen items
let shown = [];   // shown items
let likes = JSON.parse(localStorage.getItem("cw_likes") || "[]");
el.likeCount.textContent = likes.length;

function persistLikes(){ localStorage.setItem("cw_likes", JSON.stringify(likes)); el.likeCount.textContent = likes.length; }

function pickTitleAuthor(post){
  const t = post.title || "";
  // crude “name first” extractor (keep what’s before a ":" or " - ")
  return t.split(/[-:|•]/)[0].trim() || "Unknown";
}
function extractMedia(post){
  // prefer direct images or gifs
  if (!post) return null;
  const url = post.url_overridden_by_dest || post.url;
  const isImg = /\.(jpg|jpeg|png|webp)$/i.test(url);
  const isGif = /\.(gif|gifv|mp4)$/i.test(url);
  if (isImg) return {type:"img", src:url};
  if (isGif) {
    // gifv → mp4 if present
    const mp4 = url.endsWith(".gifv") ? url.replace(".gifv",".mp4") : url;
    return {type:"video", src: mp4};
  }
  // try preview
  if (post.preview?.images?.[0]?.source?.url){
    return {type:"img", src: post.preview.images[0].source.url.replace(/&amp;/g,'&')};
  }
  return null;
}

async function buildBatch(){
  setPhase("Requesting", .2); log("Building new batch…");
  const token = localStorage.getItem("rw_access_token");
  if (!token){ log("Not connected. Tap Connect Reddit."); setPhase("Ready",1); return; }

  const multi = SUBS.join("+");
  try{
    const data = await apiGet(`/r/${multi}/hot.json?limit=50&raw_json=1`);
    const arr = (data?.data?.children || []).map(n=>n.data).filter(Boolean);

    const items = [];
    for (const p of arr){
      const media = extractMedia(p);
      if (!media) continue;
      items.push({
        id: p.id,
        sub: p.subreddit_name_prefixed || p.subreddit,
        title: p.title || "",
        name: pickTitleAuthor(p),
        url: `https://reddit.com${p.permalink}`,
        media
      });
    }
    pool = items;
    el.tPool.textContent = pool.length;
    el.tTotal.textContent = pool.length + shown.length;
    setPhase("Parsed", .8);
    renderSome(6);
    setPhase("Ready",1);
    log(`Loaded ${items.length} from /r/${multi}`);
  }catch(e){
    log(`ERROR: ${e.message}`);
    setPhase("Error",1);
  }
}

function renderSome(count=4){
  for (let i=0;i<count;i++){
    const it = pool.shift(); if (!it) break;
    shown.push(it);
    el.tShown.textContent = shown.length;
    el.tPool.textContent = pool.length;
    el.tTotal.textContent = pool.length + shown.length;
    addCard(it);
  }
}

function addCard(it){
  const card = document.createElement('article');
  card.className = 'card';
  card.dataset.id = it.id;

  const media = document.createElement('div');
  media.className = 'media';
  if (it.media.type === "img"){
    const img = document.createElement('img');
    img.alt = it.title || it.name;
    img.loading = "lazy";
    img.src = it.media.src;
    media.appendChild(img);
  }else{
    const vid = document.createElement('video');
    vid.src = it.media.src;
    vid.controls = true;
    vid.loop = true;
    vid.playsInline = true;
    media.appendChild(vid);
  }

  const meta = document.createElement('div');
  meta.className = 'meta';
  const left = document.createElement('div');
  left.innerHTML = `<div class="name">${it.name}</div><div style="color:var(--muted); font-weight:700; font-size:13px">${it.sub}</div>`;
  const actions = document.createElement('div');
  actions.className = 'actions';
  const bLike = document.createElement('button');
  bLike.className = 'act like'; bLike.textContent = 'Like';
  const bNope = document.createElement('button');
  bNope.className = 'act nope'; bNope.textContent = 'Dismiss';

  bLike.onclick = ()=>{ likes.unshift(it); persistLikes(); card.remove(); };
  bNope.onclick = ()=>{ card.remove(); };

  actions.append(bLike,bNope);
  meta.append(left, actions);

  card.append(media, meta);
  el.cards.appendChild(card);
}

/* ============= Likes view ============= */
function showLikes(){
  el.cards.innerHTML = "";
  if (!likes.length){ log("No likes yet"); return; }
  likes.forEach(addCard);
}

/* ============= Wiring ============= */
el.btnNew.addEventListener('click', buildBatch);
el.btnMore.addEventListener('click', ()=>renderSome(6));
el.btnShuffle.addEventListener('click', ()=>{
  pool.sort(()=>Math.random()-0.5);
  shown.sort(()=>Math.random()-0.5);
  const cur = [...document.querySelectorAll('.card')];
  cur.sort(()=>Math.random()-0.5).forEach(n=>el.cards.appendChild(n));
});
el.btnLikes.addEventListener('click', showLikes);
el.btnTrouble.addEventListener('click', ()=> el.modal.classList.add('on'));
el.closeModal.addEventListener('click', ()=> el.modal.classList.remove('on'));
el.btnConnect.addEventListener('click', startOAuth);

/* Handle return from Reddit */
finishOAuthFromHash();

/* Initial */
setPhase("Ready",1);
log("UI ready. Tap Connect Reddit, then New batch.");
</script>
</body>
</html>