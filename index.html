<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scroll Wall</title>
<style>
  :root{
    --bg:#0b0f14;
    --bg2:#121924;
    --ink:#e9eef6;
    --muted:#9fb1c6;
    --accent:#ff6fa0;
    --panel:#182231;
    --ok:#3ddc97;
    --warn:#ffae42;
    --bad:#ff5c7a;
    --card:#1a2433;
    --shadow:rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    background:
      radial-gradient(1200px 700px at -20% -20%, #16202e 0%, transparent 60%),
      radial-gradient(1000px 600px at 120% 0%, #101926 0%, transparent 60%),
      radial-gradient(900px 600px at 10% 120%, #0f1722 0%, transparent 60%),
      var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  a{color:inherit}
  .wrap{max-width:980px;margin:20px auto;padding:16px}
  .toolbar{
    display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-start;
    margin-bottom:14px;
  }
  .pill{
    display:inline-flex;align-items:center;gap:.5rem;
    background:linear-gradient(180deg, #1b2535, #141d2a);
    border:1px solid #263145;border-radius:14px;padding:10px 16px;
    color:var(--ink);font-weight:700;letter-spacing:.2px;
    box-shadow: 0 6px 18px var(--shadow), inset 0 1px 0 rgba(255,255,255,.04);
    transition: transform .05s ease, filter .2s ease, background .2s ease;
    user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .pill:hover{filter:brightness(1.06)}
  .pill:active{transform:translateY(1px)}
  .pill.primary{background:linear-gradient(180deg, #ff7fb3, #ff5b9d); border-color:#ff7fb3; color:#10131a}
  .pill.ghost{background:transparent;border-color:#2a364a}
  .stat{min-width:80px;justify-content:center}
  .badge{display:inline-block;background:#243047;border:1px solid #2f3b54;padding:2px 8px;border-radius:999px;font-size:.8rem;color:var(--muted)}
  .hint{margin:6px 2px 14px 2px;color:var(--muted);font-size:.95rem}

  /* grid of cards */
  .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(280px,1fr));gap:18px}
  .card{
    background:linear-gradient(180deg,#1b2637,#141d2a);
    border:1px solid #22304a;border-radius:16px;overflow:hidden;position:relative;
    box-shadow: 0 12px 28px var(--shadow);
    touch-action: pan-y; /* allow vertical page scroll while we manage horizontal swipe */
  }
  /* Polaroid styling */
  .polaroid::before{
    content:""; position:absolute; inset:0;
    background: linear-gradient(180deg, rgba(255,255,255,.07), transparent 30%),
                radial-gradient(1200px 200px at 50% -10%, rgba(255,255,255,.06), transparent 60%);
    pointer-events:none;
  }
  .frame{
    aspect-ratio: 4 / 5; width:100%; background:#0e1520; display:flex; align-items:center; justify-content:center;
  }
  .frame img, .frame video{
    max-width:100%; max-height:100%; display:block;
    object-fit:contain; background:#0e1520;
  }
  .meta{
    padding:14px 12px 12px 12px; display:flex; align-items:center; gap:8px; justify-content:space-between;
    background:linear-gradient(180deg,#141d2a,#111824);
    border-top:1px solid #233049;
  }
  .sub{
    font-weight:700; color:#cfe0ff; text-shadow:0 1px 0 rgba(0,0,0,.25);
  }
  .actions{display:flex;gap:8px}
  .btn{
    display:inline-flex; align-items:center; gap:.4rem; border-radius:12px;
    padding:10px 12px; background:#1f2a3d; border:1px solid #2b3750; color:#dfe9ff; font-weight:800;
  }
  .btn.like{background:linear-gradient(180deg,#ffd76b,#ffbf3e); border-color:#ffd76b; color:#202426}
  .btn.dislike{background:linear-gradient(180deg,#ff829d,#ff5c7a); border-color:#ff829d; color:#1a0f14}
  .btn.small{padding:8px 10px;border-radius:10px;font-weight:700}
  .pill svg, .btn svg{width:18px;height:18px}

  /* swipe animation */
  .swiping{transition:none}
  .like-mark, .nope-mark{
    position:absolute; top:10px; left:10px; padding:6px 10px; border-radius:10px; font-weight:900;
    backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.15); color:#111;
    opacity:0; transform:scale(.9);
  }
  .like-mark{ background:#ffe27a; }
  .nope-mark{ background:#ff7f9b; right:10px; left:auto }
  .show-like .like-mark{opacity:1; transform:scale(1)}
  .show-nope .nope-mark{opacity:1; transform:scale(1)}

  /* pages */
  .page{display:none}
  .page.active{display:block}
  .empty{color:var(--muted);padding:40px 10px;text-align:center}

  pre.log{white-space:pre-wrap;background:#0f1621;border:1px solid #27344a;padding:14px;border-radius:12px;color:#bcd1ea}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0}
</style>
</head>
<body>
<div class="wrap">
  <!-- Top nav -->
  <div class="toolbar" id="topNav">
    <button class="pill ghost" data-page="home">Home</button>
    <button class="pill ghost" data-page="liked">Liked ‚≠ê</button>
    <button class="pill ghost" data-page="subs">Sources ‚öôÔ∏è</button>
    <span class="badge" id="flags">NSFW enabled ‚Ä¢ people-only ‚Ä¢ spicy sprinkle</span>
  </div>

  <!-- HOME -->
  <section class="page active" id="home">
    <div class="toolbar">
      <button class="pill ghost" id="newBatch">New batch</button>
      <button class="pill primary" id="loadMore">Load more</button>
      <span class="pill stat" id="counter">0/0</span>
      <button class="pill ghost" id="shuffleBtn">Shuffle üîÄ</button>
      <button class="pill ghost" id="troubleshootBtn">Troubleshoot ü©∫</button>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="emptyMsg" style="display:none">No posts yet.</div>
    <div id="trouble" style="display:none;margin-top:14px">
      <pre class="log" id="troubleLog"></pre>
    </div>
  </section>

  <!-- LIKED -->
  <section class="page" id="liked">
    <div class="toolbar">
      <button class="pill ghost" id="exportLiked">Export JSON</button>
      <button class="pill ghost" id="clearLiked">Clear liked</button>
      <span class="pill stat" id="likedCount">0</span>
    </div>
    <div class="grid" id="likedGrid"></div>
    <div class="empty" id="likedEmpty" style="display:none">No likes yet ‚Äî tap ‚≠ê on a card.</div>
  </section>

  <!-- SOURCES / SETTINGS -->
  <section class="page" id="subs">
    <div class="hint">The app first tries <b>Redgifs</b> (temporary token + search by names). If that fails or rate-limits, it falls back to <code>/media.json</code>.</div>
    <div class="row">
      <button class="pill ghost" id="saveSources">Save & Reload</button>
      <button class="pill ghost" id="resetSources">Reset to defaults</button>
      <span class="pill stat" id="namesCount">0 names</span>
    </div>
    <textarea id="namesArea" style="width:100%;height:260px;border-radius:12px;background:#0f1621;color:#cfe0ff;border:1px solid #27344a;padding:12px" spellcheck="false"></textarea>
    <div class="hint">One name per line (used for Redgifs search). Examples: <i>Charli D'Amelio</i>, <i>Hailee Steinfeld</i>, <i>Lea Elui</i>‚Ä¶</div>
  </section>
</div>

<script>
/* ======= CONFIG & STATE ======= */
const DEFAULT_NAMES = [
  "Charli D'Amelio","Hailee Steinfeld","Lea Elui","Emily Ratajkowski","Ana de Armas","Addison Rae",
  "Madelyn Cline","Sydney Sweeney","Alexis Ren","Sommer Ray","Dua Lipa","Sabrina Carpenter",
  "Jenna Ortega","Madison Beer","Hailey Bieber","Lily-Rose Depp","Margot Robbie","Lais Ribeiro",
  "Lindsey Pellas","Elsa Hosk","Bella Hadid","Gigi Hadid","Kendall Jenner","Kylie Jenner",
  "Kaia Gerber","Alix Earle","Emma Chamberlain","Barbara Palvin","Candice Swanepoel","Camila Morrone"
];
const STORAGE_KEYS = {
  liked: 'sw-liked-v2',
  names: 'sw-names-v1'
};
const STATE = {
  pool: [],   // items available to show
  shown: 0,   // how many shown this batch
  likes: loadLikes(),
  log: [],
  redgifs: { token: null, expiresAt: 0 }
};

/* ======= UTIL ======= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function log(...args){ STATE.log.push(args.join(' ')); }
function showTrouble(open=true){
  $('#trouble').style.display = open ? 'block' : 'none';
  $('#troubleLog').textContent =
`Online: ${navigator.onLine}
UA: ${navigator.userAgent}
Pool size: ${STATE.pool.length}, shown: ${STATE.shown}, likes: ${STATE.likes.length}
Log:
- ${STATE.log.join('\n- ')}`;
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function saveLikes(){ localStorage.setItem(STORAGE_KEYS.liked, JSON.stringify(STATE.likes)); updateLikedBadge(); }
function loadLikes(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEYS.liked)||'[]'); }catch{return []} }
function updateLikedBadge(){
  $('#likedCount').textContent = `${STATE.likes.length} liked`;
}

/* ======= NAV ======= */
$$('.pill.ghost[data-page]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const page = btn.getAttribute('data-page');
    $$('.page').forEach(p=>p.classList.remove('active'));
    $('#'+page).classList.add('active');
    if(page==='liked') renderLiked();
    if(page==='subs') populateNamesArea();
  });
});

/* ======= SOURCES (Names for Redgifs search) ======= */
function getNames(){
  try{
    const raw = localStorage.getItem(STORAGE_KEYS.names);
    if(!raw) return [...DEFAULT_NAMES];
    const arr = JSON.parse(raw);
    return Array.isArray(arr)&&arr.length ? arr : [...DEFAULT_NAMES];
  }catch{ return [...DEFAULT_NAMES]; }
}
function populateNamesArea(){
  const names = getNames();
  $('#namesArea').value = names.join('\n');
  $('#namesCount').textContent = `${names.length} names`;
}
$('#saveSources').addEventListener('click', ()=>{
  const lines = $('#namesArea').value.split('\n').map(s=>s.trim()).filter(Boolean);
  localStorage.setItem(STORAGE_KEYS.names, JSON.stringify(lines));
  $('#namesCount').textContent = `${lines.length} names`;
  location.reload();
});
$('#resetSources').addEventListener('click', ()=>{
  localStorage.removeItem(STORAGE_KEYS.names);
  populateNamesArea();
});

/* ======= RENDER CARDS ======= */
const grid = $('#grid');
const emptyMsg = $('#emptyMsg');

function makeCard(item){
  const card = document.createElement('article');
  card.className = 'card polaroid';
  card.dataset.id = item.id || (item.src||'').slice(-24);

  card.innerHTML = `
    <div class="like-mark">‚≠ê LIKE</div>
    <div class="nope-mark">üëé NOPE</div>
    <div class="frame">
      ${item.type==='video'
        ? `<video playsinline muted loop preload="metadata" src="${item.src}"></video>`
        : `<img loading="lazy" src="${item.src}" alt="">`
      }
    </div>
    <div class="meta">
      <span class="sub">${item.by || (item.platform||'')}</span>
      <span class="actions">
        <button class="btn small like">‚≠ê Like</button>
        <button class="btn small dislike">üëé Dislike</button>
      </span>
    </div>
  `;

  // autoplay videos when visible
  const video = card.querySelector('video');
  if(video){
    const io = new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if(e.isIntersecting){ video.play().catch(()=>{}); }
        else { video.pause(); }
      });
    }, {threshold:.6});
    io.observe(card);
    video.addEventListener('click', ()=>{ if(video.muted) video.muted=false; video.play().catch(()=>{}); });
  }

  // like / dislike buttons
  card.querySelector('.like').addEventListener('click', ()=> likeItem(item, card));
  card.querySelector('.dislike').addEventListener('click', ()=> dismissCard(card));

  // swipe gesture
  let startX=0, currentX=0, dragging=false;
  const threshold = 60;
  card.addEventListener('pointerdown', (e)=>{
    dragging=true; startX=e.clientX; card.setPointerCapture(e.pointerId); card.classList.add('swiping');
  });
  card.addEventListener('pointermove', (e)=>{
    if(!dragging) return;
    currentX = e.clientX - startX;
    const rot = Math.max(-8, Math.min(8, currentX/12));
    card.style.transform = `translateX(${currentX}px) rotate(${rot}deg)`;
    card.classList.toggle('show-like', currentX>threshold);
    card.classList.toggle('show-nope', currentX<-threshold);
  });
  card.addEventListener('pointerup', ()=>{
    dragging=false; card.classList.remove('swiping');
    if(currentX>threshold){ likeItem(item, card, true); }
    else if(currentX<-threshold){ dismissCard(card,true); }
    else { card.style.transform=''; card.classList.remove('show-like','show-nope'); }
    currentX=0;
  });

  return card;
}

function likeItem(item, card, fromSwipe=false){
  // avoid duplicate
  if(!STATE.likes.find(x=>x.src===item.src)){
    STATE.likes.unshift(item);
    saveLikes();
  }
  animateOut(card, true);
}
function dismissCard(card, fromSwipe=false){
  animateOut(card, false);
}
function animateOut(card, liked){
  const dx = liked ? 220 : -220;
  card.style.transition='transform .22s ease, opacity .22s ease';
  card.style.transform = `translateX(${dx}px) rotate(${liked?6:-6}deg)`;
  card.style.opacity = .0;
  setTimeout(()=>{ card.remove(); updateCounter(-1); checkEmpty(); }, 220);
}

/* ======= BATCH / COUNTERS ======= */
function updateCounter(delta=0){
  if(delta) STATE.shown += delta;
  $('#counter').textContent = `${STATE.shown}/${STATE.pool.length}`;
}
function checkEmpty(){
  emptyMsg.style.display = grid.children.length? 'none':'block';
}

/* ======= LIKED PAGE ======= */
function renderLiked(){
  const g = $('#likedGrid'); g.innerHTML='';
  if(!STATE.likes.length){ $('#likedEmpty').style.display='block'; updateLikedBadge(); return; }
  $('#likedEmpty').style.display='none';
  STATE.likes.forEach(item=>{
    const card = makeCard(item);
    // In liked view, dislike removes from likes
    card.querySelector('.dislike').textContent = 'üóëÔ∏è Remove';
    card.querySelector('.dislike').onclick = ()=>{
      STATE.likes = STATE.likes.filter(x=>x.src!==item.src);
      saveLikes();
      card.remove();
      renderLiked();
    };
    g.appendChild(card);
  });
  updateLikedBadge();
}
$('#exportLiked').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(STATE.likes,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'liked.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
$('#clearLiked').addEventListener('click', ()=>{
  if(confirm('Clear all liked items?')){ STATE.likes=[]; saveLikes(); renderLiked(); }
});

/* ======= REDGIFS FETCH (best effort) ======= */
async function getRedgifsToken(){
  try{
    const now = Date.now();
    if(STATE.redgifs.token && STATE.redgifs.expiresAt>now+30_000) return STATE.redgifs.token;
    const r = await fetch('https://api.redgifs.com/v2/auth/temporary');
    if(!r.ok) throw new Error(`token ${r.status}`);
    const j = await r.json();
    STATE.redgifs.token = j.jwt;
    // temp tokens usually ~24h; we set a 2h window
    STATE.redgifs.expiresAt = now + 2*60*60*1000;
    return j.jwt;
  }catch(err){
    log('Redgifs token error:', err.message||err);
    throw err;
  }
}

async function redgifsSearchOne(name, limit=6){
  const token = await getRedgifsToken();
  const url = new URL('https://api.redgifs.com/v2/gifs/search');
  url.searchParams.set('search_text', name);
  url.searchParams.set('order', 'trending');
  url.searchParams.set('page', '1');
  url.searchParams.set('count', String(limit));
  const r = await fetch(url, {headers:{Authorization:`Bearer ${token}`}});
  if(!r.ok) throw new Error(`${name}: ${r.status}`);
  const j = await r.json();
  if(!j || !Array.isArray(j.gifs)) return [];
  return j.gifs
    .map(g=>{
      // prefer hd->sd url chain if present
      const src = (g.urls && (g.urls.hd || g.urls.sd || g.urls.vthumbnail)) || null;
      return src ? {
        id: g.id,
        type: 'video',
        src,
        by: name,
        platform: 'Redgifs',
        href: `https://redgifs.com/watch/${g.id}`
      } : null;
    })
    .filter(Boolean);
}

/* ======= MEDIA.JSON FALLBACK ======= */
async function loadMediaJSON(){
  try{
    const r = await fetch('./media.json', {cache:'no-store'});
    if(!r.ok) throw new Error('no media.json');
    const j = await r.json();
    if(!Array.isArray(j)) throw new Error('media.json not array');
    return j.map(x=>({
      id: x.id || (x.src||'').slice(-24),
      type: (x.type || (x.src?.match(/\.(mp4|webm|gif)$/i)?'video':'image')),
      src: x.src, by: x.by || '', platform: x.platform || 'custom', href: x.href || ''
    }));
  }catch(err){
    log('media.json error:', err.message||err);
    return [];
  }
}

/* ======= LOAD LOGIC ======= */
async function buildNewBatch(){
  STATE.pool = [];
  STATE.shown = 0;
  grid.innerHTML='';
  updateCounter(0);
  checkEmpty();
  STATE.log.length = 0;

  // Try Redgifs first
  const names = getNames();
  $('#namesCount').textContent = `${names.length} names`;
  try{
    const pick = shuffle([...names]).slice(0, 10);
    let results = [];
    for(const n of pick){
      try{
        const part = await redgifsSearchOne(n, 6);
        log(`+ ${n}: ${part.length} items`);
        results.push(...part);
        // throttle a bit to be gentle
        await new Promise(res=>setTimeout(res, 250));
      }catch(e){
        log(`- ${n}: ${e.message||e}`);
      }
    }
    results = dedupeBySrc(results);
    if(results.length){
      STATE.pool = shuffle(results);
      log(`Redgifs OK: ${STATE.pool.length} total`);
    }
  }catch(e){
    log('Redgifs top-level error:', e.message||e);
  }

  // Fallback to media.json if needed
  if(!STATE.pool.length){
    const f = await loadMediaJSON();
    if(f.length){
      STATE.pool = shuffle(f);
      log(`Using media.json: ${STATE.pool.length} items`);
    }
  }

  if(!STATE.pool.length){
    log('No media sources produced items.');
  }
  updateCounter(0);
}

function dedupeBySrc(arr){
  const seen = new Set();
  return arr.filter(x=>{ if(!x.src || seen.has(x.src)) return false; seen.add(x.src); return true; });
}

function renderMore(count=8){
  if(!STATE.pool.length){ checkEmpty(); return; }
  const slice = STATE.pool.splice(0, count);
  slice.forEach(item=>{
    const card = makeCard(item);
    grid.appendChild(card);
  });
  updateCounter(slice.length);
  checkEmpty();
}

/* ======= EVENTS ======= */
$('#newBatch').addEventListener('click', async ()=>{
  $('#trouble').style.display='none';
  $('#emptyMsg').style.display='none';
  await buildNewBatch();
  renderMore(10);
});
$('#loadMore').addEventListener('click', ()=> renderMore(8));
$('#shuffleBtn').addEventListener('click', ()=>{
  // Shuffle remaining pool and reflow current grid order
  STATE.pool = shuffle(STATE.pool);
  const cards = Array.from(grid.children);
  shuffle(cards).forEach(c=>grid.appendChild(c));
});
$('#troubleshootBtn').addEventListener('click', ()=> showTrouble(true));

/* ======= INIT ======= */
(async function init(){
  populateNamesArea();
  updateLikedBadge();
  await buildNewBatch();
  renderMore(10);
})();
</script>
</body>
</html>