<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Celeb Wall</title>
<style>
  :root{
    --bg:#0e0f12; --panel:#17191f; --glass:rgba(255,255,255,.06);
    --text:#e9edf3; --muted:#a5adbb; --pill:#20232b;
    --glow1:#a18cff; --glow2:#79d8ff; --glow3:#ff9ecb;
    --ok:#4bd1c5; --bad:#ff6b7a; --accent:#b79cff;
    --radius:18px; --gap:14px;
  }
  *{box-sizing:border-box}
  html,body{background:radial-gradient(1200px 600px at 10% -10%,rgba(161,140,255,.13),transparent 60%),
            radial-gradient(1200px 600px at 90% -10%,rgba(121,216,255,.10),transparent 60%),var(--bg);
            color:var(--text); margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:820px;margin:0 auto;padding:22px 16px 80px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap);margin-bottom:16px}
  .stat{background:var(--panel);border-radius:24px;padding:18px 16px;box-shadow:0 10px 40px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03)}
  .stat b{display:block;font-size:40px;line-height:1.1;margin-top:6px}
  .row{display:flex;gap:var(--gap);flex-wrap:wrap;justify-content:center;margin:16px 0}
  .btn{background:var(--panel);border:1px solid rgba(255,255,255,.06);padding:18px 22px;border-radius:22px;
       font-weight:800;letter-spacing:.2px;box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 10px 30px rgba(0,0,0,.25);cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--glow1),var(--glow3));color:#0b0b0f;border:none}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .meter{height:12px;border-radius:10px;background:#1a1c22;position:relative;overflow:hidden;margin:8px 0 4px}
  .bar{position:absolute;left:0;top:0;bottom:0;width:0%;
       background:linear-gradient(90deg,var(--glow1),var(--glow2),var(--glow3));filter:saturate(115%)}
  .status{display:flex;justify-content:space-between;color:var(--muted);font-weight:800}
  .cards{display:grid;grid-template-columns:1fr;gap:20px;margin-top:18px}
  .card{background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border-radius:26px;
        border:1px solid rgba(255,255,255,.06);overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .card .top{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;font-weight:900}
  .card img,.card video{width:100%;display:block;background:#0c0d10;max-height:70vh;object-fit:contain}
  .actions{display:flex;gap:12px;padding:14px;justify-content:center}
  .pill{padding:12px 16px;border-radius:14px;background:var(--pill);color:#dfe5f0;font-weight:800}
  .like{background:linear-gradient(135deg,#4bd1c5,#7ee8d4)}
  .nope{background:linear-gradient(135deg,#ff6b7a,#ff9cab)}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:18px}
  .sheet{max-width:760px;width:100%;background:var(--panel);border:1px solid rgba(255,255,255,.06);
         border-radius:28px;box-shadow:0 30px 120px rgba(0,0,0,.6)}
  .hd{display:flex;justify-content:space-between;align-items:center;padding:16px 18px}
  pre{margin:0;padding:0 18px 18px 18px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, monospace}
  a.link{color:#b9d8ff;text-decoration:none}
</style>
</head>
<body>
<div class="wrap">

  <div class="grid">
    <div class="stat"><span>BUILD</span><b id="build">v2.8.2</b></div>
    <div class="stat"><span>SHOWN</span><b id="shown">0</b></div>
    <div class="stat"><span>POOL</span><b id="pool">0</b></div>
    <div class="stat"><span>TOTAL</span><b id="total">0</b></div>
  </div>

  <div class="meter"><div class="bar" id="bar"></div></div>
  <div class="status"><div id="phase">Idle</div><div id="pct">100%</div></div>

  <div class="row" id="dash">
    <button class="btn" id="homeBtn">Home</button>
    <button class="btn" id="likesBtn">⭐ Likes <span id="likeCount">0</span></button>
    <button class="btn primary" id="batchBtn">New batch</button>
    <button class="btn" id="shuffleBtn">Shuffle feed</button>
    <button class="btn" id="loadMoreBtn">Load more</button>
    <button class="btn" id="authBtn">Connect Reddit</button>
    <button class="btn" id="troubleBtn">Troubleshoot</button>
  </div>

  <section id="cards" class="cards"></section>

  <!-- Troubleshoot -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="hd">
        <div class="btn">Troubleshoot</div>
        <button class="btn primary" id="closeModal">Close</button>
      </div>
      <pre id="log"></pre>
    </div>
  </div>
</div>

<script>
/* =========== CONFIG (FILL THESE 2) ============ */
const CLIENT_ID    = "-ZjCpRiT6UPJVawJqRU_9g";
const REDIRECT_URI = "https://charlessmainville-a11y.github.io/Budget-App-2/"; // e.g. https://yourname.github.io/YourRepo/
/* ============================================== */

/* —— app state —— */
const state = {
  token:null, tokenExp:0, scope:"read", subreddits:[
    "Celebs","BeautifulCelebrities","celebrityhotties","celebritylegs","celebrity_arms",
    "LadiesOfWrestling","TheCelebArchive","risingcelebs","victoriassecret","celebfashion"
  ],
  pool:[], shown:0, total:0, likes: JSON.parse(localStorage.getItem("cw_likes")||"[]"),
  mode:"home" // 'home' | 'likes'
};
document.getElementById("likeCount").textContent = state.likes.length;

/* —— helpers —— */
const log = (m)=>{ const p=document.getElementById('log'); const t=`[${new Date().toLocaleTimeString()}] ${m}\n`; p.textContent=t+p.textContent; };
const setBar = (pct, phaseText)=>{ document.getElementById('bar').style.width=pct+"%"; if(phaseText) document.getElementById('phase').textContent=phaseText; document.getElementById('pct').textContent = Math.round(pct)+"%"; };
const setStats = ()=>{ document.getElementById('shown').textContent=state.shown; document.getElementById('pool').textContent=state.pool.length; document.getElementById('total').textContent=state.total; };

function randStr(n=28){ const a='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~'; let s=''; for(let i=0;i<n;i++) s+=a[Math.floor(Math.random()*a.length)]; return s; }
async function sha256(s){ const b=new TextEncoder().encode(s); const d=await crypto.subtle.digest('SHA-256',b); return Array.from(new Uint8Array(d)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

/* —— OAuth (PKCE implicit, no secret) —— */
async function ensureAuth(interactive=true){
  if(state.token && Date.now()<state.tokenExp-60000) return state.token;

  const stored = JSON.parse(sessionStorage.getItem("cw_token")||"null");
  if(stored && stored.access_token && Date.now()<stored.exp) {
    state.token=stored.access_token; state.tokenExp=stored.exp; return state.token;
  }

  if(!interactive){ log("Auth required (silent)"); return null; }

  // Build PKCE auth URL
  const verifier = randStr(64);
  const challenge = await sha256(verifier);
  const authState = randStr(12);
  sessionStorage.setItem("cw_pkce", JSON.stringify({verifier, state:authState}));

  const url = new URL("https://www.reddit.com/api/v1/authorize");
  url.searchParams.set("client_id", CLIENT_ID);
  url.searchParams.set("response_type", "code");
  url.searchParams.set("state", authState);
  url.searchParams.set("redirect_uri", REDIRECT_URI);
  url.searchParams.set("duration", "temporary");
  url.searchParams.set("scope", state.scope);
  url.searchParams.set("code_challenge", challenge);
  url.searchParams.set("code_challenge_method", "S256");

  window.location.href = url.toString(); // full redirect flow
}

/* Handle redirect with ?code= */
(async function handleRedirect(){
  const qs = new URLSearchParams(location.search);
  if(qs.has("code") && qs.has("state")){
    setBar(15,"Exchanging token…");
    const pk = JSON.parse(sessionStorage.getItem("cw_pkce")||"null");
    if(!pk){ log("Missing PKCE in session"); return; }
    if(pk.state !== qs.get("state")){ log("State mismatch"); return; }

    const body = new URLSearchParams({
      grant_type:"authorization_code",
      code:qs.get("code"),
      redirect_uri:REDIRECT_URI,
      code_verifier:pk.verifier
    });

    // token endpoint supports CORS on oauth.reddit.com
    const r = await fetch("https://www.reddit.com/api/v1/access_token",{
      method:"POST",
      headers:{ "Authorization":"Basic "+btoa(CLIENT_ID+":"), "Content-Type":"application/x-www-form-urlencoded" },
      body
    }).then(r=>r.json()).catch(e=>({error:e+""}));

    if(r.error){ log("Token error: "+JSON.stringify(r)); setBar(100,"Error"); return; }
    const exp = Date.now() + (r.expires_in*1000);
    state.token = r.access_token; state.tokenExp = exp;
    sessionStorage.setItem("cw_token", JSON.stringify({access_token:r.access_token, exp}));
    // remove auth params from URL
    history.replaceState({}, "", REDIRECT_URI);
    log("Signed in ✅");
    setBar(100,"Ready");
  }
})();

/* —— API calls —— */
async function api(path){
  await ensureAuth(false);
  if(!state.token){ throw new Error("No token"); }
  const res = await fetch("https://oauth.reddit.com"+path, {
    headers:{ "Authorization":"Bearer "+state.token, "User-Agent":"celebwall/1.0 by you" }
  });
  if(!res.ok){ throw new Error("HTTP "+res.status); }
  return res.json();
}

async function pullFromSubreddit(sr, limit=25){
  try{
    const j = await api(`/r/${sr}/search?restrict_sr=1&sort=hot&t=week&limit=${limit}&q=url:jpg OR url:png OR url:gif`);
    const items = (j.data?.children||[]).map(p=>p.data).filter(d=>{
      return !d.over_18 && /(\.jpg|\.png|\.gif)$/i.test(d.url) && !d.is_self;
    }).map(d=>({
      id:d.id, title:d.title, author:d.author, url:d.url, sr:d.subreddit, permalink:"https://reddit.com"+d.permalink
    }));
    return items;
  }catch(e){
    log(`× /r/${sr}: ${e.message}`);
    return [];
  }
}

/* —— UI building —— */
function render(){
  const host = document.getElementById("cards"); host.innerHTML="";
  const list = state.mode==="likes" ? state.likes : state.pool;
  list.forEach(it=>{
    const card = document.createElement("article"); card.className="card";
    card.innerHTML = `
      <div class="top"><div>${it.title || it.name || "Untitled"}</div><div class="pill">r/${it.sr||"celebs"}</div></div>
      ${/\.gif$/i.test(it.url) ? `<img src="${it.url}" alt="${it.title||""}">`
                               : `<img src="${it.url}" alt="${it.title||""}">`}
      <div class="actions">
        <button class="btn nope" data-act="nope" data-id="${it.id}">Dismiss</button>
        <a class="btn pill" href="${it.permalink||'#'}" target="_blank" rel="noopener">Reddit</a>
        <button class="btn like" data-act="like" data-id="${it.id}">Like</button>
      </div>`;
    host.appendChild(card);
  });
  setStats();
}

function likeItem(id, save=true){
  const found = state.pool.find(x=>x.id===id) || state.likes.find(x=>x.id===id);
  if(!found) return;
  if(!state.likes.some(x=>x.id===id)) state.likes.unshift(found);
  if(save){ localStorage.setItem("cw_likes", JSON.stringify(state.likes)); document.getElementById("likeCount").textContent = state.likes.length; }
  // remove from pool view
  state.pool = state.pool.filter(x=>x.id!==id);
}

function dismissItem(id){
  state.pool = state.pool.filter(x=>x.id!==id);
}

/* —— batch/flow —— */
async function newBatch(){
  if(!state.token){ await ensureAuth(true); if(!state.token) return; }
  setBar(5,"Gathering…");
  state.pool.length = 0;
  state.shown = 0;
  const srs = [...state.subreddits];
  let fetched = [];
  for(let i=0;i<srs.length;i++){
    setBar(5 + (i/srs.length)*70, `r/${srs[i]}`);
    const items = await pullFromSubreddit(srs[i], 20);
    fetched = fetched.concat(items);
  }
  // de-dup by id/url
  const seen = new Set();
  state.pool = fetched.filter(it=>{
    const key = it.id || it.url;
    if(seen.has(key)) return false; seen.add(key); return true;
  });
  state.total = state.pool.length;
  setBar(90,"Building…");
  render();
  setBar(100,"Ready");
}

/* —— events —— */
document.getElementById("batchBtn").onclick = newBatch;
document.getElementById("loadMoreBtn").onclick = ()=>{ state.shown += Math.min(10,state.pool.length); render(); };
document.getElementById("shuffleBtn").onclick = ()=>{ state.pool.sort(()=>Math.random()-.5); render(); };
document.getElementById("homeBtn").onclick = ()=>{ state.mode="home"; render(); };
document.getElementById("likesBtn").onclick = ()=>{ state.mode="likes"; render(); };
document.getElementById("authBtn").onclick = ()=> ensureAuth(true);

document.getElementById("troubleBtn").onclick = ()=>{ document.getElementById("modal").style.display="flex"; };
document.getElementById("closeModal").onclick = ()=>{ document.getElementById("modal").style.display="none"; };

document.getElementById("cards").addEventListener("click", (e)=>{
  const btn = e.target.closest("button"); if(!btn) return;
  const id = btn.dataset.id;
  if(btn.dataset.act==="like"){ likeItem(id); }
  if(btn.dataset.act==="nope"){ dismissItem(id); }
  render();
});

/* Start */
setBar(100,"Ready");
setStats();
</script>
</body>
</html>