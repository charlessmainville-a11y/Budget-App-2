<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Celeb Wall ‚Äî OAuth build</title>
<style>
  :root{
    --bg:#0e0f11;
    --card:#17191d;
    --glass:rgba(255,255,255,.06);
    --glass-2:rgba(255,255,255,.08);
    --text:#e9edf3;
    --muted:#aeb6c5;
    --pill:#20242b;
    --ok:#3ee1c4;
    --bad:#ff5f6d;
    --accent1:#9F7AEA;
    --accent2:#6EE7F9;
    --shadow:0 10px 30px rgba(0,0,0,.45);
    --radius:22px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 600px at 50% -10%,#1a1e25 0%,#0e0f11 55%) no-repeat #0e0f11;
    color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
  }
  .wrap{max-width:920px;margin:0 auto;padding:20px 16px 120px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px}
  .tile{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
    border-radius:18px;padding:20px;box-shadow:var(--shadow);backdrop-filter:blur(10px);
  }
  .tile h3{margin:0 0 6px;font-size:14px;color:var(--muted);letter-spacing:.12em}
  .big{font-size:34px;font-weight:900;line-height:1.05}
  .dash{
    display:grid;gap:14px;margin:20px 0 16px;
    grid-template-columns:repeat(2,1fr);
  }
  .dash .btn{
    padding:18px 22px;border-radius:28px;border:1px solid rgba(255,255,255,.06);
    background:rgba(255,255,255,.04);backdrop-filter:blur(8px);box-shadow:var(--shadow);
    font-size:22px;font-weight:800;text-align:center;cursor:pointer;user-select:none;
  }
  .btn.primary{
    color:#0d1223;
    background:linear-gradient(135deg,var(--accent1),var(--accent2));
    border:none;
  }
  .btn.ghost{color:var(--text)}
  .btn.full{grid-column:1/-1}
  .btn:active{transform:translateY(1px)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .meter{
    height:12px;border-radius:999px;background:#20232a;overflow:hidden;margin:14px 0 8px;
    box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
  }
  .bar{height:100%;width:0;background:linear-gradient(90deg,#9F7AEA,#6EE7F9,#FF8EC0)}
  .meter-label{display:flex;justify-content:space-between;color:#c9d1e3;font-weight:800;margin-bottom:16px}

  /* cards */
  #cards{display:grid;gap:18px;margin-top:22px}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
    border-radius:24px;overflow:hidden;box-shadow:var(--shadow);
  }
  .card .top{
    position:absolute;inset:0 0 auto 0;height:68px;
    display:flex;align-items:flex-end;background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));
    padding:12px 14px;pointer-events:none
  }
  .name{
    pointer-events:auto;
    background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);
    padding:8px 12px;border-radius:14px;font-weight:800
  }
  .frame{position:relative;background:#0b0c0e}
  .frame img,.frame video{display:block;width:100%;height:auto;max-height:70vh;object-fit:cover;background:#0b0c0e}
  .card .foot{
    display:flex;gap:12px;padding:14px;background:rgba(0,0,0,.25)
  }
  .rect{
    flex:1;text-align:center;font-weight:900;padding:14px 16px;border-radius:14px;cursor:pointer;user-select:none
  }
  .rect.like{background:linear-gradient(135deg,#21d3b8,#6ee7f9);color:#041015}
  .rect.nope{background:linear-gradient(135deg,#ff5f6d,#ffc371);color:#190b0c}
  .pill{
    padding:10px 14px;border-radius:14px;background:rgba(255,255,255,.06);backdrop-filter:blur(8px);
    display:inline-flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.08)
  }
  .muted{color:var(--muted)}
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:16px}
  .sheet{
    width:min(860px,100%);max-height:85vh;overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
    padding:18px;border-radius:20px;box-shadow:var(--shadow);backdrop-filter:blur(10px)
  }
  pre{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;margin:0}
  .hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .tag{font-weight:900;background:rgba(255,255,255,.08);padding:10px 14px;border-radius:16px}
  .close{border:none;border-radius:16px;padding:10px 16px;font-weight:800;color:#0d1223;background:linear-gradient(135deg,var(--accent2),#ffb3e3)}
  a {color:#7dc1ff;text-decoration:none}
  @media (max-width:740px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .dash{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Stats tiles -->
    <div class="grid">
      <div class="tile"><h3>BUILD</h3><div class="big" id="build">v2.8.2-oauth</div></div>
      <div class="tile"><h3>SHOWN</h3><div class="big" id="shown">0</div></div>
      <div class="tile"><h3>POOL</h3><div class="big" id="pool">0</div></div>
      <div class="tile"><h3>TOTAL</h3><div class="big" id="total">0</div></div>
    </div>

    <!-- progress -->
    <div class="meter"><div id="bar" class="bar"></div></div>
    <div class="meter-label"><div id="phase">Ready</div><div id="pct">100%</div></div>

    <!-- source + status line -->
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div class="pill">source: <b id="source">r/celebs + more</b></div>
      <div class="pill muted">token: <b id="tokState">missing</b></div>
    </div>

    <!-- controls -->
    <div class="dash">
      <div class="btn ghost" id="btnHome">Home</div>
      <div class="btn ghost" id="btnLikes">‚≠ê Likes <span id="likeCount" class="pill" style="margin-left:10px;padding:6px 10px">0</span></div>

      <div class="btn primary" id="btnNew">New batch</div>
      <div class="btn ghost" id="btnShuffle">Shuffle feed</div>

      <div class="btn ghost" id="btnMore">Load more</div>
      <div class="btn ghost" id="btnConnect">Connect Reddit</div>

      <div class="btn full ghost" id="btnTrouble">Troubleshoot</div>
    </div>

    <!-- cards -->
    <section id="cards"></section>
  </div>

  <!-- Troubleshoot modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="hd">
        <div class="tag">Troubleshoot</div>
        <button class="close" id="closeModal">Close</button>
      </div>
      <pre id="log"></pre>
    </div>
  </div>

<script>
/* ========= CONFIG (baked in) ========= */
const CLIENT_ID   = "D_nzkiZhFVjFgNs_sqCQ3Q";
const REDIRECT_URI= "https://charlessmainville-a11y.github.io/Budget-App-2/";
const SCOPES      = "identity read"; // add 'history' later if needed
/* ===================================== */

const els = {
  bar: byId('bar'), pct: byId('pct'), phase: byId('phase'),
  shown: byId('shown'), pool: byId('pool'), total: byId('total'),
  source: byId('source'), cards: byId('cards'),
  likeCount: byId('likeCount'), tokState: byId('tokState'),
  modal: byId('modal'), log: byId('log')
};

const SUBREDDITS = [
  // üî• Influencers / TikTok / IG
  "charlidameliomommy",
  "LeaEluiGinet",
  "LeaEluiG_NR",

  // üé¨ Celebs
  "CelebEvents",
  "celebnsfw",
  "celebpics",
  "emrata",
  "kendalljenner",
  "bellahadid",
  "madisonbeer",
  "scarlettjohansson",
  "meganfox",
  "natalieportman",

  // üå∂Ô∏è Adult performers
  "Pornstars",
  "NSFWCelebs",
  "FayeReagan",
  "RileyReid",
  "Stoya"
];

const store = {
  get token(){ try{ return JSON.parse(localStorage.getItem('rw_token')||'null'); }catch(e){ return null } },
  set token(v){ localStorage.setItem('rw_token', JSON.stringify(v)); },
  likes: JSON.parse(localStorage.getItem('rw_likes')||'[]'),
  hides: JSON.parse(localStorage.getItem('rw_hides')||'[]'),
  saveLikes(){ localStorage.setItem('rw_likes', JSON.stringify(this.likes)); },
  saveHides(){ localStorage.setItem('rw_hides', JSON.stringify(this.hides)); }
};

let pool = [];           // not-yet-shown
let shown = 0;           // shown count
let total = 0;           // ever-fetched
let currentMode = 'home' // 'home' or 'likes'

/* ===== Helpers ===== */
function byId(id){ return document.getElementById(id); }
function log(line){
  const t = new Date().toLocaleTimeString();
  els.log.textContent = `[${t}] ${line}\n` + els.log.textContent;
}
function setProgress(p,label){
  els.bar.style.width = `${Math.max(0,Math.min(100,p))}%`;
  els.pct.textContent = `${Math.round(p)}%`;
  if(label) els.phase.textContent = label;
}
function setCounters(){
  els.shown.textContent = String(shown);
  els.pool.textContent  = String(pool.length);
  els.total.textContent = String(total);
  els.likeCount.textContent = String(store.likes.length);
  els.tokState.textContent = store.token && !isExpired(store.token) ? "stored" : "missing";
}
function isExpired(tok){
  return !tok || (Date.now() >= tok.obtained_at + (tok.expires_in-30)*1000);
}
function ensureTokenOrConnect(){
  if(!store.token || isExpired(store.token)){
    connectReddit();
    return false;
  }
  return true;
}
function oauthHeaders(){
  return { "Authorization": `Bearer ${store.token.access_token}` };
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr;
}

/* ===== OAuth (Implicit) ===== */
function connectReddit(){
  const state = Math.random().toString(36).slice(2);
  localStorage.setItem('rw_state', state);
  const authUrl = `https://www.reddit.com/api/v1/authorize.compact?client_id=${encodeURIComponent(CLIENT_ID)}&response_type=token&state=${encodeURIComponent(state)}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&duration=temporary&scope=${encodeURIComponent(SCOPES)}`;
  window.location.href = authUrl;
}
function captureTokenFromHash(){
  if(!location.hash) return;
  const params = new URLSearchParams(location.hash.slice(1));
  const access_token = params.get('access_token');
  const token_type = params.get('token_type');
  const expires_in = Number(params.get('expires_in')||'3600');
  const state = params.get('state');
  if(access_token){
    const expect = localStorage.getItem('rw_state');
    if(expect && state !== expect){ log("State mismatch (ignored)"); }
    store.token = { access_token, token_type, expires_in, obtained_at: Date.now() };
    history.replaceState({}, document.title, REDIRECT_URI); // clean the hash
    log("Token stored");
  }
}

/* ===== Fetching from Reddit (OAuth API) ===== */
async function fetchSub(sub, after=null, limit=25){
  const url = new URL(`https://oauth.reddit.com/r/${sub}/hot`);
  url.searchParams.set('limit', String(limit));
  if(after) url.searchParams.set('after', after);
  const res = await fetch(url, { headers: oauthHeaders() });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  return json.data;
}
function extractMedia(post){
  // Only accept images/gifs/hosted videos with previews
  const d = post.data;
  const title = d.title || "";
  const author = d.author || "";
  const name = d.name; // fullname
  let url = null;
  let type = "img";

  // Try gallery
  if(d.is_gallery && d.media_metadata){
    const first = Object.values(d.media_metadata)[0];
    if(first && first.s && first.s.u){
      url = first.s.u.replace(/&amp;/g,'&');
    }
  }
  // Try preview images
  if(!url && d.preview && d.preview.images && d.preview.images[0]){
    url = (d.preview.images[0].source || {}).url || null;
    if(url) url = url.replace(/&amp;/g,'&');
  }
  // Direct url fallback (jpg/png/gif)
  if(!url && d.url_overridden_by_dest){
    const u = d.url_overridden_by_dest;
    if(/\.(jpg|jpeg|png|gif|webp)$/i.test(u)) url = u;
  }
  // Hosted video mp4
  if(!url && d.secure_media && d.secure_media.reddit_video){
    url = d.secure_media.reddit_video.fallback_url;
    type = "video";
  }

  if(!url) return null;
  return {
    id: name,
    title,
    author,
    sub: d.subreddit,
    url,
    type
  };
}

async function buildBatch() {
  if(!ensureTokenOrConnect()) return;
  log(`Building new batch‚Ä¶ (${SUBS.join(', ')})`);
  setProgress(5, "Requesting");
  let gathered = [];
  for(let i=0;i<SUBS.length;i++){
    const s = SUBS[i];
    try{
      els.source.textContent = `r/${s}`;
      setProgress(5 + (i*80/SUBS.length), `Fetching r/${s}`);
      const data = await fetchSub(s,null,30);
      const posts = data.children || [];
      for(const p of posts){
        const m = extractMedia(p);
        if(!m) continue;
        // skip hidden
        if(store.hides.includes(m.id)) continue;
        // avoid duplicates
        if(gathered.find(x=>x.id===m.id)) continue;
        gathered.push(m);
      }
      log(`Loaded ${gathered.length} so far (r/${s})`);
    }catch(err){
      log(`√ó r/${s}: ${err.message||err}`);
    }
  }
  // merge into pool
  const before = pool.length;
  for(const item of gathered){ if(!pool.find(x=>x.id===item.id)) pool.push(item); }
  pool = shuffle(pool);
  total += (pool.length - before);
  setCounters();
  setProgress(100, "Ready");
  if(before===0) { // first load ‚Äì show some
    loadMore();
  }
}

/* ===== Rendering ===== */
function mk(el, attrs={}, ...kids){
  const n = document.createElement(el);
  for(const [k,v] of Object.entries(attrs)) {
    if(k==='class') n.className = v;
    else if(k==='style') n.style.cssText = v;
    else n.setAttribute(k,v);
  }
  for(const c of kids){
    if(typeof c==='string') n.appendChild(document.createTextNode(c));
    else if(c) n.appendChild(c);
  }
  return n;
}
function renderCard(item){
  const media = item.type==='video'
    ? mk('video', {controls:'', playsinline:'', muted:'', loop:''}, mk('source',{src:item.url,type:'video/mp4'}))
    : mk('img', {src:item.url, alt:item.title||item.author||''});

  const top = mk('div',{class:'top'}, mk('div',{class:'name'}, `${item.author ? item.author+' ‚Ä¢ ' : ''}r/${item.sub}`));
  const frame = mk('div',{class:'frame'}, top, media);

  const like = mk('div',{class:'rect like', role:'button'}, 'Like');
  const nope = mk('div',{class:'rect nope', role:'button'}, 'Dismiss');
  like.onclick = ()=>{
    if(!store.likes.find(x=>x.id===item.id)) { store.likes.unshift(item); store.saveLikes(); setCounters(); }
    removeCard(card, item.id, true);
  };
  nope.onclick = ()=>{
    if(!store.hides.includes(item.id)){ store.hides.push(item.id); store.saveHides(); }
    removeCard(card, item.id, false);
  };

  const foot = mk('div',{class:'foot'}, nope, like);
  const card = mk('article',{class:'card', 'data-id':item.id}, frame, foot);
  return card;
}
function removeCard(card, id, liked){
  card.remove();
  shown++; setCounters();
  // also pop from pool copy if present
  const idx = pool.findIndex(x=>x.id===id);
  if(idx>-1) pool.splice(idx,1);
  // top-up
  if(document.querySelectorAll('.card').length < 3) loadMore();
}

function loadMore(count=5){
  if(currentMode==='likes'){
    // paginate likes
    const existing = [...document.querySelectorAll('.card')].map(c=>c.getAttribute('data-id'));
    const next = store.likes.filter(x=>!existing.includes(x.id)).slice(0,count);
    if(next.length===0){ log("No more liked items."); return; }
    next.forEach(item=> els.cards.appendChild(renderCard(item)));
    return;
  }

  const items = pool.splice(0, count);
  if(items.length===0){ log("No more in pool."); return; }
  items.forEach(item=> els.cards.appendChild(renderCard(item)));
  setCounters();
}

function shuffleFeed(){
  // shuffle visible cards + leftover pool
  const cards = Array.from(document.querySelectorAll('.card'));
  const visible = cards.map(c=>{
    const id = c.getAttribute('data-id');
    const itm = { id };
    return { node:c, id };
  });
  // recompose combined array from visible + pool
  const allIds = visible.map(v=>v.id).concat(pool.map(p=>p.id));
  // We only shuffle pool for simplicity (visible stays as-is, new order will show on next loads)
  pool = shuffle(pool);
  log("Shuffled feed.");
}

/* ===== Actions ===== */
byId('btnConnect').onclick = ()=> connectReddit();
byId('btnNew').onclick      = ()=>{ els.cards.innerHTML=''; shown=0; setCounters(); buildBatch(); }
byId('btnMore').onclick     = ()=> loadMore();
byId('btnShuffle').onclick  = ()=> shuffleFeed();
byId('btnHome').onclick     = ()=>{
  currentMode='home'; els.cards.innerHTML=''; shown=0; setCounters(); loadMore(8);
};
byId('btnLikes').onclick    = ()=>{
  currentMode='likes'; els.cards.innerHTML=''; shown=0; setCounters(); loadMore(12);
};
byId('btnTrouble').onclick  = ()=> els.modal.style.display='flex';
byId('closeModal').onclick  = ()=> els.modal.style.display='none';

/* ===== Boot ===== */
captureTokenFromHash();
setCounters();
setProgress(100,"Ready");

// auto-kick a batch if token already present
if(store.token && !isExpired(store.token)){
  buildBatch();
} else {
  log("No token yet. Tap ‚ÄúConnect Reddit‚Äù.");
}
</script>
</body>
</html>