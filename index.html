<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CelebWall v2.0-stable</title>
<style>
  :root{
    --bg:#0d0f12;--panel:#12151a;--glass:#171b21;--muted:#9aa3ad;--txt:#eaf0f6;
    --pill:#1f2530;--ok1:#1dd3b0;--ok2:#009ad6;--no1:#ff597a;--no2:#ff9068;
    --shine:linear-gradient(135deg,#ffffff25 0%,#ffffff05 60%,transparent 100%);
    --btn-ok:linear-gradient(135deg,var(--ok2),var(--ok1));
    --btn-no:linear-gradient(135deg,var(--no2),var(--no1));
    --bar:linear-gradient(90deg,#a0d9ff 0%,#c8b6ff 50%,#ffb3c7 100%);
    --card:linear-gradient(180deg,#141922, #0f131a);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1000px 600px at 50% -200px,#151b23 0%,#0d0f12 40%,#0d0f12 100%);color:var(--txt);font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  a{color:inherit}
  .wrap{max-width:880px;margin:0 auto;padding:18px 14px 64px}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px}
  .stat{background:linear-gradient(180deg,#151a22,#0e1218);border-radius:18px;padding:16px 14px;box-shadow:inset 0 1px 0 #ffffff0f,0 10px 28px #00000050}
  .stat h5{margin:0 0 4px;color:#aeb6c2;letter-spacing:.15em;font:700 12px/1.2 Inter,system-ui;text-transform:uppercase}
  .stat b{display:block;font:800 36px/1 Inter,system-ui}
  @media (max-width:720px){.grid{grid-template-columns:repeat(2,1fr)} .stat b{font-size:28px}}
  .bar{height:14px;border-radius:99px;background:#ffffff10;position:relative;overflow:hidden;margin:14px 4px}
  .bar>.fill{position:absolute;inset:0 auto 0 0;width:0%;background:var(--bar)}
  .status{display:flex;justify-content:space-between;color:#b8c0cc;margin:6px 4px 14px;font-weight:700}
  .dash{display:flex;flex-wrap:wrap;gap:14px;justify-content:center;margin:8px 0 12px}
  .btn{
    position:relative;border:none;border-radius:22px;padding:18px 22px;
    color:#edf3fb;font:800 20px/1 Inter,system-ui;letter-spacing:.02em;
    background:linear-gradient(180deg,#151b22,#0e131a);
    box-shadow:inset 0 1px 0 #ffffff14,0 18px 30px #00000045;cursor:pointer;
    transform:translateZ(0);transition:transform .08s ease,opacity .2s ease;
  }
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn.ok{background:var(--btn-ok)}
  .btn.no{background:var(--btn-no)}
  .btn.glassy:before{
    content:"";position:absolute;inset:0;border-radius:inherit;background:var(--shine);mix-blend-mode:screen;pointer-events:none
  }
  .btn.small{padding:14px 18px;font-size:18px;border-radius:18px}
  .btn.tiny{padding:10px 14px;font-size:14px;border-radius:14px}
  .btn.hollow{background:#12161e;border:1px solid #ffffff12;color:#dfe6ef}
  .pill{background:#12161e;border:1px solid #ffffff14;border-radius:18px;padding:10px 14px;color:#cbd4df}
  .note{color:#aeb6c2}
  /* card */
  .feed{display:grid;gap:18px}
  .card{
    background:var(--card);border-radius:22px;overflow:hidden;box-shadow:0 22px 40px #00000070,inset 0 1px 0 #ffffff12;
    position:relative;isolation:isolate
  }
  .polaroid{position:absolute;left:14px;top:14px;right:14px;z-index:2;
    padding:10px 12px;border-radius:14px;background:linear-gradient(180deg,#0a0e14cc,#0a0e14aa);
    backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
    color:#f3f7ff;font:800 22px/1.15 Inter,system-ui;text-shadow:0 2px 12px #000c;
  }
  .polaroid small{display:block;color:#c9d1dd;font:700 14px/1.1 Inter,system-ui;opacity:.9;margin-top:6px}
  .media{display:block;width:100%;height:auto;max-height:86vh;object-fit:cover;background:#0b0f15}
  video.media{max-height:86vh;background:#0b0f15}
  .actions{display:flex;gap:16px;justify-content:space-between;padding:18px;background:linear-gradient(180deg,transparent 0%,#0e1218 20%)}
  .actions .btn{flex:1;border-radius:20px}
  /* pages */
  .tabs{display:flex;gap:10px;justify-content:center;margin:10px 0 6px}
  .hidden{display:none!important}
  /* animations */
  .burst{animation:burst .45s ease forwards}
  @keyframes burst{0%{transform:scale(1)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
  .fade{animation:fade .28s ease forwards}
  @keyframes fade{to{opacity:0;transform:translateY(10px)}}
  /* modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:#0009;z-index:50}
  .modal.show{display:grid}
  .sheet{width:min(840px,92vw);max-height:80vh;overflow:auto;background:#0f141a;border-radius:22px;box-shadow:0 24px 60px #000; padding:18px}
  .log{white-space:pre-wrap;font:600 16px/1.35 ui-monospace,Menlo,Consolas,monospace;color:#d7e3f5}
</style>
</head>
<body>
<div class="wrap">
  <!-- Stats -->
  <div class="grid">
    <div class="stat"><h5>Build</h5><b id="build">v2.0-stable</b></div>
    <div class="stat"><h5>Shown</h5><b id="shown">0</b></div>
    <div class="stat"><h5>Pool</h5><b id="pool">0</b></div>
    <div class="stat"><h5>Total</h5><b id="total">0</b></div>
  </div>

  <div class="bar"><div class="fill" id="bar"></div></div>
  <div class="status"><div id="phase">Ready</div><div id="pct">100%</div></div>

  <!-- Dashboard -->
  <div class="dash">
    <button class="btn small hollow" id="homeBtn">Home</button>
    <button class="btn small hollow" id="likesBtn">Likes</button>
    <button class="btn small hollow" id="discardBtn">Discard</button>
  </div>
  <div class="dash">
    <button class="btn glassy" id="newBatchBtn">New batch</button>
    <button class="btn small hollow" id="shuffleBtn">Shuffle feed</button>
    <button class="btn small hollow" id="loadMoreBtn">Load more</button>
  </div>
  <div class="dash">
    <button class="btn small hollow" id="addSubsBtn">+ Subreddits</button>
    <button class="btn small hollow" id="troubleBtn">Troubleshoot</button>
  </div>

  <!-- Tabs -->
  <div class="tabs hidden" id="pageTabs">
    <span class="pill" id="tabHome">Home</span>
    <span class="pill" id="tabLikes">Likes</span>
    <span class="pill" id="tabDiscard">Discard</span>
  </div>

  <!-- Feeds -->
  <div id="home" class="feed"></div>
  <div id="likes" class="feed hidden"></div>
  <div id="discard" class="feed hidden"></div>
</div>

<!-- Troubleshooter -->
<div class="modal" id="modal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
      <h2 style="margin:0">Troubleshoot</h2>
      <button class="btn tiny hollow" id="closeModal">Close</button>
    </div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
/* -------------------- config -------------------- */
const STARTER_SUBS = [
  // core “works everywhere”
  'Celebs','CelebEvents','celebritypics',
  // charli / lea elui fan subs you liked
  'charlidameliomommy','LeaEluiGinet',
  // a few safe NSFW celeb-ish hubs (can trim later)
  'CelebNSFW','celebnipslips','CelebGowns'
];
// optional performer subs (skip quietly if 404/banned)
const OPTIONAL_NSFW = ['EvaElfie','RileyReid','Stoya','AbellaDanger','MiaMalkova'];

// how many to fetch per subreddit
const LIMIT = 30;
// how many cards to append on “Load more” or scroll-batch
const CHUNK = 10;

/* ------------- state ------------- */
let pool = [];          // all parsed items (objects)
let shown = 0;          // count shown on Home
let likes = [];         // liked items
let discards = [];      // dismissed items
let currentFeed = 'home';
let fetching = false;
const logEl = document.getElementById('log');

/* ------------- helpers ------------- */
const el = (sel) => document.querySelector(sel);
const els = (sel) => [...document.querySelectorAll(sel)];
const log = (msg) => { const t=new Date().toLocaleTimeString(); logEl.textContent += `[${t}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; };

const ui = {
  phase(s){ el('#phase').textContent = s; },
  bar(p){ el('#bar').style.width = `${p}%`; el('#pct').textContent = `${Math.round(p)}%`; },
  counts(){
    el('#shown').textContent = String(shown);
    el('#pool').textContent  = String(pool.length);
    el('#total').textContent = String(likes.length + discards.length + shown);
  },
  showPage(name){
    currentFeed = name;
    ['home','likes','discard'].forEach(id => el('#'+id).classList.toggle('hidden', id!==name));
    el('#pageTabs').classList.remove('hidden');
  }
};

/* ------------- OAuth (optional) ------------- */
/* If you connected Reddit earlier, we reuse your token from localStorage.
   Otherwise we’ll fall back to a CORS helper for public JSON. */
function getToken(){ try{ const t = JSON.parse(localStorage.getItem('reddit_token')||'null'); if(!t) return null; if(Date.now()>t.expires_at) return null; return t.access_token; }catch{ return null; }}

/* ------------- fetchers ------------- */
const CORS = 'https://cors.isomorphic-git.org/';
function subUrl(sub){
  const token = getToken();
  const base = `https://www.reddit.com/r/${sub}/hot.json?limit=${LIMIT}&raw_json=1`;
  if(token){ return { url:`https://oauth.reddit.com/r/${sub}/hot?limit=${LIMIT}`, headers:{'Authorization':`Bearer ${token}`}}; }
  return { url:CORS+base, headers:{} };
}

async function pullSubreddit(sub){
  try{
    const {url,headers} = subUrl(sub);
    const res = await fetch(url,{headers});
    if(!res.ok){ log(`✖ /r/${sub}: HTTP ${res.status}`); return []; }
    const data = await res.json();
    const items = (data.data?.children||[]).map(n=>normalize(n.data)).filter(Boolean);
    log(`Loaded ${items.length} from /r/${sub}`);
    return items;
  }catch(e){
    log(`✖ /r/${sub}: ${e}`);
    return [];
  }
}

/* Normalize a reddit post into a {mediaType,url,thumb,title,author,sub,permalink} */
function normalize(d){
  // prefer reddit video
  const rv = d.secure_media?.reddit_video || d.media?.reddit_video;
  if(rv?.fallback_url){
    return {
      t:'video', url:rv.fallback_url, thumb:d.thumbnail&&d.thumbnail.startsWith('http')?d.thumbnail:null,
      title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}`
    };
  }
  // gif / gfycat / redgifs already transcoded on reddit as .gif or .mp4 in preview
  const preview = d.preview?.images?.[0]?.variants;
  if(preview?.mp4?.source?.url){
    return { t:'video', url:fix(preview.mp4.source.url), thumb:fix(d.preview.images[0].source.url),
      title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
  }
  if(preview?.gif?.source?.url){
    return { t:'gif', url:fix(preview.gif.source.url), thumb:fix(d.preview.images[0].source.url),
      title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
  }
  // gallery
  if(d.is_gallery && d.gallery_data?.items){
    const firstId = d.gallery_data.items[0]?.media_id;
    const meta = d.media_metadata?.[firstId];
    const src = bestMeta(meta);
    if(src){
      return { t:'image', url:src, thumb:src, title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
    }
  }
  // single image
  const img = d.url_overridden_by_dest || d.url;
  if(img && /\.(jpg|jpeg|png|webp)$/i.test(img)){
    return { t:'image', url:img, thumb:img, title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
  }
  return null;
}
function bestMeta(meta){
  if(!meta) return null;
  const s = meta.s; if(!s) return null;
  return fix(s.u || s.gif || s.mp4 || null);
}
function fix(u){ return u ? u.replace(/&amp;/g,'&') : u; }

/* ------------- rendering ------------- */
function card(item){
  const wrap = document.createElement('article');
  wrap.className = 'card';

  const head = document.createElement('div');
  head.className = 'polaroid';
  head.innerHTML = `<div>u/${item.author}</div><small>r/${item.sub}</small>`;
  wrap.appendChild(head);

  let media;
  if(item.t==='video'){
    media = document.createElement('video');
    media.className='media'; media.controls=true; media.playsInline=true; media.muted=false; media.preload='metadata';
    media.src=item.url;
  }else if(item.t==='gif'){
    media = document.createElement('video'); // smoother playback than <img gif>
    media.className='media'; media.autoplay=true; media.loop=true; media.muted=true; media.playsInline=true;
    media.src=item.url;
  }else{
    media = document.createElement('img');
    media.className='media'; media.loading='lazy'; media.alt=item.title||''; media.src=item.url;
  }
  wrap.appendChild(media);

  const actions = document.createElement('div');
  actions.className='actions';
  actions.innerHTML = `
    <button class="btn no glassy" data-act="no">Dismiss</button>
    <button class="btn ok glassy" data-act="ok">Like</button>
  `;
  actions.addEventListener('click', (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    if(b.dataset.act==='ok'){
      likes.push(item);
      wrap.classList.add('burst');
    }else{
      discards.push(item);
      wrap.classList.add('fade');
    }
    setTimeout(()=>wrap.remove(), 260);
    shown++; ui.counts();
  });
  wrap.appendChild(actions);
  return wrap;
}

function renderChunk(where, n=CHUNK){
  const feed = el('#'+where);
  const slice = pool.splice(0,n);
  slice.forEach(it => feed.appendChild(card(it)));
  ui.counts();
}

/* ------------- batching ------------- */
async function newBatch(){
  if(fetching) return;
  fetching = true; ui.phase('Fetching…'); ui.bar(10);
  pool.length = 0;
  el('#home').innerHTML = ''; shown = 0; ui.counts();

  const subs = [...STARTER_SUBS, ...OPTIONAL_NSFW];
  let done = 0;
  for(const s of subs){
    const items = await pullSubreddit(s);
    pool.push(...items);
    done++;
    ui.bar(10 + (done/subs.length)*80);
  }

  // unique by URL and shuffle
  pool = dedupeBy(pool, x=>x.url);
  shuffle(pool);

  ui.bar(100); ui.phase('Ready'); ui.counts();
  renderChunk('home', Math.min(CHUNK, pool.length));
  fetching = false;
}

function dedupeBy(arr, fn){
  const seen = new Set(); const out=[];
  for(const x of arr){ const k = fn(x); if(seen.has(k)) continue; seen.add(k); out.push(x); }
  return out;
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }

/* ------------- events ------------- */
el('#newBatchBtn').addEventListener('click', newBatch);
el('#shuffleBtn').addEventListener('click', ()=>{ shuffle(pool); renderChunk('home', Math.min(CHUNK,pool.length)); });
el('#loadMoreBtn').addEventListener('click', ()=> renderChunk('home'));
el('#homeBtn').addEventListener('click', ()=> ui.showPage('home'));
el('#likesBtn').addEventListener('click', ()=>{ ui.showPage('likes'); paintList('likes', likes); });
el('#discardBtn').addEventListener('click', ()=>{ ui.showPage('discard'); paintList('discard', discards); });

el('#addSubsBtn').addEventListener('click', async ()=>{
  const s = prompt('Add subreddits (comma-separated, no /r/):', 'Celebs, CelebEvents, celebritypics');
  if(!s) return;
  const list = s.split(',').map(x=>x.trim()).filter(Boolean);
  STARTER_SUBS.splice(0, STARTER_SUBS.length, ...list); // replace baseline
  log(`Updated base subs: ${STARTER_SUBS.join(', ')}`);
  await newBatch();
});

el('#troubleBtn').addEventListener('click', ()=> el('#modal').classList.add('show'));
el('#closeModal').addEventListener('click', ()=> el('#modal').classList.remove('show'));

function paintList(where, arr){
  const host = el('#'+where);
  host.innerHTML = '';
  arr.forEach(it => host.appendChild(card(it)));
}

/* auto-load on scroll */
let ticking=false;
addEventListener('scroll', ()=>{
  if(ticking) return; ticking=true;
  requestAnimationFrame(()=>{
    ticking=false;
    if(currentFeed!=='home') return;
    const nearBottom = (window.innerHeight + window.scrollY) > (document.body.offsetHeight - 1600);
    if(nearBottom && pool.length) renderChunk('home');
  });
});

/* ------------- boot ------------- */
ui.counts(); ui.bar(100); ui.phase('Ready');
log('Ready. Tap “New batch” to fetch.');

/* optional: auto-fetch first batch */
newBatch();
</script>
</body>
</html>