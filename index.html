<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CelebWall v3.1</title>
<style>
  :root{
    --bg:#0a0f14;--panel:#10151c;--glass:rgba(255,255,255,.08);
    --stroke:rgba(255,255,255,.12);--fg:#e8eef6;
    --grad-like:linear-gradient(135deg,#00f5ff,#00c8d4 55%,#1aa6ff);
    --grad-nope:linear-gradient(135deg,#ff4d6d,#ff7a98 55%,#ff9aa5);
    --grad-sheen:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,0) 40%);
    --pill:999px;
  }
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 50% -10%,#18202a 0%,var(--bg) 55%,#06090c 100%);color:var(--fg);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:14px 12px 6px}
  h1{margin:0 0 6px;font-size:18px;font-weight:800;opacity:.85}
  .stats{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
  .stat{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid var(--stroke);border-radius:16px;padding:10px 14px;min-width:92px;text-align:center;box-shadow:inset 0 1px 0 rgba(255,255,255,.05)}
  .stat b{display:block;font-size:28px;letter-spacing:.5px}
  .bar-wrap{margin:10px auto 0;max-width:920px;padding:0 12px}
  .bar{height:8px;background:rgba(255,255,255,.06);border-radius:8px;overflow:hidden}
  .bar>i{display:block;height:100%;width:100%;background:linear-gradient(90deg,#9be2ff,#d5b2ff,#ffafc6);transform-origin:left;transform:scaleX(1)}
  .status-row{max-width:920px;margin:6px auto 0;padding:0 16px;display:flex;justify-content:space-between;opacity:.85;font-weight:800}
  .dash{max-width:980px;margin:12px auto;display:flex;flex-wrap:wrap;justify-content:center;gap:12px;padding:0 12px}
  .btn{position:relative;border:1px solid var(--stroke);background:var(--glass);backdrop-filter:blur(8px);color:var(--fg);padding:12px 16px;border-radius:var(--pill);font-weight:800;cursor:pointer;transition:transform .14s ease,opacity .2s}
  .btn:active{transform:translateY(1px) scale(.98)}
  .btn-like{background:var(--grad-like);color:#03151c;text-shadow:0 1px 0 rgba(255,255,255,.45);box-shadow:inset 0 1px 0 rgba(255,255,255,.45),0 10px 24px rgba(7,196,227,.25)}
  .btn-nope{background:var(--grad-nope);color:#2a060c;text-shadow:0 1px 0 rgba(255,255,255,.55);box-shadow:inset 0 1px 0 rgba(255,255,255,.45),0 10px 24px rgba(255,90,125,.25)}
  .btn-like:before,.btn-nope:before{content:"";position:absolute;inset:0;border-radius:inherit;background:var(--grad-sheen);opacity:.55}
  .grid{max-width:980px;margin:0 auto 56px;padding:0 12px}
  .card{max-width:640px;margin:18px auto;background:var(--panel);border-radius:18px;border:1px solid var(--stroke);overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.45)}
  .card-head{padding:12px 14px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));font-weight:900;letter-spacing:.4px}
  .media{display:block;width:100%;background:#000;max-height:82vh;object-fit:contain}
  .actions{display:flex;gap:14px;justify-content:space-between;padding:14px}
  .like-burst{animation:burst .4s ease-out}
  .fade-out{animation:fade .35s ease forwards}
  @keyframes burst{0%{transform:scale(1)}50%{transform:scale(1.16)}100%{transform:scale(1)}}
  @keyframes fade{to{opacity:0;transform:translateY(6px) scale(.97)}}
  .tab{display:none}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.07);border:1px solid var(--stroke);font-weight:800}
  .oauth{max-width:980px;margin:12px auto;padding:10px 12px;border-radius:16px;background:rgba(255,255,255,.04);border:1px solid var(--stroke)}
  .empty{opacity:.6;text-align:center;padding:24px 0;font-weight:700}
</style>
</head>
<body>
<header>
  <h1>CelebWall v3.1</h1>
  <div class="stats">
    <div class="stat">SHOWN<b id="shown">0</b></div>
    <div class="stat">POOL<b id="pool">0</b></div>
    <div class="stat">TOTAL<b id="total">0</b></div>
  </div>
  <div class="bar-wrap">
    <div class="bar"><i id="barFill" style="transform:scaleX(1)"></i></div>
  </div>
  <div class="status-row">
    <span id="phase">Ready</span>
    <span id="pct">100%</span>
  </div>
</header>

<div class="dash">
  <button class="btn" onclick="showTab('feed')">Home</button>
  <button class="btn" onclick="showTab('likesTab')">Likes</button>
  <button class="btn" onclick="showTab('disTab')">Discard</button>
  <button class="btn" onclick="newBatch()">New batch</button>
  <button class="btn" onclick="shuffleFeed()">Shuffle feed</button>
  <button class="btn" onclick="loadMore()">Load more</button>
  <button class="btn" onclick="addSubs()">+ Subreddits</button>
</div>

<div id="feed" class="grid"></div>
<div id="likesTab" class="grid tab"><div class="empty">No likes yet</div></div>
<div id="disTab" class="grid tab"><div class="empty">Nothing discarded</div></div>

<div class="oauth" id="oauthBox">
  <span class="pill">Reddit: <span id="oauthStatus">not connected</span></span>
  <button class="btn" onclick="connectReddit()">Connect Reddit</button>
  <button class="btn" onclick="clearToken()">Clear token</button>
</div>

<script>
/* ---------- Config ---------- */
const clientId = "D_nzkiZhFVjFgNs_sqCQ3Q";              // installed app id
const tokenLS  = "cw.token", expLS = "cw.exp";           // token storage
const pageSize = 10;

const subsDefault = [
  // SFW celeb pools
  "celebs","CelebEvents","charlidameliomommy","EmilyRatajkowski","CelebSelfies",
  "LeaEluiGinet","LeaEluiG_NR",
  // NSFW performer pools (about 20)
  "EvaElfie","RileyReid","Stoya","FayeReagan","KenzieReeves","MiaMalkova","AbellaDanger",
  "AdrianaChechik","LanaRhoades","NicoleAniston","VioletMyers","GabbieCarter","NatashaNice",
  "KelsiMonroe","KendraSunderland","LenaPaul","JessaRhodes","AidraFox","KeishaGrey","KimmyGranger"
];

let subs = [...subsDefault];
let pool = [], shown = 0, total = 0;
const ids = s => document.getElementById(s);

/* ---------- OAuth helpers ---------- */
function getToken(){
  const t = localStorage.getItem(tokenLS);
  const e = +localStorage.getItem(expLS) || 0;
  return (t && Date.now() < e) ? t : null;
}
function setToken(tok, secs){
  localStorage.setItem(tokenLS, tok);
  localStorage.setItem(expLS, (Date.now() + secs*1000)+'');
  refreshOAuth();
}
function clearToken(){ localStorage.removeItem(tokenLS); localStorage.removeItem(expLS); refreshOAuth(); }

function connectReddit(){
  const state = Math.random().toString(36).slice(2);
  sessionStorage.cw_state = state;
  const redirect = location.origin + location.pathname;
  const url = `https://www.reddit.com/api/v1/authorize?client_id=${clientId}`+
              `&response_type=token&state=${state}&redirect_uri=${encodeURIComponent(redirect)}`+
              `&duration=temporary&scope=read`;
  location.href = url;
}
// capture implicit token in hash
(function capture(){
  if(location.hash.includes("access_token=")){
    const p = new URLSearchParams(location.hash.slice(1));
    if(p.get("state") !== sessionStorage.cw_state){ alert("State mismatch"); history.replaceState({},'',location.pathname); return; }
    const tok = p.get("access_token"), exp = +(p.get("expires_in")||3600);
    setToken(tok, exp);
    history.replaceState({},'',location.pathname);
  }
})();
function refreshOAuth(){ ids("oauthStatus").textContent = getToken()? "connected" : "not connected"; }
refreshOAuth();

/* ---------- Fetch helpers ---------- */
function setPhase(text, frac=null){
  ids("phase").textContent = text;
  if(frac!=null){ ids("barFill").style.transform = `scaleX(${Math.max(0.05,Math.min(1,frac))})`; ids("pct").textContent = Math.round(frac*100)+"%"; }
}

async function fetchJSON(url, useOAuth){
  const opts = useOAuth && getToken() ? { headers:{ Authorization: `Bearer ${getToken()}`, "User-Agent":"celebwall/3.1 by you" } } : {};
  const r = await fetch(url, opts);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
function mediaFromPost(d){
  // pick best playable URL: reddit video, preview video, gif/mp4 direct, or image
  let url = null, isVideo = false;
  if(d.is_video && d.secure_media?.reddit_video?.fallback_url){
    url = d.secure_media.reddit_video.fallback_url; isVideo=true;
  }else if(d.preview?.reddit_video_preview?.fallback_url){
    url = d.preview.reddit_video_preview.fallback_url; isVideo=true;
  }else if(d.url_overridden_by_dest){
    url = d.url_overridden_by_dest;
    const low = url.toLowerCase();
    if(low.endsWith(".mp4") || low.endsWith(".webm")) isVideo=true;
    if(low.endsWith(".gifv")) { url = url.replace(/\.gifv$/i,".mp4"); isVideo=true; }
  }else if(d.url){ url = d.url; }
  if(!url) return null;
  // filter obvious non-media
  if(!/\.(jpg|jpeg|png|gif|mp4|webm)$/i.test(url) && !isVideo) return null;
  return {
    url, isVideo,
    author: d.author, subreddit: d.subreddit || d.subreddit_name_prefixed?.replace(/^r\//,'') || ''
  };
}

async function fetchSubreddit(s){
  const base = getToken() ? "https://oauth.reddit.com" : "https://www.reddit.com";
  const url  = `${base}/r/${s}/hot.json?limit=50&raw_json=1`;
  try{
    const j = await fetchJSON(url, true);
    const items = j.data.children.map(c => mediaFromPost(c.data)).filter(Boolean);
    return items;
  }catch(e){
    console.log("fail", s, e);
    return [];
  }
}

/* ---------- UI + feed ---------- */
function cardHTML(it){
  const top = `u/${it.author} • r/${it.subreddit}`;
  const media = it.isVideo
    ? `<video class="media" src="${it.url}" autoplay muted playsinline loop></video>`
    : `<img class="media" src="${it.url}" loading="lazy" alt="">`;
  return `<div class="card">
    <div class="card-head">${top}</div>
    ${media}
    <div class="actions">
      <button class="btn btn-nope" onclick="act(this,'discard')">Discard</button>
      <button class="btn btn-like" onclick="act(this,'like')">Like</button>
    </div>
  </div>`;
}

function act(btn, kind){
  const card = btn.closest(".card");
  if(kind==="like"){ card.classList.add("like-burst"); ids("likesTab").querySelector(".empty")?.remove(); ids("likesTab").insertAdjacentHTML("afterbegin", card.outerHTML); }
  else { card.classList.add("fade-out"); ids("disTab").querySelector(".empty")?.remove(); ids("disTab").insertAdjacentHTML("afterbegin", card.outerHTML); }
  setTimeout(()=>card.remove(), 320);
  shown++; ids("shown").textContent = shown;
}

function showTab(which){
  for(const id of ["feed","likesTab","disTab"]) ids(id).style.display = (id===which)?"block":"none";
}

async function newBatch(){
  setPhase("Building…", .15);
  ids("feed").innerHTML=""; ids("shown").textContent=shown=0; pool.length=0;
  let done=0;
  for(const s of subs){
    const items = await fetchSubreddit(s);
    pool.push(...items);
    done++;
    setPhase(`Loaded r/${s}`, .15 + .75*(done/subs.length));
  }
  total = pool.length; ids("total").textContent = total;
  shuffleFeed(); // randomize a bit
  setPhase("Ready", 1);
  loadMore();
}

function shuffleFeed(){ pool.sort(()=>Math.random()-.5); }
function loadMore(){
  if(pool.length===0){ return; }
  const chunk = pool.splice(0, pageSize);
  ids("pool").textContent = pool.length;
  ids("feed").insertAdjacentHTML("beforeend", chunk.map(cardHTML).join(""));
}

function addSubs(){
  const inp = prompt("Add/replace subreddits (comma separated):", subs.join(", "));
  if(!inp) return