<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Celeb Wall — v2.0-stable+scrollfix</title>
<style>
  :root{
    /* --- design tokens --- */
    --bg:#0b0f14;
    --card:#121821;
    --glass:rgba(255,255,255,.06);
    --ink:#e9eef7;
    --muted:#9fb0c6;
    --ok-grad: linear-gradient(135deg,#23c6ff 0%, #14e3d1 100%);
    --no-grad: linear-gradient(135deg,#ff6b88 0%, #ff9fb0 100%);
    --pill-grad: linear-gradient(135deg,#a68bff 0%, #ffa6d0 100%);
    --accent: #7fd1ff;
    --radius-xl: 22px;
    --radius-lg: 18px;
    --radius-md: 14px;
    --shadow-1: 0 10px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
    --shadow-2: inset 0 1px 0 rgba(255,255,255,.12), 0 6px 22px rgba(0,0,0,.38);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:radial-gradient(1200px 600px at 50% -200px, #11192a 0%, var(--bg) 60%);color:var(--ink);font:600 18px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
  .wrap{max-width:820px;margin:24px auto 80px;padding:0 18px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .stat{
    flex:1 1 160px;min-width:150px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(0,0,0,.25));
    border-radius:24px;padding:18px 18px 14px;box-shadow:var(--shadow-1)
  }
  .k{letter-spacing:.22em;color:#9fb0c6;font-weight:800;font-size:15px}
  .v{font-size:40px;font-weight:900;margin-top:8px}
  .bar-wrap{margin:18px 6px 4px}
  .bar{height:14px;border-radius:999px;background:rgba(255,255,255,.06);position:relative;overflow:hidden}
  .bar > i{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#a5c8ff,#71e6ff,#f8a5d3);border-radius:inherit;transition:width .25s ease}
  .bar-label{display:flex;justify-content:space-between;margin-top:8px;color:var(--muted)}
  /* glass buttons */
  .dash{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:18px 0 8px}
  .btn{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(0,0,0,.35));
    border-radius:999px;padding:16px 18px;text-align:center;box-shadow:var(--shadow-2);
    color:#e9eef7;text-decoration:none;user-select:none;touch-action:manipulation;border:1px solid rgba(255,255,255,.08)
  }
  .btn-pill{background:var(--pill-grad);color:#0a0a0a;font-weight:900;text-shadow:0 1px 0 rgba(255,255,255,.35)}
  .btn:active{transform:translateY(1px)}
  .btn-ghost{opacity:.7}
  .btn-ok{background:var(--ok-grad);color:#001b1b;font-weight:900;text-shadow:0 1px 0 rgba(255,255,255,.4)}
  .btn-no{background:var(--no-grad);color:#310006;font-weight:900;text-shadow:0 1px 0 rgba(255,255,255,.4)}
  /* cards */
  .feed{display:grid;gap:22px;margin-top:20px}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(0,0,0,.35));
    border-radius:28px;overflow:hidden;box-shadow:var(--shadow-1);position:relative
  }
  .hdr{
    position:absolute;left:16px;right:16px;top:14px;padding:10px 14px;border-radius:18px;
    background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.25));
    color:#fff;font-weight:900;font-size:22px;letter-spacing:.5px;text-shadow:0 2px 8px rgba(0,0,0,.55)
  }
  .hdr small{display:block;color:#d6e2ff;opacity:.9;margin-top:2px;font-size:15px;font-weight:700}
  .media{display:block;width:100%;height:auto;background:#0a0f16}
  video.media{max-height:82vh}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:18px;background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.45))}
  /* like/dislike FX */
  @keyframes burst{0%{transform:scale(1);opacity:1} 100%{transform:scale(1.25);opacity:0}}
  .burst{position:absolute;right:28px;bottom:96px;width:90px;height:90px;border-radius:50%;
         background:var(--ok-grad);filter:blur(1px);animation:burst .6s ease forwards;box-shadow:0 0 40px rgba(25,255,230,.45)}
  @keyframes fadeOut{to{opacity:0;transform:translateY(8px)}}
  .fade{animation:fadeOut .28s ease forwards}
  /* modal log */
  dialog{border:none;border-radius:24px;background:linear-gradient(180deg,rgba(20,24,32,.98),rgba(10,12,18,.98));color:#eaf2ff;max-width:740px;width:92%;padding:0;box-shadow:0 30px 80px rgba(0,0,0,.6)}
  .dlg-h{display:flex;justify-content:space-between;align-items:center;padding:22px}
  .dlg-body{max-height:55vh;overflow:auto;padding:0 22px 22px}
  pre{white-space:pre-wrap;font:600 15px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .chip{display:inline-block;padding:.2em .6em;border-radius:999px;background:rgba(255,255,255,.08);margin-right:.4em}
  .hidden{display:none!important}
  /* footer pad */
  .pad{height:120px}
</style>
</head>
<body>
<div class="wrap" id="app">

  <!-- stats -->
  <div class="row">
    <div class="stat"><div class="k">BUILD</div><div class="v" id="build">v2.0-stable+scrollfix</div></div>
    <div class="stat"><div class="k">SHOWN</div><div class="v" id="shown">0</div></div>
    <div class="stat"><div class="k">POOL</div><div class="v" id="pool">0</div></div>
    <div class="stat"><div class="k">TOTAL</div><div class="v" id="total">0</div></div>
  </div>

  <div class="bar-wrap">
    <div class="bar"><i id="prog"></i></div>
    <div class="bar-label"><span id="phase">Ready</span><span id="pct">100%</span></div>
  </div>

  <!-- dashboard -->
  <div class="dash">
    <a class="btn" id="btnHome">Home</a>
    <a class="btn" id="btnLikes">Likes</a>
    <a class="btn" id="btnTrash">Discard</a>

    <a class="btn btn-pill" id="btnNew">New batch</a>
    <a class="btn" id="btnShuffle">Shuffle feed</a>
    <a class="btn" id="btnMore">Load more</a>

    <a class="btn" id="btnSubs">+ Subreddits</a>
    <a class="btn btn-ghost" id="btnConnect">Connect Reddit</a>
    <a class="btn" id="btnLog">Troubleshoot</a>
  </div>

  <!-- feed -->
  <div class="feed" id="feed"></div>
  <div class="pad"></div>
</div>

<!-- log modal -->
<dialog id="logDlg">
  <div class="dlg-h">
    <div style="font-weight:900;font-size:24px">Troubleshoot</div>
    <button class="btn btn-pill" id="closeLog" style="padding:10px 16px">Close</button>
  </div>
  <div class="dlg-body">
    <pre id="log"></pre>
  </div>
</dialog>

<script>
/* =================== CONFIG (edit just this block) =================== */
const CONFIG = {
  version: 'v2.0-stable+scrollfix',
  batchSizePerSub: 30,
  autoload: true,
  autoloadThresholdPx: 1600,
  autoloadThrottleMs: 600,     // ← NEW: min gap between auto-loads
  maxAppendPerFrame: 4,        // ← NEW: limit cards appended per frame
  // default sources (you can add more at runtime with + Subreddits)
  subreddits: [
    'Celebs','celebs','CelebEvents','celeboutfits','emrata',
    'charlidameliomommy','LeaEluiGinet','LeaEluiG_NR','Goddessleaelui','Lea_bellybutton',
    'celebpicks','CelebrityArmpits','CelebrityBellyButtons'
  ],
  // OAuth — baked in so you don’t have to edit code elsewhere
  oauth: {
    client_id: 'D_nzkiZhFVjFgNs_sqCQ3Q', // your installed app client id
    redirect_uri: 'https://charlessmainville-a11y.github.io/Budget-App-2/', // your redirect
    scope: 'read',
    duration: 'temporary'
  }
};
/* ================= END CONFIG ================= */

const state = {
  feed: [],           // current working items
  pool: [],           // unshown queue
  shown: 0,
  likes: JSON.parse(localStorage.getItem('cw_likes')||'[]'),
  trash: JSON.parse(localStorage.getItem('cw_trash')||'[]'),
  token: null,
  tokenExp: 0,
  busy:false,
  loadLock:false,           // ← NEW: prevents overlapping loadMore
  lastAuto: 0,              // ← NEW: throttle timestamp
  io: null                  // ← NEW: IntersectionObserver for videos
};

const els = {
  build: byId('build'), shown:byId('shown'), pool:byId('pool'), total:byId('total'),
  phase:byId('phase'), pct:byId('pct'), prog:byId('prog'),
  feed:byId('feed'), log:byId('log'), logDlg:byId('logDlg'),
  btn:{home:byId('btnHome'), likes:byId('btnLikes'), trash:byId('btnTrash'),
       more:byId('btnMore'), newb:byId('btnNew'), shuffle:byId('btnShuffle'),
       subs:byId('btnSubs'), log:byId('btnLog'), closeLog:byId('closeLog'),
       connect:byId('btnConnect')}
};

boot();

/* =================== CORE =================== */
function boot(){
  els.build.textContent = CONFIG.version;
  restoreTokenFromHashOrStorage();
  wireUI();
  setupIO();
  uiReady();
}

function wireUI(){
  els.btn.newb.onclick = buildNewBatch;
  els.btn.more.onclick = () => loadMore();
  els.btn.shuffle.onclick = shuffleFeed;
  els.btn.home.onclick = () => renderHome();
  els.btn.likes.onclick = () => renderCollection('Likes', state.likes);
  els.btn.trash.onclick = () => renderCollection('Discard', state.trash);
  els.btn.subs.onclick = askSubreddits;
  els.btn.log.onclick = () => els.logDlg.showModal();
  els.btn.closeLog.onclick = () => els.logDlg.close();
  els.btn.connect.onclick = connectReddit;

  if(CONFIG.autoload){
    window.addEventListener('scroll', onScrollAutoLoad, {passive:true});
  }
}

function uiReady(){ phase('Ready',1); setCounts(); }

function phase(name, pct){ els.phase.textContent = name; setPct(pct); }
function setPct(p){ const v=Math.max(0,Math.min(1,p)); els.pct.textContent = Math.round(v*100)+'%'; els.prog.style.width = (v*100)+'%'; }
function setCounts(){ byId('pool').textContent = state.pool.length; byId('shown').textContent = state.shown; byId('total').textContent = state.feed.length; }

function log(msg){ const t=new Date().toLocaleTimeString(); els.log.textContent = `[${t}] ${msg}\n` + els.log.textContent; }

/* =================== OAUTH =================== */
function connectReddit(){
  const {client_id,redirect_uri,scope,duration} = CONFIG.oauth;
  const stateStr = Math.random().toString(36).slice(2);
  localStorage.setItem('cw_oauth_state', stateStr);
  const url = `https://www.reddit.com/api/v1/authorize`+
              `?client_id=${encodeURIComponent(client_id)}`+
              `&response_type=token&state=${encodeURIComponent(stateStr)}`+
              `&redirect_uri=${encodeURIComponent(redirect_uri)}`+
              `&duration=${duration}&scope=${encodeURIComponent(scope)}`;
  location.href = url;
}

function restoreTokenFromHashOrStorage(){
  // from hash
  if (location.hash.includes('access_token=')){
    const params = new URLSearchParams(location.hash.slice(1));
    const token = params.get('access_token');
    const exp = parseInt(params.get('expires_in')||'3600',10);
    const st = params.get('state');
    const expect = localStorage.getItem('cw_oauth_state');
    if (expect && st !== expect){ log('State mismatch (ignored token)'); history.replaceState(null,'',location.pathname); return; }
    state.token = token;
    state.tokenExp = Date.now() + (exp*1000 - 10000);
    localStorage.setItem('cw_token', token);
    localStorage.setItem('cw_token_exp', String(state.tokenExp));
    history.replaceState(null,'',location.pathname); // tidy url
    log('OAuth token stored');
  }else{
    // from storage
    const t = localStorage.getItem('cw_token');
    const e = parseInt(localStorage.getItem('cw_token_exp')||'0',10);
    if (t && Date.now()<e){ state.token=t; state.tokenExp=e; }
  }
  // reflect
  els.btn.connect.classList.toggle('btn-ghost', !!state.token);
  els.btn.connect.textContent = state.token ? 'Connected ✅' : 'Connect Reddit';
}

/* =================== DATA =================== */
async function buildNewBatch(){
  if (state.busy) return;
  state.busy = true;
  phase('Building…', .12);
  state.feed = [];
  state.pool = [];
  state.shown = 0;
  renderHome(true);
  setCounts();

  const subs = [...CONFIG.subreddits];
  for (let i=0; i<subs.length; i++){
    const s = subs[i];
    phase(`Pulling r/${s}`, (i+1)/subs.length * .8 + .12);
    try{
      const items = await fetchSubreddit(s, CONFIG.batchSizePerSub);
      log(`Loaded ${items.length} from r/${s}`);
      state.feed.push(...items);
      await sleep(30); // yield a bit between sub fetches
    }catch(err){
      log(`× r/${s}: ${err.message||err}`);
    }
  }
  // dedupe by permalink
  const seen = new Set(), unique=[];
  for(const it of state.feed){
    if (seen.has(it.permalink)) continue;
    seen.add(it.permalink); unique.push(it);
  }
  state.feed = unique;
  // create pool (unseen)
  state.pool = [...state.feed];
  shuffleArray(state.pool);
  setCounts();
  phase('Ready',1);
  state.busy=false;
  // first draw if empty
  if (!els.feed.children.length) loadMore();
}

async function fetchSubreddit(sub, limit=30){
  const headers = state.token ? {Authorization:`Bearer ${state.token}`, 'User-Agent':'celeb-wall/2.0 by a11y'} : {};
  const url = `https://oauth.reddit.com/r/${encodeURIComponent(sub)}/hot.json?limit=${Math.min(100,limit)}&raw_json=1`;
  if (!state.token){ log('No token — tap “Connect Reddit”'); throw new Error('Auth required'); }
  const r = await fetch(url,{headers});
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const j = await r.json();
  const out=[];
  for (const c of (j.data?.children||[])){
    const d=c.data;
    // media extraction
    let mediaUrl=null, isVideo=false;
    if (d.post_hint==='image' && d.url){ mediaUrl=d.url; }
    else if (d.is_video && d.secure_media?.reddit_video?.fallback_url){
      mediaUrl = d.secure_media.reddit_video.fallback_url; isVideo=true;
    } else if (d.preview?.images?.[0]?.source?.url){
      mediaUrl = d.preview.images[0].source.url.replace(/&amp;/g,'&');
    }
    if (!mediaUrl) continue;
    out.push({
      title: d.title || '',
      author: d.author || 'u/unknown',
      subreddit: d.subreddit || sub,
      url: mediaUrl,
      isVideo,
      permalink: `https://reddit.com${d.permalink||''}`
    });
  }
  return out;
}

/* =================== RENDER =================== */
function renderHome(clear=false){
  byId('build').textContent = CONFIG.version;
  if (clear) els.feed.innerHTML='';
}

function renderCollection(name, list){
  els.feed.innerHTML='';
  const hdr = document.createElement('div');
  hdr.className='row'; hdr.style.margin='12px 0';
  hdr.innerHTML = `<span class="chip">${name}</span> <span class="chip">${list.length}</span>`;
  els.feed.appendChild(hdr);
  for(const item of list){
    els.feed.appendChild(makeCard(item, false));
  }
  window.scrollTo({top:0,behavior:'smooth'});
}

async function loadMore(count=8){
  if (state.loadLock) return;
  if (!state.pool.length) return;

  state.loadLock = true;
  try{
    const n = Math.min(count, state.pool.length);
    // append in small bursts per frame
    let appended = 0;
    while (appended < n){
      const chunk = Math.min(CONFIG.maxAppendPerFrame, n - appended);
      const frag = document.createDocumentFragment();
      for(let i=0;i<chunk;i++){
        const item = state.pool.shift();
        frag.appendChild(makeCard(item,true));
        state.shown++;
      }
      els.feed.appendChild(frag);
      setCounts();
      appended += chunk;
      await nextFrame(); // yield to UI so fast scroll doesn’t choke
    }
  } finally {
    state.loadLock = false;
  }
}

function makeCard(item, interactive){
  const card=document.createElement('article'); card.className='card';

  // header
  const hdr=document.createElement('div'); hdr.className='hdr';
  hdr.innerHTML=`${escapeHtml(item.author)} • <small>r/${escapeHtml(item.subreddit)}</small>`;
  card.appendChild(hdr);

  // media
  let media;
  if (item.isVideo){
    media=document.createElement('video');
    media.className='media';
    media.playsInline=true; media.muted=true; media.controls=true; media.preload='metadata';
    media.src=item.url;
    // pause if not visible
    media.addEventListener('error', ()=> card.remove(), {once:true});
  }else{
    media=document.createElement('img');
    media.className='media';
    media.loading='lazy'; media.alt=item.title||''; media.src=item.url;
    media.addEventListener('error', ()=> card.remove(), {once:true});
  }
  card.appendChild(media);

  // register videos with IntersectionObserver
  if (item.isVideo && state.io) state.io.observe(media);

  // actions
  const actions=document.createElement('div'); actions.className='actions';
  if (interactive){
    actions.innerHTML = `
      <button class="btn btn-no">Dismiss</button>
      <button class="btn btn-ok">Like</button>
    `;
    const [bNo,bOk]=actions.querySelectorAll('button');
    bOk.onclick = ()=>likeItem(item, card);
    bNo.onclick = ()=>trashItem(item, card);
  }else{
    actions.innerHTML = `
      <a class="btn" href="${item.permalink}" target="_blank" rel="noreferrer">Open</a>
      <span class="btn btn-ghost">${escapeHtml(item.title||'')}</span>
    `;
  }
  card.appendChild(actions);
  return card;
}

function likeItem(item, card){
  state.likes.unshift(item);
  localStorage.setItem('cw_likes', JSON.stringify(state.likes.slice(0,1000)));
  const fx=document.createElement('i'); fx.className='burst'; card.appendChild(fx);
  setTimeout(()=>card.remove(),280);
}

function trashItem(item, card){
  state.trash.unshift(item);
  localStorage.setItem('cw_trash', JSON.stringify(state.trash.slice(0,1000)));
  card.classList.add('fade');
  setTimeout(()=>card.remove(),250);
}

/* =================== HELPERS =================== */
function askSubreddits(){
  const current = CONFIG.subreddits.join(', ');
  const ans = prompt('Add or edit subreddits (comma separated):', current);
  if (!ans) return;
  CONFIG.subreddits = ans.split(',').map(s=>s.trim()).filter(Boolean);
  log(`Subreddits set → ${CONFIG.subreddits.join(', ')}`);
}

function shuffleFeed(){
  shuffleArray(state.pool);
  log('Feed shuffled');
}

function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

function byId(id){ return document.getElementById(id); }

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function nextFrame(){ return new Promise(r=>requestAnimationFrame(()=>r())); }

/* -------- Autoload throttle -------- */
function onScrollAutoLoad(){
  if (!CONFIG.autoload) return;
  if (state.loadLock) return;
  const nearBottom = (document.documentElement.scrollHeight - (window.scrollY + window.innerHeight)) < CONFIG.autoloadThresholdPx;
  const now = performance.now();
  if (nearBottom && (now - state.lastAuto) > CONFIG.autoloadThrottleMs){
    state.lastAuto = now;
    loadMore();
  }
}

/* -------- Video IntersectionObserver -------- */
function setupIO(){
  if (!('IntersectionObserver' in window)) return;
  state.io = new IntersectionObserver((entries)=>{
    for (const e of entries){
      const v = e.target;
      if (!(v instanceof HTMLVideoElement)) continue;
      if (e.isIntersecting && e.intersectionRatio > 0.5){
        // try play; safari needs this sequence sometimes
        v.muted = true;
        v.play().catch(()=>{ /* ignore */ });
      } else {
        v.pause();
      }
    }
  }, {threshold:[0,0.5,1]});
}
</script>
</body>
</html>