<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CelebWall v2.4.2</title>
<style>
  :root{
    --bg:#0d0f12;--panel:#12151a;--glass:#171b21;--muted:#9aa3ad;--txt:#eaf0f6;
    --pill:#1f2530; --like1:#2aa0ff; --like2:#14c8b3;
    --dismiss1:#ff4757; --dismiss2:#ff7ab8;
    --tile-grad1:#b08cff; --tile-grad2:#ff9ecf;
    --load1:#3a66ff; --load2:#12c2e9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{background:#0d0f12;overscroll-behavior-y:contain;color-scheme:dark;-webkit-overflow-scrolling:touch;touch-action:manipulation;}
  body{
    margin:0;background:radial-gradient(1000px 600px at 50% -200px,#151b23 0%,#0d0f12 40%,#0d0f12 100%);
    color:var(--txt);font:800 16px/1.3 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow-x:hidden;
  }
  a{color:inherit}
  .wrap{max-width:880px;margin:0 auto;padding:18px 14px 96px}

  .dash{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin:8px 0 12px}
  @media(min-width:920px){.dash{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .btn{position:relative;border:none;cursor:pointer;transition:transform .08s ease,filter .18s ease,opacity .18s ease;}
  .btn.tile{
    border-radius:22px;padding:22px 24px;color:#f5f7ff;font:900 20px/1.1 Inter,system-ui;letter-spacing:.01em;
    background:linear-gradient(180deg,rgba(20,25,34,.6),rgba(18,22,31,.4));
    border:1px solid rgba(255,255,255,.18);
    -webkit-backdrop-filter:blur(14px) saturate(140%);backdrop-filter:blur(14px) saturate(140%);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.22),0 10px 22px rgba(0,0,0,.55);
  }
  .btn.tile.grad{
    background:
      linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
      linear-gradient(135deg,var(--tile-grad1),var(--tile-grad2));
  }
  .btn.tile:hover{transform:translateY(-1px);filter:brightness(1.06)}
  .btn.tile:active{transform:translateY(0);filter:brightness(.96)}
  .btn.small{padding:16px 18px;border-radius:18px;font-size:18px}
  .btn.tiny{padding:10px 14px;border-radius:14px;font-size:14px}

  .progressBtn{grid-column:1 / -1;display:flex;align-items:center;justify-content:space-between;
    padding:16px 18px;border-radius:22px;font-size:18px;position:relative;overflow:hidden;color:#e9f1ff;}
  .progressBtn .fill{position:absolute;inset:0 auto 0 0;width:0%;
    background:linear-gradient(90deg,#a0d9ff 0%,#c8b6ff 50%,#ffb3c7 100%);opacity:.95;pointer-events:none;}
  .progressBtn .label,.progressBtn .pct{position:relative;z-index:1;font-weight:900}
  .progressBtn.is-cta{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
               linear-gradient(135deg,var(--load1),var(--load2));color:#fff;}
  .progressBtn[disabled]{opacity:.7;cursor:not-allowed}

  .tabs{display:flex;gap:10px;justify-content:center;margin:10px 0 6px}
  .pill{border-radius:18px;padding:10px 14px;color:#e9f1ff;
        background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
        border:1px solid rgba(255,255,255,.18);
        -webkit-backdrop-filter:blur(14px) saturate(140%);backdrop-filter:blur(14px) saturate(140%);
        box-shadow:inset 0 1px 0 rgba(255,255,255,.22),0 6px 14px rgba(0,0,0,.45);}
  .hidden{display:none!important}

  .feed{display:grid;gap:18px}
  .card{
    position:relative;border-radius:22px;overflow:hidden;isolation:isolate;touch-action:pan-y;
    background:linear-gradient(180deg,rgba(20,25,34,.55),rgba(15,19,26,.40));
    border:1px solid rgba(255,255,255,.18);
    -webkit-backdrop-filter:blur(14px) saturate(140%);backdrop-filter:blur(14px) saturate(140%);
    box-shadow:0 22px 40px rgba(0,0,0,.7), inset 0 1px 0 rgba(255,255,255,.18);
  }
  .card.swiping{transition:none}
  .media{display:block;width:100%;height:auto;max-height:86vh;object-fit:cover;background:#0b0f15}
  video.media{max-height:86vh;background:#0b0f15}
  .caption{
    padding:12px 14px;border-top:1px solid rgba(255,255,255,.18);
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
    -webkit-backdrop-filter:blur(14px) saturate(140%);backdrop-filter:blur(14px) saturate(140%);
    color:#f3f7ff;font:900 20px/1.2 Inter,system-ui;letter-spacing:.01em;
  }

  .actions{display:flex;gap:16px;justify-content:space-between;padding:18px;
    background:linear-gradient(180deg,transparent 0%,rgba(255,255,255,.03) 20%);
    -webkit-backdrop-filter:blur(12px) saturate(140%);backdrop-filter:blur(12px) saturate(140%);}
  .actions .btn{
    flex:1;border-radius:22px;padding:16px 18px;font-size:18px;
    border:1px solid rgba(255,255,255,.18);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.25), 0 10px 22px rgba(0,0,0,.55);
  }
  .btn.ok{color:#04131a;font-weight:900;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
               linear-gradient(135deg,var(--like1),var(--like2))}
  .btn.no{color:#2b060b;font-weight:900;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
               linear-gradient(135deg,var(--dismiss2),var(--dismiss1))}
  .stamp{
    position:absolute;top:12px;padding:6px 12px;border-radius:12px;font:900 14px/1 Inter,system-ui;
    opacity:0;transform:scale(.9);pointer-events:none;border:1px solid rgba(255,255,255,.22);
    -webkit-backdrop-filter:blur(10px) saturate(140%);backdrop-filter:blur(10px) saturate(140%);
    box-shadow:0 8px 18px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.3);
  }
  .stamp.like{left:12px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04)),linear-gradient(135deg,var(--like1),var(--like2));color:#04131a}
  .stamp.no{right:12px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04)),linear-gradient(135deg,var(--dismiss2),var(--dismiss1));color:#2b060b}

  .burst{animation:burst .45s ease forwards}
  @keyframes burst{0%{transform:scale(1)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
  .fade{animation:fade .28s ease forwards}
  @keyframes fade{to{opacity:0;transform:translateY(10px)}}

  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:50}
  .modal.show{display:grid}
  .sheet{
    width:min(920px,92vw);max-height:80vh;overflow:auto;border-radius:22px;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.18);
    -webkit-backdrop-filter:blur(16px) saturate(160%);backdrop-filter:blur(16px) saturate(160%);
    box-shadow:0 24px 60px rgba(0,0,0,.85); padding:18px
  }
  .log{white-space:pre-wrap;font:600 14px/1.45 ui-monospace,Menlo,Consolas,monospace;color:#d7e3f5}
</style>
</head>
<body>
<div class="wrap">
  <div class="dash">
    <button class="btn tile small" id="homeBtn">Home</button>
    <button class="btn tile small" id="likesBtn">Likes</button>
    <button class="btn tile small" id="discardBtn">Discard</button>
    <button class="btn tile grad small" id="newBatchBtn">New batch</button>
    <button class="btn tile small" id="shuffleBtn">Shuffle feed</button>
    <button class="btn tile small" id="manageSubsBtn">Subreddits</button>
    <button class="btn tile small" id="troubleBtn">Troubleshoot</button>
    <button class="btn tile small" id="connectBtn">Connect Reddit</button>
    <button class="btn tile progressBtn glass" id="progressBtn">
      <div class="fill" id="bar"></div>
      <span class="label" id="phase">Ready</span>
      <span class="pct" id="pct">100%</span>
    </button>
  </div>

  <div class="tabs hidden" id="pageTabs">
    <span class="pill" id="tabHome">Home</span>
    <span class="pill" id="tabLikes">Likes</span>
    <span class="pill" id="tabDiscard">Discard</span>
    <span class="pill" id="tabSubs" style="display:none">Subreddits</span>
  </div>

  <div id="home" class="feed"></div>
  <div id="likes" class="feed hidden"></div>
  <div id="discard" class="feed hidden"></div>

  <section id="subsPage" class="hidden">
    <div class="sheet glass" style="padding:12px">
      <div class="subs-head" style="background:none;border:0;box-shadow:none;padding:0">
        <h2 style="margin:0;font:900 22px/1.2 Inter,system-ui">Manage subreddits</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn tile small" id="subsSelectAll">Select all</button>
          <button class="btn tile small" id="subsClearAll">Clear all</button>
          <button class="btn tile small grad" id="subsSave">Save & New batch</button>
          <button class="btn tile small" id="subsBack">← Back</button>
        </div>
      </div>
      <div class="subs-grid" id="subsGrid"></div>
    </div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
      <h2 style="margin:0">Troubleshoot</h2>
      <button class="btn tiny tile" id="closeModal">Close</button>
    </div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
/* =========================================================
   CelebWall – Stable Script (Safari + Meta Quest tuned)
   - Autoplay muted by default (policy-friendly)
   - Tap video to toggle mute/unmute (with toast)
   - IO + visibility retries (robust play)
   - Fullscreen exit restores scroll
   ========================================================= */

/* -------------------- OAuth config -------------------- */
const DEFAULT_CLIENT_ID   = localStorage.getItem('reddit_client_id')    || '';
const DEFAULT_REDIRECT_URI= localStorage.getItem('reddit_redirect_uri') || (location.origin + location.pathname);

/* -------------------- name list -------------------- */
const CELEB_NAMES = [
  "Scarlett Johansson","Margot Robbie","Zendaya","Ana de Armas","Gal Gadot","Emma Watson","Emma Stone","Natalie Portman","Alexandra Daddario","Salma Hayek",
  "Jessica Alba","Megan Fox","Blake Lively","Emily Ratajkowski","Kate Beckinsale","Priyanka Chopra","Sophie Turner","Taylor Swift","Ariana Grande","Dua Lipa",
  "Beyoncé","Rihanna","Selena Gomez","Jennifer Lopez","Shakira","Camila Cabello","Olivia Rodrigo","Madison Beer","Hailey Bieber","Kylie Jenner",
  "Kendall Jenner","Gigi Hadid","Bella Hadid","Kaia Gerber","Sydney Sweeney","Jenna Ortega","Anya Taylor-Joy","Florence Pugh","Elizabeth Olsen","Vanessa Hudgens",
  "Lily James","Alicia Vikander","Rachel McAdams","Mila Kunis","Amber Heard","Emilia Clarke","Katherine Langford","Zoë Kravitz","Lily Collins","Lucy Hale",
  "Nina Dobrev","Victoria Justice","Karlie Kloss","Barbara Palvin","Taylor Hill","Adriana Lima","Candice Swanepoel","Irina Shayk","Rosie Huntington-Whiteley","Natalie Dormer",
  "Hailee Steinfeld","Chloë Grace Moretz","Lana Del Rey","Halsey","Sabrina Carpenter","Ava Max","SZA","Doja Cat","Billie Eilish","Kacey Musgraves",
  "Maitreyi Ramakrishnan","Alexandra Shipp","Brie Larson","Tessa Thompson","Zoe Saldana","Karen Gillan","Naomi Scott","Ella Balinska","Eiza González","Camila Morrone",
  "Ana de la Reguera","Lupita Nyong'o","Taylour Paige","Ariel Winter","Kiernan Shipka","Lili Reinhart","Camila Mendes","Madelaine Petsch","Addison Rae","Charli D'Amelio",
  "Suki Waterhouse","Phoebe Dynevor","Simone Ashley","Alexa Demie","Yara Shahidi","Maude Apatow","Mandy Moore","Lauren Jauregui","Janelle Monáe","Kerry Washington"
];
const _escRx = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
const NAME_RX = new RegExp("\\b(" + CELEB_NAMES.map(_escRx).join("|") + ")\\b","i");

/* -------------------- app config -------------------- */
const DEFAULT_STARTER_SUBS   = ['Celebs'];
const DEFAULT_OPTIONAL_NSFW  = [
  'charlidameliomommy','leaeluig_nr','leaeluiginet','lea_bellybutton',
  'nsfwfashion','naked_models','Dixied_nsfw','dixiedameliofans',
  'emmachamberlainnsfw','dovecameronlewd','emrata','elsiehewitt',
  'hunterschafer','kendalljenner','niamh_adkins','addisonrae',
  'sydneysweeney','alexandradaddario','alejandraguilmant','jenya_d',
  'girlsontop','hotwife','highresnsfwpro','nsfw_gif'
];
const saved = JSON.parse(localStorage.getItem('subs_toggle')||'{}');
let STARTER_SUBS  = saved.starters || [...DEFAULT_STARTER_SUBS];
let OPTIONAL_NSFW = saved.nsfw     || [...DEFAULT_OPTIONAL_NSFW];

/* -------------------- tunables -------------------- */
const LIMIT=100, PAGES=3, CHUNK=30, LIGHT_SHUFFLES=2;
const AUTOLOAD=true, AUTOLOAD_THRESHOLD_PX=1400, AUTOLOAD_THROTTLE_MS=1400, MAX_APPEND_PER_FRAME=6;

/* -------------------- state -------------------- */
let pool=[], likes=[], discards=[], currentFeed='home', fetching=false, lastErrors=[], loadLock=false, lastAutoTs=0;
const logEl=document.getElementById('log');

/* -------------------- persistence -------------------- */
function saveState(){ try{ localStorage.setItem('likes',JSON.stringify(likes)); localStorage.setItem('discards',JSON.stringify(discards)); }catch{} }
function loadState(){ try{ likes=JSON.parse(localStorage.getItem('likes')||'[]'); discards=JSON.parse(localStorage.getItem('discards')||'[]'); }catch{ likes=[]; discards=[]; } }
loadState();

/* viewed persistence */
const viewed=new Set(JSON.parse(localStorage.getItem('viewed')||'[]'));
function markViewed(url){
  if(!url) return;
  viewed.add(url);
  if(viewed.size>5000){
    const arr=[...viewed].slice(-4000);
    viewed.clear(); arr.forEach(v=>viewed.add(v));
  }
  localStorage.setItem('viewed', JSON.stringify([...viewed]));
}

/* -------------------- helpers -------------------- */
const el = sel => document.querySelector(sel);
const log = msg => { const t=new Date().toLocaleTimeString(); logEl.textContent += `[${t}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; };
const esc = s => String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
function getScrollY(){ return window.scrollY || document.documentElement.scrollTop || 0; }
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* -------------------- name helpers -------------------- */
function titleHasName(t){ return !!t && NAME_RX.test(t); }
function textMatchesAnyName(t){ if(!t) return false; const L=t.toLowerCase(); return CELEB_NAMES.some(n=>L.includes(n.toLowerCase())); }

const PERSON_SUBS = new Set(['LeaEluiGinet','charlidameliomommy','leaeluig_nr','leaeluiginet','lea_bellybutton','nsfwfashion','naked_models','Dixied_nsfw','dixiedameliofans']);
const STOP_WORDS = /^(at|in|with|on|of|for|from|and|the|to|by|wearing|holding|during)\b/i;
function humanizeSubName(sub){return sub.replace(/[_-]+/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/(\d+)/g,' $1 ').replace(/\s+/g,' ').trim().replace(/\b\w/g,m=>m.toUpperCase());}
function guessNameFromTitle(title){
  if(!title) return '';
  const cleaned = title.replace(/\s+/g,' ').trim();
  const parts = [];
  for(const tok of cleaned.split(' ')){
    if(STOP_WORDS.test(tok)) break;
    if(/^[A-ZÀ-Ý][\w’'-.]*$/.test(tok) || /^(de|van|von|da|di|del|la)$/i.test(tok)){ parts.push(tok.replace(/[_-]/g,' ')); continue; }
    if(/[.,;:()|\[\]]/.test(tok)) break;
    if(parts.length===0) break;
    parts.push(tok);
  }
  const name = parts.join(' ').trim();
  return (name && /^[A-ZÀ-Ý]/.test(name)) ? name : '';
}
function inferPerformer(item){
  if(PERSON_SUBS.has(item.sub)) return humanizeSubName(item.sub);
  if(/^[A-Za-z][A-Za-z0-9_]*$/.test(item.sub) && !/(pics|porn|nsfw|celebs?|gowns|events|nips|slips|the|official|fans|hub|girls)/i.test(item.sub)){
    return humanizeSubName(item.sub);
  }
  const tGuess = guessNameFromTitle(item.title);
  if(tGuess) return tGuess;
  return (item.title||'').split(' ').slice(0,3).join(' ').trim() || 'Unknown';
}

/* -------------------- UI helpers -------------------- */
const ui = {
  phase(s){ el('#phase').textContent = s; },
  bar(p){ el('#bar').style.width = `${p}%`; el('#pct').textContent = `${Math.round(p)}%`; },
  setProgressMode(isFetching){
    const btn = el('#progressBtn');
    if(isFetching){ btn.classList.remove('is-cta'); btn.setAttribute('disabled',''); }
    else { btn.classList.add('is-cta'); btn.removeAttribute('disabled'); this.bar(100); this.phase('Ready'); el('#pct').textContent = '100%'; }
  },
  showPage(name){
    currentFeed = name;
    ['home','likes','discard','subsPage'].forEach(id => el('#'+id).classList.add('hidden'));
    if(name==='home') el('#home').classList.remove('hidden');
    if(name==='likes') el('#likes').classList.remove('hidden');
    if(name==='discard') el('#discard').classList.remove('hidden');
    if(name==='subs') el('#subsPage').classList.remove('hidden');
    el('#pageTabs').classList.remove('hidden');
    el('#tabSubs').style.display = (name==='subs' ? '' : (el('#tabSubs').style.display || ''));
    this.progressVisibility();
  },
  progressVisibility(){ const visible = currentFeed==='home' && (pool.length>0 || !fetching); el('#progressBtn').style.display = visible ? '' : 'none'; }
};

/* =========================================================
   VIDEO ENGINE (Safari + Meta Quest hardened)
   ========================================================= */

/* IO: play/pause with visibility */
const io = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    const v = e.target;
    if(!(v instanceof HTMLVideoElement)) return;
    if(e.isIntersecting){ safePlay(v); } else { v.pause(); }
  });
},{threshold:0.5});

/* Page visibility: pause all when hidden, retry when visible */
document.addEventListener('visibilitychange', ()=>{
  const vids = document.querySelectorAll('video.media');
  if(document.hidden){
    vids.forEach(v=>v.pause());
  }else{
    vids.forEach(v=>{ if(inViewport(v)) safePlay(v); });
  }
});

/* First-gesture: nudge play (keeps muted) */
let firstGestureDone=false;
['pointerdown','touchstart','click','keydown'].forEach(evt=>{
  window.addEventListener(evt, ()=>{
    if(firstGestureDone) return;
    firstGestureDone=true;
    document.querySelectorAll('video.media').forEach(v=>safePlay(v)); // don’t unmute here
  }, {once:true, passive:true});
});

// --- Safari/Quest autoplay sound unlock (global) ---
window.addEventListener('DOMContentLoaded', ()=>{
  // make sure we have at least one user gesture before trying sound playback
  let unlocked = false;
  const unlock = ()=>{
    if(unlocked) return;
    unlocked = true;
    document.querySelectorAll('video.media').forEach(v=>{
      // retry play once the gesture is registered
      safePlay(v);
    });
  };
  ['pointerdown','touchstart','click','keydown','scroll'].forEach(evt=>{
    window.addEventListener(evt, unlock, {once:true, passive:true});
  });
});

/* Utility: in viewport? */
function inViewport(elm){
  const r = elm.getBoundingClientRect();
  return r.top < innerHeight*0.9 && r.bottom > innerHeight*0.1;
}

/* Fullscreen scroll restore */
let _fsPrevScroll = 0;
document.addEventListener('fullscreenchange', ()=>{
  if(!document.fullscreenElement){
    document.body.style.overflow = '';
    const y = _fsPrevScroll;
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      window.scrollTo({top:y, left:0, behavior:'instant' in window ? 'instant' : 'auto'});
    }));
  }
});

/* Tiny toast for mute toggles */
function showMuteToast(isMuted){
  const toast = document.createElement('div');
  toast.textContent = isMuted ? '🔇 Muted' : '🔊 Unmuted';
  Object.assign(toast.style, {
    position:'fixed', bottom:'24px', left:'50%', transform:'translateX(-50%)',
    background:'rgba(0,0,0,0.7)', color:'#fff', padding:'8px 16px', borderRadius:'12px',
    font:'900 16px/1 Inter,system-ui', zIndex:9999, transition:'opacity .3s ease'
  });
  document.body.appendChild(toast);
  setTimeout(()=>toast.style.opacity='0',1000);
  setTimeout(()=>toast.remove(),1300);
}

/* Safe play helper */
async function safePlay(v){
  try{
    if(v.readyState < 2) await new Promise(r=>v.addEventListener('loadeddata', r, {once:true}));
  }catch{}
  try{
    const p = v.play();
    if(p && typeof p.then==='function') await p;
  }catch{/* autoplay may fail until user interacts */}
}

/* Build video element (tap to play; tap again to unmute) */
function makeVideo(src, thumb, loop=false){
  const wrap = document.createElement('div');
  wrap.style.position = 'relative';
  wrap.style.width = '100%';

  const v = document.createElement('video');
  v.className = 'media';
  v.src = src;
  v.autoplay = false;                // no autoplay: Safari-safe
  v.muted = true;                    // start muted
  v.playsInline = true;
  v.setAttribute('webkit-playsinline', '');
  v.preload = 'metadata';
  v.loop = !!loop;
  v.disableRemotePlayback = true;
  v.setAttribute('x-webkit-airplay', 'deny');
  if (thumb) v.poster = thumb;
  v.setAttribute('controlslist', 'nodownload noplaybackrate noremoteplayback');
  v.setAttribute('disablepictureinpicture', '');

  // --- Frosted-glass play overlay (guaranteed render) ---
function ensureOverlay() {
  if (wrap.querySelector('.tap-overlay')) return; // already exists

  const playOverlay = document.createElement('div');
  playOverlay.className = 'tap-overlay';
  playOverlay.textContent = '▶ Tap to Play';
  Object.assign(playOverlay.style, {
    position: 'absolute',
    top: '50%',
    left: '50%',
    transform: 'translate(-50%,-50%)',
    padding: '16px 28px',
    borderRadius: '20px',
    font: '900 18px/1 Inter,system-ui',
    letterSpacing: '.01em',
    color: '#eaf0f6',
    background: 'linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06))',
    border: '1px solid rgba(255,255,255,.18)',
    backdropFilter: 'blur(14px) saturate(140%)',
    WebkitBackdropFilter: 'blur(14px) saturate(140%)',
    boxShadow: 'inset 0 1px 0 rgba(255,255,255,.22), 0 6px 16px rgba(0,0,0,.55)',
    cursor: 'pointer',
    zIndex: 3,
    userSelect: 'none',
    transition: 'opacity .3s ease'
  });

  playOverlay.addEventListener('click', async e => {
    e.stopPropagation();
    playOverlay.style.opacity = '0';
    setTimeout(()=>playOverlay.remove(), 300);
    try { await v.play(); } catch {}
    showMuteToast(v.muted);
  });

  wrap.appendChild(playOverlay);
}

// Call it immediately for normal videos
ensureOverlay();
// And call it again when delayed videos finish loading
v.addEventListener('loadeddata', ensureOverlay);

  // Tap overlay to start video (muted)
  playOverlay.addEventListener('click', async e => {
    e.stopPropagation();
    playOverlay.style.opacity = '0';
    setTimeout(()=>playOverlay.remove(), 300);
    try { await v.play(); } catch {}
    showMuteToast(v.muted);
  });

  // Tap video to toggle mute/unmute
  v.addEventListener('click', async e => {
    e.stopPropagation();
    v.muted = !v.muted;
    if (!v.muted) {
      try { await v.play(); } catch {}
    }
    showMuteToast(v.muted);
  });

  v.addEventListener('error', () => v.closest('.card')?.remove());

  // Minimal fullscreen button
  const fsBtn = document.createElement('button');
  fsBtn.textContent = '⛶';
  fsBtn.title = 'Fullscreen';
  Object.assign(fsBtn.style, {
    position: 'absolute',
    bottom: '12px',
    right: '12px',
    fontSize: '22px',
    padding: '4px 10px',
    border: 'none',
    borderRadius: '12px',
    background: 'rgba(0,0,0,0.55)',
    color: '#fff',
    cursor: 'pointer',
    zIndex: '2',
    opacity: '0',
    transition: 'opacity .25s ease'
  });
  wrap.addEventListener('mouseenter', () => fsBtn.style.opacity = '0.85');
  wrap.addEventListener('mouseleave', () => fsBtn.style.opacity = '0');

  fsBtn.addEventListener('click', e => {
    e.stopPropagation();
    _fsPrevScroll = getScrollY();
    document.body.style.overflow = 'hidden';
    if (v.requestFullscreen) v.requestFullscreen();
    else if (v.webkitRequestFullscreen) v.webkitRequestFullscreen();
  });

  wrap.appendChild(v);
  wrap.appendChild(fsBtn);
  io.observe(v);
  return wrap;
}

/* -------------------- fetchers (Reddit) -------------------- */
const CORS = 'https://cors.isomorphic-git.org/';
function baseUrl(sub, token){
  return token
    ? `https://oauth.reddit.com/r/${sub}/hot?limit=${LIMIT}`
    : CORS + `https://www.reddit.com/r/${sub}/hot.json?limit=${LIMIT}&raw_json=1`;
}
async function pullSubreddit(sub){
  const token = getToken();
  let after = null;
  const out = [];
  for(let page=0; page<PAGES; page++){
    const url = baseUrl(sub, token) + (after ? `&after=${after}` : '');
    try{
      const res = await fetch(url, token ? {headers:{'Authorization':`Bearer ${token}`}} : {});
      if(!res.ok){ const msg=`✖ /r/${sub} p${page+1}: HTTP ${res.status}`; lastErrors.push(msg); log(msg); break; }
      const data = await res.json();
      const children = (data.data?.children || []);
      const items = children.map(n=>normalize(n.data)).filter(Boolean);
      out.push(...items);
      log(`Loaded ${items.length} from /r/${sub} (page ${page+1})`);
      after = data.data?.after || null;
      if(!after) break;
      await new Promise(r=>setTimeout(r,20));
    }catch(e){
      const msg = `✖ /r/${sub} p${page+1}: ${e}`; lastErrors.push(msg); log(msg); break;
    }
  }
  return out;
}

/* Normalize Reddit post -> card item */
function normalize(d){
  const rv = d.secure_media?.reddit_video || d.media?.reddit_video;
  if(rv?.fallback_url){
    return { t:'video', url:rv.fallback_url, thumb:pickThumb(d), title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
  }
  const preview = d.preview?.images?.[0];
  const variants = preview?.variants;

  if(variants?.mp4?.source?.url){
    return { t:'video', url:fix(variants.mp4.source.url), thumb:fix(preview?.source?.url),
      title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
  }
  if(variants?.gif?.source?.url){
    return { t:'gif', url:fix(variants.gif.source.url), thumb:fix(preview?.source?.url),
      title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
  }
  if(d.is_gallery && d.gallery_data?.items){
    const firstId = d.gallery_data.items[0]?.media_id;
    const meta = d.media_metadata?.[firstId];
    const src = bestMeta(meta);
    if(src){ return { t:'image', url:src, thumb:src, title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` }; }
  }
  const img = d.url_overridden_by_dest || d.url;
  if(img && /\.(jpg|jpeg|png|webp)$/i.test(img)){
    return { t:'image', url:img, thumb:img, title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
  }
  if(preview?.source?.url){
    const src = fix(preview.source.url);
    return { t:'image', url:src, thumb:src, title:d.title, author:d.author, sub:d.subreddit, link:`https://reddit.com${d.permalink}` };
  }
  return null;
}
function pickThumb(d){ const t=d.thumbnail; if(t && t.startsWith('http')) return t; const p=d.preview?.images?.[0]?.source?.url; return p ? fix(p) : null; }
function bestMeta(meta){ if(!meta) return null; const s=meta.s; if(!s) return null; return fix(s.u||s.gif||s.mp4||null); }
function fix(u){ return u ? u.replace(/&amp;/g,'&') : u; }

/* -------------------- render pipeline -------------------- */
function interleaveBuckets(buckets){
  const keys = Object.keys(buckets); const out=[]; let added=true;
  while(added){ added=false; for(const k of keys){ const arr=buckets[k]; if(arr && arr.length){ out.push(arr.shift()); added=true; } } }
  for(let i=0;i<LIGHT_SHUFFLES;i++) shuffleArray(out);
  return out;
}

function attachSwipe(wrap, item){
  const likeStamp=document.createElement('div'); likeStamp.className='stamp like'; likeStamp.textContent='Like';
  const noStamp=document.createElement('div'); noStamp.className='stamp no'; noStamp.textContent='Dismiss';
  wrap.appendChild(likeStamp); wrap.appendChild(noStamp);

  let startX=0, startY=0, dx=0, dy=0, dragging=false;
  const threshold=Math.max(120, window.innerWidth*0.22), rotFactor=20;

  function setTransform(x){
    const r=(x/threshold)*rotFactor;
    wrap.style.transform=`translateX(${x}px) rotate(${r}deg)`;
    likeStamp.style.opacity=Math.max(0,Math.min(1,x/threshold));
    noStamp.style.opacity=Math.max(0,Math.min(1,-x/threshold));
    likeStamp.style.transform=`scale(${0.9 + Math.min(0.2, Math.max(0, x/threshold)*0.2)})`;
    noStamp.style.transform=`scale(${0.9 + Math.min(0.2, Math.max(0, -x/threshold)*0.2)})`;
  }
  function registerLike(i){ if(!likes.some(it=>it.url===i.url)){ likes.push(i); saveState(); } }
  function registerDiscard(i){ if(!discards.some(it=>it.url===i.url)){ discards.push(i); saveState(); } }

  function endSwipe(finalX){
    wrap.classList.remove('swiping');
    const didLike = finalX > threshold, didNo = finalX < -threshold;
    if(didLike || didNo){
      const off=(didLike?1:-1)*(window.innerWidth+200);
      wrap.style.transition='transform .28s ease-out, opacity .28s ease-out';
      wrap.style.transform=`translateX(${off}px) rotate(${off>0?rotFactor:-rotFactor}deg)`; wrap.style.opacity='0.2';
      setTimeout(()=>{ if(didLike) registerLike(item); else registerDiscard(item); markViewed(item.url); wrap.remove(); },280);
    }else{
      wrap.style.transition='transform .22s ease'; wrap.style.transform=''; likeStamp.style.opacity=0; noStamp.style.opacity=0;
      setTimeout(()=>{ wrap.style.transition=''; },240);
    }
  }

  wrap.addEventListener('pointerdown',e=>{ if(e.button!==0) return; dragging=true; wrap.classList.add('swiping'); startX=e.clientX; startY=e.clientY; dx=0; dy=0; wrap.setPointerCapture(e.pointerId); });
  wrap.addEventListener('pointermove',e=>{ if(!dragging) return; dx=e.clientX-startX; dy=e.clientY-startY; if(Math.abs(dx)>Math.abs(dy)*0.7){ setTransform(dx); } });
  wrap.addEventListener('pointerup',()=>{ if(!dragging) return; dragging=false; endSwipe(dx); });
  wrap.addEventListener('pointercancel',()=>{ if(!dragging) return; dragging=false; endSwipe(0); });
}

function card(item){
  const wrap=document.createElement('article'); wrap.className='card'; wrap.__item=item;
  const performer = inferPerformer(item);

  let media;
  if(item.t==='video' || item.t==='gif'){ media = makeVideo(item.url, item.thumb || null, true); }
  else{
    media = document.createElement('img'); media.className='media'; media.loading='lazy'; media.alt=item.title||''; media.src=item.url;
    media.addEventListener('error',()=>wrap.remove());
  }
  wrap.appendChild(media);

  const caption=document.createElement('div'); caption.className='caption';
  caption.textContent = performer || (item.title||'').slice(0,64); wrap.appendChild(caption);

  const actions=document.createElement('div'); actions.className='actions';
  actions.innerHTML=`<button class="btn no" data-act="no">Dismiss</button><button class="btn ok" data-act="ok">Like</button>`;
  actions.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.act==='ok'){ if(!likes.some(i=>i.url===item.url)){ likes.push(item); saveState(); } wrap.classList.add('burst'); }
    else { if(!discards.some(i=>i.url===item.url)){ discards.push(item); saveState(); } wrap.classList.add('fade'); }
    markViewed(item.url); setTimeout(()=>wrap.remove(),260);
  });
  wrap.appendChild(actions);

  attachSwipe(wrap, item);
  return wrap;
}

async function renderChunk(where, n=CHUNK){
  if(loadLock) return;
  if(pool.length===0){ ui.progressVisibility(); return; }
  loadLock=true;
  try{
    const feed=document.getElementById(where);
    const need=Math.min(n,pool.length); let appended=0;
    while(appended<need){
      const frag=document.createDocumentFragment();
      const step=Math.min(MAX_APPEND_PER_FRAME, need-appended);
      for(let i=0;i<step;i++){ const it=pool.shift(); frag.appendChild(card(it)); }
      feed.appendChild(frag); appended+=step;
      await new Promise(r=>requestAnimationFrame(r));
    }
  }finally{ loadLock=false; ui.progressVisibility(); }
}

/* -------------------- batching -------------------- */
async function newBatch(){
  if(fetching) return;
  fetching=true; ui.phase('Fetching…'); ui.bar(10); ui.setProgressMode(true);
  pool.length=0; document.getElementById('home').innerHTML='';

  const subs=[...STARTER_SUBS, ...OPTIONAL_NSFW];
  const all=[]; let done=0; lastErrors=[];

  for(const s of subs){
    const items=await pullSubreddit(s);
    all.push(...items);
    done++; ui.bar(10 + (done/subs.length)*80);
  }

  const seen=new Set(); const deduped=[];
  for(const it of all){ if(!it?.url) continue; if(seen.has(it.url)) continue; if(viewed.has(it.url)) continue; seen.add(it.url); deduped.push(it); }

  const matched=[], rest=[];
  for(const it of deduped){
    const perf=inferPerformer(it);
    if(titleHasName(it.title) || textMatchesAnyName(perf)) matched.push(it);
    else rest.push(it);
  }

  const bucketsTop={}, bucketsRest={};
  for(const it of matched){ (bucketsTop[it.sub] ||= []).push(it); }
  for(const it of rest){ (bucketsRest[it.sub] ||= []).push(it); }

  pool=[...interleaveBuckets(bucketsTop), ...interleaveBuckets(bucketsRest)];

  ui.bar(100); ui.phase('Ready'); ui.setProgressMode(false);
  await renderChunk('home', Math.min(CHUNK, pool.length));
  fetching=false;
}

/* -------------------- shuffle/subs/troubleshoot -------------------- */
function shuffleVisibleAndPool(){
  const feed=document.getElementById('home');
  const nodes=[...feed.children].filter(n=>n.classList.contains('card'));
  const visibleItems=nodes.map(n=>n.__item).filter(Boolean);
  const combined=[...visibleItems, ...pool];
  shuffleArray(combined);
  const keep=visibleItems.length; feed.innerHTML='';
  for(let i=0;i<Math.min(keep,combined.length);i++) feed.appendChild(card(combined[i]));
  pool=combined.slice(keep);
  ui.progressVisibility();
}
function buildSubsUI(){
  const grid=document.getElementById('subsGrid'); grid.innerHTML='';
  const current=new Set([...STARTER_SUBS, ...OPTIONAL_NSFW]);
  const all=[...new Set([...DEFAULT_STARTER_SUBS, ...DEFAULT_OPTIONAL_NSFW, ...STARTER_SUBS, ...OPTIONAL_NSFW])].sort((a,b)=>a.localeCompare(b));
  for(const sub of all){
    const id='sub-'+sub;
    const tile=document.createElement('label');
    tile.className='sub-tile';
    tile.innerHTML=`<input type="checkbox" id="${id}" ${current.has(sub)?'checked':''}><span>r/${esc(sub)}</span>`;
    grid.appendChild(tile);
  }
}
function saveSubsFromUI(){
  const checks=[...document.querySelectorAll('#subsGrid input[type="checkbox"]')];
  const picked=checks.filter(c=>c.checked).map(c=>c.id.replace('sub-',''));
  STARTER_SUBS = picked.filter(s=>DEFAULT_STARTER_SUBS.includes(s));
  OPTIONAL_NSFW = picked.filter(s=>DEFAULT_OPTIONAL_NSFW.includes(s));
  const leftovers=picked.filter(s=>!DEFAULT_STARTER_SUBS.includes(s) && !DEFAULT_OPTIONAL_NSFW.includes(s));
  STARTER_SUBS.push(...leftovers);
  localStorage.setItem('subs_toggle', JSON.stringify({starters:STARTER_SUBS, nsfw:OPTIONAL_NSFW}));
}
function dumpTroubleshoot(){
  const token=getToken();
  const info=[];
  info.push(`App state:\n  feed=${currentFeed}\n  pool=${pool.length}\n  likes=${likes.length}\n  discards=${discards.length}`);
  info.push(`Environment:\n  ua=${navigator.userAgent}\n  online=${navigator.onLine}\n  width=${innerWidth} height=${innerHeight}`);
  info.push(`Auth:\n  token=${token ? 'present' : 'none'}`);
  info.push(`Subs:\n  starters=[${STARTER_SUBS.join(', ')}]\n  nsfw=[${OPTIONAL_NSFW.join(', ')}]`);
  info.push(`Fetch plan:\n  LIMIT=${LIMIT}, PAGES=${PAGES}, CHUNK=${CHUNK}\n  celebNames=${CELEB_NAMES.length}`);
  if(lastErrors.length) info.push('Recent fetch errors:\n' + lastErrors.slice(-8).join('\n')); else info.push('Recent fetch errors: (none)');
  logEl.textContent=''; log(info.join('\n\n'));
}

/* -------------------- events -------------------- */
document.getElementById('newBatchBtn').addEventListener('click', newBatch);
document.getElementById('shuffleBtn').addEventListener('click', shuffleVisibleAndPool);
// (Removed Load More button)
// (Removed Clear Token + Token pill UI)
document.getElementById('homeBtn').addEventListener('click', ()=>ui.showPage('home'));
document.getElementById('likesBtn').addEventListener('click', ()=>{ paintList('likes', likes); requestAnimationFrame(()=>ui.showPage('likes')); });
document.getElementById('discardBtn').addEventListener('click', ()=>{ paintList('discard', discards); requestAnimationFrame(()=>ui.showPage('discard')); });
document.getElementById('manageSubsBtn').addEventListener('click', ()=>{ buildSubsUI(); ui.showPage('subs'); el('#tabSubs').style.display=''; });
document.getElementById('troubleBtn').addEventListener('click', ()=>{ dumpTroubleshoot(); el('#modal').classList.add('show'); });
document.getElementById('closeModal').addEventListener('click', ()=> el('#modal').classList.remove('show'));
document.getElementById('connectBtn').addEventListener('click', beginOAuth);
document.getElementById('subsSelectAll').addEventListener('click', ()=>{ document.querySelectorAll('#subsGrid input[type="checkbox"]').forEach(c=>c.checked=true); });
document.getElementById('subsClearAll').addEventListener('click', ()=>{ document.querySelectorAll('#subsGrid input[type="checkbox"]').forEach(c=>c.checked=false); });
document.getElementById('subsBack').addEventListener('click', ()=> ui.showPage('home'));
document.getElementById('subsSave').addEventListener('click', async ()=>{ saveSubsFromUI(); await newBatch(); ui.showPage('home'); });

function paintList(where, arr){ const host=document.getElementById(where); host.innerHTML=''; arr.forEach(it=>host.appendChild(card(it))); }

/* -------------------- autoload on scroll -------------------- */
function onScrollAuto(){
  if(!AUTOLOAD || currentFeed!=='home') return;
  if(loadLock) return;
  const doc=document.documentElement;
  const scrollTop=getScrollY();
  const nearBottom=(doc.scrollHeight - (scrollTop + window.innerHeight)) < AUTOLOAD_THRESHOLD_PX;
  const now=performance.now();
  if(nearBottom && (now - lastAutoTs) > AUTOLOAD_THROTTLE_MS){ lastAutoTs=now; renderChunk('home'); }
}
window.addEventListener('scroll', onScrollAuto, {passive:true});

/* -------------------- OAuth helpers (implicit) -------------------- */
function rand(n=12){ return Array.from(crypto.getRandomValues(new Uint8Array(n))).map(v=>(v%36).toString(36)).join(''); }
function beginOAuth(){
  let clientId = localStorage.getItem('reddit_client_id') || DEFAULT_CLIENT_ID;
  let redirectUri = localStorage.getItem('reddit_redirect_uri') || DEFAULT_REDIRECT_URI;
  if(!clientId){ clientId = prompt('Enter your Reddit CLIENT ID (installed app):',''); if(!clientId) return; localStorage.setItem('reddit_client_id', clientId); }
  if(!redirectUri){ redirectUri = prompt('Enter the exact Redirect URI you set on old.reddit.com/apps:', location.origin + location.pathname) || ''; if(!redirectUri) return; localStorage.setItem('reddit_redirect_uri', redirectUri); }
  const state=rand(24); localStorage.setItem('reddit_oauth_state', state);
  const params=new URLSearchParams({client_id:clientId,response_type:'token',state,redirect_uri:redirectUri,duration:'temporary',scope:'read identity'});
  location.href='https://www.reddit.com/api/v1/authorize.compact?' + params.toString();
}
function captureTokenFromHash(){
  if(!location.hash) return;
  const h=new URLSearchParams(location.hash.slice(1));
  const token=h.get('access_token'); const state=h.get('state');
  if(!token) return;
  const expected=localStorage.getItem('reddit_oauth_state');
  if(expected && state !== expected){ log('State mismatch (ignored)'); return; }
  const expiresIn=parseInt(h.get('expires_in')||'3600',10);
  const rec={ access_token: token, expires_at: Date.now() + (expiresIn*1000) };
  localStorage.setItem('reddit_token', JSON.stringify(rec));
  log('Token stored, expires in ' + Math.round(expiresIn/60) + 'm');
  history.replaceState({}, document.title, location.pathname + location.search);
}
function clearToken(){ localStorage.removeItem('reddit_token'); log('Token cleared'); }
function getToken(){ try{ const t=JSON.parse(localStorage.getItem('reddit_token')||'null'); if(!t) return null; if(Date.now()>t.expires_at) return null; return t.access_token; }catch{ return null; } }

/* -------------------- RedGifs integration -------------------- */
const REDGIFS_MAX_NAMES_PER_BATCH=6;
const REDGIFS_COUNT_PER_QUERY=6;
const REDGIFS_TRENDING_COUNT=12;
const REDGIFS_PAGE=1;
const REDGIFS_NAME_BIAS_FIRST=true;

let _redgifsTokenCache={token:null, exp:0};
async function getRedGifsToken(){
  try{
    if(_redgifsTokenCache.token && Date.now() < _redgifsTokenCache.exp) return _redgifsTokenCache.token;
    const r=await fetch('https://api.redgifs.com/v2/auth/temporary',{method:'POST'});
    if(!r.ok) throw new Error('Auth HTTP ' + r.status);
    const j=await r.json(); const tok=j?.token || null;
    if(!tok) throw new Error('No token');
    _redgifsTokenCache={token:tok, exp: Date.now()+6*60*60*1000};
    return tok;
  }catch(e){ log('✖ RedGifs auth failed: '+e.message); return null; }
}
function normalizeRedGifsItem(g){
  try{
    const urls=g?.urls||{};
    const vid=urls.hd || urls.sd || urls.vthumbnail || null;
    const thumb=urls.thumbnail || urls.poster || urls.mobilePoster || null;
    if(!vid) return null;
    return { t:'video', url:vid, thumb:thumb||vid, title:g.title || g.id || 'RedGifs', author:g.userName || 'redgifs', sub:'RedGifs', link:vid };
  }catch{ return null; }
}
async function redgifsFetch(endpoint, token){
  const r=await fetch(endpoint,{headers:{'Authorization':`Bearer ${token}`}});
  if(!r.ok) throw new Error('HTTP ' + r.status);
  const j=await r.json(); const arr=j?.gifs||[];
  return arr.map(normalizeRedGifsItem).filter(Boolean);
}
async function fetchRedGifsByName(token, name, page=REDGIFS_PAGE, count=REDGIFS_COUNT_PER_QUERY){
  const url=`https://api.redgifs.com/v2/gifs/search?search_text=${encodeURIComponent(name)}&page=${page}&count=${count}`;
  return redgifsFetch(url, token);
}
async function fetchRedGifsTrending(token, page=REDGIFS_PAGE, count=REDGIFS_TRENDING_COUNT){
  const url=`https://api.redgifs.com/v2/gifs/trending?page=${page}&count=${count}`;
  return redgifsFetch(url, token);
}
function pickCelebNames(n=REDGIFS_MAX_NAMES_PER_BATCH){ const names=[...CELEB_NAMES]; shuffleArray(names); return names.slice(0,n); }

async function autoLoadRedGifs(){
  try{
    ui.phase('Adding RedGifs…'); ui.setProgressMode(true); ui.bar(15);
    const token=await getRedGifsToken();
    if(!token){ ui.setProgressMode(false); ui.phase('Ready'); return; }

    const picked=pickCelebNames();
    const nameGroups=await Promise.allSettled(picked.map(n=>fetchRedGifsByName(token,n)));
    const byName=nameGroups.flatMap(res=>res.status==='fulfilled'?res.value:[]);
    ui.bar(55);

    let trending=[]; try{ trending=await fetchRedGifsTrending(token); }catch(e){ log('RedGifs trending failed: '+e.message); }
    ui.bar(75);

    const existing=new Set(pool.map(i=>i.url)); const seen=new Set();
    const outName=[], outTrend=[];
    for(const it of byName){ if(!it?.url) continue; if(viewed.has(it.url)) continue; if(existing.has(it.url)) continue; if(seen.has(it.url)) continue; seen.add(it.url); outName.push(it); }
    for(const it of trending){ if(!it?.url) continue; if(viewed.has(it.url)) continue; if(existing.has(it.url)) continue; if(seen.has(it.url)) continue; seen.add(it.url); outTrend.push(it); }

    let merged;
    if(REDGIFS_NAME_BIAS_FIRST){
      const bucketsTop={ redgifs: outName, reddit: pool.slice() };
      const bucketsRest={ redgifs: outTrend };
      merged=[...interleaveBuckets(bucketsTop), ...interleaveBuckets(bucketsRest)];
    }else{
      merged = interleaveBuckets({ reddit: pool.slice(), redgifs:[...outName, ...outTrend] });
    }
    pool=merged;

    await renderChunk('home', Math.min(CHUNK, pool.length));
    ui.bar(100); ui.phase('Ready'); ui.setProgressMode(false);
    log(`✅ RedGifs merged: ${outName.length} name-matched + ${outTrend.length} trending`);
  }catch(e){ log('✖ RedGifs integration error: ' + e.message); ui.setProgressMode(false); ui.phase('Ready'); }
}

/* -------------------- boot -------------------- */
captureTokenFromHash();
ui.setProgressMode(false);
ui.bar(100); ui.phase('Ready');
log('Ready. Swipe right to Like, left to Dismiss. Tap video to toggle sound. “Viewed” items are skipped.');
(async ()=>{ await newBatch(); setTimeout(autoLoadRedGifs, 3000); })();
</script>
</body>
</html>