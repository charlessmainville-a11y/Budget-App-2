<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CelebWall v3</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{margin:0;background:#0a0f14;color:#fff;font-family:system-ui,sans-serif;overflow-x:hidden}
  header{padding:12px;text-align:center}
  .stats{display:flex;justify-content:center;gap:20px;margin:6px 0}
  .stat{background:#111;padding:8px 14px;border-radius:10px;font-size:14px}
  .bar{height:4px;background:linear-gradient(90deg,#8cf,#f9a);margin:4px 0;border-radius:4px}
  .dash{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:12px}
  .btn{padding:10px 14px;border-radius:999px;border:none;font-weight:700;cursor:pointer;transition:.2s}
  .btn-like{background:linear-gradient(135deg,#00f5ff,#00c8d4);color:#041016;text-shadow:0 1px 0 rgba(255,255,255,.4)}
  .btn-dismiss{background:linear-gradient(135deg,#ff4d6d,#ff8a80);color:#041016;text-shadow:0 1px 0 rgba(255,255,255,.4)}
  .btn-nav{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);color:#fff}
  .card{max-width:500px;margin:20px auto;background:#111;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.5);overflow:hidden}
  .card-head{padding:10px;font-weight:700;font-size:14px;background:rgba(0,0,0,.4)}
  .media{width:100%;display:block}
  video.media{max-height:80vh;object-fit:contain}
  .actions{display:flex;gap:12px;justify-content:space-between;padding:12px}
  .like-burst{animation:burst .4s ease-out}
  .fade-out{animation:fade .4s forwards}
  @keyframes burst{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
  @keyframes fade{to{opacity:0;transform:scale(.8)}}
  .oauth{max-width:760px;margin:10px auto;padding:10px 14px;border-radius:14px;background:rgba(255,255,255,.04);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08)}
</style>
</head>
<body>
<header>
  <div>CelebWall v3.0</div>
  <div class="stats">
    <div class="stat">Shown <span id="shown">0</span></div>
    <div class="stat">Pool <span id="pool">0</span></div>
    <div class="stat">Total <span id="total">0</span></div>
  </div>
  <div class="bar"></div>
</header>

<div class="dash">
  <button class="btn btn-nav" onclick="showHome()">Home</button>
  <button class="btn btn-nav" onclick="showLikes()">Likes</button>
  <button class="btn btn-nav" onclick="showDiscards()">Discard</button>
  <button class="btn btn-nav" onclick="newBatch()">New batch</button>
  <button class="btn btn-nav" onclick="shuffleFeed()">Shuffle feed</button>
  <button class="btn btn-nav" onclick="loadMore()">Load more</button>
  <button class="btn btn-nav" onclick="addSubs()">+ Subreddits</button>
</div>

<div id="feed"></div>
<div id="likes" style="display:none"></div>
<div id="discards" style="display:none"></div>

<div class="oauth" id="oauthBox" style="display:none">
  <span id="oauthStatus">Reddit: not connected</span>
  <button class="btn btn-nav" onclick="connectReddit()">Connect Reddit</button>
  <button class="btn btn-nav" onclick="clearToken()">Clear</button>
</div>

<script>
const subsDefault = ["celebs","CelebEvents","charlidameliomommy","LeaEluiGinet"];
let subs=[...subsDefault];
let pool=[],shown=0,total=0;
const LS_T='cw.token',LS_E='cw.exp'; const clientId="D_nzkiZhFVjFgNs_sqCQ3Q";

function getTok(){let t=localStorage[LS_T],e=+localStorage[LS_E]||0;if(!t||Date.now()>e)return null;return t}
function setTok(t,sec){localStorage[LS_T]=t;localStorage[LS_E]=Date.now()+sec*1000}
function clearToken(){localStorage.removeItem(LS_T);localStorage.removeItem(LS_E);refreshOAuth()}
function connectReddit(){
  const redir=location.origin+location.pathname; const st=Math.random().toString(36).slice(2);sessionStorage.cwst=st;
  location.href=`https://www.reddit.com/api/v1/authorize?client_id=${clientId}&response_type=token&state=${st}&redirect_uri=${redir}&duration=temporary&scope=read`;
}
(function capture(){if(location.hash.includes("access_token=")){let p=new URLSearchParams(location.hash.slice(1));let t=p.get("access_token");let ex=+p.get("expires_in")||3600;if(p.get("state")!==sessionStorage.cwst){alert("State mismatch");return}setTok(t,ex);history.replaceState(null,"",location.pathname)}})();
function refreshOAuth(){document.getElementById("oauthBox").style.display="block";document.getElementById("oauthStatus").textContent="Reddit: "+(getTok()?"connected":"not connected")}
refreshOAuth();

function cardHTML(it){
  return `<div class="card" data-url="${it.url}">
    <div class="card-head">u/${it.author} â€¢ r/${it.subreddit}</div>
    ${it.is_video?`<video class="media" src="${it.url}" autoplay muted loop></video>`:`<img class="media" src="${it.url}" alt="">`}
    <div class="actions">
      <button class="btn btn-dismiss" onclick="act(this,'discard')">Dismiss</button>
      <button class="btn btn-like" onclick="act(this,'like')">Like</button>
    </div></div>`
}
function act(btn,what){
  const card=btn.closest(".card");card.classList.add(what==="like"?"like-burst":"fade-out");
  setTimeout(()=>{card.remove()},400);
  if(what==="like") document.getElementById("likes").innerHTML+=card.outerHTML;
  else document.getElementById("discards").innerHTML+=card.outerHTML;
  shown++;document.getElementById("shown").textContent=shown;
}
function showHome(){feed.style.display="block";likes.style.display=discards.style.display="none"}
function showLikes(){feed.style.display=discards.style.display="none";likes.style.display="block"}
function showDiscards(){feed.style.display=likes.style.display="none";discards.style.display="block"}

async function fetchSub(s){
  let url=`https://www.reddit.com/r/${s}/hot.json?limit=20`;
  let r=await fetch(url);if(!r.ok)return[];let j=await r.json();
  return j.data.children.map(c=>({url:c.data.url_overridden_by_dest||c.data.url,author:c.data.author,subreddit:s,is_video:c.data.is_video}))
}
async function newBatch(){pool=[];feed.innerHTML="";shown=0;for(let s of subs){let its=await fetchSub(s);pool.push(...its)}total=pool.length;document.getElementById("total").textContent=total;loadMore()}
function shuffleFeed(){pool.sort(()=>Math.random()-.5);loadMore()}
function loadMore(){let chunk=pool.splice(0,10);document.getElementById("pool").textContent=pool.length;feed.insertAdjacentHTML("beforeend",chunk.map(cardHTML).join(""))}
function addSubs(){let inp=prompt("Add subreddits (comma separated)","");if(inp){subs=inp.split(",").map(s=>s.trim());newBatch()}}
window.onscroll=function(){if(window.innerHeight+window.scrollY>=document.body.offsetHeight-300){loadMore()}}
newBatch();
</script>
</body>
</html>