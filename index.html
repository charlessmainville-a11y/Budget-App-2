<script>
/* ===== Reddit OAuth block (ready with your values) ===== */

const CLIENT_ID    = 'D_nzkiZhFVjFgNs_sqCQ3Q';
const REDIRECT_URI = 'https://charlessmainville-a11y.github.io/Budget-App-2/';
const SCOPES       = 'read';
const TOKEN_STORE  = 'reddit_token_v1';

function logTS(msg){
  try { appendLog(msg); } catch { console.log(msg); }
}

function redditAuthUrl(state){
  const params = new URLSearchParams({
    client_id: CLIENT_ID,
    response_type: 'token',
    state,
    redirect_uri: REDIRECT_URI,
    duration: 'temporary',
    scope: SCOPES
  });
  return `https://www.reddit.com/api/v1/authorize?${params.toString()}`;
}

function redditStartAuth(){
  const state = (crypto && crypto.getRandomValues)
    ? Array.from(crypto.getRandomValues(new Uint8Array(8)))
        .map(b => b.toString(16).padStart(2, '0')).join('')
    : String(Math.random()).slice(2);
  sessionStorage.setItem('reddit_oauth_state', state);
  location.href = redditAuthUrl(state);
}

function redditParseHash(){
  if (!location.hash.startsWith('#')) return false;
  const h = new URLSearchParams(location.hash.slice(1));
  if (!h.get('access_token')) return false;

  const returnedState = h.get('state');
  const expectedState = sessionStorage.getItem('reddit_oauth_state') || '';
  if (expectedState && returnedState !== expectedState){
    logTS(`[${new Date().toLocaleTimeString()}] State mismatch`);
    history.replaceState(null, '', location.pathname + location.search);
    // continue anyway, for your app
  }

  const expiresIn = parseInt(h.get('expires_in') || '3600', 10);
  const token = {
    access_token: h.get('access_token'),
    token_type:   h.get('token_type') || 'bearer',
    expires_at:   Date.now() + expiresIn * 1000 - 5000
  };
  localStorage.setItem(TOKEN_STORE, JSON.stringify(token));
  logTS(`[${new Date().toLocaleTimeString()}] Connected to Reddit`);
  history.replaceState(null, '', location.pathname + location.search);
  return true;
}

function redditGetToken(){
  const raw = localStorage.getItem(TOKEN_STORE);
  if (!raw) return null;
  try {
    const obj = JSON.parse(raw);
    if (!obj.access_token) return null;
    if (Date.now() > obj.expires_at) { localStorage.removeItem(TOKEN_STORE); return null; }
    return obj.access_token;
  } catch {
    return null;
  }
}

async function redditEnsureAuth(){
  const tok = redditGetToken();
  if (tok) return tok;
  throw new Error('Not connected to Reddit yet');
}

async function redditAPI(path, opts = {}){
  const tok = await redditEnsureAuth();
  const url = path.startsWith('http') ? path : `https://oauth.reddit.com${path.startsWith('/') ? '' : '/'}${path}`;
  const headers = new Headers(opts.headers || {});
  headers.set('Authorization', `bearer ${tok}`);
  headers.set('User-Agent', 'CelebWall/0.1 (browser)');
  const resp = await fetch(url, { ...opts, headers });
  if (!resp.ok){
    const txt = await resp.text().catch(()=> '');
    logTS(`[${new Date().toLocaleTimeString()}] Reddit API error ${resp.status}: ${txt.slice(0,200)}`);
    throw new Error(`Reddit API ${resp.status}`);
  }
  return resp.json();
}

redditParseHash();  // run on load to catch token after redirect

document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('btnConnectReddit');
  if (btn){
    if (redditGetToken()) btn.disabled = true;
    btn.addEventListener('click', e => { e.preventDefault(); redditStartAuth(); });
  }
});
</script>