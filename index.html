<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wall v17</title>
<style>
  :root{--bg:#0b0f14;--ink:#eaf0ff;--muted:#9fb0c9;--accent:#ff6fa3;--panel:#141c28;--chip:#213048;--polaroid:#0f141f;--shadow:#000000aa}
  *{box-sizing:border-box} html,body{margin:0;height:100%;background:radial-gradient(1200px 700px at 50% -200px,#162132 0,#0b0f14 55%);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .wrap{max-width:980px;margin:16px auto 120px;padding:0 14px}
  .nav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .btn{appearance:none;border:none;cursor:pointer;border-radius:14px;padding:12px 16px;font-weight:800;background:#101824;color:var(--ink);box-shadow:0 0 0 1px #26354f inset}
  .btn.pink{background:var(--accent);color:#0b0f14} .btn.ghost{background:transparent;box-shadow:0 0 0 1px #2a3a58 inset}
  .right{margin-left:auto} .tiny{font-size:12px;color:var(--muted)}
  .badgeok{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #274064;background:#0e1726}
  .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:linear-gradient(180deg,#131b28,#0f1521);padding:12px;border-radius:16px;box-shadow:0 10px 26px var(--shadow),0 0 0 1px #ffffff10 inset}
  .counter{min-width:88px;text-align:center;font-weight:900;border-radius:12px;background:#0b1220;border:1px solid #1e2c45;padding:10px 12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:14px}
  .card{position:relative;border-radius:18px;background:var(--polaroid);box-shadow:0 24px 44px #0009,0 0 0 1px #ffffff12 inset;overflow:hidden}
  .frame{position:relative;aspect-ratio:4/5;background:#0a0f18}
  .frame img,.frame video{width:100%;height:100%;object-fit:cover;display:block}
  .badge{position:absolute;left:10px;top:10px;background:#0007;color:#fff;padding:6px 10px;border-radius:999px;font-weight:800;border:1px solid #ffffff30}
  .nsfw{left:auto;right:10px}
  .acts{display:flex;gap:10px;padding:12px;border-top:1px solid #ffffff12;background:linear-gradient(180deg,#0f141f,#0b0f16)}
  .star{width:42px;height:42px;border-radius:12px;border:1px solid #26354f;background:#0e1521;display:grid;place-items:center;font-size:22px}
  .star.liked{background:#ffe9f1;border-color:#ffc1d6;color:#9c0040}
  .pill{padding:8px 12px;border-radius:999px;background:#0e1726;color:#cfe0ff;border:1px solid #26354f}
  .hidden{display:none!important}
  .sheet{position:fixed;inset:auto 0 0 0;background:linear-gradient(180deg,#141c28,#0d141f);border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -12px 40px #000c;border-top:1px solid #ffffff12;transform:translateY(110%);transition:transform .22s ease;max-height:84vh;overflow:auto;z-index:2500}
  .sheet.open{transform:none} .hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #ffffff14;position:sticky;top:0;background:#141c28}
  .pad{padding:12px 14px}
</style>
</head>
<body>
<div class="wrap">
  <div class="nav">
    <button class="btn ghost" id="navHome">Home</button>
    <button class="btn ghost" id="navLiked">Liked ‚≠ê</button>
    <button class="btn ghost" id="navSubs">Subreddits ‚öôÔ∏è</button>
    <span class="right tiny" id="status">loading JS‚Ä¶</span>
    <a class="badgeok" href="#" id="hardReload" title="Hard refresh (cache-bust)">Reload</a>
  </div>

  <div class="bar">
    <button class="btn" id="newBatch">New batch</button>
    <button class="btn pink" id="loadMore">Load more</button>
    <div class="counter" id="count">0/0</div>
    <button class="btn" id="shuffle">Shuffle üîÄ</button>
    <button class="btn ghost right" id="trouble">Troubleshoot ü©∫</button>
  </div>

  <div class="tiny" id="bootNote"></div>
  <div class="grid" id="grid"></div>

  <div class="sheet" id="likedSheet">
    <div class="hdr"><strong>Liked</strong><button class="btn pink" id="closeLiked">Close</button></div>
    <div class="pad"><div class="grid" id="likedGrid"></div></div>
  </div>

  <div class="sheet" id="subsSheet">
    <div class="hdr"><strong>Subreddits</strong><div><button class="btn" id="resetSubs">Reset</button> <button class="btn pink" id="saveSubs">Save & Refresh</button></div></div>
    <div class="pad"><textarea id="subsBox" rows="14" style="width:100%;background:#0b121c;color:#eaf0ff;border:1px solid #24344f;border-radius:12px;padding:10px"></textarea>
      <div class="tiny" id="subsNote" style="margin-top:6px"></div></div>
  </div>

  <div class="sheet" id="troubleSheet">
    <div class="hdr"><strong>Troubleshoot</strong><button class="btn pink" id="closeTrouble">Close</button></div>
    <pre class="pad" id="diag" style="white-space:pre-wrap;margin:0"></pre>
  </div>
</div>

<script>
/* ultra-early boot marker */
document.getElementById('bootNote').textContent = 'JS file parsed. Booting‚Ä¶';

/* crash collectors (ES5) */
var __errLog=[];
window.addEventListener('error',function(e){__errLog.unshift('JS error: '+e.message); refreshDiag();});
window.addEventListener('unhandledrejection',function(e){__errLog.unshift('Promise rejection'); refreshDiag();});

/* helpers */
function $(id){return document.getElementById(id);}
function text(el, s){ if(el) el.textContent=s; }
function showSheet(id, on){ var el=$(id); if(!el) return; if(on===false){ el.classList.remove('open'); } else { el.classList.add('open'); } }

/* constants (people-only) */
var DEFAULT_SUBS=[
"EmilyRatajkowski","AnaDeArmas","AlexisRen","MadisonBeer","AddisonRae","HaileyBieber","BellaHadid",
"KylieJenner","KendallJenner","CharliDAmelio","ArianaGrande","SabrinaCarpenter","SydneySweeney",
"MargotRobbie","Zendaya","EmiliaClarke","JennaOrtega","FlorencePugh","AnyaTaylorJoy","AlexandraDaddario",
"ElizabethOlsen","GalGadot","EmmaWatson","DuaLipa","SelenaGomez","HaileeSteinfeld","SophieTurner",
"OliviaRodrigo","Halsey","LeaElui","MadelynCline","VictoriaJustice","PeytonList","ChloeMoretz",
"CamilaCabello","NinaDobrev","PhoebeDynevor","MayaHawke","Jisoo","Jennie","Lisa","RoseBlackpink",
"KarinaAESPA","WinterAESPA","BarbaraPalvin","SaraSampaio","GigiHadid","KaiaGerber","IrinaShayk"
];
var SPICY_HUBS=["InstagramBaddies","HotModels","SexyButNotPorn","NSFWCeleb"];

/* storage */
var LS_SUBS='sw_subs_v3', LS_LIKES='sw_likes_v3';
function loadSubs(){ try{var v=localStorage.getItem(LS_SUBS); return v?JSON.parse(v):DEFAULT_SUBS.slice();}catch(e){return DEFAULT_SUBS.slice();} }
function saveSubs(list){ localStorage.setItem(LS_SUBS, JSON.stringify(list)); }
function loadLikes(){ try{var v=localStorage.getItem(LS_LIKES); return v?JSON.parse(v):[];}catch(e){return [];} }
function saveLikes(list){ localStorage.setItem(LS_LIKES, JSON.stringify(list)); }

/* state */
var subs=loadSubs();
var likes=loadLikes();
var pool=[], shown=0, lastErrors=[];

/* UI wiring (plain functions) */
function bind(){
  $('navHome').onclick=function(){ showSheet('likedSheet',false); showSheet('subsSheet',false); };
  $('navLiked').onclick=function(){ renderLiked(); showSheet('likedSheet',true); };
  $('closeLiked').onclick=function(){ showSheet('likedSheet',false); };
  $('navSubs').onclick=function(){ renderSubs(); showSheet('subsSheet',true); };
  $('resetSubs').onclick=function(){ subs=DEFAULT_SUBS.slice(); saveSubs(subs); renderSubs(); };
  $('saveSubs').onclick=function(){ subs=parseSubs($('subsBox').value); saveSubs(subs); showSheet('subsSheet',false); newBatch(); };
  $('closeTrouble').onclick=function(){ showSheet('troubleSheet',false); };
  $('hardReload').onclick=function(e){ e.preventDefault(); location.replace(location.pathname+'?v='+(Date.now())); };

  $('newBatch').onclick=newBatch;
  $('loadMore').onclick=function(){ loadMore(6); };
  $('shuffle').onclick=shuffleAll;
  $('trouble').onclick=function(){ refreshDiag(); showSheet('troubleSheet',true); };
}
bind();

/* simple diag */
function diagText(){
  var s = [];
  s.push('Online: '+navigator.onLine);
  s.push('UA: '+navigator.userAgent);
  s.push('Pool size: '+pool.length+', shown: '+shown+', likes: '+likes.length);
  if (__errLog.length){ s.push('Errors:'); for(var i=0;i<__errLog.length;i++) s.push(' - '+__errLog[i]); }
  if (lastErrors.length){ s.push('Fetch notes:'); for(i=0;i<lastErrors.length;i++) s.push(' - '+lastErrors[i]); }
  return s.join('\n');
}
function refreshDiag(){ text($('diag'), diagText()); }

/* helpers */
function parseSubs(t){
  var lines=t.split(/\r?\n/), out=[], seen={};
  for(var i=0;i<lines.length;i++){ var s=lines[i].trim().replace(/^r\//i,''); if(s && !seen[s]){ seen[s]=1; out.push(s); } }
  return out;
}
function setCount(){ text($('count'), shown+'/'+pool.length); }

/* fetchers (no async/await) */
function subUrls(sub){
  var s=encodeURIComponent(sub);
  return [
    'https://www.reddit.com/r/'+s+'/hot.json?limit=25&raw_json=1',
    'https://www.reddit.com/r/'+s+'/top.json?limit=25&t=day&raw_json=1',
    'https://api.reddit.com/r/'+s+'/hot?limit=25&raw_json=1',
    'https://r.jina.ai/http://www.reddit.com/r/'+s+'/hot.json?limit=25&raw_json=1'
  ];
}
function fetchOne(sub){
  var urls=subUrls(sub);
  var attempt=0;

  function tryUrl(idx){
    if(idx>=urls.length) return Promise.reject('no url worked');
    return fetch(urls[idx],{cache:'no-store',credentials:'omit',headers:{'Accept':'application/json'}})
      .then(function(r){ if(!r.ok) throw new Error('status '+r.status); return r.json(); })
      .then(function(json){
        var kids=json && json.data && json.data.children ? json.data.children : [];
        var out=[], k, d, src, kind, p, rv, url;
        for(k=0;k<kids.length;k++){
          d=kids[k].data; if(!d || d.is_self || d.is_gallery) continue;
          src=null; kind='img'; url=(d.url||'');
          rv = d.secure_media && d.secure_media.reddit_video && d.secure_media.reddit_video.fallback_url ||
               d.media && d.media.reddit_video && d.media.reddit_video.fallback_url;
          if(rv){ src=rv; kind='vid'; }
          else if(/\.(mp4|webm|gifv)(\?|$)/i.test(url)){ src=url.replace(/\.gifv$/i,'.mp4'); kind='vid'; }
          else{
            p = d.preview && d.preview.images && d.preview.images[0] && d.preview.images[0].source && d.preview.images[0].source.url;
            if(p){ src=p.replace(/&amp;/g,'&'); }
            else if(/\.(jpe?g|png|webp)(\?|$)/i.test(url)){ src=url; }
          }
          if(!src) continue;
          out.push({id:d.id,sub:d.subreddit,nsfw:!!d.over_18,media:{type:kind,src:src},permalink:'https://reddit.com'+d.permalink});
        }
        if(out.length) return out;
        lastErrors.unshift(sub+': no media'); return Promise.reject('no media');
      })
      .catch(function(){ return tryUrl(idx+1); });
  }

  function attemptLoop(){
    return tryUrl(0).catch(function(err){
      attempt++; if(attempt<3){ return new Promise(function(res){ setTimeout(function(){ res(attemptLoop()); }, 600*attempt); }); }
      lastErrors.unshift(sub+': '+err); return [];
    });
  }
  return attemptLoop();
}

/* build, shuffle, render */
function newBatch(){
  pool=[]; shown=0; setCount(); lastErrors=[];
  text($('bootNote'),'Building batch‚Ä¶');
  var names = subs && subs.length ? subs.slice() : DEFAULT_SUBS.slice();
  names.sort(function(){return Math.random()-0.5;});
  var picks=[], i, pickCount=Math.min(10, Math.max(6,names.length));
  for(i=0;i<pickCount;i++){
    if(Math.random()<0.2 && SPICY_HUBS.length) picks.push(SPICY_HUBS[Math.floor(Math.random()*SPICY_HUBS.length)]);
    else picks.push(names[i]);
  }
  // unique
  var seen={}, uniq=[]; for(i=0;i<picks.length;i++){ if(!seen[picks[i]]){ seen[picks[i]]=1; uniq.push(picks[i]); } }

  var chain = Promise.resolve();
  uniq.forEach(function(s){
    chain = chain.then(function(){ return fetchOne(s); })
      .then(function(items){ if(items && items.length){ items.sort(function(){return Math.random()-0.5;}); pool=pool.concat(items.slice(0,6)); setCount(); } })
      .catch(function(){ /* ignore */ });
  });
  chain.then(function(){
    // dedupe by id
    var seenId={}, out=[]; for(i=0;i<pool.length;i++){ var p=pool[i]; if(!seenId[p.id]){ seenId[p.id]=1; out.push(p);} }
    pool=out.sort(function(){return Math.random()-0.5;});
    text($('bootNote'), pool.length? 'ready' : 'No fresh posts. Tap New batch.');
  });
}
function loadMore(n){
  if(!pool.length){ text($('bootNote'),'Nothing queued. Tap New batch.'); return; }
  var take=pool.slice(shown, shown+n);
  for(var i=0;i<take.length;i++){ $('grid').appendChild(renderCard(take[i])); }
  shown+=take.length; setCount();
}
function shuffleAll(){
  var nodes=[].slice.call($('grid').children);
  nodes.sort(function(){return Math.random()-0.5;}).forEach(function(n){ $('grid').appendChild(n); });
  text($('bootNote'),'Shuffled');
}

/* render card (no swipe = tap star for now to stay simple) */
function renderCard(p){
  var card=document.createElement('div'); card.className='card';
  var fr=document.createElement('div'); fr.className='frame';
  if(p.media.type==='vid'){
    var v=document.createElement('video'); v.src=p.media.src; v.autoplay=true; v.loop=true; v.muted=true; v.playsInline=true; v.controls=false; fr.appendChild(v);
  }else{ var img=new Image(); img.loading='lazy'; img.src=p.media.src; fr.appendChild(img); }
  var b=document.createElement('div'); b.className='badge'; b.textContent='r/'+p.sub; fr.appendChild(b);
  if(p.nsfw){ var n=document.createElement('div'); n.className='badge nsfw'; n.textContent='NSFW'; fr.appendChild(n); }
  card.appendChild(fr);

  var acts=document.createElement('div'); acts.className='acts';
  var star=document.createElement('button'); star.className='star'; star.textContent='‚≠ê';
  if(indexOfLike(p.id)>=0) star.classList.add('liked');
  star.onclick=function(){ toggleLike(p,star); };
  var open=document.createElement('a'); open.className='pill'; open.target='_blank'; open.rel='noopener'; open.href=p.permalink; open.textContent='Reddit';
  acts.appendChild(star); acts.appendChild(open); card.appendChild(acts);
  return card;
}

/* likes */
function indexOfLike(id){ for(var i=0;i<likes.length;i++){ if(likes[i].id===id) return i; } return -1; }
function toggleLike(p,star){
  var i=indexOfLike(p.id);
  if(i>=0){ likes.splice(i,1); if(star) star.classList.remove('liked'); }
  else { likes.unshift(p); if(star) star.classList.add('liked'); }
  saveLikes(likes);
}
function renderLiked(){
  var g=$('likedGrid'); g.innerHTML='';
  if(!likes.length){ g.innerHTML='<div class="tiny">No likes yet.</div>'; return; }
  for(var i=0;i<likes.length;i++){ g.appendChild(renderCard(likes[i])); }
}

/* subs page */
function renderSubs(){ $('subsBox').value=(subs && subs.length? subs: DEFAULT_SUBS).join('\n'); $('subsNote').textContent=(subs?subs.length:DEFAULT_SUBS.length)+' subs'; }

/* kick it */
text($('status'),'booting‚Ä¶');
newBatch();                 /* create a first pool */
setTimeout(function(){ text($('status'),'ready'); }, 400);
</script>
</body>
</html>