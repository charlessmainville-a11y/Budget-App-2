<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Celeb Wall v2.0</title>
<style>
  :root{
    --bg:#0d0f12; --card:#14171c; --glass:#181c22cc; --ink:#e9eef7;
    --muted:#9aa4b2; --good:#20e3b2; --bad:#ff6b8f;
    --gradA:#a6b1ff; --gradB:#8be3ff; --gradC:#ffa8d8;
    --shadow:0 10px 40px rgba(0,0,0,.35);
    --radius:18px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 50% -10%, #1a1f27 0%, #0d0f12 55%); color:var(--ink); font:600 18px/1.35 ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Inter, "SF Pro Rounded", "SF Pro Text", Arial}
  .wrap{max-width:900px;margin:0 auto;padding:18px 14px 80px}

  /* Dashboard */
  .grid{display:grid;gap:14px}
  .kpis{grid-template-columns:repeat(4,minmax(0,1fr))}
  .kpi{background:linear-gradient(180deg,#14171c,#101318); border-radius:22px;padding:16px 18px; box-shadow:var(--shadow)}
  .kpi h5{margin:0 0 6px;font-size:14px;letter-spacing:.18em;color:var(--muted)}
  .kpi b{font-size:30px}
  .bar{height:14px;background:#1b2028;border-radius:999px; margin:14px 0 6px; position:relative; overflow:hidden}
  .bar>i{position:absolute;inset:0 0 0 auto;width:0;background:linear-gradient(90deg,var(--gradA),var(--gradB),var(--gradC));border-radius:999px}
  .status{display:flex;justify-content:space-between;color:var(--muted);font-weight:700}

  .actions{display:grid;grid-template-columns:repeat(3,minmax(0,1fr)); gap:14px; margin:16px 0 6px}
  .btn{border:0;outline:0;background:linear-gradient(180deg,#1a1f25,#13171e); color:#eaf0fb; padding:16px 18px; border-radius:999px; box-shadow:var(--shadow); font:700 18px/1 ui-rounded,system-ui}
  .btn.primary{background:linear-gradient(90deg,var(--gradA),var(--gradC)); color:#0b0e13}
  .btn.ghost{background:#151a22}
  .btn:active{transform:translateY(1px)}

  /* Feed cards */
  .card{background:linear-gradient(180deg,#161a20,#12161c); border-radius:28px; padding:12px; margin:20px 0; box-shadow:var(--shadow); overflow:hidden}
  .polaroid{position:relative;border-radius:22px;overflow:hidden;background:#0b0e13}
  .hdr{
    position:absolute; left:12px; right:12px; top:12px;
    padding:14px 16px;border-radius:14px;
    background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.2));
    backdrop-filter: blur(8px);
    color:#fff;font-weight:800;text-shadow:0 2px 12px rgba(0,0,0,.45);
  }
  .hdr small{display:block;color:#c7cfdb;font-weight:700;margin-top:4px}
  .media{display:block;width:100%;height:auto;max-height:78vh;object-fit:cover;background:#0b0e13}
  .videoWrap{position:relative}
  .playHint{position:absolute;inset:auto 0 12px; margin:auto; width:78px;height:78px;border-radius:999px;background:linear-gradient(180deg,#222, #111); opacity:.9; display:grid;place-items:center}
  .playHint:before{content:"▶";font-size:30px;color:#fff;margin-left:4px}
  .stack{display:flex; gap:14px; padding:14px 4px 4px}
  .pill{flex:1;text-align:center;padding:18px 10px;border-radius:20px;font:900 22px/1 ui-rounded,system-ui;letter-spacing:.02em;color:#0b0e13}
  .pill.like{background:linear-gradient(90deg,#21d4fd,#20e3b2)}
  .pill.dislike{background:linear-gradient(90deg,#ff7eb3,#ff758c)}
  .fadeOut{animation:fade .35s ease both}
  .pop{animation:pop .38s cubic-bezier(.2,.8,.2,1)}
  @keyframes fade{to{opacity:0; transform:translateY(8px)}}
  @keyframes pop{0%{transform:scale(.98)}70%{transform:scale(1.02)}100%{transform:scale(1)}}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45); z-index:50}
  .sheet{width:min(760px,92vw);max-height:80vh;overflow:auto;background:linear-gradient(180deg,#161a20,#12161c); border-radius:22px;padding:18px; box-shadow:var(--shadow)}
  .sheet h3{margin:0 0 10px}
  .sheet pre{white-space:pre-wrap;background:#0e1217;border-radius:14px;padding:14px;font:600 14px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row input, .row textarea{flex:1; min-width:220px; background:#0f1319;border:1px solid #202733;color:#dfe6f3;border-radius:12px;padding:12px 14px;font:600 16px ui-rounded}
  .tag{display:inline-block;padding:6px 10px;border-radius:12px;background:#0f1319;border:1px solid #202733;color:#b7c2d3;font-weight:700;margin:6px 8px 0 0}
</style>
</head>
<body>
<div class="wrap">
  <!-- KPIs -->
  <div class="grid kpis">
    <div class="kpi"><h5>BUILD</h5><b id="kBuild">v2.0</b></div>
    <div class="kpi"><h5>SHOWN</h5><b id="kShown">0</b></div>
    <div class="kpi"><h5>POOL</h5><b id="kPool">0</b></div>
    <div class="kpi"><h5>TOTAL</h5><b id="kTotal">0</b></div>
  </div>

  <!-- Progress -->
  <div class="bar"><i id="barFill"></i></div>
  <div class="status"><span id="statusText">Ready</span><span id="statusPct">100%</span></div>

  <!-- Controls -->
  <div class="actions">
    <button class="btn" id="btnHome">Home</button>
    <button class="btn" id="btnLikes">Likes</button>
    <button class="btn" id="btnDiscard">Discard</button>

    <button class="btn primary" id="btnBatch">New batch</button>
    <button class="btn" id="btnShuffle">Shuffle feed</button>
    <button class="btn" id="btnMore">Load more</button>

    <button class="btn" id="btnSubs">+ Subreddits</button>
    <button class="btn ghost" id="btnConnect">Connect Reddit</button>
    <button class="btn ghost" id="btnTrouble">Troubleshoot</button>
  </div>

  <!-- Feed -->
  <div id="feed"></div>
</div>

<!-- Subreddits modal -->
<div class="modal" id="subsModal">
  <div class="sheet">
    <h3>Subreddits</h3>
    <p class="row">
      <textarea id="subsInput" rows="4" placeholder="Paste names or r/Names… separated by comma/space"></textarea>
    </p>
    <div class="row">
      <button class="btn primary" id="saveSubs">Save</button>
      <button class="btn" id="closeSubs">Close</button>
    </div>
    <div id="subsChips"></div>
  </div>
</div>

<!-- Troubleshoot modal -->
<div class="modal" id="logModal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between">
      <h3>Troubleshoot</h3>
      <button class="btn" id="closeLog">Close</button>
    </div>
    <pre id="logBox"></pre>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const APP = {
  BUILD: 'v2.0-stable',
  CLIENT_ID: 'D_nzkiZhFVjFgNs_sqCQ3Q', // your installed app id
  REDIRECT_URI: 'https://charlessmainville-a11y.github.io/Budget-App-2/', // must match Reddit app
  SCOPE: 'read identity',
  OAUTH_URL(){
    const p = new URLSearchParams({
      client_id: this.CLIENT_ID,
      response_type: 'token',
      state: crypto.getRandomValues(new Uint32Array(1))[0].toString(36),
      redirect_uri: this.REDIRECT_URI,
      duration: 'temporary',
      scope: this.SCOPE
    });
    return `https://old.reddit.com/api/v1/authorize?${p}`;
  }
};

// defaults (no wrestling)
const DEFAULT_SUBS = [
  'celebs','celebevents','celebritypics','celebgowns','charlidameliomommy',
  'leaeluiginet','leaeluig_nr','gonewildcelebs','celebface','celebfashion',
  'modelsgonewild','celebnipslips','celeboutfits','emrata','kendalljenner',
  'salmahayek','natalieportman','alexandradaddario'
];

/* ===================== STATE ===================== */
let token = null;
let subs = [];
let pool = [];     // items not shown yet
let shown = [];    // items already rendered
let mode = 'home'; // home|likes|discard
let loading = false;

/* ================== UTIL & SANITIZER ============== */
function $(q,root=document){ return root.querySelector(q); }
function el(tag, cls){ const n=document.createElement(tag); if(cls) n.className=cls; return n; }

function setStatus(text, pct=100){
  $('#statusText').textContent = text;
  $('#statusPct').textContent = `${Math.max(0, Math.min(100, pct))}%`;
  $('#barFill').style.width = `${pct}%`;
}
function kpi(){ $('#kBuild').textContent = APP.BUILD; $('#kShown').textContent = shown.length; $('#kPool').textContent = pool.length; $('#kTotal').textContent = shown.length + pool.length; }

function log(s){ const t=new Date().toLocaleTimeString(); $('#logBox').textContent = `[${t}] ${s}\n` + $('#logBox').textContent; }

/** Sanitizes arbitrary subreddit input -> array of valid names */
function normalizeSubs(input){
  return [...new Set(
    String(input||'')
      .split(/[,\s]+/)
      .map(s=>s.trim().replace(/^r\//i,'').toLowerCase())
      .filter(Boolean)
      .map(s=>s.replace(/[^a-z0-9_]/g,''))  // keep only valid chars
      .filter(s=>/^[a-z0-9_]{2,21}$/.test(s))
  )];
}
/* sanitize whatever is saved once on load */
function loadSubs(){
  const saved = JSON.parse(localStorage.getItem('cw.subs')||'[]');
  const cleaned = normalizeSubs(saved.length ? saved.join(' ') : DEFAULT_SUBS.join(' '));
  localStorage.setItem('cw.subs', JSON.stringify(cleaned));
  subs = cleaned;
}

/* ================ OAUTH =================== */
function readTokenFromHash(){
  if(location.hash.includes('access_token=')){
    const h = new URLSearchParams(location.hash.slice(1));
    const tk = h.get('access_token'); const exp = +h.get('expires_in')||3600;
    const until = Date.now() + (exp*1000);
    localStorage.setItem('cw.token', JSON.stringify({ token: tk, until }));
    history.replaceState({}, document.title, location.pathname); // clean hash
    log('OAuth: token captured.');
  }
}
function getToken(){
  const raw = localStorage.getItem('cw.token');
  if(!raw) return null;
  try{
    const obj = JSON.parse(raw);
    if(!obj?.token) return null;
    if(Date.now() > obj.until){ log('OAuth: token expired.'); return null; }
    return obj.token;
  }catch{ return null; }
}
function ensureTokenUI(){
  token = getToken();
  $('#btnConnect').style.display = token ? 'none':'block';
}
$('#btnConnect').onclick = ()=>{ location.href = APP.OAUTH_URL(); };

/* ================ FETCH ================ */
async function fetchSub(sub){
  const s = normalizeSubs(sub)[0];
  if(!s) return [];
  const url = `https://oauth.reddit.com/r/${s}/hot?limit=40&raw_json=1`;
  const res = await fetch(url, { headers:{ 'Authorization': `Bearer ${token}`, 'User-Agent':'celebwall/2.0 (by u/No-Appointment-479)' }});
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  const items = [];
  for(const c of data?.data?.children ?? []){
    const p = c.data;
    // only posts with media-ish
    let img = null, isVideo=false, videoUrl=null;
    if(p.post_hint === 'image' && p.url){
      img = p.url;
    }else if(p.is_video && p.media?.reddit_video?.fallback_url){
      isVideo = true; videoUrl = p.media.reddit_video.fallback_url;
      img = p.thumbnail && p.thumbnail.startsWith('http') ? p.thumbnail : null;
    }else if(/(\.jpg|\.jpeg|\.png|\.gif)$/i.test(p.url||'')){
      img = p.url;
    }
    if(!img && !isVideo) continue;

    items.push({
      id: p.id,
      author: `u/${p.author}`,
      sub: `r/${p.subreddit}`,
      title: p.title,
      url: img || videoUrl,
      isVideo,
      videoUrl
    });
  }
  return items;
}

async function buildBatch(){
  if(!token){ setStatus('Connect Reddit', 100); log('No token – press Connect Reddit'); return; }
  if(loading) return;
  loading = true;
  setStatus('Requesting', 10);
  pool = [];
  const per=100 / Math.max(1, subs.length);
  for(let i=0;i<subs.length;i++){
    const s = subs[i];
    try{
      const items = await fetchSub(s);
      pool.push(...items);
      setStatus(`Loaded ${pool.length}…`, Math.min(95, 10 + per*(i+1)));
      log(`Loaded ${items.length} from /r/${s}`);
    }catch(e){
      log(`✖ /r/${s}: ${e.message||e}`);
    }
  }
  shuffle(pool);
  setStatus('Ready', 100);
  kpi();
  loading = false;
  if(pool.length) loadMore();
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* =============== RENDER =============== */
function renderItem(it){
  const card = el('div','card pop');
  const pol = el('div','polaroid');
  const hdr = el('div','hdr');
  hdr.innerHTML = `<div>${escapeHtml(it.author)}</div><small>${escapeHtml(it.sub)}</small>`;
  pol.appendChild(hdr);

  if(it.isVideo){
    const wrap = el('div','videoWrap');
    const vid = document.createElement('video');
    vid.className='media';
    vid.src = it.videoUrl;
    vid.preload='metadata'; vid.muted=true; vid.playsInline=true; vid.controls=false;
    const hint = el('div','playHint');
    wrap.append(vid,hint);
    wrap.addEventListener('click', ()=>{
      if(vid.paused){ vid.play(); hint.style.display='none'; }
      else { vid.pause(); hint.style.display='grid'; }
    });
    pol.appendChild(wrap);
  }else{
    const img = el('img','media');
    img.loading='lazy'; img.alt = it.title||''; img.src = it.url;
    pol.appendChild(img);
  }

  const stack = el('div','stack');
  const dis = el('div','pill dislike'); dis.textContent='Dismiss';
  const lik = el('div','pill like');    lik.textContent='Like';
  stack.append(dis, lik);

  dis.onclick = ()=>act(card,it,'discard');
  lik.onclick = ()=>act(card,it,'like');

  card.append(pol, stack);
  $('#feed').appendChild(card);
}

function act(card,item, kind){
  card.classList.add(kind==='like'?'pop':'fadeOut');
  // store
  const key = kind==='like' ? 'cw.likes' : 'cw.discard';
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  arr.unshift(item);
  localStorage.setItem(key, JSON.stringify(arr));
  // remove from feed
  setTimeout(()=>card.remove(), 250);
}

function loadMore(n=20){
  const take = pool.splice(0, n);
  shown.push(...take);
  for(const it of take) renderItem(it);
  kpi();
}

/* =============== VIEWS =============== */
function showHome(){
  mode='home'; $('#feed').innerHTML=''; shown=[]; kpi(); loadMore(12);
}
function showLikes(){
  mode='likes'; $('#feed').innerHTML=''; const arr=JSON.parse(localStorage.getItem('cw.likes')||'[]'); for(const it of arr) renderItem(it);
}
function showDiscard(){
  mode='discard'; $('#feed').innerHTML=''; const arr=JSON.parse(localStorage.getItem('cw.discard')||'[]'); for(const it of arr) renderItem(it);
}

/* =============== SUBS UI =============== */
function openSubs(){
  $('#subsInput').value = subs.join(', ');
  renderChips();
  $('#subsModal').style.display='grid';
}
function renderChips(){
  const box = $('#subsChips'); box.innerHTML='';
  for(const s of subs){
    const t=el('span','tag'); t.textContent=s; box.appendChild(t);
  }
}

/* =============== HELPERS =============== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* =============== EVENTS =============== */
$('#btnBatch').onclick = buildBatch;
$('#btnShuffle').onclick = ()=>{ shuffle(pool); showHome(); };
$('#btnMore').onclick = ()=> loadMore(12);
$('#btnHome').onclick = showHome;
$('#btnLikes').onclick = showLikes;
$('#btnDiscard').onclick = showDiscard;

$('#btnSubs').onclick = openSubs;
$('#closeSubs').onclick = ()=> $('#subsModal').style.display='none';
$('#saveSubs').onclick = ()=>{
  const cleaned = normalizeSubs($('#subsInput').value);
  subs = cleaned;
  localStorage.setItem('cw.subs', JSON.stringify(cleaned));
  renderChips();
  $('#subsModal').style.display='none';
  log(`Saved ${cleaned.length} subs`);
};

$('#btnTrouble').onclick = ()=> $('#logModal').style.display='grid';
$('#closeLog').onclick = ()=> $('#logModal').style.display='none';

/* Infinite-ish scroll */
addEventListener('scroll', ()=>{
  if(mode!=='home') return;
  const near = (innerHeight + scrollY) > (document.body.offsetHeight - 1200);
  if(near && pool.length && !loading) loadMore(10);
});

/* =============== BOOT =============== */
readTokenFromHash();
ensureTokenUI();
loadSubs();
kpi();
setStatus('Ready',100);

/* If you already have a token and want content immediately: */
if(getToken()){
  token = getToken();
  buildBatch();
}

/* =============== END =============== */
</script>
</body>
</html>