<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Celeb Wall — v2.8.1-stable</title>
<style>
  :root{
    --bg: #0c0f14;
    --glass: rgba(255,255,255,.06);
    --glass-2: rgba(255,255,255,.12);
    --ink: #dfe6f3;
    --ink-dim:#aeb7c6;
    --ink-sub:#8a93a3;
    --pill-shadow: 0 8px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
    --gradA: linear-gradient(135deg,#B3A6FF 0%, #8ED1F5 50%, #F7A7C1 100%);
    --gradLike: linear-gradient(135deg,#29c6b7 0%,#53e1d3 100%);
    --gradNope: linear-gradient(135deg,#ff5a76 0%,#ff8aa0 100%);
    --btnGrad: linear-gradient(135deg,#8aa7ff 0%,#b694ff 60%,#ff9ac6 100%);
    --glass-blur: blur(14px);
    --card-radius: 20px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-rounded, "SF Pro Rounded", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--ink);
    background: radial-gradient(1200px 600px at 10% -10%,#1b2231 0%,transparent 60%),
                radial-gradient(1200px 600px at 110% -10%,#271a27 0%,transparent 60%),
                var(--bg);
    background-attachment: fixed;
  }
  .page{max-width:900px;margin:0 auto;padding:20px 14px 80px}
  header{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;align-items:stretch}
  .pill{
    border-radius:16px;
    background:var(--glass);
    box-shadow:var(--pill-shadow);
    padding:18px 16px;
    text-align:center;
    backdrop-filter:var(--glass-blur);
  }
  .pill .k{display:block;font-weight:700;letter-spacing:.06em;color:var(--ink-dim)}
  .pill .v{display:block;font-size:34px;font-weight:900;letter-spacing:.02em}
  .meter-wrap{margin:22px 0 10px}
  .meter{
    height:12px;border-radius:12px;background:rgba(255,255,255,.06);overflow:hidden;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  }
  .meter > i{
    display:block;height:100%;width:0%;
    background: var(--gradA);
    transition: width .25s ease;
  }
  .stage{display:flex;justify-content:space-between;gap:10px;color:var(--ink-sub);font-weight:800}
  .toolbar{
    margin:20px 0 6px;display:grid;grid-template-columns:1fr 1fr;gap:14px
  }
  .btn{
    border:none;border-radius:16px;padding:18px 18px;font-size:20px;font-weight:800;
    color:var(--ink);background:var(--glass);box-shadow:var(--pill-shadow);backdrop-filter:var(--glass-blur);
    cursor:pointer;transition:transform .04s ease, filter .2s ease, background .2s ease;
  }
  .btn:active{transform:translateY(1px) scale(.99)}
  .btn.primary{background:var(--glass-2)}
  .btn.grad{background:var(--btnGrad)}
  .btn.full{grid-column:1 / -1}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  /* Cards */
  .cards{display:grid;gap:24px;margin-top:18px}
  .card{
    border-radius:var(--card-radius);
    background: rgba(255,255,255,.04);
    box-shadow: 0 14px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
    overflow:hidden; position:relative; backdrop-filter: var(--glass-blur);
  }
  .titleBar{
    position:absolute;left:0;right:0;top:0;padding:14px 16px;
    display:flex;justify-content:space-between;gap:8px;align-items:center;
    background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,0));
    color:#fff;font-weight:900;letter-spacing:.02em;text-shadow:0 1px 0 rgba(0,0,0,.5);
  }
  .media{width:100%;display:block;background:#0a0d12;min-height:260px;object-fit:cover}
  .cardFooter{
    display:flex;justify-content:space-between;gap:12px;padding:14px;background:rgba(0,0,0,.28)
  }
  .act{
    flex:1;border:none;border-radius:14px;padding:14px 16px;font-size:18px;font-weight:900;color:#0b1114;
    cursor:pointer;background:var(--glass);backdrop-filter:var(--glass-blur);
  }
  .act.like{background:var(--gradLike)}
  .act.nope{background:var(--gradNope)}
  .source{font-weight:800;color:var(--ink-sub)}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter: blur(6px);z-index:40}
  .modal.show{display:flex}
  .sheet{
    width:min(800px,92vw);max-height:86vh;overflow:auto;border-radius:20px;padding:16px 16px 8px;
    background:rgba(20,22,28,.92);box-shadow:0 20px 60px rgba(0,0,0,.6)
  }
  .sheet .hd{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
  .close{border:none;border-radius:14px;background:var(--btnGrad);padding:10px 16px;color:#fff;font-weight:900;cursor:pointer}
  pre{white-space:pre-wrap;font-size:15px;line-height:1.5em;color:#cfe2ff}
  /* Helpers */
  .muted{color:var(--ink-sub)}
  .hide{display:none!important}
  .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .badge{background:rgba(255,255,255,.08);padding:6px 10px;border-radius:999px;font-weight:800}
</style>
</head>
<body>
  <div class="page">
    <header>
      <div class="pill"><span class="k">BUILD</span><span class="v" id="build">v2.8.1</span></div>
      <div class="pill"><span class="k">SHOWN</span><span class="v" id="shown">0</span></div>
      <div class="pill"><span class="k">POOL</span><span class="v" id="pool">0</span></div>
      <div class="pill"><span class="k">TOTAL</span><span class="v" id="total">0</span></div>
    </header>

    <div class="meter-wrap">
      <div class="meter"><i id="bar"></i></div>
      <div class="stage"><span id="stageL">Idle</span><span id="stageR">0%</span></div>
    </div>

    <div class="toolbar">
      <button class="btn" id="homeBtn">Home</button>
      <button class="btn" id="likesBtn">⭐ Likes <span class="badge" id="likesCount">0</span></button>
      <button class="btn grad" id="newBtn">New batch</button>
      <button class="btn" id="shuffleBtn">Shuffle feed</button>
      <button class="btn full" id="loadBtn">Load more</button>
      <button class="btn full" id="sourcesBtn">r/celebs + more</button>
      <button class="btn full" id="troubleBtn">Troubleshoot</button>
    </div>

    <section id="cards" class="cards"></section>
  </div>

  <!-- Troubleshoot -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="hd">
        <div class="pill" style="padding:10px 14px;font-weight:900">Troubleshoot</div>
        <button class="close" id="closeModal">Close</button>
      </div>
      <pre id="log"></pre>
    </div>
  </div>

<script>
(() => {
  /*** CONFIG **************************************************************/
  const BUILD = 'v2.8.1-stable';
  const SUBS = [
    'Celebs','celebrityhotties','BeautifulCelebrities','celebrity_armpits',
    'celebritylegs','LadiesOfWrestling','ModelsofReddit','thecelebrityclub'
  ];
  const BATCH_SIZE = 3;       // subs to hit per pass
  const ITEMS_PER_FETCH = 25; // per sub request
  const BASE = 'https://r.jina.ai/http://www.reddit.com';
  const PROGRESS_STEPS = ['Queueing','Requesting','Parsing','Filtering','Ready'];
  const IMAGE_OK = ['.jpg','.jpeg','.png','.gif','.gifv','.webp'];

  /*** STATE ***************************************************************/
  const state = {
    mode: 'home',          // 'home' | 'likes'
    pool: [],              // unseen cards
    shown: 0,
    total: 0,
    likes: loadLikes(),    // [{id,url,title,sub}]
    dismissed: loadDismissed(), // Set of post ids
    fetching: false,
    backoffMs: 1200,       // exponential backoff base
    subCursor: {},         // sub -> after
    rotating: 0            // start index for sub batch
  };

  /*** DOM *****************************************************************/
  const $cards = qs('#cards');
  const $shown = qs('#shown');
  const $pool = qs('#pool');
  const $total = qs('#total');
  const $build = qs('#build');
  const $bar = qs('#bar');
  const $stageL = qs('#stageL');
  const $stageR = qs('#stageR');
  const $likesCount = qs('#likesCount');
  const $modal = qs('#modal'), $log = qs('#log');

  $build.textContent = BUILD;
  $likesCount.textContent = state.likes.length;

  on('#homeBtn','click',() => { state.mode='home'; repaint(); });
  on('#likesBtn','click',() => { state.mode='likes'; repaint(true); });
  on('#newBtn','click',() => { resetAndFetch(); });
  on('#shuffleBtn','click',() => { shuffle(state.pool); repaint(); toast('Shuffled'); });
  on('#loadBtn','click',() => { ensurePool(12); });
  on('#sourcesBtn','click',() => { toast('Sources: ' + SUBS.join(', ')); });
  on('#troubleBtn','click',() => { $modal.classList.add('show'); });
  on('#closeModal','click',() => { $modal.classList.remove('show'); });

  /*** HELPERS *************************************************************/
  function qs(s, el=document){ return el.querySelector(s); }
  function on(sel,evt,fn){ qs(sel).addEventListener(evt,fn); }
  function log(line){
    const t = new Date().toLocaleTimeString();
    $log.textContent += `\n[${t}] ${line}`;
    $log.scrollTop = $log.scrollHeight;
    console.debug(line);
  }
  function stage(i, pctText){
    $stageL.textContent = PROGRESS_STEPS[i]||'Idle';
    if (pctText!==undefined) $stageR.textContent = pctText;
    $bar.style.width = pctText||'0%';
  }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  function extOK(url){ const u = url.split('?')[0].toLowerCase(); return IMAGE_OK.some(e=>u.endsWith(e)); }
  function fixGif(url){ return url.endsWith('.gifv') ? url.replace('.gifv','.mp4') : url; }
  function saveLikes(a){ localStorage.setItem('cw_likes', JSON.stringify(a)); }
  function loadLikes(){ try{ return JSON.parse(localStorage.getItem('cw_likes')||'[]'); }catch{ return []; } }
  function saveDismissed(set){ localStorage.setItem('cw_nope', JSON.stringify([...set])); }
  function loadDismissed(){ try{ return new Set(JSON.parse(localStorage.getItem('cw_nope')||'[]')); }catch{ return new Set(); } }
  function toast(msg){ log(msg); }

  function repaint(forceLikes=false){
    $shown.textContent = String(state.shown);
    $pool.textContent = String(state.pool.length);
    $total.textContent = String(state.total);
    $likesCount.textContent = state.likes.length;

    $cards.innerHTML = '';
    const list = (state.mode==='likes'||forceLikes) ? state.likes : state.pool;
    list.forEach(addCard);
  }

  function addCard(item){
    const card = document.createElement('article');
    card.className = 'card';
    card.dataset.id = item.id;

    const titleBar = document.createElement('div');
    titleBar.className='titleBar';
    titleBar.innerHTML = `<div>${item.title || item.author || '—'}</div><div class="source">r/${item.sub}</div>`;

    const media = document.createElement(item.url.endsWith('.mp4') ? 'video' : 'img');
    media.className='media';
    media.src = item.url;
    if (media.tagName==='VIDEO'){ media.controls=true; media.loop=true; media.muted=true; media.playsInline=true; }

    const foot = document.createElement('div'); foot.className='cardFooter';
    const nope = document.createElement('button'); nope.className='act nope'; nope.textContent='Dismiss';
    const like = document.createElement('button'); like.className='act like'; like.textContent='Like';
    foot.append(nope, like);

    nope.addEventListener('click', () => {
      state.dismissed.add(item.id); saveDismissed(state.dismissed);
      if (state.mode==='likes') { /* ignore on likes view */ } else {
        state.pool = state.pool.filter(x=>x.id!==item.id);
        repaint();
      }
    });
    like.addEventListener('click', () => {
      if (!state.likes.some(x=>x.id===item.id)){ state.likes.unshift(item); saveLikes(state.likes); }
      state.pool = state.pool.filter(x=>x.id!==item.id);
      repaint();
    });

    card.append(titleBar, media, foot);
    $cards.append(card);
  }

  /*** FETCH LOGIC **********************************************************/
  async function resetAndFetch(){
    state.fetching=false;
    state.pool.length=0;
    state.shown=0;
    state.total=0;
    state.subCursor = {};
    state.rotating = 0;
    repaint();
    await ensurePool(18);
  }

  async function ensurePool(minCount){
    if (state.fetching) return;
    if (state.pool.length>=minCount){ repaint(); return; }
    state.fetching=true;

    stage(0,'12%'); // Queueing
    const startIdx = state.rotating;
    const batch = [];
    for (let i=0;i<BATCH_SIZE;i++){
      batch.push(SUBS[(startIdx+i) % SUBS.length]);
    }
    state.rotating = (startIdx + BATCH_SIZE) % SUBS.length;
    log('Building new batch… ('+ batch.join(', ') +')');

    stage(1,'22%'); // Requesting

    // Request serially with backoff to behave nicely
    const found = [];
    for (const sub of batch){
      const items = await pullFromSub(sub).catch(e => { log(`× r/${sub}: ${e.message||e}`); return []; });
      found.push(...items);
      await sleep(450); // small spacing
    }

    stage(2,'55%'); // Parsing (already parsed, but keep the UX)

    const filtered = found.filter(it => {
      if (!it.url) return false;
      if (!extOK(it.url)) return false;
      if (state.dismissed.has(it.id)) return false;
      if (state.likes.some(x=>x.id===it.id)) return false;
      return true;
    }).map(it => ({...it, url: fixGif(it.url)}));

    stage(3,'78%'); // Filtering

    state.pool.push(...filtered);
    state.total += filtered.length;
    state.shown += 0;
    repaint();

    stage(4,'100%'); // Ready
    setTimeout(()=>stage(0,'0%'),500);

    state.fetching=false;
    if (state.pool.length < minCount) {
      // recurse lightly to top-up
      await sleep(600);
      return ensurePool(minCount);
    }
  }

  async function pullFromSub(sub){
    // prefer images in last month, restrict subreddit
    const params = new URLSearchParams({
      q: '(url:.jpg OR url:.jpeg OR url:.png OR url:.gif OR url:.gifv OR site:i.redd.it)',
      restrict_sr: 'on',
      sort: 'top',
      t: 'month',
      limit: String(ITEMS_PER_FETCH),
      after: state.subCursor[sub] || ''
    });
    const url = `${BASE}/r/${sub}/search.json?${params.toString()}`;

    // polite user agent via jina proxy not needed, but keep delay/backoff on 429
    const res = await safeFetch(url);

    if (!res.ok) {
      if (res.status===429){ throw new Error('HTTP 429'); }
      throw new Error(`HTTP ${res.status}`);
    }

    const txt = await res.text();
    let data;
    try { data = JSON.parse(txt); }
    catch(e){
      // common when mirror returns HTML (e.g., blocked)
      throw new Error('JSON Parse error');
    }

    const after = data?.data?.after || null;
    state.subCursor[sub] = after;

    const list = (data?.data?.children || []).map(n => {
      const d = n.data || {};
      return {
        id: d.id,
        url: d.url_overridden_by_dest || d.url || '',
        title: d.title || d.author || '',
        sub: d.subreddit || sub,
        author: d.author || '',
      };
    });

    log(`+ r/${sub}: ${list.length} items`);
    return list;
  }

  async function safeFetch(url){
    let tries = 0;
    let wait = state.backoffMs;
    while (true){
      try{
        const r = await fetch(url, { headers: { 'accept': 'application/json,text/plain,*/*' }});
        // If 429, backoff
        if (r.status===429){
          tries++;
          const until = Math.min(wait*(2**(tries-1)), 6000);
          stage(1, `Backoff ${Math.ceil(until/1000)}s…`);
          log(`429 on ${url} — backing off ${until}ms`);
          await sleep(until);
          continue;
        }
        // Sometimes proxies return text/html error with 200—detect
        const ct = r.headers.get('content-type')||'';
        if (!/json|javascript|plain/i.test(ct)) {
          // still could be JSON as text/plain (OK), we’ll try parse later.
          // If clearly HTML, treat as soft error:
          if (/html/i.test(ct)) {
            tries++;
            const until = Math.min(wait*(2**(tries-1)), 5000);
            log(`Non-JSON content-type (${ct}) — retry in ${until}ms`);
            await sleep(until);
            continue;
          }
        }
        return r;
      }catch(err){
        tries++;
        const until = Math.min(wait*(2**(tries-1)), 5000);
        log(`Network error – retry in ${until}ms`);
        await sleep(until);
        if (tries>=3) throw err;
      }
    }
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  /*** BOOT ****************************************************************/
  // Prime with one batch
  resetAndFetch();

})();
</script>
</body>
</html>