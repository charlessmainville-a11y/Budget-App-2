<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CelebWall v2.4-persistfix</title>
<style>
  :root{
    --bg:#0d0f12;--panel:#12151a;--glass:#171b21;--muted:#9aa3ad;--txt:#eaf0f6;
    --pill:#1f2530;
    --like1:#2aa0ff; --like2:#14c8b3;
    --dismiss1:#ff4757; --dismiss2:#ff7ab8;
    --tile-grad1:#b08cff; --tile-grad2:#ff9ecf;
    --load1:#3a66ff; --load2:#12c2e9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{
    background:#0d0f12;
    overscroll-behavior-y:contain;
    color-scheme:dark;
    -webkit-overflow-scrolling:touch;
    touch-action:manipulation;
  }
  body{
    margin:0;
    background:radial-gradient(1000px 600px at 50% -200px,#151b23 0%,#0d0f12 40%,#0d0f12 100%);
    color:var(--txt);
    font:800 16px/1.3 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    overflow-x:hidden;
  }
  a{color:inherit}
  .wrap{max-width:880px;margin:0 auto;padding:18px 14px 96px}
  .glass{
    background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
    border:1px solid rgba(255,255,255,.18);
    -webkit-backdrop-filter:blur(14px) saturate(140%);
    backdrop-filter:blur(14px) saturate(140%);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.25),0 10px 22px rgba(0,0,0,.55);
  }
  .dash{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;justify-items:stretch;margin:8px 0 12px;}
  @media(min-width:920px){.dash{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .btn{position:relative;border:none;cursor:pointer;transform:translateZ(0);
       transition:transform .08s ease,filter .18s ease,opacity .18s ease;}
  .btn.tile{border-radius:22px;padding:22px 24px;color:#f5f7ff;
            font:900 20px/1.1 Inter,system-ui;letter-spacing:.01em;
            background:linear-gradient(180deg,rgba(20,25,34,.6),rgba(18,22,31,.4));
            border:1px solid rgba(255,255,255,.18);
            -webkit-backdrop-filter:blur(14px) saturate(140%);
            backdrop-filter:blur(14px) saturate(140%);
            box-shadow:inset 0 1px 0 rgba(255,255,255,.22),0 10px 22px rgba(0,0,0,.55);}
  .btn.tile.grad{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
               linear-gradient(135deg,var(--tile-grad1),var(--tile-grad2));
  }
  .btn.tile:hover{transform:translateY(-1px);filter:brightness(1.06)}
  .btn.tile:active{transform:translateY(0);filter:brightness(.96)}
  .btn.small{padding:16px 18px;border-radius:18px;font-size:18px}
  .btn.tiny{padding:10px 14px;border-radius:14px;font-size:14px}

  /* --- unified progress --- */
  .progressBtn{
    grid-column:1 / -1;display:flex;align-items:center;justify-content:space-between;
    padding:16px 18px;border-radius:22px;font-size:18px;position:relative;overflow:hidden;color:#e9f1ff;
  }
  .progressBtn .fill{position:absolute;inset:0 auto 0 0;width:0%;
    background:linear-gradient(90deg,#a0d9ff 0%,#c8b6ff 50%,#ffb3c7 100%);
    opacity:.95;pointer-events:none;}
  .progressBtn .label,.progressBtn .pct{position:relative;z-index:1;font-weight:900}
  .progressBtn.is-cta{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
               linear-gradient(135deg,var(--load1),var(--load2));color:#fff;
  }
  .progressBtn[disabled]{opacity:.7;cursor:not-allowed}
  .tabs{display:flex;gap:10px;justify-content:center;margin:10px 0 6px}
  .pill{border-radius:18px;padding:10px 14px;color:#e9f1ff;
        background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
        border:1px solid rgba(255,255,255,.18);
        -webkit-backdrop-filter:blur(14px) saturate(140%);
        backdrop-filter:blur(14px) saturate(140%);
        box-shadow:inset 0 1px 0 rgba(255,255,255,.22),0 6px 14px rgba(0,0,0,.45);}
  .hidden{display:none!important}
  .feed{display:grid;gap:18px}
  .card{position:relative;border-radius:22px;overflow:hidden;isolation:isolate;
        touch-action:pan-y;will-change:transform;
        background:linear-gradient(180deg,rgba(20,25,34,.55),rgba(15,19,26,.40));
        border:1px solid rgba(255,255,255,.18);
        -webkit-backdrop-filter:blur(14px) saturate(140%);
        backdrop-filter:blur(14px) saturate(140%);
        box-shadow:0 22px 40px rgba(0,0,0,.7),inset 0 1px 0 rgba(255,255,255,.18);}
  .media{display:block;width:100%;height:auto;max-height:86vh;object-fit:cover;background:#0b0f15}
  video.media{max-height:86vh;background:#0b0f15}
  .caption{padding:12px 14px;border-top:1px solid rgba(255,255,255,.18);
           background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
           -webkit-backdrop-filter:blur(14px) saturate(140%);
           backdrop-filter:blur(14px) saturate(140%);
           color:#f3f7ff;font:900 20px/1.2 Inter,system-ui;letter-spacing:.01em;}
  .actions{display:flex;gap:16px;justify-content:space-between;padding:18px;
           background:linear-gradient(180deg,transparent 0%,rgba(255,255,255,.03) 20%);
           -webkit-backdrop-filter:blur(12px) saturate(140%);
           backdrop-filter:blur(12px) saturate(140%);}
  .actions .btn{flex:1;border-radius:22px;padding:16px 18px;font-size:18px;
                border:1px solid rgba(255,255,255,.18);
                box-shadow:inset 0 1px 0 rgba(255,255,255,.25),0 10px 22px rgba(0,0,0,.55);}
  .btn.ok{color:#04131a;font-weight:900;
          background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
                     linear-gradient(135deg,var(--like1),var(--like2));}
  .btn.no{color:#2b060b;font-weight:900;
          background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
                     linear-gradient(135deg,var(--dismiss2),var(--dismiss1));}
  .stamp{position:absolute;top:12px;padding:6px 12px;border-radius:12px;
         font:900 14px/1 Inter,system-ui;opacity:0;transform:scale(.9);
         pointer-events:none;border:1px solid rgba(255,255,255,.22);
         -webkit-backdrop-filter:blur(10px) saturate(140%);
         backdrop-filter:blur(10px) saturate(140%);
         box-shadow:0 8px 18px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.3);}
  .stamp.like{left:12px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04)),
                           linear-gradient(135deg,var(--like1),var(--like2));color:#04131a}
  .stamp.no{right:12px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04)),
                         linear-gradient(135deg,var(--dismiss2),var(--dismiss1));color:#2b060b}
  .burst{animation:burst .45s ease forwards}
  @keyframes burst{0%{transform:scale(1)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
  .fade{animation:fade .28s ease forwards}
  @keyframes fade{to{opacity:0;transform:translateY(10px)}}
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:50}
  .modal.show{display:grid}
  .sheet{width:min(920px,92vw);max-height:80vh;overflow:auto;border-radius:22px;
         background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
         border:1px solid rgba(255,255,255,.18);
         -webkit-backdrop-filter:blur(16px) saturate(160%);
         backdrop-filter:blur(16px) saturate(160%);
         box-shadow:0 24px 60px rgba(0,0,0,.85);padding:18px;}
  .log{white-space:pre-wrap;font:600 14px/1.45 ui-monospace,Menlo,Consolas,monospace;color:#d7e3f5}
</style>
</head>
<body>

<script>
/* -------------------- Persistent State Helpers -------------------- */
function saveState(){
  localStorage.setItem('likes', JSON.stringify(likes));
  localStorage.setItem('discards', JSON.stringify(discards));
}
function loadState(){
  try{
    likes = JSON.parse(localStorage.getItem('likes')||'[]');
    discards = JSON.parse(localStorage.getItem('discards')||'[]');
  }catch{
    likes=[];discards=[];
  }
}
loadState();

/* -------------------- Scroll Helper (Safari Safe) -------------------- */
function getScrollY(){
  return window.scrollY || document.documentElement.scrollTop || 0;
}

/* -------------------- Modify Like/Discard Actions -------------------- */
function registerLike(item){
  if(!likes.some(i=>i.url===item.url)){
    likes.push(item);
    saveState();
  }
}
function registerDiscard(item){
  if(!discards.some(i=>i.url===item.url)){
    discards.push(item);
    saveState();
  }
}

/* --- hook into existing haptic + markViewed --- */
function handleAction(item, isLike, wrap){
  if(isLike){registerLike(item);wrap.classList.add('burst');haptic('success');}
  else{registerDiscard(item);wrap.classList.add('fade');haptic('error');}
  markViewed(item.url);
  setTimeout(()=>wrap.remove(),260);
}

/* --- Patch card() action handler --- */
const oldCard = window.card;
window.card = function(item){
  const wrap = oldCard(item);
  const actions = wrap.querySelector('.actions');
  if(actions){
    actions.replaceChildren(); // clear then rebuild
    const btnNo=document.createElement('button');
    btnNo.className='btn no';btnNo.textContent='Dismiss';
    const btnOk=document.createElement('button');
    btnOk.className='btn ok';btnOk.textContent='Like';
    actions.append(btnNo,btnOk);
    actions.addEventListener('click',e=>{
      const b=e.target.closest('button');if(!b)return;
      handleAction(item,b.classList.contains('ok'),wrap);
    });
  }
  return wrap;
}

/* --- Patch swipe helper --- */
const oldAttachSwipe=window.attachSwipe;
window.attachSwipe=function(wrap,item){
  oldAttachSwipe(wrap,item);
  // intercept endSwipe by delegation
  wrap.addEventListener('celebwall-swipe-like',()=>registerLike(item));
  wrap.addEventListener('celebwall-swipe-no',()=>registerDiscard(item));
}

/* -------------------- Scroll Autoload Patch -------------------- */
function onScrollAuto(){
  if(!AUTOLOAD || currentFeed!=='home') return;
  if(loadLock) return;
  const doc = document.documentElement;
  const scrollTop = getScrollY();
  const nearBottom = (doc.scrollHeight - (scrollTop + window.innerHeight)) < AUTOLOAD_THRESHOLD_PX;
  const now = performance.now();
  if(nearBottom && (now - lastAutoTs) > AUTOLOAD_THROTTLE_MS){
    lastAutoTs = now;
    renderChunk('home');
  }
}
window.removeEventListener('scroll', onScrollAuto);
window.addEventListener('scroll', onScrollAuto, {passive:true});

/* -------------------- Boot Re-init -------------------- */
captureTokenFromHash();
ui.tokenBadge();
ui.setProgressMode(false);
ui.bar(100);ui.phase('Ready');
log('Ready. Swipe right to Like, left to Dismiss. “Viewed” items are skipped.');
newBatch();
</script>

<!-- Troubleshooter modal -->
<div class="modal" id="modal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
      <h2 style="margin:0">Troubleshoot</h2>
      <button class="btn tiny tile" id="closeModal">Close</button>
    </div>
    <div class="log" id="log"></div>
  </div>
</div>

</body>
</html>