<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scroll Wall ‚Äî v4.1</title>
<style>
:root{
  --bg:#0c1116; --ink:#e9eef4; --muted:#a3afbf;
  --panel:#141a22; --panel2:#0f141a; --accent:#ff7aa2;
  --accent-ink:#1b0c13; --ring:rgba(255,255,255,.12);
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:radial-gradient(1200px 600px at 30% -10%, #1b2430 0%, #0c1116 60%) fixed, var(--bg);color:var(--ink);font:16px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
button{cursor:pointer;border:0;background:transparent;color:inherit}
.app{max-width:860px;margin:18px auto 120px;padding:0 16px}
.header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.badge{background:linear-gradient(180deg,#1a212b,#111820);border:1px solid var(--ring);padding:10px 16px;border-radius:16px;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
.badge.pink{background:linear-gradient(180deg,#ff99b5,#ff7aa2);color:#1a0e15;border-color:#ffb0c6}
.hint{color:var(--muted);opacity:.8}
.controls{background:linear-gradient(180deg,#111821,#0d1218);border:1px solid var(--ring);border-radius:22px;padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;position:sticky;top:0;z-index:5;backdrop-filter:blur(10px)}
.controls .big{grid-column:1/3;background:linear-gradient(180deg,#ff99b5,#ff7aa2);color:#1b0c13;border:1px solid #ffb0c6;border-radius:18px;padding:14px 18px;font-weight:800;font-size:20px}
.controls .pill{background:linear-gradient(180deg,#1a212b,#111820);border:1px solid var(--ring);border-radius:16px;padding:12px 16px;font-weight:700;text-align:center}
.counter{font-weight:900;font-size:22px;letter-spacing:.5px;text-align:center}
.grid{display:grid;gap:18px;margin-top:18px}
.card{background:linear-gradient(180deg,#121922,#0f141b);border:1px solid var(--ring);border-radius:26px;padding:14px 14px 12px;box-shadow:0 14px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04)}
.frame{position:relative;border-radius:18px;overflow:hidden;background:#0a0f14}
.media{width:100%;height:64vh;max-height:560px;object-fit:contain;background:#0a0f14;display:block}
.stamp{position:absolute;top:10px;left:12px;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:12px;font-weight:700;font-size:13px;backdrop-filter:blur(6px)}
.actions{display:flex;gap:10px;align-items:center;margin-top:10px}
.tag{background:linear-gradient(180deg,#1a212b,#111820);border:1px solid var(--ring);border-radius:12px;padding:10px 14px;font-weight:800;color:#cfe6ff}
.star,.nope{flex:0 0 auto;padding:12px 16px;border-radius:14px;font-size:18px;font-weight:900}
.star{background:linear-gradient(180deg,#ffafc5,#ff7aa2);color:#291018;border:1px solid #ffc2d3}
.nope{background:linear-gradient(180deg,#ffb2a6,#ff8b7e);color:#2a0e0a;border:1px solid #ffc3bb}
@keyframes pop {0%{transform:scale(.9);opacity:.0} 50%{transform:scale(1.05);opacity:1} 100%{transform:scale(1);opacity:1}}
.pop{animation:pop .28s ease-out}
.sheet{position:fixed;inset:0;background:rgba(8,12,16,.7);backdrop-filter:blur(8px);display:none;align-items:flex-start;justify-content:center;padding:20px;z-index:50}
.sheet .box{max-width:860px;width:100%;background:linear-gradient(180deg,#101620,#0d1218);border:1px solid var(--ring);border-radius:20px;padding:16px}
.sheet.open{display:flex}
.sheet .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap;background:#0a0f14;border:1px solid var(--ring);border-radius:14px;padding:12px;color:#cfe6ff}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#2a171b;border:1px solid #6f2f3a;color:#ffb3c2;padding:12px 16px;border-radius:14px;display:none}
.toast.show{display:block}
@media (max-width:480px){ .media{height:60vh} }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="badge">Build <strong>v4.1</strong></div>
    <button class="badge" id="btnHome">Home</button>
    <button class="badge" id="btnLiked">Liked ‚≠ê</button>
    <button class="badge" id="btnTrouble">Troubleshoot ü©∫</button>
    <div class="hint" id="modeHint">NSFW enabled ¬∑ people-only ¬∑ spicy sprinkle</div>
  </div>

  <div class="controls">
    <button class="big" id="btnLoad">Load more</button>
    <div class="pill counter" id="counter">0/0</div>
    <button class="pill" id="btnNew">New batch</button>
    <button class="pill" id="btnShuffle">Shuffle üîÄ</button>
  </div>

  <div class="grid" id="feed"></div>
</div>

<div class="sheet" id="likedSheet" aria-hidden="true">
  <div class="box">
    <div class="title">
      <strong>Liked ‚≠ê</strong>
      <div>
        <button class="badge" id="btnExport">Export JSON</button>
        <button class="badge" id="btnClearLikes">Clear</button>
        <button class="badge pink" id="btnCloseLiked">Close</button>
      </div>
    </div>
    <div id="likedGrid" class="grid"></div>
  </div>
</div>

<div class="sheet" id="troubleSheet" aria-hidden="true">
  <div class="box">
    <div class="title">
      <strong>Troubleshoot</strong>
      <button class="badge pink" id="btnCloseTrouble">Close</button>
    </div>
    <div class="code" id="diag">Loading‚Ä¶</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Config ===== */
const BUILD = "v4.1";
const TARGET_BATCH = 6;
const PAGE_SIZE = 3;
const HOSTS = ["https://api.redgifs.com","https://api-cdn.redgifs.com"];
const NAME_BIAS = 1.0;

const NAMES = [
"Addison Rae","Adriana Lima","Alexandra Daddario","Alexis Ren","Alisha Lehmann","Alix Earle",
"Ana de Armas","Ananya Panday","Anne Hathaway","Anya Taylor-Joy","Ariana Grande","Ashley Graham",
"Barbara Palvin","Bella Hadid","Bebe Rexha","Blake Lively","Camila Cabello","Camila Morrone","Candice Swanepoel",
"Charli D‚ÄôAmelio","Chloe Bailey","Daisy Keech","Disha Patani","Dua Lipa","Elle Fanning","Emilia Clarke",
"Emily Ratajkowski","Emma Chamberlain","Emma Watson","Gal Gadot","Gigi Hadid","Hailee Steinfeld","Hailey Bieber",
"Haley Kalil","Halle Bailey","Hannah Palmer","Iggy Azalea","Irina Shayk","Jenna Ortega","Jennifer Lawrence",
"Jessica Alba","Joey King","Josephine Skriver","Jisoo","Jourdan Dunn","Kali Uchis","Kara Del Toro","Karlie Kloss",
"Kendall Jenner","Kim Kardashian","Kylie Jenner","Kaia Gerber","Keke Palmer","Lais Ribeiro","Lana Del Rey",
"Lily-Rose Depp","Lily Collins","Lorena Rae","Madelyn Cline","Madison Beer","Megan Fox","Megan Thee Stallion",
"Miranda Kerr","Molly Eskam","Naomi Scott","Natalie Portman","Nina Agdal","Nina Dobrev","Olivia Culpo","Olivia Holt",
"Olivia Rodrigo","Paris Hilton","Rihanna","Sabrina Carpenter","Sadie Sink","Salma Hayek","Sara Sampaio",
"Selena Gomez","Sofia Carson","Sofia Vergara","Sommer Ray","Sydney Sweeney","Taylor Hill","Taylor Swift",
"Vanessa Hudgens","Victoria Justice","Yara Shahidi","Zendaya","Loren Gray","Lea Elui","Kendall Vertes",
"Charli Howard","Elsa Hosk","Kylie Verzosa","Pia Wurtzbach","Deepika Padukone","Janhvi Kapoor",
"Sara Ali Khan","Anushka Sharma","Taissa Farmiga","Mila Kunis","Emmy Rossum"
];
const SPICY = ["lingerie","bikini","photoshoot","runway","backstage","swimsuit"];

/* ===== State ===== */
const feedEl = document.getElementById('feed');
const counterEl = document.getElementById('counter');
const toastEl = document.getElementById('toast');
const likedSheet = document.getElementById('likedSheet');
const likedGrid = document.getElementById('likedGrid');
const troubleSheet = document.getElementById('troubleSheet');
const diagEl = document.getElementById('diag');

let token = null, tokenTime = 0;
let pool = [], shown = 0, likes = loadLikes();
let lastError = "(none)";

/* ===== Utils ===== */
function showToast(m){toastEl.textContent=m;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),1800)}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function loadLikes(){try{return JSON.parse(localStorage.getItem('likes_v1')||'[]')}catch{return[]}}
function saveLikes(){localStorage.setItem('likes_v1',JSON.stringify(likes))}
function setCounter(){counterEl.textContent=`${shown}/${pool.length}`}
const age = () => Date.now()-tokenTime;

/* ===== Token (auto-refresh every 5 min) ===== */
async function ensureToken(){
  if (token && age()<5*60*1000) return token;
  for (const host of HOSTS){
    try{
      const r = await fetch(`${host}/v2/auth/temporary`,{mode:'cors'});
      if (!r.ok) { lastError=`auth ${r.status}`; continue; }
      const j = await r.json();
      token = j?.token||null; tokenTime = Date.now();
      if (token) return token;
    }catch(e){ lastError = `auth err ${e.message||e}`; }
  }
  return null;
}

/* ===== Search (with smart retries + better diagnostics) ===== */
async function searchOnce(host, q, count, variant=0){
  // variant 0: default search_text
  // variant 1: add spicy tag
  const text = variant===1 ? `${q} ${SPICY[Math.floor(Math.random()*SPICY.length)]}` : q;
  const url = `${host}/v2/gifs/search?search_text=${encodeURIComponent(text)}&order=trending&count=${count}&from=0`;
  const t = await ensureToken(); if(!t) throw new Error("token missing");
  const r = await fetch(url,{headers:{Authorization:`Bearer ${t}`},mode:'cors'});
  if (!r.ok){ const msg = `HTTP ${r.status}`; if (r.status===429) throw new Error("429 rate limited"); throw new Error(msg); }
  const j = await r.json();
  return (j?.gifs||[]).map(g=>({
    id:g.id,
    url:g?.urls?.hd||g?.urls?.sd||g?.urls?.gif||"",
    preview:g?.urls?.poster||"",
    width:g?.width,height:g?.height,
    author:g?.userName||"", title:g?.title||"",
    source:"RedGifs", query:text
  })).filter(x=>x.url);
}

async function searchRedgifs(q, count=24){
  let last = "";
  for (const host of HOSTS){
    try { const a = await searchOnce(host,q,count,0); if (a.length) return a; last=`${host} empty`; }
    catch(e){ lastError = `${q}: ${e.message||e}`; last = lastError;}
    // try a spicy variant before switching host again
    try { const b = await searchOnce(host,q,count,1); if (b.length) return b; }
    catch(e){ last = `${q}: ${e.message||e}`; }
  }
  throw new Error(last||"no results");
}

/* ===== Batch ===== */
function pickQueries(n){
  const names = shuffle([...NAMES]).slice(0, Math.ceil(n*NAME_BIAS));
  const extra = Array.from({length:Math.max(0,n-names.length)}, ()=>`${NAMES[Math.floor(Math.random()*NAMES.length)]} ${SPICY[Math.floor(Math.random()*SPICY.length)]}`);
  return shuffle([...names,...extra]);
}

async function buildBatch(){
  pool.length=0; shown=0; setCounter(); feedEl.innerHTML="";
  const want = TARGET_BATCH;
  const queries = pickQueries(Math.max(6,want*3));
  for (const q of queries){
    if (pool.length>=want) break;
    try{
      const items = await searchRedgifs(q, 24);
      // Looser filter now ‚Äì only require we have a usable url
      shuffle(items).slice(0,2).forEach(it=>pool.push(it));
    }catch(e){
      lastError = `${q}: ${e.message||e}`;
      if (String(e).includes("429")) await new Promise(r=>setTimeout(r, 900));
    }
  }
  shuffle(pool); setCounter();
  if(!pool.length) showToast("No posts yet. Tap Shuffle, then Load more, or try again in ~30‚Äì60s.");
}

/* ===== Render ===== */
function cardTemplate(item, idx){
  const isVideo = /\.mp4|\.webm/i.test(item.url);
  const media = isVideo
    ? `<video class="media" playsinline muted loop controls preload="metadata" poster="${item.preview||''}">
         <source src="${item.url}" type="video/mp4"></video>`
    : `<img class="media" src="${item.url}" alt="">`;
  return `<div class="card" data-idx="${idx}">
    <div class="frame">
      ${media}
      <div class="stamp">${item.query} ¬∑ ${item.source}</div>
    </div>
    <div class="actions">
      <div class="tag">${item.source}</div><div style="flex:1"></div>
      <button class="star" title="Like">‚≠ê</button>
      <button class="nope" title="Remove">üëé</button>
    </div>
  </div>`;
}

function renderMore(n=PAGE_SIZE){
  const end = Math.min(pool.length, shown+n);
  for(let i=shown;i<end;i++){
    const html = cardTemplate(pool[i], i);
    const wrap = document.createElement('div'); wrap.innerHTML = html;
    const card = wrap.firstElementChild;
    feedEl.appendChild(card);

    const media = card.querySelector('.media');
    if (media && media.tagName==='VIDEO'){
      media.addEventListener('canplay', ()=>media.play().catch(()=>{}), {once:true});
      setTimeout(()=>media.play().catch(()=>{}), 40);
    }

    card.querySelector('.star').addEventListener('click', ()=>{ likeItem(pool[i]); card.classList.add('pop'); showToast("Saved to Liked ‚≠ê"); });
    card.querySelector('.nope').addEventListener('click', ()=> card.remove());
  }
  shown=end; setCounter();
}

/* ===== Likes ===== */
function likeItem(it){
  likes.unshift({t:Date.now(),url:it.url,preview:it.preview,where:it.source,query:it.query});
  likes=likes.slice(0,500); saveLikes();
}
function openLiked(){
  likedGrid.innerHTML = likes.length?"":"<div class='hint'>No likes yet.</div>";
  likes.forEach((it,i)=>{
    const isVideo=/\.mp4|\.webm/i.test(it.url);
    const media=isVideo?`<video class="media" playsinline muted loop controls preload="metadata" poster="${it.preview||''}"><source src="${it.url}" type="video/mp4"></video>`:`<img class="media" src="${it.url}" alt="">`;
    const row=document.createElement('div'); row.className='card';
    row.innerHTML=`<div class="frame">${media}<div class="stamp">${it.query||''} ¬∑ ${it.where||''}</div></div>
                   <div class="actions"><div class="tag">${new Date(it.t).toLocaleString()}</div><div style="flex:1"></div><button class="nope">Remove</button></div>`;
    row.querySelector('.nope').addEventListener('click',()=>{likes.splice(i,1);saveLikes();row.remove();});
    const v=row.querySelector('video'); if(v){setTimeout(()=>v.play().catch(()=>{}),50);}
    likedGrid.appendChild(row);
  });
  likedSheet.classList.add('open');
}

/* ===== Troubleshoot ===== */
function openTrouble(){
  const log = `Online: ${navigator.onLine}
UA: ${navigator.userAgent}
Pool size: ${pool.length}, shown: ${shown}, likes: ${likes.length}
Last error: ${lastError}

If ‚Äú429 rate limited‚Äù appears, RedGifs is throttling.
Tap Shuffle or wait ~30‚Äì60s and try again.`;
  diagEl.textContent = log;
  troubleSheet.classList.add('open');
}

/* ===== Wire-up ===== */
document.getElementById('btnLoad').addEventListener('click', ()=>renderMore());
document.getElementById('btnNew').addEventListener('click', async()=>{showToast("Building a new batch‚Ä¶");await buildBatch();renderMore();});
document.getElementById('btnShuffle').addEventListener('click', ()=>{shuffle(pool);feedEl.innerHTML="";shown=0;renderMore();});
document.getElementById('btnLiked').addEventListener('click', openLiked);
document.getElementById('btnCloseLiked').addEventListener('click', ()=>likedSheet.classList.remove('open'));
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(likes,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='liked.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('btnClearLikes').addEventListener('click', ()=>{ if(confirm("Clear all likes?")){likes=[];saveLikes();openLiked();} });
document.getElementById('btnTrouble').addEventListener('click', openTrouble);
document.getElementById('btnCloseTrouble').addEventListener('click', ()=>troubleSheet.classList.remove('open'));
document.getElementById('btnHome').addEventListener('click', ()=>{likedSheet.classList.remove('open'); troubleSheet.classList.remove('open'); window.scrollTo({top:0,behavior:'smooth'});});

/* First run */
(async function init(){ await buildBatch(); renderMore(); })();
</script>
</body>
</html>