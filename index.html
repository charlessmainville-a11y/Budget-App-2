<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CelebWall v2.5.0</title>
<link rel="stylesheet" href="./styles.css" />
<style>
  :root{
    --bg-900:#05070c;
    --bg-800:#080b12;
    --bg-700:#0e131d;
    --glass-border:rgba(255,255,255,0.18);
    --glass-highlight:rgba(255,255,255,0.32);
    --glass-shadow:rgba(3,7,15,0.7);
    --text-100:#eef4ff;
    --text-200:#c0cad9;
    --accent-1:#36b5ff;
    --accent-2:#4ee3d0;
    --accent-3:#9f7bff;
    --danger-1:#ff5f8c;
    --danger-2:#ff3d58;
    --radius-lg:22px;
    --radius-md:18px;
    --radius-sm:14px;
    --transition-fast:0.26s cubic-bezier(0.22,0.61,0.36,1);
    --font-display:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
  }
  *{box-sizing:border-box;-webkit-font-smoothing:antialiased}
  html,body{height:100%}
  html{background:var(--bg-900);overscroll-behavior-y:contain;color-scheme:dark;-webkit-overflow-scrolling:touch;touch-action:manipulation;}
  body{
    margin:0;
    color:var(--text-100);
    background:
      radial-gradient(1200px 680px at 50% -240px,rgba(90,120,180,0.22) 0%,rgba(38,55,85,0.08) 42%,rgba(5,8,12,0.94) 100%),
      linear-gradient(180deg,var(--bg-800),var(--bg-900));
    font:600 16px/1.45 var(--font-display);
    letter-spacing:0.01em;
    overflow-x:hidden;
  }
  a{color:inherit;text-decoration:none}
  h1,h2,h3,h4{font-family:var(--font-display);font-weight:800;letter-spacing:0.015em;margin:0 0 0.6em;color:var(--text-100);}
  p{margin:0 0 1em;color:var(--text-200);}
  .wrap{max-width:920px;margin:0 auto;padding:24px 18px 110px;display:flex;flex-direction:column;gap:18px;}

  .dash{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));align-items:stretch;}
  @media(min-width:920px){.dash{gap:16px;grid-template-columns:repeat(3,minmax(0,1fr));}}
  .btn{position:relative;border:1px solid var(--glass-border);border-radius:var(--radius-md);cursor:pointer;
    color:var(--text-100);padding:16px 18px;font:700 16px/1.1 var(--font-display);letter-spacing:0.015em;text-transform:none;
    background:linear-gradient(180deg,rgba(40,52,71,0.55),rgba(22,28,40,0.62));
    -webkit-backdrop-filter:blur(18px) saturate(160%);backdrop-filter:blur(18px) saturate(160%);
    box-shadow:0 16px 32px rgba(0,0,0,0.55),inset 0 1px 0 rgba(255,255,255,0.22);
    transition:transform var(--transition-fast),box-shadow var(--transition-fast),filter var(--transition-fast),color var(--transition-fast);
    display:inline-flex;align-items:center;justify-content:center;gap:10px;overflow:hidden;min-height:54px;
  }
  .btn::before{
    content:"";position:absolute;inset:1px;border-radius:inherit;background:linear-gradient(120deg,rgba(255,255,255,0.16),rgba(255,255,255,0));
    opacity:0.75;pointer-events:none;transition:opacity var(--transition-fast);
  }
  .btn::after{
    content:"";position:absolute;inset:-60%;background:radial-gradient(circle at 20% 20%,rgba(255,255,255,0.28),rgba(255,255,255,0) 60%);
    opacity:0;transform:translate3d(-20%,0,0) rotate(8deg);
    transition:transform 0.45s ease,opacity 0.45s ease;
    pointer-events:none;
  }
  .btn:hover{transform:translateY(-2px) scale(1.01);box-shadow:0 22px 38px rgba(7,10,18,0.66);}
  .btn:hover::after{opacity:0.65;transform:translate3d(12%,0,0) rotate(8deg);}
  .btn:active{transform:translateY(0) scale(0.99);filter:brightness(0.96);}
  .btn:focus-visible{outline:2px solid rgba(102,179,255,0.8);outline-offset:3px;}
  .btn[disabled]{cursor:not-allowed;opacity:0.6;filter:saturate(80%);}
  .btn.tile{border-radius:var(--radius-lg);padding:22px 24px;font:800 20px/1.1 var(--font-display);text-align:left;align-items:flex-start;min-height:0;}
  .btn.tile.small{font-size:18px;padding:18px 20px;}
  .btn.tiny{border-radius:var(--radius-sm);padding:10px 14px;font-size:14px;min-height:0;}
  .btn.grad{background:
      linear-gradient(180deg,rgba(255,255,255,0.12),rgba(255,255,255,0.04)),
      linear-gradient(135deg,var(--accent-1),var(--accent-3));
    color:#04131a;
    box-shadow:0 20px 40px rgba(12,54,92,0.55),inset 0 1px 0 rgba(255,255,255,0.32);
  }

  .progressBtn{grid-column:1 / -1;display:flex;align-items:center;justify-content:space-between;
    padding:18px 20px;border-radius:var(--radius-lg);font-size:18px;position:relative;overflow:hidden;color:var(--text-100);
    min-height:60px;
  }
  .progressBtn .fill{position:absolute;inset:0 auto 0 0;width:0%;
    background:linear-gradient(90deg,rgba(53,181,255,0.9),rgba(115,153,255,0.85),rgba(152,112,255,0.9));pointer-events:none;
    transition:width 0.22s ease;
  }
  .progressBtn .label,.progressBtn .pct{position:relative;z-index:1;font-weight:800;letter-spacing:0.02em;}
  .progressBtn.is-cta{background:linear-gradient(180deg,rgba(63,120,210,0.38),rgba(34,48,72,0.55));color:#0c1626;}
  .progressBtn.is-cta .fill{background:linear-gradient(90deg,rgba(74,196,255,0.85),rgba(78,227,208,0.9));}

  .tabs{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:6px 0 4px;padding:4px 0;}
  .pill{border-radius:999px;padding:10px 16px;color:var(--text-200);
        background:linear-gradient(180deg,rgba(42,54,74,0.55),rgba(26,33,46,0.68));
        border:1px solid var(--glass-border);
        -webkit-backdrop-filter:blur(18px) saturate(150%);backdrop-filter:blur(18px) saturate(150%);
        box-shadow:0 10px 24px rgba(0,0,0,0.45),inset 0 1px 0 rgba(255,255,255,0.18);
        font:700 15px/1 var(--font-display);letter-spacing:0.02em;cursor:default;transition:color var(--transition-fast),box-shadow var(--transition-fast),transform var(--transition-fast);
  }
  .pill.is-active{color:var(--text-100);box-shadow:0 18px 32px rgba(13,36,64,0.6);}
  .pill[data-action]{cursor:pointer;}
  .pill[data-action]:hover{transform:translateY(-2px);color:var(--text-100);}

  .hidden{display:none!important}

  .page{position:relative;opacity:0;transform:translate3d(0,28px,0);transition:opacity 0.26s ease,transform 0.26s ease;will-change:opacity,transform;pointer-events:none;}
  .page.is-active{opacity:1;transform:translate3d(0,0,0);pointer-events:auto;}
  .page.is-leaving{opacity:0;transform:translate3d(0,-18px,0);pointer-events:none;}

  .feed{display:grid;gap:20px;margin:0;padding:0;list-style:none;}
  .card{
    position:relative;border-radius:var(--radius-lg);overflow:hidden;isolation:isolate;touch-action:pan-y;
    background:linear-gradient(180deg,rgba(30,39,55,0.65),rgba(14,18,28,0.72));
    border:1px solid var(--glass-border);
    -webkit-backdrop-filter:blur(18px) saturate(160%);backdrop-filter:blur(18px) saturate(160%);
    box-shadow:0 26px 52px rgba(0,0,0,0.72),inset 0 1px 0 rgba(255,255,255,0.18);
  }
  .local-badge{
    position:absolute;top:12px;left:12px;padding:6px 12px;border-radius:999px;
    background:rgba(8,12,20,0.78);color:var(--text-100);font:800 13px/1 var(--font-display);
    display:inline-flex;align-items:center;gap:6px;pointer-events:none;user-select:none;
    box-shadow:0 10px 22px rgba(0,0,0,0.45);
  }
  .card.swiping{transition:none}
  .media{display:block;width:100%;height:auto;max-height:86vh;object-fit:cover;background:#0b0f15}
  video.media{max-height:86vh;background:#0b0f15}
  .caption{
    padding:14px 18px;border-top:1px solid rgba(255,255,255,0.16);
    background:linear-gradient(180deg,rgba(27,36,52,0.58),rgba(16,21,32,0.7));
    -webkit-backdrop-filter:blur(16px) saturate(160%);backdrop-filter:blur(16px) saturate(160%);
    color:var(--text-100);font:800 20px/1.24 var(--font-display);letter-spacing:0.015em;
  }

  .action-buttons{display:flex;justify-content:space-between;gap:1rem;padding:18px;background:linear-gradient(180deg,rgba(10,14,22,0),rgba(22,28,40,0.7));
    -webkit-backdrop-filter:blur(14px) saturate(160%);backdrop-filter:blur(14px) saturate(160%);}
  .action-buttons .btn{flex:1;border-radius:var(--radius-lg);padding:16px 18px;font-size:18px;}
  .btn.ok{color:#03161a;font-weight:800;
    background:linear-gradient(180deg,rgba(255,255,255,0.12),rgba(255,255,255,0.05)),
               linear-gradient(135deg,var(--accent-1),var(--accent-2));
  }
  .btn.no{color:#2d0710;font-weight:800;
    background:linear-gradient(180deg,rgba(255,255,255,0.12),rgba(255,255,255,0.05)),
               linear-gradient(135deg,var(--danger-1),var(--danger-2));
  }
  .stamp{
    position:absolute;top:12px;padding:6px 12px;border-radius:12px;font:800 14px/1 var(--font-display);
    opacity:0;transform:scale(.9);pointer-events:none;border:1px solid rgba(255,255,255,0.22);
    -webkit-backdrop-filter:blur(12px) saturate(160%);backdrop-filter:blur(12px) saturate(160%);
    box-shadow:0 12px 26px rgba(0,0,0,0.46),inset 0 1px 0 rgba(255,255,255,0.26);
  }
  .stamp.like{left:12px;background:linear-gradient(180deg,rgba(255,255,255,0.12),rgba(255,255,255,0.04)),linear-gradient(135deg,var(--accent-1),var(--accent-2));color:#03161a}
  .stamp.no{right:12px;background:linear-gradient(180deg,rgba(255,255,255,0.12),rgba(255,255,255,0.04)),linear-gradient(135deg,var(--danger-1),var(--danger-2));color:#2d0710}

  .burst{animation:burst .45s ease forwards}
  @keyframes burst{0%{transform:scale(1)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
  .fade{animation:fade .28s ease forwards}
  @keyframes fade{to{opacity:0;transform:translateY(10px)}}

  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,4,8,0.72);z-index:50;padding:24px;}
  .modal.show{display:grid}
  .sheet{
    width:min(920px,92vw);max-height:80vh;overflow:auto;border-radius:var(--radius-lg);
    background:linear-gradient(180deg,rgba(36,46,64,0.72),rgba(16,21,32,0.82));
    border:1px solid var(--glass-border);
    -webkit-backdrop-filter:blur(18px) saturate(180%);backdrop-filter:blur(18px) saturate(180%);
    box-shadow:0 24px 60px rgba(0,0,0,0.88);padding:20px;
  }
  .log{white-space:pre-wrap;font:600 14px/1.45 ui-monospace,Menlo,Consolas,monospace;color:#d7e3f5}

  @media(max-width:640px){
    body{font-size:15px;}
    .wrap{padding:20px 14px 96px;}
    .dash{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;}
    .btn.tile{font-size:18px;padding:18px 20px;}
  }

  @media(max-width:320px){
    .action-buttons{flex-direction:column;}
    .action-buttons .btn{width:100%;}
  }

  .toast{
    position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
    padding:10px 16px;border-radius:8px;color:white;font-weight:500;
    opacity:0.95;z-index:9999;transition:opacity 0.3s ease;
    pointer-events:none;
    -webkit-backdrop-filter:blur(12px) saturate(160%);
    backdrop-filter:blur(12px) saturate(160%);
    box-shadow:0 18px 32px rgba(0,0,0,0.45);
  }

  #zoomOverlay {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.9);
    overscroll-behavior: contain;
    touch-action: none;
    transform: none !important;
    backface-visibility: hidden;
    isolation: isolate;
  }
  #zoomOverlay.open { display: flex; }
  #zoomOverlay img, #zoomOverlay video {
    max-width: 100vw;
    max-height: 100vh;
    transform-origin: center center;
    transform: translate3d(0, 0, 0) scale(1);
    transition: transform 0.15s ease-out;
    touch-action: none;
    user-select: none;
    will-change: transform;
  }
  html.is-zoom-open, html.is-zoom-open body, html.is-zoom-open .wrap, html.is-zoom-open .card {
    transform: none !important;
  }

  @media(prefers-reduced-motion:reduce){
    *,*::before,*::after{transition:none!important;animation-duration:0.01ms!important;animation-iteration-count:1!important;}
    .btn:hover::after{opacity:0;}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="dash">
    <button class="btn tile small nav-btn" id="homeBtn" data-feed="home">Home</button>
    <button class="btn tile small nav-btn" id="likesBtn" data-feed="likes">Likes</button>
    <button class="btn tile small nav-btn" id="discardBtn" data-feed="discard">Discard</button>
    <button class="btn tile small nav-btn" id="localBtn" data-feed="local">Local</button>
    <button class="btn tile grad small" id="newBatchBtn">New batch</button>
    <button class="btn tile small" id="refreshBtn">Refresh</button>
    <button class="btn tile small" id="shuffleBtn">Shuffle feed</button>
    <button class="btn tile small" id="replaceLocalBtn">Replace Video</button>
    <button class="btn tile small" id="addLocalVideosBtn">Add Local Videos</button>
    <button class="btn tile small" id="manageSubsBtn">Subreddits</button>
    <button class="btn tile small" id="troubleBtn">Troubleshoot</button>
    <button class="btn tile small" id="connectBtn">Connect Reddit</button>
    <button class="btn tile progressBtn glass" id="progressBtn">
      <div class="fill" id="bar"></div>
      <span class="label" id="phase">Ready</span>
      <span class="pct" id="pct">100%</span>
    </button>
  </div>

  <div class="tabs" id="pageTabs">
    <button class="pill is-active" id="tabHome" type="button" data-action="home">Home</button>
    <button class="pill" id="tabLikes" type="button" data-action="likes">Likes</button>
    <button class="pill" id="tabDiscard" type="button" data-action="discard">Discard</button>
    <button class="pill" id="tabLocal" type="button" data-action="local">Local</button>
    <button class="pill" id="tabSubs" type="button" style="display:none" data-action="subs">Subreddits</button>
  </div>

  <div id="home" class="feed page is-active" data-page="home"></div>
  <div id="likes" class="feed page hidden" data-page="likes"></div>
  <div id="discard" class="feed page hidden" data-page="discard"></div>
  <div id="localTools" class="hidden" style="display:flex;justify-content:flex-end;margin:0 0 12px;gap:10px">
    <button class="btn tile small" id="clearLocalBtn">Clear Local Videos</button>
  </div>
  <div id="local" class="feed page hidden" data-page="local"></div>

  <section id="subsPage" class="page hidden" data-page="subs">
    <div class="sheet glass" style="padding:12px">
      <div class="subs-head" style="background:none;border:0;box-shadow:none;padding:0">
        <h2 style="margin:0;font:900 22px/1.2 Inter,system-ui">Manage subreddits</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn tile small" id="subsSelectAll">Select all</button>
          <button class="btn tile small" id="subsClearAll">Clear all</button>
          <button class="btn tile small grad" id="subsSave">Save & New batch</button>
          <button class="btn tile small" id="subsBack">‚Üê Back</button>
        </div>
      </div>
      <div class="subs-grid" id="subsGrid"></div>
    </div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
      <h2 style="margin:0">Troubleshoot</h2>
      <button class="btn tiny tile" id="closeModal">Close</button>
    </div>
    <div class="log" id="log"></div>
  </div>
</div>

<input type="file" id="localVideoInput" accept="video/mp4,video/*" multiple style="display:none" />

<script>
/* =========================================================
   CelebWall ‚Äì Production (Reddit-only, gesture-first video)
   - No autoplay; every video shows a Tap-to-Play overlay
   - After start: tap toggles mute/unmute (toast)
   - IO only pauses/resumes after user-start
   - Safari + Meta Quest friendly
   ========================================================= */

/* -------------------- OAuth config -------------------- */
const DEFAULT_CLIENT_ID   = localStorage.getItem('reddit_client_id')    || '';
const DEFAULT_REDIRECT_URI= localStorage.getItem('reddit_redirect_uri') || (location.origin + location.pathname);

/* -------------------- name list -------------------- */
const CELEB_NAMES = [
  "Scarlett Johansson","Margot Robbie","Zendaya","Ana de Armas","Gal Gadot","Emma Watson","Emma Stone","Natalie Portman","Alexandra Daddario","Salma Hayek",
  "Jessica Alba","Megan Fox","Blake Lively","Emily Ratajkowski","Kate Beckinsale","Priyanka Chopra","Sophie Turner","Taylor Swift","Ariana Grande","Dua Lipa",
  "Beyonc√©","Rihanna","Selena Gomez","Jennifer Lopez","Shakira","Camila Cabello","Olivia Rodrigo","Madison Beer","Hailey Bieber","Kylie Jenner",
  "Kendall Jenner","Gigi Hadid","Bella Hadid","Kaia Gerber","Sydney Sweeney","Jenna Ortega","Anya Taylor-Joy","Florence Pugh","Elizabeth Olsen","Vanessa Hudgens",
  "Lily James","Alicia Vikander","Rachel McAdams","Mila Kunis","Amber Heard","Emilia Clarke","Katherine Langford","Zo√´ Kravitz","Lily Collins","Lucy Hale",
  "Nina Dobrev","Victoria Justice","Karlie Kloss","Barbara Palvin","Taylor Hill","Adriana Lima","Candice Swanepoel","Irina Shayk","Rosie Huntington-Whiteley","Natalie Dormer",
  "Hailee Steinfeld","Chlo√´ Grace Moretz","Lana Del Rey","Halsey","Sabrina Carpenter","Ava Max","SZA","Doja Cat","Billie Eilish","Kacey Musgraves",
  "Maitreyi Ramakrishnan","Alexandra Shipp","Brie Larson","Tessa Thompson","Zoe Saldana","Karen Gillan","Naomi Scott","Ella Balinska","Eiza Gonz√°lez","Camila Morrone",
  "Ana de la Reguera","Lupita Nyong'o","Taylour Paige","Ariel Winter","Kiernan Shipka","Lili Reinhart","Camila Mendes","Madelaine Petsch","Addison Rae","Charli D'Amelio",
  "Suki Waterhouse","Phoebe Dynevor","Simone Ashley","Alexa Demie","Yara Shahidi","Maude Apatow","Mandy Moore","Lauren Jauregui","Janelle Mon√°e","Kerry Washington"
];
const _escRx = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
const NAME_RX = new RegExp("\\b(" + CELEB_NAMES.map(_escRx).join("|") + ")\\b","i");

/* -------------------- app config -------------------- */
const DEFAULT_STARTER_SUBS   = ['Celebs'];
const DEFAULT_OPTIONAL_NSFW  = [
  'charlidameliomommy','leaeluig_nr','leaeluiginet','lea_bellybutton',
  'nsfwfashion','naked_models','Dixied_nsfw','dixiedameliofans',
  'emmachamberlainnsfw','dovecameronlewd','emrata','elsiehewitt',
  'hunterschafer','kendalljenner','niamh_adkins','addisonrae',
  'sydneysweeney','alexandradaddario','alejandraguilmant','jenya_d',
  'girlsontop','hotwife','highresnsfwpro','nsfw_gif'
];
const saved = JSON.parse(localStorage.getItem('subs_toggle')||'{}');
let STARTER_SUBS  = saved.starters || [...DEFAULT_STARTER_SUBS];
let OPTIONAL_NSFW = saved.nsfw     || [...DEFAULT_OPTIONAL_NSFW];

/* -------------------- tunables -------------------- */
const LIMIT=100, PAGES=3, CHUNK=30, LIGHT_SHUFFLES=2;
const AUTOLOAD=true, AUTOLOAD_THRESHOLD_PX=1400, AUTOLOAD_THROTTLE_MS=1400, MAX_APPEND_PER_FRAME=6;

/* -------------------- state -------------------- */
let pool=[], likes=[], discards=[], currentFeed='home', isFetching=false, lastErrors=[], loadLock=false, lastAutoTs=0;
const logEl = document.getElementById('log');
const localVideoInput = document.getElementById('localVideoInput');
const localFeedEl = document.getElementById('local');
const localToolsEl = document.getElementById('localTools');
const clearLocalBtn = document.getElementById('clearLocalBtn');
let localVideoCard = null;
let localVideoObjectUrl = null;
let localFeedRecords = [];
const localBlobUrls = new Set();
let localInputMode = 'replace';
const LOCAL_CACHE_MANIFEST_URL = './local-cache/manifest.json';
let localCacheManifestLoaded = false;
let localCacheManifestError = '';
let localCacheLoadingPromise = null;

const pages = {
  home: document.getElementById('home'),
  likes: document.getElementById('likes'),
  discard: document.getElementById('discard'),
  local: document.getElementById('local'),
  subs: document.getElementById('subsPage')
};
let activePageEl = pages.home || null;
let _fsPrevScroll = 0;

function toggleFullscreen(videoEl) {
  if (!videoEl) return;
  if (!document.fullscreenElement) {
    _fsPrevScroll = window.scrollY;
    videoEl.requestFullscreen?.().catch(()=>{});
  } else {
    document.exitFullscreen?.();
  }
}

/* --- unified debug logger --- */
function dbg(...args) {
  const msg = '[DBG] ' + args.join(' ');
  console.log(msg);
  if (logEl) {
    logEl.textContent += msg + '\n';
    logEl.scrollTop = logEl.scrollHeight;
  }
}

const truncateLog = (value, max = 400) => {
  if (value == null) return '';
  const str = String(value);
  return str.length > max ? str.slice(0, max) + '‚Ä¶' : str;
};

function setLocalVideoObjectUrl(objectUrl) {
  if (localVideoObjectUrl && localVideoObjectUrl !== objectUrl) {
    try { URL.revokeObjectURL(localVideoObjectUrl); } catch {}
  }
  localVideoObjectUrl = objectUrl || null;
}

function ensureLocalVideoBadge(card){
  if (!card) return;
  if (card.querySelector('.local-badge')) return;
  const badge=document.createElement('div');
  badge.className='local-badge';
  badge.textContent='üìå Local';
  card.appendChild(badge);
}

function createLocalVideoCard(name, objectUrl){
  const cardEl = VideoContainer({
    title: name,
    url: objectUrl,
    controls: true
  });
  cardEl.dataset.kind = 'local-video';
  cardEl.dataset.localVideoName = name;
  ensureLocalVideoBadge(cardEl);
  return cardEl;
}

function clearLocalVideoCard(){
  if (localVideoCard && localVideoCard.parentElement) {
    localVideoCard.remove();
  }
  localVideoCard = null;
  setLocalVideoObjectUrl(null);
}

function ensureLocalCardAtTop(feed, options = {}){
  if (!feed) return null;
  const { logReinsert = true } = options;
  const card = localVideoCard || feed.querySelector('[data-kind="local-video"]');
  if (!card) return null;
  localVideoCard = card;
  ensureLocalVideoBadge(card);
  let reinserted = false;
  if (card.parentElement !== feed) {
    feed.prepend(card);
    reinserted = true;
  } else if (feed.firstElementChild !== card) {
    feed.insertBefore(card, feed.firstElementChild);
    reinserted = true;
  }
  feed.querySelectorAll('[data-kind="local-video"]').forEach(node => {
    if (node !== card) node.remove();
  });
  if (reinserted && logReinsert) {
    const label = truncateLog(card.dataset.localVideoName || 'local video', 160);
    dbg('source=local-session (reinserted)', label);
  }
  return card;
}

function insertLocalVideoCard(name, objectUrl){
  if (!objectUrl) return null;
  const feed = document.getElementById('home');
  const cardEl = createLocalVideoCard(name, objectUrl);
  if (feed) {
    feed.querySelectorAll('[data-kind="local-video"]').forEach(node => node.remove());
    feed.prepend(cardEl);
  }
  localVideoCard = cardEl;
  document.dispatchEvent(new Event('videosBuilt'));
  return cardEl;
}

function clearLocalFeedObjectUrls(){
  for (const url of localBlobUrls) {
    try { URL.revokeObjectURL(url); } catch {}
  }
  localBlobUrls.clear();
}

function setLocalFeedRecords(records){
  if (!Array.isArray(records)) {
    localFeedRecords = [];
  } else {
    const baseTs = Date.now();
    localFeedRecords = records
      .map((rec, idx) => {
        const name = typeof rec?.name === 'string' && rec.name.trim() ? rec.name.trim() : 'Local video';
        const source = typeof rec?.source === 'string' && rec.source
          ? rec.source
          : (typeof rec?.objectUrl === 'string' && rec.objectUrl ? rec.objectUrl : '');
        if (!source) return null;
        const savedAt = typeof rec?.savedAt === 'number' && Number.isFinite(rec.savedAt)
          ? rec.savedAt
          : (baseTs + idx);
        const poster = typeof rec?.poster === 'string' ? rec.poster : '';
        const isBlob = rec?.isBlob === true || (typeof source === 'string' && source.startsWith('blob:'));
        return { name, source, poster, savedAt, isBlob };
      })
      .filter(Boolean);
  }

  localFeedRecords.sort((a, b) => (b.savedAt || 0) - (a.savedAt || 0));

  localBlobUrls.clear();
  for (const rec of localFeedRecords) {
    if (rec.isBlob && rec.source) localBlobUrls.add(rec.source);
  }

  updateLocalFeedControls();
}

function createLocalFeedCard(record){
  if (!record || !record.source) return null;
  const name = record.name || 'Local video';
  const card = VideoContainer({
    title: name,
    url: record.source,
    poster: record.poster || '',
    controls: true
  });
  card.dataset.kind = 'local-feed-video';
  card.dataset.localVideoName = name;
  if (record.isBlob) card.dataset.localVideoSource = 'blob';
  ensureLocalVideoBadge(card);
  return card;
}

function updateLocalFeedEmptyState(){
  if (!localFeedEl) return;
  let emptyEl = localFeedEl.querySelector('[data-role="local-empty"]');
  if (localFeedRecords.length === 0) {
    if (!emptyEl) {
      emptyEl = document.createElement('div');
      emptyEl.dataset.role = 'local-empty';
      emptyEl.style.textAlign = 'center';
      emptyEl.style.opacity = '0.82';
      emptyEl.style.padding = '36px 14px';
      emptyEl.style.fontWeight = '800';
      emptyEl.style.lineHeight = '1.5';
    }
    if (localCacheManifestError) {
      emptyEl.innerHTML = `<strong>${localCacheManifestError}</strong><br><span style="opacity:0.75;">Add local videos or refresh the cache.</span>`;
    } else {
      emptyEl.textContent = 'No local videos found.';
    }
    localFeedEl.appendChild(emptyEl);
  } else if (emptyEl) {
    emptyEl.remove();
  }
}

function updateLocalFeedControls(){
  if (!clearLocalBtn) return;
  const hasBlobRecords = localFeedRecords.some(rec => rec.isBlob);
  if (!hasBlobRecords) {
    clearLocalBtn.setAttribute('disabled', '');
  } else {
    clearLocalBtn.removeAttribute('disabled');
  }
}

function rebuildLocalFeed(){
  if (!localFeedEl) return;
  localFeedEl.innerHTML = '';
  for (const record of localFeedRecords) {
    const card = createLocalFeedCard(record);
    if (card) localFeedEl.appendChild(card);
  }
  updateLocalFeedEmptyState();
}

async function loadLocalCacheManifest(){
  if (localCacheManifestLoaded) return localFeedRecords;
  if (localCacheLoadingPromise) return localCacheLoadingPromise;
  localCacheLoadingPromise = (async () => {
    localCacheManifestError = '';
    try {
      const res = await fetch(LOCAL_CACHE_MANIFEST_URL, { cache: 'no-store' });
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const payload = await res.json();
      const list = Array.isArray(payload?.videos) ? payload.videos : (Array.isArray(payload) ? payload : []);
      const now = Date.now();
      const manifestRecords = list
        .map((entry, idx) => {
          const source = typeof entry?.src === 'string' && entry.src
            ? entry.src
            : (typeof entry?.url === 'string' && entry.url ? entry.url : '');
          if (!source) return null;
          const name = typeof entry?.title === 'string' && entry.title.trim()
            ? entry.title.trim()
            : (typeof entry?.name === 'string' && entry.name.trim() ? entry.name.trim() : `Local video ${idx + 1}`);
          const savedAt = typeof entry?.savedAt === 'number' && Number.isFinite(entry.savedAt)
            ? entry.savedAt
            : now - idx;
          const poster = typeof entry?.poster === 'string' ? entry.poster : '';
          return { name, source, savedAt, poster, isBlob: false };
        })
        .filter(Boolean);
      const existingBlobs = localFeedRecords.filter(rec => rec.isBlob);
      setLocalFeedRecords([...manifestRecords, ...existingBlobs]);
      rebuildLocalFeed();
      localCacheManifestLoaded = true;
    } catch (err) {
      const msg = err?.message || 'unknown error';
      localCacheManifestError = /HTTP 404/.test(msg)
        ? 'Local cache directory not found.'
        : `Local cache unavailable (${msg})`;
      if (localFeedRecords.length === 0) updateLocalFeedEmptyState();
      throw err;
    } finally {
      localCacheLoadingPromise = null;
    }
  })();
  try {
    await localCacheLoadingPromise;
  } catch {}
  return localFeedRecords;
}

async function ensureLocalCacheReady(){
  if (localCacheManifestLoaded) return localFeedRecords;
  if (localCacheLoadingPromise) {
    try { await localCacheLoadingPromise; } catch {}
    return localFeedRecords;
  }
  try { await loadLocalCacheManifest(); } catch {}
  return localFeedRecords;
}

async function addFilesToLocalFeed(files){
  if (!files || !files.length) return;
  const baseTs = Date.now();
  const newRecords = [];
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (!file) continue;
    const objectUrl = URL.createObjectURL(file);
    localBlobUrls.add(objectUrl);
    newRecords.push({
      name: file.name || 'Local video',
      source: objectUrl,
      savedAt: baseTs + i,
      isBlob: true
    });
  }
  if (!newRecords.length) return;

  setLocalFeedRecords([...newRecords, ...localFeedRecords]);
  rebuildLocalFeed();
  dbg(`source=local-feed (${newRecords.length} files added)`);
}

function clearLocalFeed(){
  const preserved = [];
  const removed = [];
  for (const rec of localFeedRecords) {
    if (rec.isBlob && rec.source) removed.push(rec);
    else preserved.push(rec);
  }
  removed.forEach(rec => {
    try { URL.revokeObjectURL(rec.source); } catch {}
  });
  setLocalFeedRecords(preserved);
  clearLocalVideoCard();
  rebuildLocalFeed();
  dbg('source=local-feed (cleared local session videos)');
}

function bootstrapLocalFeed(){
  setLocalFeedRecords([]);
  rebuildLocalFeed();
  ensureLocalCacheReady();
}

/* -------------------- persistence -------------------- */
function saveState(){ try{ localStorage.setItem('likes',JSON.stringify(likes)); localStorage.setItem('discards',JSON.stringify(discards)); }catch{} }
function loadState(){ try{ likes=JSON.parse(localStorage.getItem('likes')||'[]'); discards=JSON.parse(localStorage.getItem('discards')||'[]'); }catch{ likes=[]; discards=[]; } }
loadState();

function showToast(msg, color){
  const toast=document.createElement('div');
  toast.textContent=msg;
  toast.className='toast';
  toast.style.opacity='0';
  if(color) toast.style.background=color;
  document.body.appendChild(toast);
  requestAnimationFrame(()=>{ toast.style.opacity='0.95'; });
  setTimeout(()=>{
    toast.style.opacity='0';
    setTimeout(()=>toast.remove(),300);
  },1500);
}

function persistLike(item){
  if(!item) return false;
  const exists=likes.some(it=>it.url===item.url);
  if(!exists){ likes.push(item); saveState(); }
  if(currentFeed==='likes'){ paintList('likes', likes); }
  return !exists;
}

function handleLike(item){
  if(!item) return false;
  const added = persistLike(item);
  showToast('Liked!', 'linear-gradient(135deg,var(--accent-1),var(--accent-2))');
  if(item?.url) markViewed(item.url);
  return added;
}

function persistDiscard(item){
  if(!item) return false;
  const exists=discards.some(it=>it.url===item.url);
  if(!exists){ discards.push(item); saveState(); }
  if(currentFeed==='discard'){ paintList('discard', discards); }
  return !exists;
}

/* viewed persistence */
const viewed=new Set(JSON.parse(localStorage.getItem('viewed')||'[]'));
function markViewed(url){
  if(!url) return;
  viewed.add(url);
  if(viewed.size>5000){
    const arr=[...viewed].slice(-4000);
    viewed.clear(); arr.forEach(v=>viewed.add(v));
  }
  localStorage.setItem('viewed', JSON.stringify([...viewed]));
}

/* -------------------- helpers -------------------- */
const el = sel => document.querySelector(sel);
const log = msg => { const t=new Date().toLocaleTimeString(); logEl.textContent += `[${t}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; };
const esc = s => String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
function getScrollY(){ return window.scrollY || document.documentElement.scrollTop || 0; }
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* -------------------- name helpers -------------------- */
function titleHasName(t){ return !!t && NAME_RX.test(t); }
function textMatchesAnyName(t){ if(!t) return false; const L=t.toLowerCase(); return CELEB_NAMES.some(n=>L.includes(n.toLowerCase())); }

const PERSON_SUBS = new Set(['LeaEluiGinet','charlidameliomommy','leaeluig_nr','leaeluiginet','lea_bellybutton','nsfwfashion','naked_models','Dixied_nsfw','dixiedameliofans']);
const STOP_WORDS = /^(at|in|with|on|of|for|from|and|the|to|by|wearing|holding|during)\b/i;
function humanizeSubName(sub){return sub.replace(/[_-]+/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/(\d+)/g,' $1 ').replace(/\s+/g,' ').trim().replace(/\b\w/g,m=>m.toUpperCase());}
function guessNameFromTitle(title){
  if(!title) return '';
  const cleaned = title.replace(/\s+/g,' ').trim();
  const parts = [];
  for(const tok of cleaned.split(' ')){
    if(STOP_WORDS.test(tok)) break;
    if(/^[A-Z√Ä-√ù][\w‚Äô'-.]*$/.test(tok) || /^(de|van|von|da|di|del|la)$/i.test(tok)){ parts.push(tok.replace(/[_-]/g,' ')); continue; }
    if(/[.,;:()|\[\]]/.test(tok)) break;
    if(parts.length===0) break;
    parts.push(tok);
  }
  const name = parts.join(' ').trim();
  return (name && /^[A-Z√Ä-√ù]/.test(name)) ? name : '';
}
function inferPerformer(item){
  if(PERSON_SUBS.has(item.sub)) return humanizeSubName(item.sub);
  if(/^[A-Za-z][A-Za-z0-9_]*$/.test(item.sub) && !/(pics|porn|nsfw|celebs?|gowns|events|nips|slips|the|official|fans|hub|girls)/i.test(item.sub)){
    return humanizeSubName(item.sub);
  }
  const tGuess = guessNameFromTitle(item.title);
  if(tGuess) return tGuess;
  return (item.title||'').split(' ').slice(0,3).join(' ').trim() || 'Unknown';
}

/* -------------------- UI helpers -------------------- */
function setActiveTab(name){
  document.querySelectorAll('#pageTabs .pill').forEach(btn => {
    const action = btn.dataset.action;
    btn.classList.toggle('is-active', action === name);
  });
}

const ui = {
  phase(s){ el('#phase').textContent = s; },
  bar(p){ el('#bar').style.width = `${p}%`; el('#pct').textContent = `${Math.round(p)}%`; },
  setProgressMode(isFetching){
    const btn = el('#progressBtn');
    if(isFetching){ btn.classList.remove('is-cta'); btn.setAttribute('disabled',''); }
    else { btn.classList.add('is-cta'); btn.removeAttribute('disabled'); this.bar(100); this.phase('Ready'); el('#pct').textContent = '100%'; }
  },
  showPage(name){
    const next = name === 'subs' ? pages.subs : pages[name];
    if (!next) return;
    currentFeed = name;

    if (name === 'local') {
      ensureLocalCacheReady();
      updateLocalFeedEmptyState();
    }

    if (localToolsEl) {
      if (name === 'local') localToolsEl.classList.remove('hidden');
      else localToolsEl.classList.add('hidden');
    }

    const tabsEl = document.getElementById('pageTabs');
    if (tabsEl) tabsEl.classList.remove('hidden');
    const subsTab = document.getElementById('tabSubs');
    if (subsTab) subsTab.style.display = name==='subs' ? '' : 'none';

    if (activePageEl === next) {
      setActiveTab(name);
      this.progressVisibility();
      return;
    }

    if (activePageEl) {
      const leaving = activePageEl;
      leaving.classList.remove('is-active');
      leaving.classList.add('is-leaving');
      const finalize = () => {
        leaving.classList.remove('is-leaving');
        leaving.classList.add('hidden');
      };
      leaving.addEventListener('transitionend', finalize, { once: true });
      setTimeout(finalize, 320);
    }

    next.classList.remove('hidden');
    next.classList.remove('is-leaving');
    requestAnimationFrame(() => next.classList.add('is-active'));
    activePageEl = next;

    setActiveTab(name);
    this.progressVisibility();
  },
  progressVisibility(){ const visible = currentFeed==='home' && (pool.length>0 || !isFetching); el('#progressBtn').style.display = visible ? '' : 'none'; }
};

function renderHome(){
  ui.showPage('home');
}

function renderLikes(){
  paintList('likes', likes);
  ui.showPage('likes');
}

function renderDiscard(){
  paintList('discard', discards);
  ui.showPage('discard');
}

function renderLocal(){
  ensureLocalCacheReady().finally(()=>{
    ui.showPage('local');
  });
}

function renderFeed(){
  if(currentFeed==='home'){ renderHome(); return; }
  if(currentFeed==='likes'){ renderLikes(); return; }
  if(currentFeed==='discard'){ renderDiscard(); return; }
  if(currentFeed==='local'){ renderLocal(); }
}

function switchFeed(feedName){
  if(!feedName) return;
  if(!['home','likes','discard','local'].includes(feedName)) return;
  currentFeed = feedName;
  renderFeed();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* =========================================================
   VIDEO ENGINE (gesture-first; Safari + Meta Quest)
   ========================================================= */

/* --- IntersectionObserver --- */
const io = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    const v = e.target;
    if(!(v instanceof HTMLVideoElement)) return;
    const started = v.dataset.userStarted === '1';
    if(e.isIntersecting){
      if(started) safePlay(v);
    } else {
      v.pause();
    }
  });
},{threshold:0.5});

/* --- helpers --- */
async function safePlay(v){
  dbg('safePlay', v.src, 'muted=', v.muted, 'readyState=', v.readyState);
  try{
    if(v.readyState < 2)
      await new Promise(r=>v.addEventListener('loadeddata', r, {once:true}));
  }catch{}
  try{
    const p=v.play();
    if(p && typeof p.then==='function') await p;
    dbg('play() success', v.src);
  }catch(err){
    dbg('play() error', err.message);
    if (typeof v.__handlePlayError === 'function') {
      try {
        v.__handlePlayError(err);
      } catch (innerErr) {
        dbg('play() error handler failure', innerErr?.message || innerErr);
      }
    }
  }
}

function showMuteToast(isMuted){
  const toast=document.createElement('div');
  toast.textContent=isMuted?'üîá Muted':'üîä Unmuted';
  Object.assign(toast.style,{
    position:'fixed',bottom:'24px',left:'50%',transform:'translateX(-50%)',
    background:'rgba(0,0,0,0.7)',color:'#fff',padding:'8px 16px',borderRadius:'12px',
    font:'900 16px/1 Inter,system-ui',zIndex:9999,transition:'opacity .3s ease'
  });
  document.body.appendChild(toast);
  setTimeout(()=>toast.style.opacity='0',1000);
  setTimeout(()=>toast.remove(),1300);
}

/* --- fullscreen scroll restore --- */
document.addEventListener('fullscreenchange',()=>{
  if(document.fullscreenElement){
    document.body.style.overflow='hidden';
  }else{
    document.body.style.overflow='';
    const y=_fsPrevScroll;
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      window.scrollTo({top:y,left:0,behavior:'auto'});
    }));
  }
});

/* =========================================================
   üé¨ makeVideo() ‚Äî Manual Start Only (Safari-Proof)
   ========================================================= */
function makeVideo(url, thumb, provider) {
  const v = document.createElement('video');
  v.className = 'media';
  v.src = url;
  v.poster = thumb || '';
  v.playsInline = true;
  v.setAttribute('playsinline', '');
  v.setAttribute('webkit-playsinline', '');
  v.loop = true;
  v.muted = true;      // start muted
  v.defaultMuted = true;
  v.setAttribute('muted', '');
  v.autoplay = false;  // never auto-play
  v.preload = 'metadata';
  v.controls = false;
  v.dataset.userStarted = '0';
  if (provider) v.dataset.provider = provider;

  const wrap = document.createElement('div');
  wrap.className = 'video-wrap';
  wrap.style.position = 'relative';
  wrap.style.overflow = 'hidden';
  wrap.appendChild(v);

  // --- Overlay buttons ---
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  Object.assign(overlay.style, {
    position: 'absolute',
    inset: 0,
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    background: 'rgba(0,0,0,0.35)',
    backdropFilter: 'blur(6px)',
    transition: 'opacity 0.25s ease'
  });

  const playBtn = document.createElement('button');
  playBtn.textContent = '‚ñ∂Ô∏è';
  Object.assign(playBtn.style, {
    fontSize: '48px',
    border: 'none',
    background: 'none',
    color: '#fff',
    cursor: 'pointer'
  });

  const muteBtn = document.createElement('button');
  muteBtn.textContent = 'üîä';
  Object.assign(muteBtn.style, {
    position: 'absolute',
    top: '10px',
    right: '10px',
    fontSize: '22px',
    border: 'none',
    background: 'rgba(0,0,0,0.5)',
    color: '#fff',
    borderRadius: '50%',
    width: '40px',
    height: '40px',
    cursor: 'pointer',
    display: 'none' // hidden until video starts
  });

  const isFullscreenEligible = provider === 'reddit' || provider === 'direct';
  let fsBtn = null;
  if (isFullscreenEligible) {
    fsBtn = document.createElement('button');
    fsBtn.textContent = '‚õ∂';
    Object.assign(fsBtn.style, {
      position: 'absolute',
      top: '10px',
      right: '56px',
      fontSize: '22px',
      border: 'none',
      background: 'rgba(0,0,0,0.5)',
      color: '#fff',
      borderRadius: '50%',
      width: '40px',
      height: '40px',
      cursor: 'pointer',
      display: 'block'
    });
    fsBtn.addEventListener('click', e => {
      e.stopPropagation();
      toggleFullscreen(v);
    });
  }

  overlay.appendChild(playBtn);
  wrap.appendChild(overlay);
  wrap.appendChild(muteBtn);
  if (fsBtn) wrap.appendChild(fsBtn);

  // --- Play handler ---
  playBtn.addEventListener('click', async e => {
    e.stopPropagation();
    overlay.style.opacity = 0;
    setTimeout(()=>overlay.remove(),250);
    try {
      await v.play();
      v.dataset.userStarted = '1';
      dbg('‚ñ∂ manual play', url);
      muteBtn.style.display = 'block';
    } catch (err) {
      dbg('‚ö†Ô∏è play failed', err.message);
    }
  });

  // --- Mute toggle ---
  muteBtn.addEventListener('click', e => {
    e.stopPropagation();
    v.muted = !v.muted;
    muteBtn.textContent = v.muted ? 'üîá' : 'üîä';
  });

  // --- Log errors for troubleshoot ---
  v.addEventListener('error', e => dbg('‚ùå video error', url, e));

  if (isFullscreenEligible) {
    v.addEventListener('dblclick', e => {
      e.stopPropagation();
      toggleFullscreen(v);
    });
  }

  // mark as user-started when playback resumes from other gestures (e.g. fullscreen)
  v.addEventListener('play', ()=>{ v.dataset.userStarted = '1'; }, {once:true});

  // ensure intersection observer tracks the actual video element once attached
  requestAnimationFrame(()=>{ try{ io.observe(v); }catch{} });

  return wrap;
}

/* =========================================================
   üìº VideoContainer ‚Äî Autoplay fallback
   ========================================================= */
function VideoContainer({ title, url, poster = '', controls = false, provider = '', onVideo = null, onPlayError = null } = {}) {
  const container = document.createElement('article');
  container.className = 'card';
  container.dataset.component = 'video-container';

  const video = document.createElement('video');
  video.className = 'media';
  video.src = url;
  if (poster) video.poster = poster;
  video.loop = true;
  video.autoplay = true;
  video.muted = true;
  video.defaultMuted = true;
  video.playsInline = true;
  video.setAttribute('playsinline', '');
  video.setAttribute('webkit-playsinline', '');
  video.setAttribute('autoplay', '');
  video.setAttribute('muted', '');
  video.setAttribute('loop', '');
  const providerTag = typeof provider === 'string' ? provider : '';
  if (providerTag) {
    video.dataset.provider = providerTag;
    container.dataset.provider = providerTag;
  }
  if (controls) {
    video.controls = true;
    video.setAttribute('controls', '');
  } else {
    video.controls = false;
    video.removeAttribute('controls');
  }
  video.dataset.userStarted = '1';
  video.__handlePlayError = typeof onPlayError === 'function' ? err => onPlayError(err, video) : null;

  container.appendChild(video);

  const isFullscreenEligible = providerTag === 'reddit' || providerTag === 'direct';
  let fsBtn = null;
  if (isFullscreenEligible) {
    fsBtn = document.createElement('button');
    fsBtn.textContent = '‚õ∂';
    Object.assign(fsBtn.style, {
      position: 'absolute',
      top: '10px',
      right: '56px',
      fontSize: '22px',
      border: 'none',
      background: 'rgba(0,0,0,0.5)',
      color: '#fff',
      borderRadius: '50%',
      width: '40px',
      height: '40px',
      cursor: 'pointer',
      display: 'block'
    });
    fsBtn.addEventListener('click', e => {
      e.stopPropagation();
      toggleFullscreen(video);
    });
    container.appendChild(fsBtn);
  }

  if (title) {
    const caption = document.createElement('div');
    caption.className = 'caption';
    caption.textContent = title;
    container.appendChild(caption);
  }

  if (typeof onVideo === 'function') {
    try { onVideo(video); } catch (err) { dbg('‚ö†Ô∏è onVideo handler error', err?.message || err); }
  }

  if (isFullscreenEligible) {
    video.addEventListener('dblclick', e => {
      e.stopPropagation();
      toggleFullscreen(video);
    });
  }

  requestAnimationFrame(()=>{ try{ io.observe(video); safePlay(video); }catch{} });

  return container;
}

function getLocalVideoCard() {
  if (localVideoCard) return localVideoCard;
  const existing = document.querySelector('#home [data-kind="local-video"]');
  if (existing) {
    localVideoCard = existing;
    ensureLocalVideoBadge(existing);
    return existing;
  }
  return null;
}

async function setLocalVideoFromFile(file) {
  if (!file) return;
  const name = file.name || 'Local video';
  clearLocalVideoCard();
  try {
    const objectUrl = URL.createObjectURL(file);
    setLocalVideoObjectUrl(objectUrl);
    const cardEl = insertLocalVideoCard(name, objectUrl);
    if (cardEl) {
      const label = truncateLog(name, 160);
      dbg('source=local-session (local video added)', label);
    }
    return cardEl;
  } catch (err) {
    dbg('‚ö†Ô∏è local video load error', err?.message || err);
    setLocalVideoObjectUrl(null);
    return null;
  }
}

function bootstrapLocalVideo(){
  clearLocalVideoCard();
}

/* --- unlock gesture --- */
window.addEventListener('DOMContentLoaded',()=>{
  let unlocked=false;
  const unlock=()=>{
    if(unlocked) return;
    unlocked=true;
    dbg('gesture unlock fired');
    document.querySelectorAll('video.media').forEach(v=>{
      if(v.dataset.userStarted==='1') safePlay(v);
    });
  };
  ['pointerdown','touchstart','click','keydown','scroll','focus']
    .forEach(evt=>window.addEventListener(evt,unlock,{once:true,passive:true}));
});

/* --- update Troubleshoot button to start live logging --- */
document.getElementById('troubleBtn').addEventListener('click', ()=>{
  dumpTroubleshoot();
  el('#modal').classList.add('show');
  dbg('--- Live debug logging started ---');
});

/* =========================================================
   üîç VIDEO DEBUG DIAGNOSTICS
   ========================================================= */
function attachVideoDiagnostics(){
  const vids = document.querySelectorAll('video.media');
  dbg(`üé¨ Diagnostics attached to ${vids.length} videos`);
  vids.forEach(v=>{
    const src=v.currentSrc||v.src;
    dbg('üîç checking video element', src);

    // basic load/error state watchers
    v.addEventListener('loadstart', ()=>dbg('loadstart', src));
    v.addEventListener('loadedmetadata', ()=>dbg('loadedmetadata', src));
    v.addEventListener('loadeddata', ()=>dbg('loadeddata', src));
    v.addEventListener('canplay', ()=>dbg('canplay', src));
    v.addEventListener('canplaythrough', ()=>dbg('canplaythrough', src));
    v.addEventListener('stalled', ()=>dbg('‚ö†Ô∏è stalled', src));
    v.addEventListener('waiting', ()=>dbg('‚åõ waiting for data', src));
    v.addEventListener('suspend', ()=>dbg('suspend (network paused)', src));
    v.addEventListener('playing', ()=>dbg('‚ñ∂ playing ok', src));
    v.addEventListener('pause', ()=>dbg('‚è∏ paused', src));
    v.addEventListener('error', e=>{
      const err=v.error;
      if(err){
        dbg(`‚ùå video error [${err.code}] ${err.message||'(no msg)'} src=${src}`);
      }else{
        dbg('‚ùå video error (unknown)', src);
      }
    });

    // network readyState polling (Safari sometimes hides this)
    const poll=()=>{
      const rs=v.readyState;
      const ns=v.networkState;
      dbg(`‚ÑπÔ∏è readyState=${rs} networkState=${ns} muted=${v.muted}`, src);
      if(rs<2) setTimeout(poll,1500);
    };
    poll();
  });
}

document.addEventListener('videosBuilt', attachVideoDiagnostics);


/* -------------------- Reddit fetchers -------------------- */

function baseUrl(sub, token, after) {
  const params = new URLSearchParams({ limit: LIMIT, raw_json: 1 });
  if (after) params.set('after', after);

  if (token) {
    // OAuth endpoint
    return {
      url: `https://oauth.reddit.com/r/${sub}/hot?${params.toString()}`,
      mode: "oauth"
    };
  }

  // Fallback (no token) ‚Üí use proxy
  const target = `https://www.reddit.com/r/${sub}/hot.json?${params.toString()}`;
  return {
    url: `https://corsproxy.io/?${encodeURIComponent(target)}`,
    mode: "proxy"
  };
}
async function pullSubreddit(sub) {
  const token = getToken();
  let after = null;
  const out = [];

  for (let page = 0; page < PAGES; page++) {
    const { url, mode } = baseUrl(sub, token, after);
    try {
      const res = await fetch(url,
        token && mode === "oauth" ? { headers: { 'Authorization': `Bearer ${token}` } } : {}
      );

      if (res.status !== 200) {
        log(`‚ö†Ô∏è /r/${sub} p${page + 1}: HTTP ${res.status} [${mode}]`);
      }

      if (!res.ok) {
        const msg = `‚úñ /r/${sub} p${page + 1}: HTTP ${res.status} [${mode}]`;
        lastErrors.push(msg);
        log(msg);
        break;
      }

      const data = await res.json();
      const children = (data.data?.children || []);
      const items = (await Promise.all(children.map(n => normalize(n.data)))).filter(Boolean);
      out.push(...items);

      log(`‚úì /r/${sub} p${page + 1} [${mode}] Loaded ${items.length}`);
      if (items.length === 0) {
        log(`‚ö†Ô∏è no normalized posts for /r/${sub} p${page + 1}`);
      }
      after = data.data?.after || null;
      if (!after) break;
      await new Promise(r => setTimeout(r, 20));

    } catch (e) {
      const status = typeof e?.status === 'number'
        ? e.status
        : (typeof e?.response?.status === 'number' ? e.response.status : null);
      if (status && status !== 200) {
        log(`‚ö†Ô∏è /r/${sub} p${page + 1}: HTTP ${status} [${mode}]`);
      }
      const errMsg = (e && e.message) ? e.message : String(e);
      const statusMsg = status && status !== 200 ? `HTTP ${status} ` : '';
      const msg = `‚úñ /r/${sub} p${page + 1}: ${statusMsg}${errMsg} [${mode}]`;
      lastErrors.push(msg);
      log(msg);
      break;
    }
  }
  return out;
}

// Helper: unescape Reddit URLs (fixes &amp; and HTML entities)
function fix(u) {
  return u ? u.replace(/&amp;/g, '&') : u;
}

// Helper: choose thumbnail
function pickThumb(d) {
  if (d.preview?.images?.[0]?.source?.url)
    return fix(d.preview.images[0].source.url);
  if (d.thumbnail && d.thumbnail.startsWith('http'))
    return d.thumbnail;
  return '';
}

// Helper: choose best gallery image from media_metadata
function bestMeta(meta) {
  if (!meta) return null;
  const s = meta.s;
  if (!s) return null;
  return fix(s.u || s.gif || s.mp4 || null);
}

/* =========================================================
   normalize() ‚Äî unified Reddit media resolver
   ========================================================= */
async function normalize(d) {

  // 1Ô∏è‚É£ Reddit-hosted videos (v.redd.it)
  const rv = d.secure_media?.reddit_video || d.media?.reddit_video;
  if (rv?.fallback_url && rv.fallback_url.includes('v.redd.it')) {
    dbg('source=reddit', truncateLog(rv.fallback_url, 200));
    return {
      t: 'video',
      url: rv.fallback_url,
      thumb: pickThumb(d),
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'reddit'
    };
  }

  // 2Ô∏è‚É£ Direct MP4 hosts (often include audio)
  const directUrlRaw = fix(d.url_overridden_by_dest || d.url || '');
  if (directUrlRaw) {
    let playable = directUrlRaw.trim();
    if (/\.gifv(\?.*)?$/i.test(playable)) playable = playable.replace(/\.gifv(\?.*)?$/i, '.mp4$1');
    if (/\.(mp4|m4v|mov)(\?.*)?$/i.test(playable)) {
      const isPreviewHost = /preview\.redd\.it/i.test(playable);
      if (isPreviewHost) {
        const still = pickThumb(d) || '';
        dbg('source=reddit', truncateLog(playable, 200));
        return {
          t: 'video',
          url: playable,
          thumb: still,
          title: d.title,
          author: d.author,
          sub: d.subreddit,
          link: `https://reddit.com${d.permalink}`,
          provider: 'reddit',
          isPreviewMp4: true,
          previewStill: still
        };
      }
      return {
        t: 'video',
        url: playable,
        thumb: pickThumb(d) || '',
        title: d.title,
        author: d.author,
        sub: d.subreddit,
        link: `https://reddit.com${d.permalink}`,
        provider: 'direct'
      };
    }
  }

  // 4Ô∏è‚É£ Reddit preview videos (rare mp4 rehosts)
  const preview = d.preview?.images?.[0];
  const variants = preview?.variants;
  if (variants?.mp4?.source?.url) {
    const mp4Url = fix(variants.mp4.source.url);
    dbg('source=reddit', truncateLog(mp4Url, 200));
    return {
      t: 'video',
      url: mp4Url,
      thumb: fix(preview?.source?.url),
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'reddit',
      isPreviewMp4: true,
      previewStill: fix(preview?.source?.url)
    };
  }

  // 5Ô∏è‚É£ GIF variants
  if (variants?.gif?.source?.url) {
    return {
      t: 'gif',
      url: fix(variants.gif.source.url),
      thumb: fix(preview?.source?.url),
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'gif'
    };
  }

  // 6Ô∏è‚É£ Galleries
  if (d.is_gallery && d.gallery_data?.items) {
    const firstId = d.gallery_data.items[0]?.media_id;
    const meta = d.media_metadata?.[firstId];
    const src = bestMeta(meta);
    if (src) {
      return {
        t: 'image',
        url: src,
        thumb: src,
        title: d.title,
        author: d.author,
        sub: d.subreddit,
        link: `https://reddit.com${d.permalink}`,
        provider: 'gallery'
      };
    }
  }

  // 7Ô∏è‚É£ Still images
  const img = d.url_overridden_by_dest || d.url;
  if (img && /\.(jpg|jpeg|png|webp)$/i.test(img)) {
    return {
      t: 'image',
      url: img,
      thumb: img,
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'image'
    };
  }

  // 8Ô∏è‚É£ Fallback preview
  if (preview?.source?.url) {
    const src = fix(preview.source.url);
    dbg('source=preview-image', truncateLog(src, 200));
    return {
      t: 'image',
      url: src,
      thumb: src,
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'preview-image'
    };
  }

  const fallbackThumb = pickThumb(d);
  if (fallbackThumb) {
    const safeThumb = truncateLog(fallbackThumb, 200);
    log(`‚ö†Ô∏è fallback to preview-only ${fallbackThumb}`);
    dbg('source=preview-image', safeThumb);
    return {
      t: 'image',
      url: fallbackThumb,
      thumb: fallbackThumb,
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'preview-image'
    };
  }

  // 9Ô∏è‚É£ Nothing usable
  return null;
}
  
/* -------------------- render pipeline -------------------- */
function interleaveBuckets(buckets){
  const keys = Object.keys(buckets); const out=[]; let added=true;
  while(added){ added=false; for(const k of keys){ const arr=buckets[k]; if(arr && arr.length){ out.push(arr.shift()); added=true; } } }
  for(let i=0;i<LIGHT_SHUFFLES;i++) shuffleArray(out);
  return out;
}

function attachSwipe(wrap, item){
  const likeStamp=document.createElement('div'); likeStamp.className='stamp like'; likeStamp.textContent='Like';
  const noStamp=document.createElement('div'); noStamp.className='stamp no'; noStamp.textContent='Dismiss';
  wrap.appendChild(likeStamp); wrap.appendChild(noStamp);

  let startX=0, startY=0, dx=0, dy=0, dragging=false;
  const threshold=Math.max(120, window.innerWidth*0.22), rotFactor=20;
  const currentItem = () => wrap.__item || item;

  function setTransform(x){
    const r=(x/threshold)*rotFactor;
    wrap.style.transform=`translateX(${x}px) rotate(${r}deg)`;
    likeStamp.style.opacity=Math.max(0,Math.min(1,x/threshold));
    noStamp.style.opacity=Math.max(0,Math.min(1,-x/threshold));
    likeStamp.style.transform=`scale(${0.9 + Math.min(0.2, Math.max(0, x/threshold)*0.2)})`;
    noStamp.style.transform=`scale(${0.9 + Math.min(0.2, Math.max(0, -x/threshold)*0.2)})`;
  }
  function endSwipe(finalX){
    wrap.classList.remove('swiping');
    const didLike = finalX > threshold, didNo = finalX < -threshold;
    if(didLike || didNo){
      const off=(didLike?1:-1)*(window.innerWidth+200);
      wrap.style.transition='transform .28s ease-out, opacity .28s ease-out';
      wrap.style.transform=`translateX(${off}px) rotate(${off>0?rotFactor:-rotFactor}deg)`; wrap.style.opacity='0.2';
      setTimeout(()=>{
        const active = currentItem();
        if(didLike){
          handleLike(active);
        }else{
          persistDiscard(active);
          showToast('Dismissed.', 'linear-gradient(135deg,var(--danger-1),var(--danger-2))');
          if(active?.url) markViewed(active.url);
        }
        wrap.remove();
      },280);
    }else{
      wrap.style.transition='transform .22s ease'; wrap.style.transform=''; likeStamp.style.opacity=0; noStamp.style.opacity=0;
      setTimeout(()=>{ wrap.style.transition=''; },240);
    }
  }

  wrap.addEventListener('pointerdown',e=>{ if(e.button!==0) return; dragging=true; wrap.classList.add('swiping'); startX=e.clientX; startY=e.clientY; dx=0; dy=0; wrap.setPointerCapture(e.pointerId); });
  wrap.addEventListener('pointermove',e=>{ if(!dragging) return; dx=e.clientX-startX; dy=e.clientY-startY; if(Math.abs(dx)>Math.abs(dy)*0.7){ setTransform(dx); } });
  wrap.addEventListener('pointerup',()=>{ if(!dragging) return; dragging=false; endSwipe(dx); });
  wrap.addEventListener('pointercancel',()=>{ if(!dragging) return; dragging=false; endSwipe(0); });
}

function card(item){
  const performer = inferPerformer(item);
  const captionText = performer || (item.title||'').slice(0,64);
  const usePreviewContainer = item.t==='video' && item.provider==='reddit' && item.isPreviewMp4;

  let wrap;
  let media;

  if(usePreviewContainer){
    wrap = VideoContainer({
      title: captionText,
      url: item.url,
      poster: item.thumb || '',
      controls: false,
      provider: item.provider || '',
      onVideo(video){
        media = video;
        video.dataset.provider = item.provider || '';
        video.dataset.previewMp4 = '1';
      }
    });
    wrap.__item = item;
    media = media || wrap.querySelector('video.media');
  } else {
    wrap=document.createElement('article'); wrap.className='card'; wrap.__item=item;

    if(item.t==='video' || item.t==='gif'){ media = makeVideo(item.url, item.thumb || null, item.provider); }
    else{
      media = document.createElement('img'); media.className='media'; media.loading='lazy'; media.alt=item.title||''; media.src=item.url;
      media.addEventListener('error',()=>wrap.remove());
    }
    wrap.appendChild(media);

    const caption=document.createElement('div'); caption.className='caption';
    caption.textContent = captionText; wrap.appendChild(caption);
  }

  if (media instanceof HTMLImageElement) {
    media.classList.add('zoomable');
  }

  const actions=document.createElement('div'); actions.className='action-buttons';
  const dismissBtn=document.createElement('button');
  dismissBtn.className='btn no dismiss-btn';
  dismissBtn.type='button';
  dismissBtn.textContent='Dismiss';
  const likeBtn=document.createElement('button');
  likeBtn.className='btn ok like-btn';
  likeBtn.type='button';
  likeBtn.textContent='Like';

  dismissBtn.addEventListener('click',()=>{
    const targetItem=wrap.__item || item;
    persistDiscard(targetItem);
    showToast('Dismissed.', 'linear-gradient(135deg,var(--danger-1),var(--danger-2))');
    markViewed(targetItem?.url);
    wrap.classList.add('fade');
    setTimeout(()=>wrap.remove(),260);
  });

  likeBtn.addEventListener('click',()=>{
    const targetItem=wrap.__item || item;
    handleLike(targetItem);
    wrap.classList.add('burst');
    setTimeout(()=>wrap.remove(),260);
    switchFeed('likes');
  });

  actions.appendChild(dismissBtn);
  actions.appendChild(likeBtn);
  wrap.appendChild(actions);

  attachSwipe(wrap, wrap.__item || item);
  return wrap;
}

async function renderChunk(where, n=CHUNK){
  if(loadLock) return;
  if(pool.length===0){
    if(where==='home') ensureLocalCardAtTop(document.getElementById(where));
    ui.progressVisibility();
    return;
  }
  loadLock=true;
  try{
    const feed=document.getElementById(where);
    if(where==='home') ensureLocalCardAtTop(feed);
    const need=Math.min(n,pool.length); let appended=0;
    while(appended<need){
      const frag=document.createDocumentFragment();
      const step=Math.min(MAX_APPEND_PER_FRAME, need-appended);
      for(let i=0;i<step;i++){ const it=pool.shift(); frag.appendChild(card(it)); }
      feed.appendChild(frag); appended+=step;
      await new Promise(r=>requestAnimationFrame(r));
    }
    if(where==='home') ensureLocalCardAtTop(feed);
  }finally{ loadLock=false; ui.progressVisibility(); }
}

function waitForLocalVideoReady(){
  return Promise.resolve();
}

/* -------------------- batching -------------------- */
async function loadBatch(){
  if(isFetching) return;
  await waitForLocalVideoReady();
  isFetching=true; ui.phase('Fetching‚Ä¶'); ui.bar(10); ui.setProgressMode(true);
  pool.length=0;
  const homeFeed=document.getElementById('home');
  if(homeFeed){
    homeFeed.innerHTML='';
    ensureLocalCardAtTop(homeFeed);
  }

  try{
    const subs=[...STARTER_SUBS, ...OPTIONAL_NSFW];
    const all=[]; let done=0; lastErrors=[];

    for(const s of subs){
      const items=await pullSubreddit(s);
      all.push(...items);
      done++; ui.bar(10 + (done/subs.length)*80);
    }

    const seen=new Set(); const deduped=[];
    for(const it of all){ if(!it?.url) continue; if(seen.has(it.url)) continue; if(viewed.has(it.url)) continue; seen.add(it.url); deduped.push(it); }

    const matched=[], rest=[];
    for(const it of deduped){
      const perf=inferPerformer(it);
      if(titleHasName(it.title) || textMatchesAnyName(perf)) matched.push(it);
      else rest.push(it);
    }

    const bucketsTop={}, bucketsRest={};
    for(const it of matched){ (bucketsTop[it.sub] ||= []).push(it); }
    for(const it of rest){ (bucketsRest[it.sub] ||= []).push(it); }

    pool=[...interleaveBuckets(bucketsTop), ...interleaveBuckets(bucketsRest)];

    if (pool.length === 0) {
      log('‚ö†Ô∏è pool empty, showing local only.');
      ui.setProgressMode(false);
      if (homeFeed) {
        homeFeed.innerHTML='';
        ensureLocalCardAtTop(homeFeed);
      }
      document.dispatchEvent(new Event('videosBuilt'));
      return;
    }

    ui.bar(100); ui.phase('Ready'); ui.setProgressMode(false);
    await renderChunk('home', Math.min(CHUNK, pool.length));
    if (homeFeed) ensureLocalCardAtTop(homeFeed);

    document.dispatchEvent(new Event('videosBuilt'));
  }catch(err){
    const msg = `loadBatch failed: ${truncateLog(err && err.message ? err.message : err, 180)}`;
    lastErrors.push(msg);
    log(`‚ö†Ô∏è ${msg}`);
    ui.setProgressMode(false);
    document.dispatchEvent(new Event('videosBuilt'));
  }finally{
    isFetching=false;
    ui.progressVisibility();
  }
}

/* -------------------- shuffle/subs/troubleshoot -------------------- */
function shuffleVisibleAndPool(){
  const feed=document.getElementById('home');
  const localCard = getLocalVideoCard();
  const nodes=feed ? [...feed.children].filter(n=>n.classList.contains('card') && n !== localCard) : [];
  const visibleItems=nodes.map(n=>n.__item).filter(Boolean);
  const combined=[...visibleItems, ...pool];
  shuffleArray(combined);
  const keep=visibleItems.length;
  if(feed){
    feed.innerHTML='';
    ensureLocalCardAtTop(feed);
    for(let i=0;i<Math.min(keep,combined.length);i++) feed.appendChild(card(combined[i]));
  }
  pool=combined.slice(keep);
  ui.progressVisibility();
}
function buildSubsUI(){
  const grid=document.getElementById('subsGrid'); grid.innerHTML='';
  const current=new Set([...STARTER_SUBS, ...OPTIONAL_NSFW]);
  const all=[...new Set([...DEFAULT_STARTER_SUBS, ...DEFAULT_OPTIONAL_NSFW, ...STARTER_SUBS, ...OPTIONAL_NSFW])].sort((a,b)=>a.localeCompare(b));
  for(const sub of all){
    const id='sub-'+sub;
    const tile=document.createElement('label');
    tile.className='sub-tile';
    tile.innerHTML=`<input type="checkbox" id="${id}" ${current.has(sub)?'checked':''}><span>r/${esc(sub)}</span>`;
    grid.appendChild(tile);
  }
}
function saveSubsFromUI(){
  const checks=[...document.querySelectorAll('#subsGrid input[type="checkbox"]')];
  const picked=checks.filter(c=>c.checked).map(c=>c.id.replace('sub-',''));
  STARTER_SUBS = picked.filter(s=>DEFAULT_STARTER_SUBS.includes(s));
  OPTIONAL_NSFW = picked.filter(s=>DEFAULT_OPTIONAL_NSFW.includes(s));
  const leftovers=picked.filter(s=>!DEFAULT_STARTER_SUBS.includes(s) && !DEFAULT_OPTIONAL_NSFW.includes(s));
  STARTER_SUBS.push(...leftovers);
  localStorage.setItem('subs_toggle', JSON.stringify({starters:STARTER_SUBS, nsfw:OPTIONAL_NSFW}));
}
function dumpTroubleshoot(){
  const token=getToken();
  const info=[];
  info.push(`App state:\n  feed=${currentFeed}\n  pool=${pool.length}\n  likes=${likes.length}\n  discards=${discards.length}`);
  info.push(`Environment:\n  ua=${navigator.userAgent}\n  online=${navigator.onLine}\n  width=${innerWidth} height=${innerHeight}`);
  info.push(`Auth:\n  token=${token ? 'present' : 'none'}`);
  info.push(`Subs:\n  starters=[${STARTER_SUBS.join(', ')}]\n  nsfw=[${OPTIONAL_NSFW.join(', ')}]`);
  info.push(`Fetch plan:\n  LIMIT=${LIMIT}, PAGES=${PAGES}, CHUNK=${CHUNK}\n  celebNames=${CELEB_NAMES.length}`);
  if(lastErrors.length) info.push('Recent fetch errors:\n' + lastErrors.slice(-8).join('\n')); else info.push('Recent fetch errors: (none)');
  logEl.textContent=''; log(info.join('\n\n'));
}

/* -------------------- events -------------------- */
if (localVideoInput) {
  localVideoInput.addEventListener('change', async e => {
    const files = Array.from(e.target.files || []);
    e.target.value = '';

    if (!files.length) {
      localInputMode = 'replace';
      return;
    }

    try {
      if (localInputMode === 'replace') {
        const [file] = files;
        if (file) await setLocalVideoFromFile(file);
      } else {
        if (!getLocalVideoCard() && files[0]) {
          await setLocalVideoFromFile(files[0]);
        }
        await addFilesToLocalFeed(files);
      }
    } finally {
      localInputMode = 'replace';
    }
  });
}

window.addEventListener('beforeunload', () => {
  setLocalVideoObjectUrl(null);
  clearLocalFeedObjectUrls();
});

document.getElementById('newBatchBtn').addEventListener('click', loadBatch);
const refreshBtn = document.getElementById('refreshBtn');
if(refreshBtn){
  refreshBtn.addEventListener('click', ()=>{ loadBatch(); });
}
document.getElementById('shuffleBtn').addEventListener('click', shuffleVisibleAndPool);
const replaceLocalBtn = document.getElementById('replaceLocalBtn');
if (replaceLocalBtn && localVideoInput) {
  replaceLocalBtn.addEventListener('click', () => {
    localInputMode = 'replace';
    clearLocalVideoCard();
    localVideoInput.value = '';
    localVideoInput.click();
  });
}
const addLocalVideosBtn = document.getElementById('addLocalVideosBtn');
if (addLocalVideosBtn && localVideoInput) {
  addLocalVideosBtn.addEventListener('click', () => {
    localInputMode = 'add';
    localVideoInput.value = '';
    localVideoInput.click();
  });
}
document.querySelectorAll('.nav-btn[data-feed]').forEach(btn => {
  btn.addEventListener('click', e => {
    const target = e.currentTarget;
    const feed = target?.dataset?.feed;
    if(!feed) return;
    switchFeed(feed);
  });
});
document.getElementById('manageSubsBtn').addEventListener('click', ()=>{ buildSubsUI(); ui.showPage('subs'); el('#tabSubs').style.display=''; });
document.getElementById('closeModal').addEventListener('click', ()=> el('#modal').classList.remove('show'));
document.getElementById('connectBtn').addEventListener('click', beginOAuth);
document.getElementById('subsSelectAll').addEventListener('click', ()=>{ document.querySelectorAll('#subsGrid input[type="checkbox"]')?.forEach(c=>c.checked=true); });
document.getElementById('subsClearAll').addEventListener('click', ()=>{ document.querySelectorAll('#subsGrid input[type="checkbox"]')?.forEach(c=>c.checked=false); });
document.getElementById('subsBack').addEventListener('click', ()=> switchFeed('home'));
document.getElementById('subsSave').addEventListener('click', async ()=>{ saveSubsFromUI(); await loadBatch(); switchFeed('home'); });

if (clearLocalBtn) {
  clearLocalBtn.addEventListener('click', () => {
    clearLocalFeed();
  });
}

const pageTabsEl = document.getElementById('pageTabs');
if (pageTabsEl) {
  pageTabsEl.addEventListener('click', e => {
    const btn = e.target.closest('.pill[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;
    if (['home','likes','discard','local'].includes(action)) {
      switchFeed(action);
      return;
    }
    if (action === 'subs') {
      buildSubsUI();
      ui.showPage('subs');
    }
  });
}

function paintList(where, arr){ const host=document.getElementById(where); host.innerHTML=''; arr.forEach(it=>host.appendChild(card(it))); }

/* -------------------- autoload on scroll -------------------- */
async function onScrollAuto(){
  if(!AUTOLOAD || currentFeed!=='home') return;
  const doc=document.documentElement;
  const scrollTop=getScrollY();
  const nearBottom=(doc.scrollHeight - (scrollTop + window.innerHeight)) < AUTOLOAD_THRESHOLD_PX;
  const now=performance.now();
  if(nearBottom && !loadLock && pool.length>0 && (now - lastAutoTs) > AUTOLOAD_THROTTLE_MS){
    lastAutoTs=now;
    renderChunk('home');
  }

  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 200){
    if(pool.length>0 || loadLock || isFetching) return;
    await loadBatch();
  }
}
window.addEventListener('scroll', () => { onScrollAuto().catch(err => console.error(err)); }, {passive:true});

/* -------------------- OAuth helpers (implicit) -------------------- */
function rand(n=12){ return Array.from(crypto.getRandomValues(new Uint8Array(n))).map(v=>(v%36).toString(36)).join(''); }
function beginOAuth(){
  let clientId = localStorage.getItem('reddit_client_id') || DEFAULT_CLIENT_ID;
  let redirectUri = localStorage.getItem('reddit_redirect_uri') || DEFAULT_REDIRECT_URI;
  if(!clientId){ clientId = prompt('Enter your Reddit CLIENT ID (installed app):',''); if(!clientId) return; localStorage.setItem('reddit_client_id', clientId); }
  if(!redirectUri){ redirectUri = prompt('Enter the exact Redirect URI you set on old.reddit.com/apps:', location.origin + location.pathname) || ''; if(!redirectUri) return; localStorage.setItem('reddit_redirect_uri', redirectUri); }
  const state=rand(24); localStorage.setItem('reddit_oauth_state', state);
  const params=new URLSearchParams({client_id:clientId,response_type:'token',state,redirect_uri:redirectUri,duration:'temporary',scope:'read identity'});
  location.href='https://www.reddit.com/api/v1/authorize.compact?' + params.toString();
}
function captureTokenFromHash(){
  if(!location.hash) return;
  const h=new URLSearchParams(location.hash.slice(1));
  const token=h.get('access_token'); const state=h.get('state');
  if(!token) return;
  const expected=localStorage.getItem('reddit_oauth_state');
  if(expected && state !== expected){ log('State mismatch (ignored)'); return; }
  const expiresIn=parseInt(h.get('expires_in')||'3600',10);
  const rec={ access_token: token, expires_at: Date.now() + (expiresIn*1000) };
  localStorage.setItem('reddit_token', JSON.stringify(rec));
  log('Token stored, expires in ' + Math.round(expiresIn/60) + 'm');
  history.replaceState({}, document.title, location.pathname + location.search);
}
function clearToken(){ localStorage.removeItem('reddit_token'); log('Token cleared'); }
function getToken(){ try{ const t=JSON.parse(localStorage.getItem('reddit_token')||'null'); if(!t) return null; if(Date.now()>t.expires_at) return null; return t.access_token; }catch{ return null; } }

let zoomOverlay = null;
let zoomOpen = false;
let prevBodyOverflow = '';
let suppressSwipe = false;
let zoomOverlayGesturesBound = false;

function ensureZoomOverlay() {
  if (!zoomOverlay) {
    zoomOverlay = document.createElement('div');
    zoomOverlay.id = 'zoomOverlay';
    document.body.appendChild(zoomOverlay);
  }
  attachZoomOverlayGestures();
  return zoomOverlay;
}

function openZoomForMedia(mediaEl) {
  if (!mediaEl) return;
  const portal = ensureZoomOverlay();
  portal.innerHTML = '';
  const clone = mediaEl.cloneNode(true);
  clone.removeAttribute('style');
  clone.className = '';
  Object.assign(clone.style, {
    maxWidth: '100vw',
    maxHeight: '100vh',
    transform: 'none',
    position: 'relative',
    objectFit: 'contain'
  });

  if (clone.tagName === 'VIDEO') {
    clone.muted = false;
    clone.controls = true;
    try { clone.pause(); } catch {}
    try { mediaEl.pause(); } catch {}
  }

  portal.appendChild(clone);
  zoomMedia = clone;
  resetZoomTransform();

  prevBodyOverflow = document.body.style.overflow || '';
  document.body.style.overflow = 'hidden';
  document.documentElement.classList.add('is-zoom-open');

  portal.classList.add('open');
  zoomOpen = true;
  suppressSwipe = true;
}

function closeZoomOverlay() {
  if (!zoomOverlay) return;
  zoomOverlay.classList.remove('open');
  zoomOverlay.innerHTML = '';
  resetZoomTransform();
  zoomMedia = null;
  document.body.style.overflow = prevBodyOverflow;
  document.documentElement.classList.remove('is-zoom-open');
  zoomOpen = false;
  suppressSwipe = false;
}

function attachZoomOverlayGestures() {
  if (!zoomOverlay || zoomOverlayGesturesBound) return;
  zoomOverlayGesturesBound = true;

  zoomOverlay.addEventListener('dblclick', e => {
    e.preventDefault();
    resetZoomTransform();
  });

  zoomOverlay.addEventListener('click', e => {
    if (e.detail > 1) return;
    if (zoomScale <= 1.02) closeZoomOverlay();
  });
}

let zoomMedia = null;
let zoomScale = 1;
let zoomStart = 1;
let startDist = 0;
let offsetX = 0, offsetY = 0;
let lastX = 0, lastY = 0;

function resetZoomTransform() {
  zoomScale = 1;
  zoomStart = 1;
  startDist = 0;
  offsetX = offsetY = lastX = lastY = 0;
  applyZoomTransform();
}

function applyZoomTransform() {
  if (!zoomMedia) return;
  zoomMedia.style.transform = `translate3d(${offsetX}px, ${offsetY}px, 0) scale(${zoomScale})`;
}

function getDist(e) {
  const dx = e.touches[0].clientX - e.touches[1].clientX;
  const dy = e.touches[0].clientY - e.touches[1].clientY;
  return Math.hypot(dx, dy);
}

document.addEventListener('touchstart', e => {
  if (!zoomOverlay?.classList.contains('open')) return;
  zoomMedia = zoomOverlay.querySelector('img, video');
  if (!zoomMedia) return;

  if (e.touches.length === 2) {
    startDist = getDist(e);
    zoomStart = zoomScale;
  } else if (e.touches.length === 1 && zoomScale > 1) {
    lastX = e.touches[0].clientX - offsetX;
    lastY = e.touches[0].clientY - offsetY;
  }
}, { passive: false });

document.addEventListener('touchmove', e => {
  if (!zoomOverlay?.classList.contains('open')) return;
  if (!zoomMedia) return;

  if (e.touches.length === 2) {
    const dist = getDist(e);
    zoomScale = Math.min(4, Math.max(1, zoomStart * (dist / startDist)));
    applyZoomTransform();
    e.preventDefault();
  } else if (e.touches.length === 1 && zoomScale > 1) {
    offsetX = e.touches[0].clientX - lastX;
    offsetY = e.touches[0].clientY - lastY;
    applyZoomTransform();
    e.preventDefault();
  }
}, { passive: false });

document.addEventListener('touchend', e => {
  if (!zoomOverlay?.classList.contains('open')) return;
  if (zoomScale < 1.02) {
    resetZoomTransform();
  }
});

document.addEventListener('dblclick', () => {
  if (zoomOverlay?.classList.contains('open')) resetZoomTransform();
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && zoomOpen) closeZoomOverlay();
});

document.addEventListener('click', e => {
  if (zoomOpen) return;
  const img = e.target.closest('img.zoomable, img.media.zoomable');
  if (img) {
    e.preventDefault();
    openZoomForMedia(img);
  }
  // Uncomment below if videos should zoom too:
  // const vid = e.target.closest('video.zoomable, video.media.zoomable');
  // if (vid) { e.preventDefault(); openZoomForMedia(vid); }
}, { capture: true });

const _origAddEventListener = HTMLElement.prototype.addEventListener;
HTMLElement.prototype.addEventListener = function(type, listener, opts) {
  if (type === 'pointermove' || type === 'touchmove') {
    const wrapped = function(ev) {
      if (suppressSwipe) return;
      return listener.call(this, ev);
    };
    return _origAddEventListener.call(this, type, wrapped, opts);
  }
  return _origAddEventListener.call(this, type, listener, opts);
};

/* -------------------- boot -------------------- */
captureTokenFromHash();
ui.setProgressMode(false);
ui.bar(100); ui.phase('Ready');
setActiveTab('home');
log('Ready. Swipe right to Like, left to Dismiss. Tap a video to start, then tap again to mute/unmute. ‚ÄúViewed‚Äù items are skipped.');
bootstrapLocalFeed();
bootstrapLocalVideo();
(async ()=>{
  await waitForLocalVideoReady();
  await loadBatch();
})();
</script>
</body>
</html>
