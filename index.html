<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wall</title>
<style>
  :root{
    --bg:#0c1016; --bg2:#111723; --ink:#e8eefc; --muted:#a8b3c7;
    --accent:#ff6fa3; --panel:#182132; --glow:#7fc8ff44; --ok:#61d094; --warn:#ffb86b;
    --polaroid:#0f141f; --shadow:#00000099; --chip:#223047;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:radial-gradient(80% 120% at 50% 0, #132033 0, var(--bg) 55%) fixed;color:var(--ink);font:16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial}
  a{color:inherit}
  .wrap{max-width:980px;margin:24px auto;padding:0 14px 120px}

  /* Top nav */
  .nav{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
  .btn{appearance:none;border:none;cursor:pointer;border-radius:16px;padding:14px 18px;background:var(--panel);color:var(--ink);font-weight:700;box-shadow:0 0 0 1px #ffffff0d inset, 0 2px 12px #0007}
  .btn.pink{background:var(--accent);color:#111}
  .btn.ghost{background:#0000;box-shadow:0 0 0 1px #ffffff1a inset}
  .right{margin-left:auto}

  /* Control bar */
  .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:linear-gradient(180deg,#151e2c,#111826);padding:14px;border-radius:18px;box-shadow:0 10px 26px var(--shadow), 0 0 0 1px #fff1 inset}
  .chip{background:var(--chip);padding:10px 12px;border-radius:12px;color:#cfe0ff;box-shadow:0 0 0 1px #ffffff1a inset}
  .counter{min-width:72px;text-align:center;font-weight:800;border-radius:12px;background:#0b1220; padding:10px 12px}
  .tiny{font-size:12px;color:var(--muted)}
  .hidden{display:none !important}

  /* Grid + Polaroid Cards */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:16px}
  .card{position:relative;border-radius:18px;background:var(--polaroid);box-shadow:
    0 22px 40px #0008, 0 0 0 1px #ffffff12 inset;overflow:hidden}
  .media{position:relative;aspect-ratio: 4/5;background:#0b1220;display:grid;place-items:center}
  .media img,.media video{width:100%;height:100%;object-fit:cover;display:block}
  .badge{position:absolute;left:12px;top:12px;background:#0009;color:#fff;padding:6px 10px;border-radius:999px;font-weight:700;backdrop-filter:blur(6px)}
  .likeStar{position:absolute;right:12px;top:12px;font-size:22px;opacity:.85;filter:drop-shadow(0 4px 10px #0008)}
  .likeStar button{background:#0000;border:none;color:#ffd66e;cursor:pointer}
  .pad{padding:14px}
  .row{display:flex;gap:10px;align-items:center}
  .pill{padding:8px 12px;border-radius:999px;background:#0c1422;color:#c8d7ff;box-shadow:0 0 0 1px #ffffff1c inset}

  /* Swipe affordance */
  .dragging{transform:rotate(var(--rot,0deg)) translateX(var(--dx,0px));transition:none}
  .decay{transition:transform .25s ease, opacity .25s ease}

  /* Slide ‚Äúliked‚Äù sparkle */
  @keyframes sparkle{0%,100%{transform:scale(1);filter:drop-shadow(0 0 0 #0000)}50%{transform:scale(1.2);filter:drop-shadow(0 0 20px #ffd66e)}}
  .spark{animation:sparkle .6s ease}

  /* Sheets */
  .sheet{position:fixed;inset:auto 0 0 0;background:linear-gradient(180deg,#141b28,#0f1420);box-shadow:0 -10px 40px #000c;border-top-left-radius:18px;border-top-right-radius:18px;max-height:82vh;overflow:auto;transform:translateY(110%);transition:transform .25s ease}
  .sheet.open{transform:none}
  .sheet .hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #ffffff14}
  textarea{width:100%;min-height:260px;background:#0c1422;color:#e6f0ff;border:1px solid #ffffff1d;border-radius:12px;padding:12px;resize:vertical}
  .note{color:var(--muted);margin:8px 0 0}

  /* Toast */
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#1a0f10;border:1px solid #ffb3c0;color:#ffd7df;padding:10px 14px;border-radius:12px;box-shadow:0 8px 30px #000a}
</style>
</head>
<body>
<div class="wrap" id="app">

  <!-- Top nav -->
  <div class="nav">
    <button class="btn ghost" data-view="home">Home</button>
    <button class="btn ghost" data-view="liked">Liked ‚≠ê</button>
    <button class="btn ghost" data-view="subs">Subreddits ‚öôÔ∏è</button>
    <span class="right tiny" id="status">NSFW enabled ‚Ä¢ People-only</span>
  </div>

  <!-- Controls -->
  <div class="bar" id="controls">
    <button class="btn" id="newBatch">New batch</button>
    <button class="btn pink" id="loadMore">Load more</button>
    <div class="counter" id="count">0/0</div>
    <button class="btn" id="shuffle">Shuffle üîÄ</button>
    <button class="btn ghost right" id="troubleBtn">Troubleshoot ü©∫</button>
  </div>

  <!-- Home grid -->
  <div class="grid" id="grid"></div>

  <!-- Liked page -->
  <div class="sheet" id="liked">
    <div class="hdr">
      <strong>Liked ‚≠ê</strong>
      <div>
        <button class="btn ghost" id="undo">Undo last</button>
        <button class="btn" id="exportLikes">Export JSON</button>
        <button class="btn pink" onclick="closeSheet('liked')">Close</button>
      </div>
    </div>
    <div class="grid" id="likedGrid"></div>
  </div>

  <!-- Subreddits page -->
  <div class="sheet" id="subs">
    <div class="hdr">
      <strong>Subreddits ‚öôÔ∏è</strong>
      <div>
        <button class="btn" id="restoreSubs">Restore default</button>
        <button class="btn pink" id="saveSubs">Save & Refresh</button>
      </div>
    </div>
    <div class="pad">
      <p class="tiny">One subreddit per line. Names only (no ‚Äúr/‚Äù). List is randomized per batch.</p>
      <textarea id="subsInput"></textarea>
      <p class="note" id="subsNote"></p>
    </div>
  </div>

  <!-- Troubleshoot -->
  <div class="sheet" id="trouble">
    <div class="hdr">
      <strong>Troubleshoot</strong>
      <button class="btn pink" onclick="closeSheet('trouble')">Close</button>
    </div>
    <pre class="pad" id="diag" style="white-space:pre-wrap"></pre>
  </div>

  <div class="toast hidden" id="toast"></div>
</div>

<script>
/* =============== Storage helpers =============== */
const LS = {
  get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
};
const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

/* =============== Default women-only sub list =============== */
/* 100+ names (models / influencers / actors / singers). Feel free to edit in Subreddits page. */
const DEFAULT_SUBS = [
  "EmilyRatajkowski","AnaDeArmas","AlexisRen","MadisonBeer","AddisonRae","HaileyBieber",
  "BellaHadid","KylieJenner","KendallJenner","CharliDamelio","DixieDamelio","ArianaGrande",
  "SabrinaCarpenter","SydneySweeney","MargotRobbie","Zendaya","EmiliaClarke","JennaOrtega",
  "FlorencePugh","AnaTaylorJoy","AlexandraDaddario","ElizabethOlsen","GalGadot","EmmaWatson",
  "DuaLipa","DojaCat","TaylorSwift","RosieHW","ScarlettJohansson","MeganFox","SZA",
  "LaurenJauregui","BeckyG","Somi","Suzy","TWICEMomo","TWICETzuyu","BLACKPINKJisoo",
  "BLACKPINKJennie","BLACKPINKLisa","BLACKPINKRos√©","IU","KarinaAESPA","WinterAESPA",
  "YooJung","Wonyoung","LeaElui","SommerRay","AlessandraAmbrosio","CandiceSwanepoel",
  "BarbaraPalvin","SaraSampaio","BellaPoarch","LilyCollins","EmilyBlunt","AnaIvanovic",
  "EmmaMackey","CamilaCabello","OliviaRodrigo","SofiaVergara","Shakira","SalmaHayek",
  "RileyKeough","KekePalmer","RachelZegler","HalleBailey","AnaCheri","AbigailRatchford",
  "PaigeSpiranac","KatieSigmond","LanaRhoades", /* still a celeb; keep SFW filter dependent on Reddit */
  "TessaThompson","BrieLarson","LilyJames","PhoebeDynevor","AlexaDemie","MaudeApatow",
  "HoyeonJung","AnaDeLaReguera","EizaGonzalez","AdriaArjona","AvaMax","BebeRexha",
  "FKA_twigs","GracieAbrams","SabrinaNichole","KarlieKloss","GigiHadid","NinaDobrev",
  "MirandaKerr","IrinaShayk","KaiaGerber","CamilaMendes","LiliReinhart","MaitreyiRamakrishnan",
  "JoeyKing","MiaGoth","AnaSophiaRobb","HalstonSage","CamilaMorrone","DoveCameron",
  "VictoriaJustice","PeytonList","ChloeMoretz","SukiWaterhouse","JordynWoods","RashmikaMandanna"
];

/* =============== State =============== */
let subs = LS.get('subs', DEFAULT_SUBS);
let liked = LS.get('liked', []);
let pool = [];         // queued posts ready to show
let shown = [];        // history of cards shown (for undo from liked page)
let lastErr = null;
let fetchBusy = false;
let backoff = 0;       // grows on 429

/* =============== Elements =============== */
const grid = document.getElementById('grid');
const likedGrid = document.getElementById('likedGrid');
const count = document.getElementById('count');
const statusLbl = document.getElementById('status');
const toastEl = document.getElementById('toast');
const diag = document.getElementById('diag');
const subsInput = document.getElementById('subsInput');
const subsNote = document.getElementById('subsNote');

/* =============== UI helpers =============== */
function setCount(){ count.textContent = `${shown.length}/${pool.length}` }
function toast(msg){ toastEl.textContent = msg; toastEl.classList.remove('hidden'); setTimeout(()=>toastEl.classList.add('hidden'), 1800) }
function openSheet(id){ document.getElementById(id).classList.add('open') }
function closeSheet(id){ document.getElementById(id).classList.remove('open') }
function setView(v){
  if(v==='liked'){ renderLiked(); openSheet('liked'); }
  else if(v==='subs'){ renderSubs(); openSheet('subs'); }
  else { closeSheet('liked'); closeSheet('subs'); }
}
document.querySelectorAll('[data-view]').forEach(b=>b.onclick=()=>setView(b.dataset.view));

/* =============== Build requests =============== */
function subToUrl(sub){
  // use reddit.com (CORS OK) with raw_json for clean URLs
  // fetch top mixed timeframe to maximize success; we'll filter images/videos below
  const pick = ['hot','top','new'][Math.floor(Math.random()*3)];
  const t = pick==='top' ? '&t=week' : '';
  return `https://www.reddit.com/r/${encodeURIComponent(sub)}/${pick}.json?raw_json=1&limit=25${t}`;
}

/* =============== Extract media =============== */
function pickMedia(p){
  // Reject text/self
  if(!p || p.over_18===undefined) return null;
  // Prefer hosted images
  if(p.post_hint==='image' && p.url && /\.(jpg|jpeg|png|webp)$/i.test(p.url)){
    return { type:'img', src:p.url };
  }
  // Animated GIF variant (mp4)
  const prev = p.preview && p.preview.images && p.preview.images[0];
  const mp4 = prev && prev.variants && (prev.variants.mp4 || prev.variants.gif);
  if(mp4 && mp4.source && mp4.source.url){
    return { type:'video', src: mp4.source.url.replace(/&amp;/g,'&'), muted:true, loop:true };
  }
  // Native reddit video
  const rv = p.secure_media && p.secure_media.reddit_video;
  if(rv && rv.fallback_url){
    return { type:'video', src: rv.fallback_url, muted:true, loop:true };
  }
  // Some direct .gif links
  if(p.url && /\.gif($|\?)/i.test(p.url)){
    return { type:'video', src: p.url, muted:true, loop:true };
  }
  return null;
}

/* =============== Fetch one subreddit with backoff/retry =============== */
async function fetchOne(sub){
  // backoff if previous 429
  if(backoff>0){ await sleep(backoff); }
  const t0 = performance.now();
  try{
    const res = await fetch(subToUrl(sub), { credentials:'omit', cache:'no-store' });
    if(res.status===429){ lastErr = `${sub}: 429`; backoff = Math.min((backoff||800)*1.6, 6000); return []; }
    if(!res.ok){ lastErr = `${sub}: ${res.status}`; return []; }
    backoff = 0;
    const json = await res.json();
    const children = json?.data?.children || [];
    const out = [];
    for(const c of children){
      const d = c.data;
      const m = pickMedia(d);
      if(!m) continue;
      out.push({
        id: d.id,
        sub: d.subreddit,
        nsfw: !!d.over_18,
        media: m,
        author: d.author,
        permalink: `https://reddit.com${d.permalink}`
      });
    }
    if(out.length===0){ lastErr = `${sub}: no media`; }
    return out;
  }catch(e){
    lastErr = `${sub}: ${e.message}`;
    return [];
  }finally{
    console.debug('fetch', sub, Math.round(performance.now()-t0)+'ms');
  }
}

/* =============== Build a new batch =============== */
async function newBatch(){
  if(fetchBusy) return;
  fetchBusy = true;
  grid.innerHTML = '';
  pool = [];
  shown = [];
  setCount();
  const list = [...subs].sort(()=>Math.random()-0.5).slice(0, 18); // hit up to 18 subs per batch
  for(const s of list){
    const items = await fetchOne(s);
    // prefer NSFW + SFW mix; we already restrict by name-only subs
    pool.push(...items);
    // light pacing between subs to avoid 429 bursts
    await sleep(160);
  }
  // unique by id, randomize order
  const seen = new Set(), dedup=[];
  for(const p of pool){ if(!seen.has(p.id)){ seen.add(p.id); dedup.push(p) } }
  pool = dedup.sort(()=>Math.random()-0.5);
  setCount();
  if(pool.length===0){ toast('No fresh posts. Tap again.'); }
  fetchBusy = false;
}

/* =============== Render one card =============== */
function cardEl(post){
  const el = document.createElement('div');
  el.className = 'card decay';
  el.dataset.id = post.id;

  const m = document.createElement('div');
  m.className = 'media';

  if(post.media.type==='img'){
    const img = new Image();
    img.loading = 'lazy';
    img.src = post.media.src;
    m.appendChild(img);
  }else{
    const v = document.createElement('video');
    v.src = post.media.src;
    v.autoplay = true; v.muted = true; v.playsInline = true; v.loop = true; v.controls = false;
    v.addEventListener('error', ()=> v.classList.add('hidden'));
    m.appendChild(v);
  }

  const tag = document.createElement('div');
  tag.className = 'badge pill';
  tag.textContent = `r/${post.sub}`;
  m.appendChild(tag);

  const star = document.createElement('div');
  star.className = 'likeStar';
  star.innerHTML = `<button title="Like">‚≠ê</button>`;
  star.onclick = (e)=>{ e.stopPropagation(); like(post, el); };
  m.appendChild(star);

  el.appendChild(m);
  enableDragToRate(el, post);
  return el;
}

/* =============== Show next chunk =============== */
function loadMore(n=6){
  if(pool.length===0){ toast('No fresh posts. Tap again.'); return }
  const next = pool.splice(0, n);
  for(const p of next){
    const el = cardEl(p);
    grid.appendChild(el);
    shown.push(p);
  }
  setCount();
}

/* =============== Shuffle: reshuffle remaining pool =============== */
function shuffle(){
  pool.sort(()=>Math.random()-0.5);
  // also reshuffle visible order by reflowing
  const nodes = [...grid.children];
  nodes.sort(()=>Math.random()-0.5).forEach(n=>grid.appendChild(n));
  toast('Shuffled');
}

/* =============== Like / Undo / Render liked =============== */
function like(post, el){
  liked.push(post);
  LS.set('liked', liked);
  if(el){ el.classList.add('spark'); setTimeout(()=>el.remove(), 260); }
}
function renderLiked(){
  likedGrid.innerHTML = '';
  if(liked.length===0){ likedGrid.innerHTML = '<div class="pad tiny">No likes yet.</div>'; return; }
  for(const p of liked){
    const el = cardEl(p);
    // remove subreddit badge in liked? keep it.
    likedGrid.appendChild(el);
  }
}
document.getElementById('undo').onclick = ()=>{
  const x = liked.pop();
  if(x){ LS.set('liked', liked); toast('Undid last like'); renderLiked(); }
};
document.getElementById('exportLikes').onclick = ()=>{
  const blob = new Blob([JSON.stringify(liked,null,2)],{type:'application/json'});
  const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'likes.json'});
  a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
};

/* =============== Drag to like/dismiss =============== */
function enableDragToRate(card, post){
  let startX=null, dx=0, likedFlag=false;
  const end = ()=>{
    card.classList.add('decay');
    const W = card.clientWidth;
    if(dx> W*0.27){ likedFlag=true; like(post, card); }
    else if(dx< -W*0.27){ card.style.opacity='.0'; setTimeout(()=>card.remove(), 200); }
    card.style.transform=''; card.style.setProperty('--rot','0deg'); card.style.setProperty('--dx','0px');
    startX=null; dx=0;
  };
  card.addEventListener('pointerdown', e=>{ startX=e.clientX; dx=0; card.setPointerCapture(e.pointerId); card.classList.remove('decay'); });
  card.addEventListener('pointermove', e=>{
    if(startX==null) return;
    dx = e.clientX - startX;
    card.style.setProperty('--dx', dx+'px');
    card.style.setProperty('--rot', (dx/22)+'deg');
    card.classList.add('dragging');
  });
  card.addEventListener('pointerup', end);
  card.addEventListener('pointercancel', end);
}

/* =============== Subreddits page render/save =============== */
function renderSubs(){
  subsInput.value = subs.join('\n');
  subsNote.textContent = subs.length + ' subs in list';
}
document.getElementById('saveSubs').onclick = ()=>{
  const lines = subsInput.value.split('\n').map(s=>s.trim()).filter(Boolean);
  subs = Array.from(new Set(lines.map(s=>s.replace(/^r\//i,'').replace(/\s+/g,'')))); // normalize
  LS.set('subs', subs);
  subsNote.textContent = 'Saved ‚Ä¢ ' + subs.length + ' subs';
  closeSheet('subs');
  newBatch();
};
document.getElementById('restoreSubs').onclick = ()=>{
  subs = [...DEFAULT_SUBS];
  LS.set('subs', subs);
  renderSubs();
  subsNote.textContent = 'Restored defaults';
};

/* =============== Troubleshoot panel =============== */
function updateDiag(){
  const ua = navigator.userAgent;
  const info = [
    `Online: ${navigator.onLine}`,
    `UA: ${ua}`,
    `Pool size: ${pool.length}, shown: ${shown.length}, likes: ${liked.length}`,
    `Last error: ${lastErr ?? '(none)'}`
  ].join('\n');
  diag.textContent = info;
}

/* =============== Wire controls =============== */
document.getElementById('loadMore').onclick = ()=> loadMore();
document.getElementById('newBatch').onclick = ()=> newBatch();
document.getElementById('shuffle').onclick = ()=> shuffle();
document.getElementById('troubleBtn').onclick = ()=>{ updateDiag(); openSheet('trouble'); };

/* =============== Init =============== */
(async function init(){
  statusLbl.textContent = 'NSFW enabled ‚Ä¢ People-only list';
  // Ensure we have subs saved at least once
  if(!LS.get('subs', null)) LS.set('subs', subs);
  await newBatch();
  // if nothing came, try once more after a short pause (handles initial 429)
  if(pool.length===0){ await sleep(1200); await newBatch(); }
})();
</script>
</body>
</html>