<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Celeb Wall v2.0</title>
<style>
  :root{
    --bg:#0e0f12;--card:#14161b;--glass:rgba(255,255,255,.06);--ring:rgba(255,255,255,.12);
    --fg:#e9eef6;--muted:#9aa3ad;--good1:#19e3cf;--good2:#1aa7ff;--bad1:#ff6b86;--bad2:#ff9aa8;
    --pill:#1a1d23;--shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    --radius:22px;--br:18px;
  }
  html,body{background:var(--bg);color:var(--fg);font:600 18px/1.35 -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,system-ui,Arial,sans-serif;margin:0}
  *{box-sizing:border-box}
  .wrap{max-width:820px;margin:18px auto;padding:0 14px 80px}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:10px 0 14px}
  .kpi{background:var(--glass);backdrop-filter:blur(14px);border-radius:20px;padding:18px 16px;border:1px solid var(--ring);box-shadow:var(--shadow)}
  .kpi h6{margin:0 0 8px;color:var(--muted);letter-spacing:.12em;font-size:12px;text-transform:uppercase}
  .kpi b{font-size:28px}
  .bar{height:10px;background:#1b1e24;border-radius:999px;overflow:hidden;border:1px solid var(--ring)}
  .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#c38bff,#7de3ff,#ff8fc9)}
  .bar-row{display:flex;gap:12px;align-items:center;margin:10px 0 4px}
  .bar-row small{color:var(--muted)}
  .dash{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin:16px 0 12px}
  .btn{appearance:none;border:0;padding:16px 22px;border-radius:28px;background:var(--glass);
       color:#dfe6f2;border:1px solid var(--ring);box-shadow:var(--shadow);font-weight:800}
  .btn.primary{background:linear-gradient(135deg,#b892ff,#89e3ff);color:#0b0f14;text-shadow:0 1px 0 rgba(255,255,255,.5)}
  .btn.good{background:linear-gradient(135deg,var(--good2),var(--good1));color:#001317;text-shadow:0 1px 0 rgba(255,255,255,.45)}
  .btn.bad{ background:linear-gradient(135deg,var(--bad2),var(--bad1)); color:#2a000a;text-shadow:0 1px 0 rgba(255,255,255,.45)}
  .grid{display:grid;gap:16px;margin:14px 0}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:26px;overflow:hidden;box-shadow:var(--shadow)}
  .head{position:relative;padding:14px 16px}
  .title{position:absolute;left:14px;top:14px;background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.0));
         padding:10px 14px;border-radius:16px;color:#fff;backdrop-filter:blur(6px);max-width:calc(100% - 28px)}
  .title b{display:block;font-size:22px;text-shadow:0 2px 10px rgba(0,0,0,.8)}
  .title small{opacity:.9;color:#e9eef6}
  .media{width:100%;max-height:80vh;object-fit:cover;display:block;background:#0b0c10}
  video.media{background:#0b0c10;outline:0}
  .actions{display:flex;gap:14px;justify-content:space-between;padding:16px}
  .actions .btn{flex:1;font-size:22px}
  .fade-out{animation:fade .4s ease forwards}
  @keyframes fade{to{opacity:0;transform:scale(.995)}}
  dialog{border:1px solid var(--ring);background:var(--card);color:var(--fg);border-radius:20px;padding:16px 16px 14px}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .field{display:flex;gap:8px;margin:10px 0}
  input[type=text]{flex:1;border:1px solid var(--ring);background:#101217;color:var(--fg);padding:14px;border-radius:14px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;margin:6px;border-radius:999px;border:1px solid var(--ring);background:#101217}
  .pill b{font-weight:700}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .footer-space{height:70px}
</style>
</head>
<body>
<div class="wrap">
  <div class="stats">
    <div class="kpi"><h6>Build</h6><b id="build">v2.0</b></div>
    <div class="kpi"><h6>Shown</h6><b id="kShown">0</b></div>
    <div class="kpi"><h6>Pool</h6><b id="kPool">0</b></div>
    <div class="kpi"><h6>Total</h6><b id="kTotal">0</b></div>
  </div>

  <div class="bar-row"><small id="phase">Ready</small><div style="flex:1" class="bar"><i id="bar"></i></div><small id="pct">100%</small></div>

  <div class="dash">
    <button class="btn" id="homeBtn">Home</button>
    <button class="btn" id="likesBtn">Likes</button>
    <button class="btn" id="discardBtn">Discard</button>
    <button class="btn primary" id="newBatch">New batch</button>
    <button class="btn" id="shuffleBtn">Shuffle feed</button>
    <button class="btn" id="loadMore">Load more</button>
    <button class="btn" id="subsBtn">+ Subreddits</button>
  </div>

  <section id="cards" class="grid"></section>
  <div class="footer-space"></div>
</div>

<dialog id="subsDlg">
  <form method="dialog">
    <h3 style="margin:0 0 6px">Subreddits</h3>
    <div class="muted" style="margin-bottom:6px">Add/remove (comma or space separated). No <code>/r/</code> prefix.</div>
    <div class="field">
      <input id="subsInput" type="text" placeholder="Celebs, CelebEvents, celebritypics …">
      <button class="btn primary">Save</button>
    </div>
    <div id="subsChips" class="row"></div>
  </form>
</dialog>

<script>
(() => {
  const qs = (s,p=document)=>p.querySelector(s);
  const el = (t,attrs={},children=[]) => {
    const n = document.createElement(t);
    for (const k in attrs){
      const v = attrs[k];
      if (k === 'style') Object.assign(n.style, v);
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v, {passive:true});
      else n.setAttribute(k, v);
    }
    if (!Array.isArray(children)) children=[children];
    children.filter(Boolean).forEach(c => n.appendChild(typeof c==='string'?document.createTextNode(c):c));
    return n;
  };

  const state = {
    items: [],
    shown: 0,
    likes: JSON.parse(localStorage.getItem('cw_likes')||'[]'),
    discards: JSON.parse(localStorage.getItem('cw_discards')||'[]'),
    subs: JSON.parse(localStorage.getItem('cw_subs')||'[]'),
    token: localStorage.getItem('cw_token')||'',
    afterBySub: {},
    mode: 'home'
  };

  // ---------- UI bits ----------
  const cards = qs('#cards');
  const kShown = qs('#kShown'), kPool = qs('#kPool'), kTotal = qs('#kTotal');
  const bar = qs('#bar'), phase = qs('#phase'), pct = qs('#pct');

  function setPhase(label, p){
    phase.textContent = label;
    const pc = Math.max(0, Math.min(100, Math.round(p)));
    bar.style.width = pc+'%'; pct.textContent = pc+'%';
  }

  function persist(){
    localStorage.setItem('cw_likes', JSON.stringify(state.likes.slice(0,10000)));
    localStorage.setItem('cw_discards', JSON.stringify(state.discards.slice(0,10000)));
    localStorage.setItem('cw_subs', JSON.stringify(state.subs.slice(0,200)));
  }

  function defaultSubs(){
    // No LadiesOfWrestling in defaults
    return ['Celebs','CelebEvents','celebritypics','BeautifulCelebrities','CelebGowns','CharliDamelioMommy','LeaEluiGinet','LeaEluiG_NR'];
  }

  // ---------- Fetch ----------
  const OAUTH_BASE = 'https://oauth.reddit.com';
  const PUBLIC_MIRROR = 'https://r.jina.ai/http://www.reddit.com';

  async function fetchListing(sub, after=''){
    // Prefer OAuth if we have a token
    const useOAuth = !!state.token;
    const url = useOAuth
      ? `${OAUTH_BASE}/r/${sub}/hot?limit=50&raw_json=1${after?`&after=${after}`:''}`
      : `${PUBLIC_MIRROR}/r/${sub}/hot.json?limit=50&raw_json=1${after?`&after=${after}`:''}`;

    const headers = useOAuth ? {Authorization:`Bearer ${state.token}`} : {};
    const res = await fetch(url, {headers});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  function normalizePost(p, sub){
    const d = p.data || p;
    const author = d.author ? `u/${d.author}`:'u/unknown';
    return {
      id: d.id,
      author,
      sub,
      title: d.title || '',
      url: d.url_overridden_by_dest || d.url || '',
      is_video: !!d.is_video,
      media: d.media || d.secure_media || null,
      preview: d.preview || null,
      hint: d.post_hint || '',
      is_gallery: d.is_gallery || false,
      gallery_data: d.gallery_data || null,
      secure_media: d.secure_media || null,
      ups: d.ups||0,
      permalink: 'https://reddit.com' + (d.permalink||'')
    };
  }

  async function getItems(batchSubs){
    const subs = (state.subs && state.subs.length ? state.subs : defaultSubs())
      .filter(s => !/ladiesofwrestling/i.test(s)); // belt+suspenders
    const finalSubs = batchSubs && batchSubs.length ? batchSubs : subs;

    setPhase(`Requesting (${finalSubs.length})`, 8);
    const results = [];
    for (let i=0;i<finalSubs.length;i++){
      const sub = finalSubs[i];
      try{
        const after = state.afterBySub[sub] || '';
        const json = await fetchListing(sub, after);
        const data = json.data || json;
        const children = (data.children || []).map(c => normalizePost(c, sub));
        if (data.after) state.afterBySub[sub] = data.after;

        // Filter only things with a visual media target
        const usable = children.filter(x => {
          if (x.is_video) return true;
          const u = (x.url||'').toLowerCase();
          return /\.(jpe?g|png|webp|gif|mp4)(\?|$)/.test(u) || /v\.redd\.it/.test(u) || (x.preview && x.preview.images?.length);
        });

        results.push(...usable);
        setPhase(`Loaded ${results.length} so far (r/${sub})`, 8 + (92*(i+1)/finalSubs.length));
      }catch(err){
        setPhase(`× r/${sub}: ${err.message}`, 8 + (92*(i+1)/finalSubs.length));
      }
    }
    return results;
  }

  // ---------- Media creation (robust GIF/MP4 handling) ----------
  function bestImageFromPreview(prev){
    try{
      const imgs = prev?.images?.[0];
      const src = imgs?.variants?.gif?.source?.url || imgs?.source?.url;
      return src ? src.replace(/&amp;/g,'&') : '';
    }catch{ return ''; }
  }

  function createMediaEl(item){
    let url =
      item.secure_media?.reddit_video?.fallback_url ||
      item.media?.reddit_video?.fallback_url ||
      item.url || '';

    // imgur .gifv → .mp4
    if (/imgur\.com\/.+\.gifv$/i.test(url)) url = url.replace(/\.gifv$/i, '.mp4');

    const looksVideo = Boolean(item.is_video) || /\.mp4(\?|$)/i.test(url) || /\/v\.redd\.it\//.test(url);
    const looksGif   = /\.(gif)(\?|$)/i.test(url);

    if (looksVideo || /v\.redd\.it/.test(url) || looksGif){
      const poster = bestImageFromPreview(item.preview) || '';
      const v = el('video', {
        class:'media',
        playsinline:'', muted:'', loop:'', preload:'metadata',
        ...(poster ? {poster} : {})
      });
      v.src = looksGif ? url.replace(/\.gif(\?|$)/i, '.mp4$1') : url;
      // Tap to toggle mute
      v.addEventListener('click', ()=>{ v.muted = !v.muted; });
      return v;
    }else{
      // image
      const img = el('img', {class:'media', loading:'lazy', alt:item.title||''});
      img.src = url || bestImageFromPreview(item.preview);
      return img;
    }
  }

  // Auto play/pause videos in view
  const io = new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      const v = e.target;
      if (!(v instanceof HTMLVideoElement)) return;
      if (e.isIntersecting){ v.play().catch(()=>{}); }
      else { v.pause(); }
    });
  }, {rootMargin:'0px 0px -35% 0px', threshold: .25});

  // ---------- Render ----------
  function cardFor(item){
    const head = el('div',{class:'head'},[
      el('div',{class:'title'},[
        el('b',{},`${item.author}`),
        el('small',{},`r/${item.sub}`)
      ])
    ]);
    const media = createMediaEl(item);
    if (media.tagName === 'VIDEO') io.observe(media);

    const like = el('button',{class:'btn good'},'Like');
    const bad  = el('button',{class:'btn bad'},'Dismiss');

    like.addEventListener('click', ()=>{
      state.likes.unshift(item);
      state.items = state.items.filter(x => x.id !== item.id);
      persist(); updateCounts();
      card.remove();
      card.classList.add('fade-out');
    }, {passive:true});

    bad.addEventListener('click', ()=>{
      state.discards.unshift(item.id);
      state.items = state.items.filter(x => x.id !== item.id);
      persist(); updateCounts();
      card.remove();
      card.classList.add('fade-out');
    }, {passive:true});

    const actions = el('div',{class:'actions'},[bad,like]);
    const card = el('div',{class:'card'},[head,media,actions]);
    return card;
  }

  function updateCounts(){
    kShown.textContent = String(document.querySelectorAll('.card').length);
    kPool.textContent  = String(state.items.length);
    kTotal.textContent = String(state.likes.length);
  }

  function renderItems(items, append=true){
    const frag = document.createDocumentFragment();
    items.forEach(it => frag.appendChild(cardFor(it)));
    if (!append) cards.innerHTML = '';
    cards.appendChild(frag);
    updateCounts();
  }

  // ---------- Controls ----------
  async function buildBatch(){
    setPhase('Requesting', 6);
    const items = await getItems();
    // De-dup by id and discard removed
    const seen = new Set();
    const filtered = items.filter(x=>{
      if (state.discards.includes(x.id)) return false;
      if (seen.has(x.id)) return false; seen.add(x.id); return true;
    });
    state.items = filtered;
    setPhase('Ready', 100);
    renderItems(state.items, false);
  }

  function shuffle(){
    for (let i=state.items.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1)); [state.items[i],state.items[j]]=[state.items[j],state.items[i]];
    }
    renderItems(state.items, false);
  }

  async function loadMore(){
    setPhase('Loading more', 12);
    const more = await getItems();
    state.items.push(...more);
    setPhase('Ready', 100);
    renderItems(state.items, false);
  }

  // “+ Subreddits” dialog
  const subsDlg = qs('#subsDlg'), subsInput = qs('#subsInput'), subsChips = qs('#subsChips');
  function openSubs(){
    const list = (state.subs && state.subs.length ? state.subs : defaultSubs());
    subsInput.value = list.join(', ');
    subsChips.innerHTML = '';
    list.forEach(s=>{
      const chip = el('span',{class:'pill'},[el('b',{},s)]);
      subsChips.appendChild(chip);
    });
    subsDlg.showModal();
  }
  subsDlg.addEventListener('close', ()=>{
    const raw = subsInput.value.trim();
    const arr = raw.split(/[\s,]+/).filter(Boolean).map(s=>s.replace(/^r\//i,''));
    state.subs = arr.filter(x=>!/ladiesofwrestling/i.test(x));
    persist();
    buildBatch();
  });

  // Auto-load on scroll (add ~10 more when near bottom)
  let ticking=false;
  window.addEventListener('scroll', ()=>{
    if (ticking) return; ticking=true;
    requestAnimationFrame(()=>{
      ticking=false;
      const near = (window.innerHeight + window.scrollY) > (document.body.offsetHeight - 900);
      if (near) loadMore().catch(()=>{});
    });
  }, {passive:true});

  // Hook up buttons
  qs('#newBatch').addEventListener('click', ()=>buildBatch());
  qs('#shuffleBtn').addEventListener('click', ()=>shuffle());
  qs('#loadMore').addEventListener('click', ()=>loadMore());
  qs('#subsBtn').addEventListener('click', ()=>openSubs());
  qs('#homeBtn').addEventListener('click', ()=>{ state.mode='home'; buildBatch(); });
  qs('#likesBtn').addEventListener('click', ()=>{
    state.mode='likes';
    const liked = state.likes || [];
    renderItems(liked, false);
    setPhase('Showing likes', 100);
  });
  qs('#discardBtn').addEventListener('click', ()=>{
    state.mode='discard';
    const disc = state.discards || [];
    cards.innerHTML='';
    cards.appendChild(el('div',{},`Discarded: ${disc.length}`));
    setPhase('Discard list', 100);
  });

  // ---------- Init ----------
  (async function init(){
    setPhase('Ready', 100);
    await buildBatch();
  })();
})();
</script>
</body>
</html>