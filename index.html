<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Celeb Wall — v2.0 glass</title>
<style>
  :root{
    --bg:#0b0c0f; --panel:#121418; --muted:#aab3c2; --text:#e9eef6;
    --chip:#1b1f26; --ring:rgba(255,255,255,.08);
    --grad-red: linear-gradient(135deg,#ff5576,#ff9bb0);
    --grad-blue: linear-gradient(135deg,#36c6ff,#12e3b2);
    --glass: linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 600px at 20% -10%,#1a2030,transparent),
                     radial-gradient(900px 500px at 110% 0,#1b2c36,transparent),
                     var(--bg);
    color:var(--text); font:16px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  /* Dashboard */
  header{position:sticky; top:0; z-index:40; padding:16px 16px 10px; backdrop-filter:saturate(120%) blur(10px);
         background:linear-gradient(180deg,rgba(7,10,14,.75),rgba(7,10,14,.35) 70%,transparent)}
  .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:center; max-width:980px; margin:0 auto}
  .stat{
    min-width:86px; padding:12px 14px; border-radius:18px; background:var(--panel); box-shadow:0 6px 24px rgba(0,0,0,.35), inset 0 1px 0 var(--ring);
    text-align:center
  }
  .stat .k{font-size:13px; letter-spacing:.12em; color:#c7cfda; opacity:.8}
  .stat .v{font-size:28px; font-weight:900}
  .controls{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:10px}
  .pill{
    padding:12px 18px; border-radius:18px; background:#171a20; color:#dfe6f2; font-weight:800; border:0;
    box-shadow:0 8px 28px rgba(0,0,0,.35), inset 0 1px 0 var(--ring); cursor:pointer
  }
  .pill.grad{ background: linear-gradient(135deg,#b19cff,#67c3ff 40%, #ffa4cf 100%); color:#0b0b0b}
  .pill:disabled{opacity:.45; cursor:not-allowed}
  .bar{position:relative; height:12px; border-radius:999px; background:#14171c; margin:12px auto 0; max-width:980px; overflow:hidden}
  .bar .fill{position:absolute; inset:0 100% 0 0; background:linear-gradient(90deg,#ff9bb0 0,#c3b5ff 50%,#67e2ff 100%); transition: right .3s ease}
  .bar .txt{position:absolute; right:10px; top:50%; transform:translateY(-50%); font-weight:800; font-size:12px; color:#d4dced; text-shadow:0 1px 0 #000}

  /* Cards */
  main{max-width:1020px; margin:14px auto 120px; padding:0 14px}
  .card{position:relative; overflow:hidden; border-radius:22px; background:#111; margin:18px auto; box-shadow:0 10px 40px rgba(0,0,0,.45)}
  .card .media{width:100%; display:block; background:#0a0a0a}
  .card video{max-height:86vh}
  .card-hd{position:absolute; left:12px; top:12px; right:12px; padding:10px 12px; border-radius:14px;
           background:linear-gradient(180deg,rgba(0,0,0,.38),rgba(0,0,0,.18)); color:#fff;
           backdrop-filter: blur(8px); text-shadow:0 1px 2px rgba(0,0,0,.45)}
  .card-hd .title{font-size:18px; font-weight:900; line-height:1.2}
  .card-hd .sub{opacity:.85; font-size:14px; margin-top:2px}
  .actions{display:grid; grid-template-columns:1fr 1fr; gap:16px; padding:16px 18px 22px; background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.18))}
  .btn{border:0; border-radius:18px; font-weight:900; font-size:22px; padding:16px 0; color:#0b0b0b; letter-spacing:.2px; cursor:pointer;
       box-shadow:0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.25)}
  .btn.dismiss{ background:var(--grad-red) }
  .btn.like{ background:var(--grad-blue) }

  /* Views switch pills under header */
  .tabs{display:flex; gap:12px; justify-content:center; margin:12px auto 4px; max-width:980px}
  .tab{padding:8px 14px; border-radius:14px; background:#171a20; color:#bcd1e6; font-weight:800; cursor:pointer}
  .tab.active{ background:var(--glass); color:#0b0b0b; box-shadow:inset 0 1px 0 rgba(255,255,255,.35) }

  /* Animations */
  @keyframes fadeOut{to{opacity:0; transform: translateY(10px) scale(.98)}}
  @keyframes burst{0%{transform:scale(1)} 55%{transform:scale(1.05)} 100%{transform:scale(.98); opacity:.9}}
  .fade-out{ animation: fadeOut .28s ease forwards }
  .burst-like{ animation: burst .28s ease forwards }

  /* Modal log (Troubleshoot) */
  .modal{position:fixed; inset:0; display:none; place-items:center; z-index:60; background:rgba(4,7,10,.55); padding:16px}
  .modal.open{display:grid}
  .sheet{width:min(720px,96vw); max-height:80vh; overflow:auto; border-radius:22px; background:#101319; box-shadow:0 30px 60px rgba(0,0,0,.55); padding:18px}
  pre{white-space:pre-wrap; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; color:#dfe7f3; background:#0c0f13; padding:14px; border-radius:14px}
  .close{float:right; border:0; border-radius:14px; padding:10px 14px; font-weight:800; background: linear-gradient(135deg,#b19cff,#67c3ff 40%, #ffa4cf); color:#0b0b0b}
</style>
</head>
<body>

<header>
  <div class="row">
    <div class="stat"><div class="k">BUILD</div><div class="v" id="build">v2.0</div></div>
    <div class="stat"><div class="k">SHOWN</div><div class="v" id="shown">0</div></div>
    <div class="stat"><div class="k">POOL</div><div class="v" id="pool">0</div></div>
    <div class="stat"><div class="k">TOTAL</div><div class="v" id="total">0</div></div>
  </div>

  <div class="bar"><div class="fill" id="barfill"></div><div class="txt" id="bartxt">Ready</div></div>

  <div class="tabs">
    <button class="tab active" data-view="home">Home</button>
    <button class="tab" data-view="likes">Likes</button>
    <button class="tab" data-view="discard">Discard</button>
  </div>

  <div class="controls">
    <button class="pill" id="btnNew">New batch</button>
    <button class="pill" id="btnShuffle">Shuffle feed</button>
    <button class="pill" id="btnMore">Load more</button>
    <button class="pill grad" id="btnSubs">+ Subreddits</button>
    <button class="pill" id="btnLog">Troubleshoot</button>
  </div>
</header>

<main id="cards"></main>

<!-- Troubleshoot -->
<div class="modal" id="modal">
  <div class="sheet">
    <button class="close" id="close">Close</button>
    <h2 style="margin:10px 0 10px">Troubleshoot</h2>
    <pre id="log"></pre>
  </div>
</div>

<script>
/* ============================================================
   Celeb Wall — robust render & controls (no innerHTML)
   This keeps your existing fetcher if present:
   - If window.CW_fetchItems exists -> uses it
   - Else falls back to a simple public fetcher
   ============================================================ */

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const state = {
  view: 'home',
  pool: [],
  shown: 0,
  likes: JSON.parse(localStorage.getItem('cw_likes')||'[]'),
  discards: JSON.parse(localStorage.getItem('cw_discards')||'[]'),
  subs: JSON.parse(localStorage.getItem('cw_subs')||'[]'),
  log: [],
  busy: false,
  page: 0,
};

const UI = {
  cards: $('#cards'),
  shown: $('#shown'), pool: $('#pool'), total: $('#total'),
  barfill: $('#barfill'), bartxt: $('#bartxt'),
  build: $('#build'), log: $('#log'), modal: $('#modal'),
};

log('Boot v2.0 glass');

/* ---------- helpers ---------- */
function log(line){
  const t = new Date().toLocaleTimeString();
  state.log.unshift(`[${t}] ${line}`);
  UI.log.textContent = state.log.slice(0,120).join('\n');
}
function setBusy(pct, label){
  UI.barfill.style.right = (100-pct)+'%';
  UI.bartxt.textContent = label ?? ((pct>=100)?'Ready':`${pct|0}%`);
}
function saveLists(){
  localStorage.setItem('cw_likes', JSON.stringify(state.likes));
  localStorage.setItem('cw_discards', JSON.stringify(state.discards));
}

/* ---------- element builders (no innerHTML) ---------- */
function el(tag, attrs = {}, ...kids) {
  const n = document.createElement(tag);
  for (const [k, v] of Object.entries(attrs)) {
    if (k === 'class') n.className = v;
    else if (k === 'dataset') Object.assign(n.dataset, v);
    else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
    else if (v === '') n.setAttribute(k, '');
    else n.setAttribute(k, v);
  }
  for (const kid of kids) n.append(kid);
  return n;
}

function createMediaEl(item){
  const url = item.secure_media?.reddit_video?.fallback_url
           || item.url_overridden_by_dest
           || item.url || '';
  const isVideo = Boolean(item.is_video) || /\.mp4(\?|$)/i.test(url);
  if (isVideo) {
    const v = el('video', { class:'media', playsinline:'', controls:'', preload:'metadata' });
    v.src = url;
    return v;
  } else {
    const img = el('img', { class:'media', alt:item.title||'', loading:'lazy' });
    img.src = url;
    return img;
  }
}

function createCard(item){
  const card = el('article', { class:'card', dataset:{ id: item.id || crypto.randomUUID() } });
  const hdr = el('div', { class:'card-hd' },
    el('div', { class:'title' }, document.createTextNode(item.author?`u/${item.author}`:' ')),
    el('div', { class:'sub' }, document.createTextNode(item.subreddit_name_prefixed || ''))
  );
  const media = createMediaEl(item);
  const actions = el('div', { class:'actions' });
  const bDis = el('button', { class:'btn dismiss', type:'button' }, document.createTextNode('Dismiss'));
  const bLike = el('button', { class:'btn like', type:'button' }, document.createTextNode('Like'));
  actions.append(bDis, bLike);

  bDis.addEventListener('click', () => handleDismiss(card, item));
  bLike.addEventListener('click', () => handleLike(card, item));

  card.append(hdr, media, actions);
  return card;
}

function placeItems(items){
  const frag = document.createDocumentFragment();
  for (const it of items) frag.append(createCard(it));
  UI.cards.append(frag);
}

/* ---------- actions ---------- */
function animateAndRemove(card, cls){
  card.classList.add(cls);
  card.addEventListener('animationend', () => card.remove(), {once:true});
  state.shown++; UI.shown.textContent = state.shown;
}

function handleDismiss(card, item){
  state.discards.unshift(item); saveLists();
  animateAndRemove(card, 'fade-out');
}

function handleLike(card, item){
  state.likes.unshift(item); saveLists();
  animateAndRemove(card, 'burst-like');
}

/* ---------- views ---------- */
function switchView(view){
  state.view = view;
  $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.view===view));
  UI.cards.innerHTML = '';
  if (view==='home') placeItems(state.pool);
  if (view==='likes') placeItems(state.likes);
  if (view==='discard') placeItems(state.discards);
  UI.total.textContent = (view==='home') ? state.pool.length : (view==='likes' ? state.likes.length : state.discards.length);
}

/* ---------- fetch (uses your existing if present) ---------- */
async function getItems(limit=30){
  // Use your existing fetcher if provided
  if (typeof window.CW_fetchItems === 'function') {
    return await window.CW_fetchItems(limit);
  }
  // Fallback – public JSON (kept tiny just so page still works)
  const subs = state.subs?.length ? state.subs : ['Celebs','CelebEvents','ladiesofwrestling'];
  const pick = subs[Math.floor(Math.random()*subs.length)];
  const url = `https://www.reddit.com/r/${pick}/hot.json?raw_json=1&limit=${limit}`;
  const r = await fetch(url, {cache:'no-store'});
  const j = await r.json();
  return (j.data?.children||[])
    .map(n => n.data)
    .filter(d => /\.(jpg|jpeg|png|gif|mp4)$/i.test(d.url||'') || d.is_video);
}

async function newBatch(){
  if (state.busy) return;
  try{
    state.busy = true; setBusy(8,'Requesting');
    UI.cards.innerHTML = ''; state.shown = 0; UI.shown.textContent = '0';
    const items = await getItems(60);
    setBusy(55,'Parsing');
    state.pool = dedupe(items);
    UI.pool.textContent = state.pool.length;
    UI.total.textContent = state.pool.length;
    placeItems(state.pool.slice(0, Math.min(20, state.pool.length)));
    setBusy(100,'Ready');
    log(`Batch ready: ${state.pool.length}`);
  }catch(e){
    log('ERROR: '+e);
    setBusy(100,'Error');
  }finally{
    state.busy = false;
  }
}

async function loadMore(){
  if (state.busy) return;
  state.busy = true; setBusy(35,'Loading more');
  try{
    const items = await getItems(30);
    const more = dedupe(items);
    state.pool.push(...more);
    UI.pool.textContent = state.pool.length;
    UI.total.textContent = state.pool.length;
    placeItems(more);
    log(`Loaded +${more.length}`);
  }catch(e){ log('ERROR: '+e) }
  setBusy(100,'Ready'); state.busy=false;
}

function dedupe(arr){
  const seen = new Set();
  const out = [];
  for (const it of arr){
    const key = it.id || it.url || it.permalink || Math.random();
    if (!seen.has(key)){
      seen.add(key); out.push(it);
    }
  }
  return out;
}

/* ---------- shuffle & auto-load ---------- */
function shuffleInPlace(a){
  for (let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]] }
  return a;
}
function shuffleFeed(){
  if (!state.pool.length) return;
  UI.cards.innerHTML = '';
  placeItems(shuffleInPlace([...state.pool]));
}

const io = new IntersectionObserver(entries=>{
  const atBottom = entries.some(e=>e.isIntersecting);
  if (atBottom && !state.busy && state.view==='home') loadMore();
},{root:null, rootMargin:'800px', threshold:0});
const sentinel = el('div',{style:'height:1px'}); document.body.append(sentinel); io.observe(sentinel);

/* ---------- subreddit input ---------- */
function promptSubs(){
  const now = (state.subs && state.subs.length) ? state.subs.join(', ') : 'Celebs, CelebEvents, ladiesofwrestling';
  const txt = prompt('Subreddits to pull from (comma separated, no /r/):', now);
  if (!txt) return;
  state.subs = txt.split(',').map(s=>s.trim()).filter(Boolean);
  localStorage.setItem('cw_subs', JSON.stringify(state.subs));
  log('Subs set: '+state.subs.join(', '));
}

/* ---------- wire controls ---------- */
$('#btnNew').addEventListener('click', newBatch);
$('#btnMore').addEventListener('click', loadMore);
$('#btnShuffle').addEventListener('click', shuffleFeed);
$('#btnSubs').addEventListener('click', promptSubs);
$('#btnLog').addEventListener('click', ()=> UI.modal.classList.add('open'));
$('#close').addEventListener('click', ()=> UI.modal.classList.remove('open'));
$$('.tab').forEach(t=> t.addEventListener('click', ()=> switchView(t.dataset.view)));

/* ---------- boot ---------- */
switchView('home');
setBusy(100,'Ready');
newBatch(); // first load

</script>
</body>
</html>