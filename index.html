<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Celeb Wall — v2.8</title>
<style>
  :root{
    --bg:#0e1116; --card:#141821e6; --glass:#1a1f29cc; --text:#e9eef6; --muted:#97a1b3;
    --pill:#1c2230cc; --pillBorder:#2a3242; --good0:#2dd4bf; --bad0:#ef476f;
    --grad1:#c084fc; --grad2:#60a5fa; --shadow:0 8px 28px rgba(0,0,0,.45);
    --round:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 700px at 50% -20%,#1a2030 0%,#0e1116 70%),var(--bg);color:var(--text);font:500 16px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  a{color:inherit}
  .wrap{max-width:900px;margin:22px auto;padding:0 16px}
  /* dashboard */
  .dash{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:14px;place-items:center}
  @media (max-width:720px){.dash{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .pill{
    width:100%; padding:14px 16px; border-radius:16px; background:var(--pill);
    border:1px solid var(--pillBorder); backdrop-filter:blur(8px);
    box-shadow:var(--shadow); text-align:center
  }
  .pill .big{font:700 22px/1.1 ui-sans-serif}
  .pill.grad{background:linear-gradient(90deg,var(--grad1),var(--grad2)); color:#0b1020; font-weight:800}
  .barWrap{margin:18px 0 8px}
  .bar{height:10px;border-radius:99px;background:#202737;border:1px solid #2a3242;overflow:hidden}
  .bar > span{display:block;height:100%;width:0;background:linear-gradient(90deg,#f2a6ff,#9ad7ff);transition:width .25s ease}
  .phase{display:flex;justify-content:space-between;color:var(--muted);font-weight:700;margin-top:8px}
  .topButtons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin:22px 0 8px}
  .btn{
    border:none;border-radius:16px;padding:14px 18px;background:var(--pill);color:var(--text);
    border:1px solid var(--pillBorder);backdrop-filter:blur(8px);box-shadow:var(--shadow);
    font-weight:800;letter-spacing:.2px;cursor:pointer;transition:transform .06s ease,filter .2s ease,opacity .2s ease
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(90deg,#c084fc,#60a5fa); color:#0b1020}
  .btn:disabled{opacity:.5;pointer-events:none}
  .caps{text-transform:uppercase;letter-spacing:.4px;font-weight:900;color:#9fb0c6}

  /* cards */
  #cards{display:grid;gap:18px;margin:26px 0}
  .card{
    border-radius:20px; overflow:hidden; background:var(--card); border:1px solid #232a38; box-shadow:var(--shadow)
  }
  .card .top{
    display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #222a38;background:#0f141d99;backdrop-filter:blur(8px)
  }
  .name{font:800 18px/1.2 ui-sans-serif}
  .source{color:var(--muted);font-size:13px}
  .media{aspect-ratio:1/1.1; background:#11161f; display:flex;align-items:center;justify-content:center}
  .media img,.media video{width:100%;height:100%;object-fit:cover;background:#0d121a}
  .actions{display:flex;gap:12px;justify-content:space-between;padding:14px;border-top:1px solid #222a38;background:#0f141d99;backdrop-filter:blur(8px)}
  .act{flex:1;text-align:center;padding:12px 10px;border-radius:14px;font-weight:900;border:1px solid #223043;cursor:pointer}
  .act.like{background:linear-gradient(90deg,#22d3ee,#34d399); color:#0a1220}
  .act.dis{background:linear-gradient(90deg,#fb7185,#ef4444); color:#0a1220}
  .badge{display:inline-flex;align-items:center;gap:8px;background:#0f141d99;border:1px solid #2a3242;padding:8px 12px;border-radius:999px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .sheet{width:min(820px,94vw);max-height:80vh;overflow:auto;background:#121723;border:1px solid #293243;border-radius:18px;box-shadow:var(--shadow);padding:18px}
  .sheet .hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .sheet pre{white-space:pre-wrap;color:#dbe7ff}
</style>
</head>
<body>
  <div class="wrap">
    <!-- Dashboard row -->
    <div class="dash" id="dash">
      <div class="pill"><div class="caps">Build</div><div class="big" id="build">v2.8</div></div>
      <div class="pill"><div class="caps">Shown</div><div class="big" id="shown">0</div></div>
      <div class="pill"><div class="caps">Pool</div><div class="big" id="pool">0</div></div>
      <div class="pill"><div class="caps">Total</div><div class="big" id="total">0</div></div>
    </div>

    <div class="barWrap">
      <div class="bar"><span id="bar"></span></div>
      <div class="phase"><span id="phaseLabel">Idle</span><span id="phasePct">100%</span></div>
    </div>

    <!-- Top controls -->
    <div class="topButtons">
      <button class="btn" id="homeBtn">Home</button>
      <button class="btn" id="likesBtn">⭐ Likes <span class="badge" id="likeCount">0</span></button>
      <button class="btn primary" id="newBatchBtn">New batch</button>
      <button class="btn" id="shuffleBtn">Shuffle feed</button>
      <button class="btn" id="loadMoreBtn">Load more</button>
      <button class="btn" id="sourcesBtn">r/celebs + more</button>
      <button class="btn" id="logBtn">Troubleshoot</button>
    </div>

    <!-- Cards -->
    <section id="cards"></section>

    <div style="text-align:center;margin:28px 0">
      <label class="badge">
        <input type="checkbox" id="autoScroll" checked style="transform:scale(1.2)">&nbsp; Auto-load on scroll
      </label>
    </div>
  </div>

  <!-- Troubleshoot modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="hd">
        <div class="pill">Troubleshoot</div>
        <button class="btn" id="closeModal">Close</button>
      </div>
      <pre id="log" class="mono"></pre>
    </div>
  </div>

<script>
/* ===== Utilities ===== */
const $ = sel => document.querySelector(sel);
const logEl = $("#log");
function logMsg(msg){
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  console.log(line);
  logEl.textContent = `${line}\n${logEl.textContent}`.slice(0, 20000);
}
function setPhase(name, pct){
  $("#phaseLabel").textContent = name;
  $("#phasePct").textContent = `${Math.round(pct)}%`;
  $("#bar").style.width = `${pct}%`;
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

/* ===== Data & State ===== */
const CELEBS = [
  "Alexandra Daddario","Madison Beer","Kendall Jenner","Hailey Bieber",
  "Dua Lipa","Gigi Hadid","Bella Hadid","Sydney Sweeney","Emma Watson",
  "Margot Robbie","Ana de Armas","Sabrina Carpenter","Taylor Swift",
  "Vanessa Hudgens","Salma Hayek","Kylie Jenner","Gal Gadot","Emily Ratajkowski",
  "Rachel Cook","Alexandra Stan","Ariana Grande","Sofía Vergara","Rita Ora",
  "Anya Taylor-Joy","Irina Shayk","Keke Palmer","Sophie Turner"
];
const SUBS = ["Celebs","BeautifulCelebrities","TheCelebArchive","celebs","LadiesOfWrestling"]; // lightweight mix
let pool = [];           // not-yet-shown items
let shown = [];          // rendered items (ids)
let likes = JSON.parse(localStorage.getItem("likes.v1")||"[]");
let mode = "home";       // "home" or "likes"

/* ===== Counters ===== */
function updateCounters(){
  $("#shown").textContent = shown.length;
  $("#pool").textContent  = pool.length;
  $("#total").textContent = shown.length + pool.length;
  $("#likeCount").textContent = likes.length;
}

/* ===== Fetch / Parse ===== */
async function fetchFromReddit(sub, limit=50){
  try{
    const url = `https://www.reddit.com/r/${sub}/hot.json?limit=${limit}`;
    const res = await fetch(url, {headers:{'User-Agent':'web'}});   // reddit allows anon JSON
    const data = await res.json();
    const kids = data?.data?.children || [];
    const posts = kids.map(k=>k.data).filter(p=>{
      // media-ish
      const u = p.url_overridden_by_dest || "";
      return p.post_hint?.includes("image") || u.match(/\.(jpg|jpeg|png|gif)$/i) || p.preview?.images?.length;
    }).map(p=>{
      let media = p.url_overridden_by_dest || (p.preview?.images?.[0]?.source?.url ?? "");
      // fix &amp; etc
      media = media.replace(/&amp;/g,"&");
      return {
        id: p.id,
        name: (p.title||"").replace(/\s*\(.*?\)\s*$/,""),
        subreddit: p.subreddit,
        url: media,
        thumb: (p.thumbnail||"").startsWith("http") ? p.thumbnail : null
      };
    });
    logMsg(`✅ r/${sub}: ${posts.length} media`);
    return posts;
  }catch(e){
    logMsg(`❌ r/${sub}: ${e.message}`);
    return [];
  }
}

async function buildBatch(){
  setPhase("Fetching", 8);
  const names = shuffle([...CELEBS]).slice(0, 10);   // sample of the list to keep it snappy
  const subs  = shuffle([...SUBS]).slice(0, 3);

  // Step 1: fetch subreddit pages
  const subPromises = subs.map((s,i)=> (async()=>{
    setPhase(`r/${s}`, 10 + i*8);
    return await fetchFromReddit(s, 50);
  })());
  const subResults = (await Promise.all(subPromises)).flat();

  // Step 2: keyword filter to favor celeb names
  setPhase("Filtering", 40);
  const lowered = names.map(n=>n.toLowerCase());
  let picked = subResults.filter(p=>{
    const t = (p.name||"").toLowerCase();
    return lowered.some(n=>t.includes(n));
  });

  // If too few, keep generic images too
  if(picked.length < 12){
    const needed = 24 - picked.length;
    picked = picked.concat(subResults.filter(p=>!picked.find(x=>x.id===p.id)).slice(0, needed));
  }

  // Dedup & keep unseen and not disliked
  const disliked = new Set(JSON.parse(localStorage.getItem("dislikes.v1")||"[]"));
  const existing = new Set(pool.map(x=>x.id).concat(shown));
  const unique = [];
  for(const p of picked){
    if(!p.url) continue;
    if(existing.has(p.id)) continue;
    if(disliked.has(p.id)) continue;
    unique.push(p);
  }

  // Update pool
  pool = pool.concat(unique);
  updateCounters();
  logMsg(`📦 Batch ready: +${unique.length} (from ${subs.join(", ")})`);
  setPhase("Ready", 100);
}

/* ===== Render ===== */
function cardEl(item){
  const el = document.createElement("article");
  el.className = "card";
  el.dataset.id = item.id;

  const top = document.createElement("div");
  top.className="top";
  top.innerHTML = `<div class="name">${item.name || "Untitled"}</div><div class="source">r/${item.subreddit}</div>`;

  const media = document.createElement("div");
  media.className = "media";
  const img = document.createElement("img");
  img.loading="lazy";
  img.src = item.url;
  img.alt = item.name || "image";
  img.onerror = ()=>{ el.remove(); bumpShown(-1); };
  media.appendChild(img);

  const actions = document.createElement("div");
  actions.className = "actions";
  const dislike = document.createElement("button");
  dislike.className = "act dis";
  dislike.textContent = "Dismiss";
  const like = document.createElement("button");
  like.className = "act like";
  like.textContent = "Like";

  dislike.onclick = ()=>{
    localStorage.setItem("dislikes.v1", JSON.stringify(
      Array.from(new Set(JSON.parse(localStorage.getItem("dislikes.v1")||"[]").concat(item.id)))
    ));
    el.remove();
    bumpShown(-1);
    logMsg(`🗑️ dismissed ${item.name}`);
  };
  like.onclick = ()=>{
    if(!likes.find(x=>x.id===item.id)){
      likes.push(item);
      localStorage.setItem("likes.v1", JSON.stringify(likes));
      $("#likeCount").textContent = likes.length;
    }
    el.remove();
    bumpShown(-1);
    logMsg(`⭐ liked ${item.name}`);
  };

  actions.append(dislike, like);
  el.append(top, media, actions);
  return el;
}

function bumpShown(delta){
  // called after removal or failure
  if(delta<0){ shown.pop(); }
  $("#shown").textContent = shown.length;
  $("#total").textContent = shown.length + pool.length;
}

/* Paint next N from pool */
function renderMore(n=6){
  if(mode==="likes"){
    // show likes in feed style
    $("#cards").innerHTML = "";
    const items = shuffle([...likes]).slice(0,n);
    for(const it of items){ $("#cards").appendChild(cardEl(it)); }
    shown = items.map(x=>x.id);
    updateCounters();
    return;
  }

  const take = pool.splice(0, n);
  for(const item of take){
    $("#cards").appendChild(cardEl(item));
    shown.push(item.id);
  }
  updateCounters();
}

/* Shuffle visible feed (not the pool itself) */
function shuffleFeed(){
  const cont = $("#cards");
  const nodes = Array.from(cont.children);
  shuffle(nodes);
  cont.innerHTML = "";
  nodes.forEach(n=>cont.appendChild(n));
}

/* ===== Events ===== */
$("#newBatchBtn").onclick = async ()=>{
  $("#cards").innerHTML = "";
  shown = [];
  updateCounters();
  setPhase("Starting", 5);
  await buildBatch();
  renderMore(8);
};
$("#loadMoreBtn").onclick = ()=>{
  if(pool.length<6){
    // automatically top-up silently
    buildBatch().then(()=>renderMore(8));
  }else{
    renderMore(8);
  }
};
$("#shuffleBtn").onclick = ()=> shuffleFeed();
$("#homeBtn").onclick = ()=>{
  mode="home";
  $("#cards").innerHTML = "";
  shown=[]; updateCounters();
};
$("#likesBtn").onclick = ()=>{
  mode="likes";
  $("#cards").innerHTML = "";
  shown=[]; updateCounters();
  renderMore(12);
};
$("#sourcesBtn").onclick = ()=>{
  alert(`Active subreddits:\n• ${SUBS.join("\n• ")}`);
};
$("#logBtn").onclick = ()=> $("#modal").classList.add("show");
$("#closeModal").onclick = ()=> $("#modal").classList.remove("show");

/* Auto-load on scroll */
window.addEventListener("scroll", ()=>{
  if(!$("#autoScroll").checked || mode!=="home") return;
  const nearBottom = window.innerHeight + window.scrollY >= document.body.offsetHeight - 400;
  if(nearBottom) $("#loadMoreBtn").click();
});

/* ===== Boot ===== */
(async function init(){
  updateCounters();
  setPhase("Idle", 100);
  logMsg("Build v2.8 — ready");
  // first touch – quick warmup batch so UI feels alive
  await buildBatch();
  renderMore(6);
})();
</script>
</body>
</html>