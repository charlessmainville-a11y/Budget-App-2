<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CelebWall v2.5.0</title>
<style>
  :root{
    --bg:#0d0f12;--panel:#12151a;--glass:#171b21;--muted:#9aa3ad;--txt:#eaf0f6;
    --pill:#1f2530; --like1:#2aa0ff; --like2:#14c8b3;
    --dismiss1:#ff4757; --dismiss2:#ff7ab8;
    --tile-grad1:#b08cff; --tile-grad2:#ff9ecf;
    --load1:#3a66ff; --load2:#12c2e9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html{background:#0d0f12;overscroll-behavior-y:contain;color-scheme:dark;-webkit-overflow-scrolling:touch;touch-action:manipulation;}
  body{
    margin:0;background:radial-gradient(1000px 600px at 50% -200px,#151b23 0%,#0d0f12 40%,#0d0f12 100%);
    color:var(--txt);font:800 16px/1.3 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow-x:hidden;
  }
  a{color:inherit}
  .wrap{max-width:880px;margin:0 auto;padding:18px 14px 96px}

  .dash{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin:8px 0 12px}
  @media(min-width:920px){.dash{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .btn{position:relative;border:none;cursor:pointer;transition:transform .08s ease,filter .18s ease,opacity .18s ease;}
  .btn.tile{
    border-radius:22px;padding:22px 24px;color:#f5f7ff;font:900 20px/1.1 Inter,system-ui;letter-spacing:.01em;
    background:linear-gradient(180deg,rgba(20,25,34,.6),rgba(18,22,31,.4));
    border:1px solid rgba(255,255,255,.18);
    -webkit-backdrop-filter:blur(14px) saturate(140%);backdrop-filter:blur(14px) saturate(140%);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.22),0 10px 22px rgba(0,0,0,.55);
  }
  .btn.tile.grad{
    background:
      linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
      linear-gradient(135deg,var(--tile-grad1),var(--tile-grad2));
  }
  .btn.tile:hover{transform:translateY(-1px);filter:brightness(1.06)}
  .btn.tile:active{transform:translateY(0);filter:brightness(.96)}
  .btn.small{padding:16px 18px;border-radius:18px;font-size:18px}
  .btn.tiny{padding:10px 14px;border-radius:14px;font-size:14px}

  .progressBtn{grid-column:1 / -1;display:flex;align-items:center;justify-content:space-between;
    padding:16px 18px;border-radius:22px;font-size:18px;position:relative;overflow:hidden;color:#e9f1ff;}
  .progressBtn .fill{position:absolute;inset:0 auto 0 0;width:0%;
    background:linear-gradient(90deg,#a0d9ff 0%,#c8b6ff 50%,#ffb3c7 100%);opacity:.95;pointer-events:none;}
  .progressBtn .label,.progressBtn .pct{position:relative;z-index:1;font-weight:900}
  .progressBtn.is-cta{
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
               linear-gradient(135deg,var(--load1),var(--load2));color:#fff;}
  .progressBtn[disabled]{opacity:.7;cursor:not-allowed}

  .tabs{display:flex;gap:10px;justify-content:center;margin:10px 0 6px}
  .pill{border-radius:18px;padding:10px 14px;color:#e9f1ff;
        background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
        border:1px solid rgba(255,255,255,.18);
        -webkit-backdrop-filter:blur(14px) saturate(140%);backdrop-filter:blur(14px) saturate(140%);
        box-shadow:inset 0 1px 0 rgba(255,255,255,.22), 0 6px 14px rgba(0,0,0,.45);}
  .hidden{display:none!important}

  .feed{display:grid;gap:18px}
  .card{
    position:relative;border-radius:22px;overflow:hidden;isolation:isolate;touch-action:pan-y;
    background:linear-gradient(180deg,rgba(20,25,34,.55),rgba(15,19,26,.40));
    border:1px solid rgba(255,255,255,.18);
    -webkit-backdrop-filter:blur(14px) saturate(140%);backdrop-filter:blur(14px) saturate(140%);
    box-shadow:0 22px 40px rgba(0,0,0,.7), inset 0 1px 0 rgba(255,255,255,.18);
  }
  .card.swiping{transition:none}
  .media{display:block;width:100%;height:auto;max-height:86vh;object-fit:cover;background:#0b0f15}
  video.media{max-height:86vh;background:#0b0f15}
  .caption{
    padding:12px 14px;border-top:1px solid rgba(255,255,255,.18);
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
    -webkit-backdrop-filter:blur(14px) saturate(140%);backdrop-filter:blur(14px) saturate(140%);
    color:#f3f7ff;font:900 20px/1.2 Inter,system-ui;letter-spacing:.01em;
  }

  .actions{display:flex;gap:16px;justify-content:space-between;padding:18px;
    background:linear-gradient(180deg,transparent 0%,rgba(255,255,255,.03) 20%);
    -webkit-backdrop-filter:blur(12px) saturate(140%);backdrop-filter:blur(12px) saturate(140%);}
  .actions .btn{
    flex:1;border-radius:22px;padding:16px 18px;font-size:18px;
    border:1px solid rgba(255,255,255,.18);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.25), 0 10px 22px rgba(0,0,0,.55);
  }
  .btn.ok{color:#04131a;font-weight:900;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
               linear-gradient(135deg,var(--like1),var(--like2))}
  .btn.no{color:#2b060b;font-weight:900;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03)),
               linear-gradient(135deg,var(--dismiss2),var(--dismiss1))}
  .stamp{
    position:absolute;top:12px;padding:6px 12px;border-radius:12px;font:900 14px/1 Inter,system-ui;
    opacity:0;transform:scale(.9);pointer-events:none;border:1px solid rgba(255,255,255,.22);
    -webkit-backdrop-filter:blur(10px) saturate(140%);backdrop-filter:blur(10px) saturate(140%);
    box-shadow:0 8px 18px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.3);
  }
  .stamp.like{left:12px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04)),linear-gradient(135deg,var(--like1),var(--like2));color:#04131a}
  .stamp.no{right:12px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04)),linear-gradient(135deg,var(--dismiss2),var(--dismiss1));color:#2b060b}

  .burst{animation:burst .45s ease forwards}
  @keyframes burst{0%{transform:scale(1)}60%{transform:scale(1.08)}100%{transform:scale(1)}}
  .fade{animation:fade .28s ease forwards}
  @keyframes fade{to{opacity:0;transform:translateY(10px)}}

  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.55);z-index:50}
  .modal.show{display:grid}
  .sheet{
    width:min(920px,92vw);max-height:80vh;overflow:auto;border-radius:22px;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.18);
    -webkit-backdrop-filter:blur(16px) saturate(160%);backdrop-filter:blur(16px) saturate(160%);
    box-shadow:0 24px 60px rgba(0,0,0,.85); padding:18px
  }
  .log{white-space:pre-wrap;font:600 14px/1.45 ui-monospace,Menlo,Consolas,monospace;color:#d7e3f5}
</style>
</head>
<body>
<div class="wrap">
  <div class="dash">
    <button class="btn tile small" id="homeBtn">Home</button>
    <button class="btn tile small" id="likesBtn">Likes</button>
    <button class="btn tile small" id="discardBtn">Discard</button>
    <button class="btn tile grad small" id="newBatchBtn">New batch</button>
    <button class="btn tile small" id="shuffleBtn">Shuffle feed</button>
    <button class="btn tile small" id="manageSubsBtn">Subreddits</button>
    <button class="btn tile small" id="troubleBtn">Troubleshoot</button>
    <button class="btn tile small" id="connectBtn">Connect Reddit</button>
    <button class="btn tile progressBtn glass" id="progressBtn">
      <div class="fill" id="bar"></div>
      <span class="label" id="phase">Ready</span>
      <span class="pct" id="pct">100%</span>
    </button>
  </div>

  <div class="tabs hidden" id="pageTabs">
    <span class="pill" id="tabHome">Home</span>
    <span class="pill" id="tabLikes">Likes</span>
    <span class="pill" id="tabDiscard">Discard</span>
    <span class="pill" id="tabSubs" style="display:none">Subreddits</span>
  </div>

  <div id="home" class="feed"></div>
  <div id="likes" class="feed hidden"></div>
  <div id="discard" class="feed hidden"></div>

  <section id="subsPage" class="hidden">
    <div class="sheet glass" style="padding:12px">
      <div class="subs-head" style="background:none;border:0;box-shadow:none;padding:0">
        <h2 style="margin:0;font:900 22px/1.2 Inter,system-ui">Manage subreddits</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn tile small" id="subsSelectAll">Select all</button>
          <button class="btn tile small" id="subsClearAll">Clear all</button>
          <button class="btn tile small grad" id="subsSave">Save & New batch</button>
          <button class="btn tile small" id="subsBack">← Back</button>
        </div>
      </div>
      <div class="subs-grid" id="subsGrid"></div>
    </div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px">
      <h2 style="margin:0">Troubleshoot</h2>
      <button class="btn tiny tile" id="closeModal">Close</button>
    </div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
/* =========================================================
   CelebWall – Production (Reddit-only, gesture-first video)
   - No autoplay; every video shows a Tap-to-Play overlay
   - After start: tap toggles mute/unmute (toast)
   - IO only pauses/resumes after user-start
   - Safari + Meta Quest friendly
   ========================================================= */

/* -------------------- OAuth config -------------------- */
const DEFAULT_CLIENT_ID   = localStorage.getItem('reddit_client_id')    || '';
const DEFAULT_REDIRECT_URI= localStorage.getItem('reddit_redirect_uri') || (location.origin + location.pathname);

/* -------------------- name list -------------------- */
const CELEB_NAMES = [
  "Scarlett Johansson","Margot Robbie","Zendaya","Ana de Armas","Gal Gadot","Emma Watson","Emma Stone","Natalie Portman","Alexandra Daddario","Salma Hayek",
  "Jessica Alba","Megan Fox","Blake Lively","Emily Ratajkowski","Kate Beckinsale","Priyanka Chopra","Sophie Turner","Taylor Swift","Ariana Grande","Dua Lipa",
  "Beyoncé","Rihanna","Selena Gomez","Jennifer Lopez","Shakira","Camila Cabello","Olivia Rodrigo","Madison Beer","Hailey Bieber","Kylie Jenner",
  "Kendall Jenner","Gigi Hadid","Bella Hadid","Kaia Gerber","Sydney Sweeney","Jenna Ortega","Anya Taylor-Joy","Florence Pugh","Elizabeth Olsen","Vanessa Hudgens",
  "Lily James","Alicia Vikander","Rachel McAdams","Mila Kunis","Amber Heard","Emilia Clarke","Katherine Langford","Zoë Kravitz","Lily Collins","Lucy Hale",
  "Nina Dobrev","Victoria Justice","Karlie Kloss","Barbara Palvin","Taylor Hill","Adriana Lima","Candice Swanepoel","Irina Shayk","Rosie Huntington-Whiteley","Natalie Dormer",
  "Hailee Steinfeld","Chloë Grace Moretz","Lana Del Rey","Halsey","Sabrina Carpenter","Ava Max","SZA","Doja Cat","Billie Eilish","Kacey Musgraves",
  "Maitreyi Ramakrishnan","Alexandra Shipp","Brie Larson","Tessa Thompson","Zoe Saldana","Karen Gillan","Naomi Scott","Ella Balinska","Eiza González","Camila Morrone",
  "Ana de la Reguera","Lupita Nyong'o","Taylour Paige","Ariel Winter","Kiernan Shipka","Lili Reinhart","Camila Mendes","Madelaine Petsch","Addison Rae","Charli D'Amelio",
  "Suki Waterhouse","Phoebe Dynevor","Simone Ashley","Alexa Demie","Yara Shahidi","Maude Apatow","Mandy Moore","Lauren Jauregui","Janelle Monáe","Kerry Washington"
];
const _escRx = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
const NAME_RX = new RegExp("\\b(" + CELEB_NAMES.map(_escRx).join("|") + ")\\b","i");

/* -------------------- app config -------------------- */
const DEFAULT_STARTER_SUBS   = ['Celebs'];
const DEFAULT_OPTIONAL_NSFW  = [
  'charlidameliomommy','leaeluig_nr','leaeluiginet','lea_bellybutton',
  'nsfwfashion','naked_models','Dixied_nsfw','dixiedameliofans',
  'emmachamberlainnsfw','dovecameronlewd','emrata','elsiehewitt',
  'hunterschafer','kendalljenner','niamh_adkins','addisonrae',
  'sydneysweeney','alexandradaddario','alejandraguilmant','jenya_d',
  'girlsontop','hotwife','highresnsfwpro','nsfw_gif'
];
const saved = JSON.parse(localStorage.getItem('subs_toggle')||'{}');
let STARTER_SUBS  = saved.starters || [...DEFAULT_STARTER_SUBS];
let OPTIONAL_NSFW = saved.nsfw     || [...DEFAULT_OPTIONAL_NSFW];

/* -------------------- tunables -------------------- */
const LIMIT=100, PAGES=3, CHUNK=30, LIGHT_SHUFFLES=2;
const AUTOLOAD=true, AUTOLOAD_THRESHOLD_PX=1400, AUTOLOAD_THROTTLE_MS=1400, MAX_APPEND_PER_FRAME=6;

/* -------------------- state -------------------- */
let pool=[], likes=[], discards=[], currentFeed='home', fetching=false, lastErrors=[], loadLock=false, lastAutoTs=0;
const logEl = document.getElementById('log');

/* --- unified debug logger --- */
function dbg(...args) {
  const msg = '[DBG] ' + args.join(' ');
  console.log(msg);
  if (logEl) {
    logEl.textContent += msg + '\n';
    logEl.scrollTop = logEl.scrollHeight;
  }
}

const truncateLog = (value, max = 400) => {
  if (value == null) return '';
  const str = String(value);
  return str.length > max ? str.slice(0, max) + '…' : str;
};

/* -------------------- fallback video -------------------- */
// You can paste either a Google Drive file ID (short string) OR a direct MP4 URL.
const FALLBACK_SOURCE_INPUT = "1jiMLN5dM0KLGj_uDw41kvCrTt-Qbbzpp"; 
// Example: "1jiMLN5dM0KLGj_uDw41kvCrTt-Qbbzpp" (Drive ID)
// Example: "https://example.com/myvideo.mp4" (direct MP4 link)

function resolveFallbackUrl(input) {
  if (input == null) return "";

  const originalInput = String(input);
  const originalLen = originalInput.length;
  input = originalInput.trim();
  const trimmedLen = input.length;
  const whitespaceRemoved = originalLen !== trimmedLen;
  dbg(
    "🎬 Input received:",
    originalInput,
    "len=",
    originalLen,
    "→ trimmedLen=",
    trimmedLen,
    "whitespaceRemoved=",
    whitespaceRemoved
  );

  if (!input) {
    dbg("🎬 Final resolved fallback URL =", "");
    return "";
  }

  let resolvedUrl = "";
  const driveShareMatch = input.match(/^https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\/view(?:\?.*)?(?:#.*)?$/i);
  if (driveShareMatch) {
    const id = driveShareMatch[1];
    resolvedUrl = `https://drive.google.com/uc?export=download&id=${id}`;
    dbg("🎬 Fallback source detected as Google Drive ID:", input, "→", resolvedUrl);
    dbg(
      "🎬 Drive share link conversion",
      "originalUrl=",
      originalInput,
      "extractedId=",
      id,
      "downloadUrl=",
      resolvedUrl,
      "note=",
      "normalized from /file/d/.../view"
    );
  } else if (/^https?:\/\//i.test(input)) {
    dbg("🎬 Fallback source detected as direct URL:", input);
    let host = "unknown";
    let protocol = "unknown";
    try {
      const parsed = new URL(input);
      protocol = parsed.protocol.replace(/:$/, "");
      host = parsed.hostname;
    } catch (err) {
      // ignore parse failures; we'll log placeholder values below
    }
    dbg("🎬 Direct URL details", "protocol=", protocol, "host=", host);
    dbg("🎬 Direct URL detected:", input, "host=", host, "protocol=", protocol);
    resolvedUrl = input;
  } else {
    resolvedUrl = `https://drive.google.com/uc?export=download&id=${input}`;
    dbg("🎬 Fallback source detected as Google Drive ID:", input, "→", resolvedUrl);
    dbg(
      "🎬 Raw Drive ID conversion",
      "id=",
      input,
      "downloadUrl=",
      resolvedUrl,
      "note=",
      "interpreted as bare ID"
    );
  }

  dbg("🎬 Final resolved fallback URL =", resolvedUrl);
  return resolvedUrl;
}

const FALLBACK_VIDEO_SOURCE = {
  title: 'Sample Fallback Video',
  url: resolveFallbackUrl(FALLBACK_SOURCE_INPUT),
  poster: '',
  controls: true
};

/* -------------------- persistence -------------------- */
function saveState(){ try{ localStorage.setItem('likes',JSON.stringify(likes)); localStorage.setItem('discards',JSON.stringify(discards)); }catch{} }
function loadState(){ try{ likes=JSON.parse(localStorage.getItem('likes')||'[]'); discards=JSON.parse(localStorage.getItem('discards')||'[]'); }catch{ likes=[]; discards=[]; } }
loadState();

/* viewed persistence */
const viewed=new Set(JSON.parse(localStorage.getItem('viewed')||'[]'));
function markViewed(url){
  if(!url) return;
  viewed.add(url);
  if(viewed.size>5000){
    const arr=[...viewed].slice(-4000);
    viewed.clear(); arr.forEach(v=>viewed.add(v));
  }
  localStorage.setItem('viewed', JSON.stringify([...viewed]));
}

/* -------------------- helpers -------------------- */
const el = sel => document.querySelector(sel);
const log = msg => { const t=new Date().toLocaleTimeString(); logEl.textContent += `[${t}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; };
const esc = s => String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
function getScrollY(){ return window.scrollY || document.documentElement.scrollTop || 0; }
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* -------------------- name helpers -------------------- */
function titleHasName(t){ return !!t && NAME_RX.test(t); }
function textMatchesAnyName(t){ if(!t) return false; const L=t.toLowerCase(); return CELEB_NAMES.some(n=>L.includes(n.toLowerCase())); }

const PERSON_SUBS = new Set(['LeaEluiGinet','charlidameliomommy','leaeluig_nr','leaeluiginet','lea_bellybutton','nsfwfashion','naked_models','Dixied_nsfw','dixiedameliofans']);
const STOP_WORDS = /^(at|in|with|on|of|for|from|and|the|to|by|wearing|holding|during)\b/i;
function humanizeSubName(sub){return sub.replace(/[_-]+/g,' ').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/(\d+)/g,' $1 ').replace(/\s+/g,' ').trim().replace(/\b\w/g,m=>m.toUpperCase());}
function guessNameFromTitle(title){
  if(!title) return '';
  const cleaned = title.replace(/\s+/g,' ').trim();
  const parts = [];
  for(const tok of cleaned.split(' ')){
    if(STOP_WORDS.test(tok)) break;
    if(/^[A-ZÀ-Ý][\w’'-.]*$/.test(tok) || /^(de|van|von|da|di|del|la)$/i.test(tok)){ parts.push(tok.replace(/[_-]/g,' ')); continue; }
    if(/[.,;:()|\[\]]/.test(tok)) break;
    if(parts.length===0) break;
    parts.push(tok);
  }
  const name = parts.join(' ').trim();
  return (name && /^[A-ZÀ-Ý]/.test(name)) ? name : '';
}
function inferPerformer(item){
  if(PERSON_SUBS.has(item.sub)) return humanizeSubName(item.sub);
  if(/^[A-Za-z][A-Za-z0-9_]*$/.test(item.sub) && !/(pics|porn|nsfw|celebs?|gowns|events|nips|slips|the|official|fans|hub|girls)/i.test(item.sub)){
    return humanizeSubName(item.sub);
  }
  const tGuess = guessNameFromTitle(item.title);
  if(tGuess) return tGuess;
  return (item.title||'').split(' ').slice(0,3).join(' ').trim() || 'Unknown';
}

/* -------------------- UI helpers -------------------- */
const ui = {
  phase(s){ el('#phase').textContent = s; },
  bar(p){ el('#bar').style.width = `${p}%`; el('#pct').textContent = `${Math.round(p)}%`; },
  setProgressMode(isFetching){
    const btn = el('#progressBtn');
    if(isFetching){ btn.classList.remove('is-cta'); btn.setAttribute('disabled',''); }
    else { btn.classList.add('is-cta'); btn.removeAttribute('disabled'); this.bar(100); this.phase('Ready'); el('#pct').textContent = '100%'; }
  },
  showPage(name){
    currentFeed = name;
    ['home','likes','discard','subsPage'].forEach(id => el('#'+id).classList.add('hidden'));
    if(name==='home') el('#home').classList.remove('hidden');
    if(name==='likes') el('#likes').classList.remove('hidden');
    if(name==='discard') el('#discard').classList.remove('hidden');
    if(name==='subs') document.getElementById('subsPage').classList.remove('hidden');
    el('#pageTabs').classList.remove('hidden');
    el('#tabSubs').style.display = (name==='subs' ? '' : (el('#tabSubs').style.display || ''));
    this.progressVisibility();
  },
  progressVisibility(){ const visible = currentFeed==='home' && (pool.length>0 || !fetching); el('#progressBtn').style.display = visible ? '' : 'none'; }
};

/* =========================================================
   VIDEO ENGINE (gesture-first; Safari + Meta Quest)
   ========================================================= */

/* --- IntersectionObserver --- */
const io = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    const v = e.target;
    if(!(v instanceof HTMLVideoElement)) return;
    const started = v.dataset.userStarted === '1';
    if(e.isIntersecting){
      if(started) safePlay(v);
    } else {
      v.pause();
    }
  });
},{threshold:0.5});

/* --- helpers --- */
async function safePlay(v){
  dbg('safePlay', v.src, 'muted=', v.muted, 'readyState=', v.readyState);
  try{
    if(v.readyState < 2)
      await new Promise(r=>v.addEventListener('loadeddata', r, {once:true}));
  }catch{}
  try{
    const p=v.play();
    if(p && typeof p.then==='function') await p;
    dbg('play() success', v.src);
  }catch(err){
    dbg('play() error', err.message);
  }
}

function showMuteToast(isMuted){
  const toast=document.createElement('div');
  toast.textContent=isMuted?'🔇 Muted':'🔊 Unmuted';
  Object.assign(toast.style,{
    position:'fixed',bottom:'24px',left:'50%',transform:'translateX(-50%)',
    background:'rgba(0,0,0,0.7)',color:'#fff',padding:'8px 16px',borderRadius:'12px',
    font:'900 16px/1 Inter,system-ui',zIndex:9999,transition:'opacity .3s ease'
  });
  document.body.appendChild(toast);
  setTimeout(()=>toast.style.opacity='0',1000);
  setTimeout(()=>toast.remove(),1300);
}

/* --- fullscreen scroll restore --- */
let _fsPrevScroll=0;
document.addEventListener('fullscreenchange',()=>{
  if(document.fullscreenElement){
    document.body.style.overflow='hidden';
  }else{
    document.body.style.overflow='';
    const y=_fsPrevScroll;
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      window.scrollTo({top:y,left:0,behavior:'auto'});
    }));
  }
});

/* =========================================================
   🎬 makeVideo() — Manual Start Only (Safari-Proof)
   ========================================================= */
function makeVideo(url, thumb, provider) {
  const v = document.createElement('video');
  v.className = 'media';
  v.src = url;
  v.poster = thumb || '';
  v.playsInline = true;
  v.setAttribute('playsinline', '');
  v.setAttribute('webkit-playsinline', '');
  v.loop = true;
  v.muted = true;      // start muted
  v.defaultMuted = true;
  v.setAttribute('muted', '');
  v.autoplay = false;  // never auto-play
  v.preload = 'metadata';
  v.controls = false;
  v.dataset.userStarted = '0';
  if (provider) v.dataset.provider = provider;

  const wrap = document.createElement('div');
  wrap.className = 'video-wrap';
  wrap.style.position = 'relative';
  wrap.style.overflow = 'hidden';
  wrap.appendChild(v);

  // --- Overlay buttons ---
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  Object.assign(overlay.style, {
    position: 'absolute',
    inset: 0,
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    background: 'rgba(0,0,0,0.35)',
    backdropFilter: 'blur(6px)',
    transition: 'opacity 0.25s ease'
  });

  const playBtn = document.createElement('button');
  playBtn.textContent = '▶️';
  Object.assign(playBtn.style, {
    fontSize: '48px',
    border: 'none',
    background: 'none',
    color: '#fff',
    cursor: 'pointer'
  });

  const muteBtn = document.createElement('button');
  muteBtn.textContent = '🔊';
  Object.assign(muteBtn.style, {
    position: 'absolute',
    top: '10px',
    right: '10px',
    fontSize: '22px',
    border: 'none',
    background: 'rgba(0,0,0,0.5)',
    color: '#fff',
    borderRadius: '50%',
    width: '40px',
    height: '40px',
    cursor: 'pointer',
    display: 'none' // hidden until video starts
  });

  overlay.appendChild(playBtn);
  wrap.appendChild(overlay);
  wrap.appendChild(muteBtn);

  // --- Play handler ---
  playBtn.addEventListener('click', async e => {
    e.stopPropagation();
    overlay.style.opacity = 0;
    setTimeout(()=>overlay.remove(),250);
    try {
      await v.play();
      v.dataset.userStarted = '1';
      dbg('▶ manual play', url);
      muteBtn.style.display = 'block';
    } catch (err) {
      dbg('⚠️ play failed', err.message);
    }
  });

  // --- Mute toggle ---
  muteBtn.addEventListener('click', e => {
    e.stopPropagation();
    v.muted = !v.muted;
    muteBtn.textContent = v.muted ? '🔇' : '🔊';
  });

  // --- Log errors for troubleshoot ---
  v.addEventListener('error', e => dbg('❌ video error', url, e));

  // mark as user-started when playback resumes from other gestures (e.g. fullscreen)
  v.addEventListener('play', ()=>{ v.dataset.userStarted = '1'; }, {once:true});

  // ensure intersection observer tracks the actual video element once attached
  requestAnimationFrame(()=>{ try{ io.observe(v); }catch{} });

  return wrap;
}

/* =========================================================
   📼 VideoContainer — Autoplay fallback
   ========================================================= */
function VideoContainer({ title, url, poster = '', controls = false } = {}) {
  const container = document.createElement('article');
  container.className = 'card';
  container.dataset.component = 'video-container';

  const video = document.createElement('video');
  video.className = 'media';
  video.src = url;
  if (poster) video.poster = poster;
  video.loop = true;
  video.autoplay = true;
  video.muted = true;
  video.defaultMuted = true;
  video.playsInline = true;
  video.setAttribute('playsinline', '');
  video.setAttribute('webkit-playsinline', '');
  video.setAttribute('autoplay', '');
  video.setAttribute('muted', '');
  video.setAttribute('loop', '');
  if (controls) {
    video.controls = true;
    video.setAttribute('controls', '');
  } else {
    video.controls = false;
    video.removeAttribute('controls');
  }
  video.dataset.userStarted = '1';

  container.appendChild(video);

  if (title) {
    const caption = document.createElement('div');
    caption.className = 'caption';
    caption.textContent = title;
    container.appendChild(caption);
  }

  requestAnimationFrame(()=>{ try{ io.observe(video); safePlay(video); }catch{} });

  return container;
}

function insertFallbackVideo(where = 'home') {
  const feed = document.getElementById(where);
  if (!feed) return;
  if (!FALLBACK_VIDEO_SOURCE?.url) return;
  if (feed.querySelector('[data-kind="fallback-video"]')) return;

  const fallbackCard = VideoContainer({
    title: FALLBACK_VIDEO_SOURCE.title,
    url: FALLBACK_VIDEO_SOURCE.url,
    poster: FALLBACK_VIDEO_SOURCE.poster || '',
    controls: !!FALLBACK_VIDEO_SOURCE.controls
  });
  fallbackCard.dataset.kind = 'fallback-video';
  feed.prepend(fallbackCard);
}

/* --- unlock gesture --- */
window.addEventListener('DOMContentLoaded',()=>{
  let unlocked=false;
  const unlock=()=>{
    if(unlocked) return;
    unlocked=true;
    dbg('gesture unlock fired');
    document.querySelectorAll('video.media').forEach(v=>{
      if(v.dataset.userStarted==='1') safePlay(v);
    });
  };
  ['pointerdown','touchstart','click','keydown','scroll','focus']
    .forEach(evt=>window.addEventListener(evt,unlock,{once:true,passive:true}));
});

/* --- update Troubleshoot button to start live logging --- */
document.getElementById('troubleBtn').addEventListener('click', ()=>{
  dumpTroubleshoot();
  el('#modal').classList.add('show');
  dbg('--- Live debug logging started ---');
});

/* =========================================================
   🔍 VIDEO DEBUG DIAGNOSTICS
   ========================================================= */
function attachVideoDiagnostics(){
  const vids = document.querySelectorAll('video.media');
  dbg(`🎬 Diagnostics attached to ${vids.length} videos`);
  vids.forEach(v=>{
    const src=v.currentSrc||v.src;
    dbg('🔍 checking video element', src);

    // basic load/error state watchers
    v.addEventListener('loadstart', ()=>dbg('loadstart', src));
    v.addEventListener('loadedmetadata', ()=>dbg('loadedmetadata', src));
    v.addEventListener('loadeddata', ()=>dbg('loadeddata', src));
    v.addEventListener('canplay', ()=>dbg('canplay', src));
    v.addEventListener('canplaythrough', ()=>dbg('canplaythrough', src));
    v.addEventListener('stalled', ()=>dbg('⚠️ stalled', src));
    v.addEventListener('waiting', ()=>dbg('⌛ waiting for data', src));
    v.addEventListener('suspend', ()=>dbg('suspend (network paused)', src));
    v.addEventListener('playing', ()=>dbg('▶ playing ok', src));
    v.addEventListener('pause', ()=>dbg('⏸ paused', src));
    v.addEventListener('error', e=>{
      const err=v.error;
      if(err){
        dbg(`❌ video error [${err.code}] ${err.message||'(no msg)'} src=${src}`);
      }else{
        dbg('❌ video error (unknown)', src);
      }
    });

    // network readyState polling (Safari sometimes hides this)
    const poll=()=>{
      const rs=v.readyState;
      const ns=v.networkState;
      dbg(`ℹ️ readyState=${rs} networkState=${ns} muted=${v.muted}`, src);
      if(rs<2) setTimeout(poll,1500);
    };
    poll();
  });
}

/* hook it to new batches */
document.addEventListener('videosBuilt', attachVideoDiagnostics);

/* -------------------- Reddit fetchers -------------------- */

/* -------------------- Reddit fetchers -------------------- */

function baseUrl(sub, token, after) {
  const params = new URLSearchParams({ limit: LIMIT, raw_json: 1 });
  if (after) params.set('after', after);

  if (token) {
    // OAuth endpoint
    return {
      url: `https://oauth.reddit.com/r/${sub}/hot?${params.toString()}`,
      mode: "oauth"
    };
  }

  // Fallback (no token) → use proxy
  const target = `https://www.reddit.com/r/${sub}/hot.json?${params.toString()}`;
  return {
    url: `https://corsproxy.io/?${encodeURIComponent(target)}`,
    mode: "proxy"
  };
}
async function pullSubreddit(sub) {
  const token = getToken();
  let after = null;
  const out = [];

  for (let page = 0; page < PAGES; page++) {
    const { url, mode } = baseUrl(sub, token, after);
    try {
      const res = await fetch(url,
        token && mode === "oauth" ? { headers: { 'Authorization': `Bearer ${token}` } } : {}
      );

      if (!res.ok) {
        const msg = `✖ /r/${sub} p${page + 1}: HTTP ${res.status} [${mode}]`;
        lastErrors.push(msg);
        log(msg);
        break;
      }

      const data = await res.json();
      const children = (data.data?.children || []);
      const items = (await Promise.all(children.map(n => normalize(n.data)))).filter(Boolean);
      out.push(...items);

      log(`✓ /r/${sub} p${page + 1} [${mode}] Loaded ${items.length}`);
      after = data.data?.after || null;
      if (!after) break;
      await new Promise(r => setTimeout(r, 20));

    } catch (e) {
      const msg = `✖ /r/${sub} p${page + 1}: ${e} [${mode}]`;
      lastErrors.push(msg);
      log(msg);
      break;
    }
  }
  return out;
}

// Helper: unescape Reddit URLs (fixes &amp; and HTML entities)
function fix(u) {
  return u ? u.replace(/&amp;/g, '&') : u;
}

// Helper: choose thumbnail
function pickThumb(d) {
  if (d.preview?.images?.[0]?.source?.url)
    return fix(d.preview.images[0].source.url);
  if (d.thumbnail && d.thumbnail.startsWith('http'))
    return d.thumbnail;
  return '';
}

// Helper: choose best gallery image from media_metadata
function bestMeta(meta) {
  if (!meta) return null;
  const s = meta.s;
  if (!s) return null;
  return fix(s.u || s.gif || s.mp4 || null);
}

/* =========================================================
   normalize() — unified Reddit media resolver
   ========================================================= */
async function normalize(d) {

  // 1️⃣ Reddit-hosted videos (v.redd.it)
  const rv = d.secure_media?.reddit_video || d.media?.reddit_video;
  if (rv?.fallback_url && rv.fallback_url.includes('v.redd.it')) {
    return {
      t: 'video',
      url: rv.fallback_url,
      thumb: pickThumb(d),
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'reddit'
    };
  }

  // 2️⃣ Direct MP4 hosts (often include audio)
  const directUrlRaw = fix(d.url_overridden_by_dest || d.url || '');
  if (directUrlRaw) {
    let playable = directUrlRaw.trim();
    if (/\.gifv(\?.*)?$/i.test(playable)) playable = playable.replace(/\.gifv(\?.*)?$/i, '.mp4$1');
    if (/\.(mp4|m4v|mov)(\?.*)?$/i.test(playable)) {
      return {
        t: 'video',
        url: playable,
        thumb: pickThumb(d) || '',
        title: d.title,
        author: d.author,
        sub: d.subreddit,
        link: `https://reddit.com${d.permalink}`,
        provider: 'direct'
      };
    }
  }

  // 4️⃣ Reddit preview videos (rare mp4 rehosts)
  const preview = d.preview?.images?.[0];
  const variants = preview?.variants;
  if (variants?.mp4?.source?.url) {
    return {
      t: 'video',
      url: fix(variants.mp4.source.url),
      thumb: fix(preview?.source?.url),
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'preview'
    };
  }

  // 5️⃣ GIF variants
  if (variants?.gif?.source?.url) {
    return {
      t: 'gif',
      url: fix(variants.gif.source.url),
      thumb: fix(preview?.source?.url),
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'gif'
    };
  }

  // 6️⃣ Galleries
  if (d.is_gallery && d.gallery_data?.items) {
    const firstId = d.gallery_data.items[0]?.media_id;
    const meta = d.media_metadata?.[firstId];
    const src = bestMeta(meta);
    if (src) {
      return {
        t: 'image',
        url: src,
        thumb: src,
        title: d.title,
        author: d.author,
        sub: d.subreddit,
        link: `https://reddit.com${d.permalink}`,
        provider: 'gallery'
      };
    }
  }

  // 7️⃣ Still images
  const img = d.url_overridden_by_dest || d.url;
  if (img && /\.(jpg|jpeg|png|webp)$/i.test(img)) {
    return {
      t: 'image',
      url: img,
      thumb: img,
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'image'
    };
  }

  // 8️⃣ Fallback preview
  if (preview?.source?.url) {
    const src = fix(preview.source.url);
    return {
      t: 'image',
      url: src,
      thumb: src,
      title: d.title,
      author: d.author,
      sub: d.subreddit,
      link: `https://reddit.com${d.permalink}`,
      provider: 'preview-image'
    };
  }

  // 9️⃣ Nothing usable
  return null;
}
  
/* -------------------- render pipeline -------------------- */
function interleaveBuckets(buckets){
  const keys = Object.keys(buckets); const out=[]; let added=true;
  while(added){ added=false; for(const k of keys){ const arr=buckets[k]; if(arr && arr.length){ out.push(arr.shift()); added=true; } } }
  for(let i=0;i<LIGHT_SHUFFLES;i++) shuffleArray(out);
  return out;
}

function attachSwipe(wrap, item){
  const likeStamp=document.createElement('div'); likeStamp.className='stamp like'; likeStamp.textContent='Like';
  const noStamp=document.createElement('div'); noStamp.className='stamp no'; noStamp.textContent='Dismiss';
  wrap.appendChild(likeStamp); wrap.appendChild(noStamp);

  let startX=0, startY=0, dx=0, dy=0, dragging=false;
  const threshold=Math.max(120, window.innerWidth*0.22), rotFactor=20;

  function setTransform(x){
    const r=(x/threshold)*rotFactor;
    wrap.style.transform=`translateX(${x}px) rotate(${r}deg)`;
    likeStamp.style.opacity=Math.max(0,Math.min(1,x/threshold));
    noStamp.style.opacity=Math.max(0,Math.min(1,-x/threshold));
    likeStamp.style.transform=`scale(${0.9 + Math.min(0.2, Math.max(0, x/threshold)*0.2)})`;
    noStamp.style.transform=`scale(${0.9 + Math.min(0.2, Math.max(0, -x/threshold)*0.2)})`;
  }
  function registerLike(i){ if(!likes.some(it=>it.url===i.url)){ likes.push(i); saveState(); } }
  function registerDiscard(i){ if(!discards.some(it=>it.url===i.url)){ discards.push(i); saveState(); } }

  function endSwipe(finalX){
    wrap.classList.remove('swiping');
    const didLike = finalX > threshold, didNo = finalX < -threshold;
    if(didLike || didNo){
      const off=(didLike?1:-1)*(window.innerWidth+200);
      wrap.style.transition='transform .28s ease-out, opacity .28s ease-out';
      wrap.style.transform=`translateX(${off}px) rotate(${off>0?rotFactor:-rotFactor}deg)`; wrap.style.opacity='0.2';
      setTimeout(()=>{ if(didLike) registerLike(item); else registerDiscard(item); markViewed(item.url); wrap.remove(); },280);
    }else{
      wrap.style.transition='transform .22s ease'; wrap.style.transform=''; likeStamp.style.opacity=0; noStamp.style.opacity=0;
      setTimeout(()=>{ wrap.style.transition=''; },240);
    }
  }

  wrap.addEventListener('pointerdown',e=>{ if(e.button!==0) return; dragging=true; wrap.classList.add('swiping'); startX=e.clientX; startY=e.clientY; dx=0; dy=0; wrap.setPointerCapture(e.pointerId); });
  wrap.addEventListener('pointermove',e=>{ if(!dragging) return; dx=e.clientX-startX; dy=e.clientY-startY; if(Math.abs(dx)>Math.abs(dy)*0.7){ setTransform(dx); } });
  wrap.addEventListener('pointerup',()=>{ if(!dragging) return; dragging=false; endSwipe(dx); });
  wrap.addEventListener('pointercancel',()=>{ if(!dragging) return; dragging=false; endSwipe(0); });
}

function card(item){
  const wrap=document.createElement('article'); wrap.className='card'; wrap.__item=item;
  const performer = inferPerformer(item);

  let media;
  if(item.t==='video' || item.t==='gif'){ media = makeVideo(item.url, item.thumb || null, item.provider); }
  else{
    media = document.createElement('img'); media.className='media'; media.loading='lazy'; media.alt=item.title||''; media.src=item.url;
    media.addEventListener('error',()=>wrap.remove());
  }
  wrap.appendChild(media);

  const caption=document.createElement('div'); caption.className='caption';
  caption.textContent = performer || (item.title||'').slice(0,64); wrap.appendChild(caption);

  const actions=document.createElement('div'); actions.className='actions';
  actions.innerHTML=`<button class="btn no" data-act="no">Dismiss</button><button class="btn ok" data-act="ok">Like</button>`;
  actions.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    if(b.dataset.act==='ok'){ if(!likes.some(i=>i.url===item.url)){ likes.push(item); saveState(); } wrap.classList.add('burst'); }
    else { if(!discards.some(i=>i.url===item.url)){ discards.push(item); saveState(); } wrap.classList.add('fade'); }
    markViewed(item.url); setTimeout(()=>wrap.remove(),260);
  });
  wrap.appendChild(actions);

  attachSwipe(wrap, item);
  return wrap;
}

async function renderChunk(where, n=CHUNK){
  if(loadLock) return;
  if(pool.length===0){ ui.progressVisibility(); return; }
  loadLock=true;
  try{
    const feed=document.getElementById(where);
    const need=Math.min(n,pool.length); let appended=0;
    while(appended<need){
      const frag=document.createDocumentFragment();
      const step=Math.min(MAX_APPEND_PER_FRAME, need-appended);
      for(let i=0;i<step;i++){ const it=pool.shift(); frag.appendChild(card(it)); }
      feed.appendChild(frag); appended+=step;
      await new Promise(r=>requestAnimationFrame(r));
    }
  }finally{ loadLock=false; ui.progressVisibility(); }
}

/* -------------------- batching -------------------- */
async function newBatch(){
  if(fetching) return;
  fetching=true; ui.phase('Fetching…'); ui.bar(10); ui.setProgressMode(true);
  pool.length=0;
  const homeFeed=document.getElementById('home');
  if(homeFeed) homeFeed.innerHTML='';
  insertFallbackVideo('home');

  const subs=[...STARTER_SUBS, ...OPTIONAL_NSFW];
  const all=[]; let done=0; lastErrors=[];

  for(const s of subs){
    const items=await pullSubreddit(s);
    all.push(...items);
    done++; ui.bar(10 + (done/subs.length)*80);
  }

  const seen=new Set(); const deduped=[];
  for(const it of all){ if(!it?.url) continue; if(seen.has(it.url)) continue; if(viewed.has(it.url)) continue; seen.add(it.url); deduped.push(it); }

  const matched=[], rest=[];
  for(const it of deduped){
    const perf=inferPerformer(it);
    if(titleHasName(it.title) || textMatchesAnyName(perf)) matched.push(it);
    else rest.push(it);
  }

  const bucketsTop={}, bucketsRest={};
  for(const it of matched){ (bucketsTop[it.sub] ||= []).push(it); }
  for(const it of rest){ (bucketsRest[it.sub] ||= []).push(it); }

  pool=[...interleaveBuckets(bucketsTop), ...interleaveBuckets(bucketsRest)];

  ui.bar(100); ui.phase('Ready'); ui.setProgressMode(false);
  await renderChunk('home', Math.min(CHUNK, pool.length));
  fetching=false;
  
  document.dispatchEvent(new Event('videosBuilt'));
}

/* -------------------- shuffle/subs/troubleshoot -------------------- */
function shuffleVisibleAndPool(){
  const feed=document.getElementById('home');
  const nodes=[...feed.children].filter(n=>n.classList.contains('card'));
  const visibleItems=nodes.map(n=>n.__item).filter(Boolean);
  const combined=[...visibleItems, ...pool];
  shuffleArray(combined);
  const keep=visibleItems.length; feed.innerHTML='';
  insertFallbackVideo('home');
  for(let i=0;i<Math.min(keep,combined.length);i++) feed.appendChild(card(combined[i]));
  pool=combined.slice(keep);
  ui.progressVisibility();
}
function buildSubsUI(){
  const grid=document.getElementById('subsGrid'); grid.innerHTML='';
  const current=new Set([...STARTER_SUBS, ...OPTIONAL_NSFW]);
  const all=[...new Set([...DEFAULT_STARTER_SUBS, ...DEFAULT_OPTIONAL_NSFW, ...STARTER_SUBS, ...OPTIONAL_NSFW])].sort((a,b)=>a.localeCompare(b));
  for(const sub of all){
    const id='sub-'+sub;
    const tile=document.createElement('label');
    tile.className='sub-tile';
    tile.innerHTML=`<input type="checkbox" id="${id}" ${current.has(sub)?'checked':''}><span>r/${esc(sub)}</span>`;
    grid.appendChild(tile);
  }
}
function saveSubsFromUI(){
  const checks=[...document.querySelectorAll('#subsGrid input[type="checkbox"]')];
  const picked=checks.filter(c=>c.checked).map(c=>c.id.replace('sub-',''));
  STARTER_SUBS = picked.filter(s=>DEFAULT_STARTER_SUBS.includes(s));
  OPTIONAL_NSFW = picked.filter(s=>DEFAULT_OPTIONAL_NSFW.includes(s));
  const leftovers=picked.filter(s=>!DEFAULT_STARTER_SUBS.includes(s) && !DEFAULT_OPTIONAL_NSFW.includes(s));
  STARTER_SUBS.push(...leftovers);
  localStorage.setItem('subs_toggle', JSON.stringify({starters:STARTER_SUBS, nsfw:OPTIONAL_NSFW}));
}
function dumpTroubleshoot(){
  const token=getToken();
  const info=[];
  info.push(`App state:\n  feed=${currentFeed}\n  pool=${pool.length}\n  likes=${likes.length}\n  discards=${discards.length}`);
  info.push(`Environment:\n  ua=${navigator.userAgent}\n  online=${navigator.onLine}\n  width=${innerWidth} height=${innerHeight}`);
  info.push(`Auth:\n  token=${token ? 'present' : 'none'}`);
  info.push(`Subs:\n  starters=[${STARTER_SUBS.join(', ')}]\n  nsfw=[${OPTIONAL_NSFW.join(', ')}]`);
  info.push(`Fetch plan:\n  LIMIT=${LIMIT}, PAGES=${PAGES}, CHUNK=${CHUNK}\n  celebNames=${CELEB_NAMES.length}`);
  if(lastErrors.length) info.push('Recent fetch errors:\n' + lastErrors.slice(-8).join('\n')); else info.push('Recent fetch errors: (none)');
  logEl.textContent=''; log(info.join('\n\n'));
}

/* -------------------- events -------------------- */
document.getElementById('newBatchBtn').addEventListener('click', newBatch);
document.getElementById('shuffleBtn').addEventListener('click', shuffleVisibleAndPool);
document.getElementById('homeBtn').addEventListener('click', ()=>ui.showPage('home'));
document.getElementById('likesBtn').addEventListener('click', ()=>{ paintList('likes', likes); requestAnimationFrame(()=>ui.showPage('likes')); });
document.getElementById('discardBtn').addEventListener('click', ()=>{ paintList('discard', discards); requestAnimationFrame(()=>ui.showPage('discard')); });
document.getElementById('manageSubsBtn').addEventListener('click', ()=>{ buildSubsUI(); ui.showPage('subs'); el('#tabSubs').style.display=''; });
document.getElementById('closeModal').addEventListener('click', ()=> el('#modal').classList.remove('show'));
document.getElementById('connectBtn').addEventListener('click', beginOAuth);
document.getElementById('subsSelectAll').addEventListener('click', ()=>{ document.querySelectorAll('#subsGrid input[type="checkbox"]')?.forEach(c=>c.checked=true); });
document.getElementById('subsClearAll').addEventListener('click', ()=>{ document.querySelectorAll('#subsGrid input[type="checkbox"]')?.forEach(c=>c.checked=false); });
document.getElementById('subsBack').addEventListener('click', ()=> ui.showPage('home'));
document.getElementById('subsSave').addEventListener('click', async ()=>{ saveSubsFromUI(); await newBatch(); ui.showPage('home'); });

function paintList(where, arr){ const host=document.getElementById(where); host.innerHTML=''; arr.forEach(it=>host.appendChild(card(it))); }

/* -------------------- autoload on scroll -------------------- */
function onScrollAuto(){
  if(!AUTOLOAD || currentFeed!=='home') return;
  if(loadLock) return;
  const doc=document.documentElement;
  const scrollTop=getScrollY();
  const nearBottom=(doc.scrollHeight - (scrollTop + window.innerHeight)) < AUTOLOAD_THRESHOLD_PX;
  const now=performance.now();
  if(nearBottom && (now - lastAutoTs) > AUTOLOAD_THROTTLE_MS){ lastAutoTs=now; renderChunk('home'); }
}
window.addEventListener('scroll', onScrollAuto, {passive:true});

/* -------------------- OAuth helpers (implicit) -------------------- */
function rand(n=12){ return Array.from(crypto.getRandomValues(new Uint8Array(n))).map(v=>(v%36).toString(36)).join(''); }
function beginOAuth(){
  let clientId = localStorage.getItem('reddit_client_id') || DEFAULT_CLIENT_ID;
  let redirectUri = localStorage.getItem('reddit_redirect_uri') || DEFAULT_REDIRECT_URI;
  if(!clientId){ clientId = prompt('Enter your Reddit CLIENT ID (installed app):',''); if(!clientId) return; localStorage.setItem('reddit_client_id', clientId); }
  if(!redirectUri){ redirectUri = prompt('Enter the exact Redirect URI you set on old.reddit.com/apps:', location.origin + location.pathname) || ''; if(!redirectUri) return; localStorage.setItem('reddit_redirect_uri', redirectUri); }
  const state=rand(24); localStorage.setItem('reddit_oauth_state', state);
  const params=new URLSearchParams({client_id:clientId,response_type:'token',state,redirect_uri:redirectUri,duration:'temporary',scope:'read identity'});
  location.href='https://www.reddit.com/api/v1/authorize.compact?' + params.toString();
}
function captureTokenFromHash(){
  if(!location.hash) return;
  const h=new URLSearchParams(location.hash.slice(1));
  const token=h.get('access_token'); const state=h.get('state');
  if(!token) return;
  const expected=localStorage.getItem('reddit_oauth_state');
  if(expected && state !== expected){ log('State mismatch (ignored)'); return; }
  const expiresIn=parseInt(h.get('expires_in')||'3600',10);
  const rec={ access_token: token, expires_at: Date.now() + (expiresIn*1000) };
  localStorage.setItem('reddit_token', JSON.stringify(rec));
  log('Token stored, expires in ' + Math.round(expiresIn/60) + 'm');
  history.replaceState({}, document.title, location.pathname + location.search);
}
function clearToken(){ localStorage.removeItem('reddit_token'); log('Token cleared'); }
function getToken(){ try{ const t=JSON.parse(localStorage.getItem('reddit_token')||'null'); if(!t) return null; if(Date.now()>t.expires_at) return null; return t.access_token; }catch{ return null; } }

/* -------------------- boot -------------------- */
captureTokenFromHash();
insertFallbackVideo('home');
ui.setProgressMode(false);
ui.bar(100); ui.phase('Ready');
log('Ready. Swipe right to Like, left to Dismiss. Tap a video to start, then tap again to mute/unmute. “Viewed” items are skipped.');
(async ()=>{ await newBatch(); })();
</script>
</body>
</html>
