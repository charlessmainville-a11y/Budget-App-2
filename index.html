<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Celeb Wall v2.0-lite</title>
<style>
  body { margin:0; font-family:sans-serif; background:#0f0f0f; color:#eee; }
  header, footer { display:flex; padding:8px; justify-content:center; gap:12px; background:#1a1a1a; position:sticky; top:0; z-index:10; }
  .btn { background:#333; color:#eee; padding:6px 12px; border-radius:6px; cursor:pointer; }
  .grid { display:grid; grid-template-columns:1fr; gap:16px; padding:16px; }
  .card { background:#222; border-radius:12px; overflow:hidden; position:relative; }
  .card img, .card video { width:100%; display:block; }
  .controls { display:flex; justify-content:space-around; padding:8px; background:#111; }
</style>
</head>
<body>
<header>
  <div class="btn" id="btnHome">Home</div>
  <div class="btn" id="btnLikes">‚≠ê Likes</div>
  <div class="btn" id="btnNew">New Batch</div>
</header>

<div id="cards" class="grid"></div>

<footer>
  <div class="btn" id="btnShuffle">Shuffle</div>
</footer>

<script>
let pool=[], shown=0;
let hidden=new Set(JSON.parse(localStorage.getItem('hidden_v1')||'[]'));
let likes=JSON.parse(localStorage.getItem('likes_v1')||'[]');
const cardsEl=document.getElementById('cards');

const PEOPLE=['Ana de Armas','Dua Lipa','Lea Elui','Kendall Jenner','Selena Gomez'];
const SUBS=['celebs','models','CelebrityPortraits'];

function log(m){console.log(m);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function fetchCelebMedia(name, limit=20, sub='celebs'){
  try{
    const url=`https://www.reddit.com/r/${sub}/search.json?q=${encodeURIComponent(name)}&restrict_sr=1&limit=${limit}&include_over_18=on&raw_json=1`;
    const res=await fetch(url);
    if(!res.ok){log(`${name} @${sub}: ${res.status}`);return 0;}
    const data=await res.json();
    const children=(data?.data?.children)||[];
    let added=0;
    for(const c of children){
      const d=c.data||{};
      const raw=d.url_overridden_by_dest||d.url||"";
      let final=null;
      if(/\.(jpg|jpeg|png|gif)$/i.test(raw)) final=raw;
      else if(/\.gifv$/i.test(raw)) final=raw.replace(/\.gifv$/i,".mp4");
      else if(d.secure_media?.reddit_video?.fallback_url) final=d.secure_media.reddit_video.fallback_url;
      if(final){
        const id=d.permalink?`https://reddit.com${d.permalink}`:`${sub}|${d.title}`;
        if(!hidden.has(id)){
          pool.push({id,title:d.title||name,url:final,link:id,source:sub});
          added++;
        }
      }
    }
    return added;
  }catch(e){log(`${name}@${sub} error ${e.message}`);return 0;}
}

async function buildNewBatch(){
  cardsEl.innerHTML=""; pool=[]; shown=0;
  const picks=PEOPLE.slice(0,5);
  for(const sub of SUBS){
    for(const n of picks){
      await fetchCelebMedia(n,20,sub);
      await sleep(200);
    }
  }
  shuffle(pool);
  renderMore();
}

function renderMore(count=8){
  for(let i=0;i<count && shown<pool.length;i++,shown++){
    renderOne(pool[shown]);
  }
}

function renderOne(item){
  const card=document.createElement('div'); card.className="card";
  let el;
  if(item.url.match(/\.(mp4|gif)$/i)){el=document.createElement('video');el.src=item.url;el.autoplay=true;el.loop=true;el.muted=true;}
  else{el=document.createElement('img');el.src=item.url;}
  card.appendChild(el);

  const ctr=document.createElement('div'); ctr.className="controls";
  const like=document.createElement('div'); like.className="btn"; like.textContent="‚≠ê";
  like.onclick=()=>{likes.unshift(item);localStorage.setItem('likes_v1',JSON.stringify(likes.slice(0,300)));card.remove();};
  const nope=document.createElement('div'); nope.className="btn"; nope.textContent="üëé";
  nope.onclick=()=>{hidden.add(item.id);localStorage.setItem('hidden_v1',JSON.stringify([...hidden]));card.remove();};
  ctr.appendChild(like); ctr.appendChild(nope);
  card.appendChild(ctr);
  cardsEl.appendChild(card);
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

document.getElementById('btnNew').onclick=buildNewBatch;
document.getElementById('btnShuffle').onclick=()=>{cardsEl.innerHTML="";shuffle(pool);shown=0;renderMore();};
document.getElementById('btnLikes').onclick=()=>{cardsEl.innerHTML="";likes.forEach(renderOne);};
document.getElementById('btnHome').onclick=()=>{cardsEl.innerHTML="";shown=0;renderMore();};

buildNewBatch();
</script>
</body>
</html>