<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Celeb Wall — v2.9</title>
<style>
  :root{
    --bg:#0d0f13;
    --panel:#151821ea;
    --chip:#1b1f28e6;
    --glass:#12151de6;
    --text:#e9eef7;
    --muted:#9ca7b6;
    --ok:#28d890;
    --warn:#ffb84d;
    --err:#ff6b6b;
    --pink:#f6a3ff;
    --blue:#7fd0ff;
    --aqua:#66e3d0;
    --grad:linear-gradient(90deg,#c9a4ff 0%,#8ecbff 50%,#f7a7c6 100%);
    --like:linear-gradient(180deg,#66e3d0,#20b8a3);
    --nope:linear-gradient(180deg,#ff9f7a,#ff6b6b);
    --radius:22px;
    --shadow:0 8px 26px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font:600 17px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    color:var(--text); background:radial-gradient(1200px 800px at 20% -10%, #1a2331 0%, transparent 60%),
                        radial-gradient(900px 700px at 100% 0%, #2a1c30 0%, transparent 60%),
                        var(--bg);
    -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:880px;margin:0 auto;padding:16px 16px 120px}
  header{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:8px 0 12px}
  .pill{background:var(--chip);border-radius:18px;padding:16px 16px 14px;box-shadow:var(--shadow);backdrop-filter:saturate(1.2) blur(10px);-webkit-backdrop-filter:saturate(1.2) blur(10px)}
  .pill h4{margin:0 0 6px 0;font-size:13px;letter-spacing:.12em;color:var(--muted)}
  .pill .big{font-size:34px;line-height:1.05;font-weight:800}
  .bar{height:12px;background:#0f1320;border-radius:999px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);position:relative;overflow:hidden;margin:10px 0 2px}
  .bar>i{position:absolute;inset:0;width:20%;background:var(--grad);border-radius:999px;transition:width .25s ease}
  .status{display:flex;justify-content:space-between;color:var(--muted);font-weight:700}
  .dash{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:18px 0 8px}
  .btn{
    background:var(--glass);color:#fff;border:none;border-radius:26px;padding:18px 20px;
    text-align:center;box-shadow:var(--shadow);backdrop-filter:saturate(1.1) blur(10px);
    -webkit-backdrop-filter:saturate(1.1) blur(10px);font-weight:800;letter-spacing:.01em
  }
  .btn.primary{background:linear-gradient(135deg,#b08cff,#7fd0ff 50%,#f7a7c6)}
  .btn.link{background:#11151c}
  .btn:disabled{opacity:.45}
  .cards{display:flex;flex-direction:column;gap:18px;margin-top:14px}
  .card{
    background:rgba(17,19,27,.86);border-radius:28px;overflow:hidden;box-shadow:var(--shadow);
    position:relative
  }
  .meta{
    position:absolute;left:16px;right:16px;top:12px;z-index:3;
    background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.1));
    border-radius:18px;padding:12px 14px;color:#fff;font-weight:900;letter-spacing:.01em;
    text-shadow:0 1px 2px rgba(0,0,0,.6)
  }
  .meta small{opacity:.8;font-weight:700}
  .imgwrap{position:relative}
  .imgwrap img{width:100%;display:block}
  .actions{
    display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;background:rgba(0,0,0,.35)
  }
  .like,.nope{
    padding:18px;border-radius:20px;border:none;color:#051014;font-weight:900;font-size:20px;letter-spacing:.01em;
    box-shadow:var(--shadow)
  }
  .like{background:var(--like)}
  .nope{background:var(--nope)}
  .tray{position:sticky;bottom:0;left:0;right:0;padding:14px;background:linear-gradient(180deg, transparent, rgba(5,8,13,.85) 40%);}
  .footer{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
  .chipbtn{
    padding:12px 16px;border-radius:20px;background:var(--chip);border:none;color:#cfe3ff;font-weight:800;box-shadow:var(--shadow)
  }
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px}
  .sheet{width:min(760px,95vw);max-height:80vh;overflow:auto;background:var(--panel);border-radius:26px;box-shadow:var(--shadow);padding:18px}
  .hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .tag{padding:10px 14px;background:#0f1320;border-radius:999px;font-weight:900;color:#dfe7f7}
  .close{border:none;border-radius:16px;padding:10px 14px;background:linear-gradient(135deg,#b08cff,#7fd0ff,#f7a7c6);font-weight:900}
  pre{white-space:pre-wrap;font:600 15px/1.4 ui-monospace,SFMono-Regular,Consolas,monospace;color:#dfe7f7}
  a { color:#cfe3ff; text-decoration:none }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="pill"><h4>BUILD</h4><div class="big" id="build">v2.9</div></div>
    <div class="pill"><h4>SHOWN</h4><div class="big" id="shown">0</div></div>
    <div class="pill"><h4>POOL</h4><div class="big" id="pool">0</div></div>
    <div class="pill"><h4>TOTAL</h4><div class="big" id="total">0</div></div>
  </header>

  <div class="pill">
    <div class="bar"><i id="bar"></i></div>
    <div class="status"><span id="stage">Ready</span><span id="pct">100%</span></div>
  </div>

  <section class="dash">
    <button class="btn" id="homeBtn">Home</button>
    <button class="btn" id="likesBtn">⭐️ Likes <span id="likeCount">0</span></button>
    <button class="btn primary" id="newBatchBtn">New batch</button>
    <button class="btn" id="shuffleBtn">Shuffle feed</button>
    <button class="btn" id="loadMoreBtn">Load more</button>
    <button class="btn link" id="connectBtn">Connect Reddit</button>
    <button class="btn" id="subsBtn">r/celebs + more</button>
    <button class="btn" id="tsBtn">Troubleshoot</button>
  </section>

  <section class="cards" id="cards"></section>

  <div class="tray">
    <div class="footer">
      <button class="chipbtn" id="homeMini">Home</button>
      <button class="chipbtn" id="likesMini">Likes</button>
      <button class="chipbtn" id="moreMini">Load</button>
      <button class="chipbtn" id="tsMini">Log</button>
    </div>
  </div>
</div>

<!-- Troubleshoot -->
<div class="modal" id="modal">
  <div class="sheet">
    <div class="hd">
      <div class="tag">Troubleshoot</div>
      <button class="close" id="closeModal">Close</button>
    </div>
    <pre id="log"></pre>
  </div>
</div>

<script>
/* ========= CONFIG ========= */

// baked-in subs (clean, no trailing comma on last line)
const SUBREDDITS = [
  "charlidameliomommy",
  "LeaEluiGinet",
  "LeaEluiG_NR",
  "CelebEvents",
  "celebpics",
  "emrata",
  "kendalljenner",
  "bellahadid",
  "madisonbeer",
  "scarlettjohansson",
  "meganfox",
  "natalieportman",
  "Pornstars",          // NSFW – will work if your account allows it
  "NSFWCelebs",         // same note
  "FayeReagan",
  "RileyReid",
  "Stoya"
];

// optional name cues for the title overlay
const CELEB_NAMES = [
  "Hailey Bieber","Madison Beer","Mia Khalifa","Keke Palmer","Selena Gomez",
  "Alexandra Daddario","Rachel Cook","Alycia Debnam-Carey",
  "Victoria Justice","Olivia Rodrigo","Irina Shayk","Hailee Steinfeld",
  "Kendall Jenner","Bella Hadid","Emily Ratajkowski","Madison Beer",
  "Riley Reid","Stoya","Faye Reagan","Lea Elui"
];

// OAuth storage keys (we already set these in the earlier build)
const LS_TOKEN = "rw_token";
const LS_EXP   = "rw_exp";  // millis since epoch

/* ========= STATE ========= */
let pool = [];      // full fetched items
let feed = [];      // visible working set
let likes = JSON.parse(localStorage.getItem("cw_likes")||"[]");
let shown = 0;

const els = {
  cards: byId('cards'),
  pool:  byId('pool'),
  shown: byId('shown'),
  total: byId('total'),
  likeCount: byId('likeCount'),
  bar:   byId('bar'),
  stage: byId('stage'),
  pct:   byId('pct'),
  log:   byId('log'),
  modal: byId('modal')
};

/* ========= UTIL ========= */
function byId(x){return document.getElementById(x)}
function log(msg){
  const t = new Date().toLocaleTimeString();
  els.log.textContent = `[${t}] ${msg}\n` + els.log.textContent;
}
function setProgress(label, frac){
  els.stage.textContent = label;
  const pct = Math.round((frac??1)*100);
  els.pct.textContent = pct + "%";
  els.bar.style.width = Math.max(4, pct) + "%";
}
function tokenValid(){
  const tok = localStorage.getItem(LS_TOKEN);
  const exp = parseInt(localStorage.getItem(LS_EXP)||"0",10);
  return tok && Date.now() < exp - 60_000;
}
function tokenGet(){ return localStorage.getItem(LS_TOKEN) || "" }

/* ========= REDDIT (OAuth) ========= */
// Uses the implicit token we already configured in earlier builds.
// If you need to reconnect, the "Connect Reddit" button navigates to your app’s authorize page.
function oauthConnect(){
  // expects you already have your Installed App set and redirect points to this page
  const clientId = localStorage.getItem("cw_client") || ""; // put your client id in LS once; or edit here
  if(!clientId){ alert("Set your Reddit client id in localStorage key `cw_client` first."); return }
  const redirect = location.href.split('#')[0]; // current page
  const state = Math.random().toString(36).slice(2);
  localStorage.setItem("cw_state", state);
  const url =
    `https://www.reddit.com/api/v1/authorize.compact?client_id=${encodeURIComponent(clientId)}` +
    `&response_type=token&state=${state}&redirect_uri=${encodeURIComponent(redirect)}` +
    `&duration=temporary&scope=read`;
  location.href = url;
}

// capture token if redirected back with hash
(function captureTokenFromHash(){
  if(location.hash.includes("access_token")){
    const params = new URLSearchParams(location.hash.slice(1));
    const state = params.get("state");
    if(state !== localStorage.getItem("cw_state")){
      log("State mismatch (oauth)"); return;
    }
    const tok = params.get("access_token");
    const expSec = parseInt(params.get("expires_in")||"3600",10);
    localStorage.setItem(LS_TOKEN, tok);
    localStorage.setItem(LS_EXP, (Date.now()+expSec*1000).toString());
    history.replaceState(null, "", location.pathname+location.search);
    log("OAuth token stored; expires in ~"+Math.round(expSec/60)+"m");
    setProgress("Ready", 1);
  }
})();

async function redditJSON(path, params={}){
  if(!tokenValid()) throw new Error("No/expired token");
  const qs = new URLSearchParams({...params, raw_json:1}).toString();
  const url = `https://oauth.reddit.com${path}?${qs}`;
  const r = await fetch(url, {headers:{Authorization:`bearer ${tokenGet()}`}});
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.json();
}

/* ========= LOADER ========= */

function extractImage(post){
  // attempts: media, preview, gallery
  const d = post.data;
  // gallery
  if(d.is_gallery && d.media_metadata){
    const first = Object.values(d.media_metadata)[0];
    const img = first?.s?.u || first?.p?.pop()?.u;
    if(img) return img.replace(/&amp;/g,'&');
  }
  // direct url
  if(d.url_overridden_by_dest && /\.(jpg|jpeg|png|webp)$/i.test(d.url_overridden_by_dest)){
    return d.url_overridden_by_dest;
  }
  // preview
  const p = d.preview?.images?.[0];
  const purl = p?.source?.url || p?.resolutions?.pop()?.url;
  if(purl) return purl.replace(/&amp;/g,'&');
  return null;
}

async function fetchSub(sub, limit=50){
  try{
    const json = await redditJSON(`/r/${sub}/hot.json`, {limit});
    const items = (json.data.children||[])
      .map(p=>{
        const img = extractImage(p);
        if(!img) return null;
        return {
          id: p.data.id,
          title: p.data.title,
          author: p.data.author,
          sub,
          url: img,
          postUrl: `https://www.reddit.com${p.data.permalink}`
        };
      }).filter(Boolean);
    log(`Loaded ${items.length} from r/${sub}`);
    return items;
  }catch(e){
    log(`× r/${sub}: ${e.message}`);
    return [];
  }
}

async function buildBatch(){
  if(!tokenValid()){ log("No valid token – tap Connect Reddit"); setProgress("Auth needed",1); return }
  setProgress("Requesting", .1);
  pool = []; feed = []; shown = 0; renderStats();
  els.cards.innerHTML = "";
  let loaded = 0;
  for(let i=0;i<SUBREDDITS.length;i++){
    const sub = SUBREDDITS[i];
    setProgress(`Fetching r/${sub}`, i/SUBREDDITS.length);
    const items = await fetchSub(sub, 40);
    pool.push(...items);
    loaded += items.length;
  }
  // dedupe by url
  const seen = new Set();
  pool = pool.filter(x=>{ if(seen.has(x.url)) return false; seen.add(x.url); return true; });
  // initial feed
  feed = shuffle(pool).slice(0, 25);
  renderFeed();
  renderStats();
  setProgress("Ready", 1);
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function loadMore(n=20){
  const current = new Set(feed.map(x=>x.url));
  const more = pool.filter(x=>!current.has(x.url)).slice(0,n);
  feed.push(...more);
  renderFeed();
  renderStats();
}

/* ========= UI ========= */

function renderStats(){
  byId('pool').textContent  = pool.length.toString();
  byId('total').textContent = pool.length.toString();
  byId('shown').textContent = shown.toString();
  byId('likeCount').textContent = likes.length.toString();
}

function nameTag(t){
  // if any celeb name is in title, return it, else author
  const title = t.toLowerCase();
  for(const n of CELEB_NAMES){
    if(title.includes(n.toLowerCase())) return n;
  }
  return null;
}

function cardHTML(item){
  const who = nameTag(item.title) || `u/${item.author}`;
  const src = item.url;
  return `
  <article class="card" data-id="${item.id}" data-url="${src}">
    <div class="meta"><div>${who} • <small>r/${item.sub}</small></div></div>
    <a class="imgwrap" href="${item.postUrl}" target="_blank" rel="noreferrer">
      <img loading="lazy" src="${src}" alt="${item.title}">
    </a>
    <div class="actions">
      <button class="nope">Dismiss</button>
      <button class="like">Like</button>
    </div>
  </article>`;
}

function renderFeed(){
  els.cards.innerHTML = feed.map(cardHTML).join("");
  // attach handlers
  els.cards.querySelectorAll(".like").forEach(btn=>{
    btn.onclick = (e)=>{
      const art = e.target.closest('.card');
      likeCard(art);
    };
  });
  els.cards.querySelectorAll(".nope").forEach(btn=>{
    btn.onclick = (e)=>{
      const art = e.target.closest('.card');
      removeCard(art);
    };
  });
}

function likeCard(art){
  const url = art.dataset.url;
  const id = art.dataset.id;
  const item = feed.find(x=>x.id===id) || pool.find(x=>x.id===id);
  if(item && !likes.find(x=>x.url===item.url)){
    likes.unshift(item);
    localStorage.setItem("cw_likes", JSON.stringify(likes.slice(0,500)));
    renderStats();
  }
  art.remove();
  shown++;
  renderStats();
}

function removeCard(art){
  art.remove();
  shown++;
  renderStats();
}

function showLikes(){
  if(!likes.length){ alert("No likes yet 🙂"); return }
  feed = likes.slice(0, 60);
  renderFeed();
  setProgress("Showing likes", 1);
}

function showHome(){
  if(!pool.length){ setProgress("No pool — build batch", 1); return }
  feed = shuffle(pool).slice(0, 25);
  renderFeed();
  setProgress("Ready", 1);
}

/* ========= EVENTS ========= */
byId('newBatchBtn').onclick = buildBatch;
byId('loadMoreBtn').onclick = ()=>loadMore(24);
byId('shuffleBtn').onclick  = ()=>{ feed = shuffle(feed); renderFeed(); };
byId('likesBtn').onclick    = showLikes;
byId('likesMini').onclick   = showLikes;
byId('homeBtn').onclick     = showHome;
byId('homeMini').onclick    = showHome;
byId('moreMini').onclick    = ()=>loadMore(24);

byId('tsBtn').onclick = ()=>els.modal.style.display='flex';
byId('tsMini').onclick= ()=>els.modal.style.display='flex';
byId('closeModal').onclick = ()=>els.modal.style.display='none';
els.modal.addEventListener('click',(e)=>{ if(e.target===els.modal) els.modal.style.display='none' });

byId('connectBtn').onclick = ()=>{
  const client = prompt("Enter your Reddit client id (Installed app):", localStorage.getItem("cw_client")||"");
  if(client){
    localStorage.setItem("cw_client", client.trim());
    oauthConnect();
  }
};

// initial
renderStats();
setProgress("Ready", 1);

// If token is present, you can auto-load a batch on first open:
// if(tokenValid()) buildBatch();

</script>
</body>
</html>